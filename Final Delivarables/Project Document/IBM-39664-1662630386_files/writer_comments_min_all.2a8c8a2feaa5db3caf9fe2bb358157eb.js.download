CommentUtils={},CommentUtils.selectWord=function(){var e,t,i=editor.doc.getSelection();if(i.isCollapsed())i.setSelectionType(SEL_AUTO_GEN).getWord().select(),CommentManager.focusCommentUnderCurrentSelection(editor.uuid),e=i.getStart(),t=i.getEnd();else if(i.isTableSelected()){var n=editor.doc.getContent(e,t);if(n.indexOf(UNICODE.ROW)!=-1){var o=i.getStartCell();if(o){e=o.getStart()+1,t=o.getEnd()-1;var s=editor.doc.createRange(e,t);i.setSelectionType(SEL_KEYBOARD).removeAllRanges().addRange(s)}}}else{var r=i.getTargetRange();e=r.start,t=r.end}return{start:e,end:t}},CommentUtils.discardHighlights=function(e){e&&CommentHighlights.highlightMap.removeByLine(e)},CommentUtils.highlightCommentedDoctext=function(e){var t=CommentHighlights.highlightMap.getElmsByComment(e);t.addClass("ui-comment-indication-new-active")},CommentUtils.removeCommentedDoctextHighlight=function(e){var t=CommentHighlights.highlightMap.getElmsByComment(e);t.removeClass("ui-comment-indication-new-active")},CommentUtils.resolveHighlights=function(e){var t=CommentHighlights.highlightMap.getHighlights(e),i=t.filter(function(e){var t=CommentHighlights.highlightMap.getComments(e),i=t.filter(function(e){var t=CommentModels.commentCollection.get(e);return t&&!t.get("isResolved")}),n=!i.length;return n}),n=CommentHighlights.highlightMap.getElms(i);n.addClass(CommentUtils.getResolvedClass())},CommentUtils.unresolveHighlights=function(e){var t=CommentHighlights.highlightMap.getHighlights(e),i=CommentHighlights.highlightMap.getElms(t);i.removeClass(CommentUtils.getResolvedClass())},CommentUtils.drawFocusLine=function(e){var t,i,n=CommentUtils.getCommentRange(e),o=70,s=CommentManager.views.commentCollectionView.commentViewMap[e].$(".ui-ncmt-container"),r=s.offset();if(r.top=s.find(".js-parent-comment-author-img").offset().top+s.find(".js-parent-comment-author-img").height(),s.offset().top<CommentManager.views.commentCollectionView.$el.offset().top&&(r.top=CommentManager.views.commentCollectionView.$el.offset().top),n){t=CommentManager.views.focusLine;var m=n.start;if(editor.doc.getCharAt(m+1)==UNICODE.IMAGE)l=J(editor.doc.getPortionData(m+2).node.firstChild);else var l=J(editor.doc.getPortionData(m+2).node);i=l.offset(),i.top=l.closest(".zw-line-content").offset().top-2}else{t=CommentManager.views.unlinkedFocusLine;var a=r.top+o,c=CommentManager.views.commentCollectionView.$el.offset().top,d=CommentManager.views.commentCollectionView.$el.height();a>c+d&&(a=r.top-o);var u=r.left-o;i={top:a,left:u}}var h;h=n?"ui-editor-outer-div":"unlinked-cmt-floating-icon",n||CommentUtils.positionUnlinkedIcon(i),t.drawLine(i,h,r,"comment-list-container","#fad76e")},CommentUtils.positionUnlinkedIcon=function(e){var t=12,i=document.getElementById("unlinked-cmt-floating-icon");i.style.display="block",i.style.left=e.left-t+"px",i.style.top=e.top-t+"px"},CommentUtils.removeFocusLine=function(e){var t=CommentManager.views.focusLine,i=CommentManager.views.unlinkedFocusLine;t.remove(),i.remove(),W.get("#unlinked-cmt-floating-icon").hide()},CommentUtils.updateFocusLine=function(){CommentUtils.removeFocusLine();var e=CommentUtils.getCurrentFocusedComment(),t=Z("review_tab").ztabpanel("getActiveTab"),i=CommentUtils.isReviewPaneVisible()&&"li-comments-tab-header"===t.id;i&&e&&CommentUtils.delay(function(){CommentUtils.drawFocusLine(e.get("id"))},500,CommentManager.views.commentPaneView.focusLineTimer)},CommentUtils.getCommentRange=function(e){var t=CommentModels.commentIndices.filter(function(t){return t.id==e})[0];if(t&&t.start&&t.end)return t;for(var i=-1,n=-1,o=editor.doc.getDocumentLength(),s=editor.doc.getDocumentContent().indexOf(UNICODE.RANGE_START),t={start:null,end:null};s>-1&&s<o;){var r=editor.doc.getRawFormatAt(s);if(r&&r.type==NODE_TYPE.COMMENT&&r.id==e){for(i=s,s=editor.doc.findNextIndexOf(UNICODE.RANGE_END,s+1);s>i;){if(format=editor.doc.getRawFormatAt(s),format&&format.type==NODE_TYPE.COMMENT&&format.id==e){n=s;break}s=editor.doc.findNextIndexOf(UNICODE.RANGE_END,s+1)}break}s=editor.doc.findNextIndexOf(UNICODE.RANGE_START,s+1)}return i!=-1&&n!=-1&&(t.start=i,t.end=n,t)},CommentUtils.pullCommentedDoctextIntoView=function(e){var t=CommentUtils.getCommentRange(e);if(!t||!editor.doc.getSelection())return!1;CommentModels.updateCommentFocus=!1;var i=editor.doc.createRange(t.start+1);editor.doc.getSelection().setSelectionType(SEL_AUTO_GEN).removeAllRanges().addRange(i),CommentModels.updateCommentFocus=!0;var n=DomUtil.scrollElementIntoView(editor.doc.getCursorPortionNode());return n},CommentUtils.pullCommentInputIntoView=function(){if(CommentModels.commentPane.get("commentCreationDialogShow")){var e=CommentManager.views.commentCreationView.$el;JcommentPane=CommentManager.views.commentCollectionView.$el,CommentPaneScrollTop=JcommentPane.scrollTop(0),CommentViewTop=e.position().top,JcommentPane.animate({scrollTop:CommentViewTop-100})}},CommentUtils.pullCommentIntoView=function(e){var t=J.Deferred(),i=CommentManager.views.commentCollectionView.commentViewMap[e];return!!i&&(JcommentView=i.$el,JcommentView.length?(JcommentPane=CommentManager.views.commentCollectionView.$el,CommentPaneScrollTop=JcommentPane.scrollTop(0),CommentViewTop=JcommentView.position().top,JcommentPane.animate({scrollTop:CommentViewTop-200},function(){t.resolve(!0)}),t):void 0)},CommentUtils.getMarkedupCommentContent=function(e,t){if(t=t||CommentModels.commentPane.get("searchQuery"),!t||t.trim().length<3)var i=e;else var n=new RegExp("("+t+")","igm"),i=e.replace(n,'<span class="search-highlight">$1</span>');var o=J("<div/>").text(i).text(),s=o.replace(/\n/g," <br/> "),r=s.replace(CommentModels.EMAIL_REGEX,'<a class="ui-atmention" rel="noreferrer" href="mailto:$1@$2.$3" title="$1@$2.$3">@$1</a>'),m=r.replace(CommentModels.URL_REGEX,function(e){var t=e;return e.startsWith("www")&&(t="http://"+e),'<a rel="noreferrer" target="_blank" href="'+t+'">'+e+"</a>"}),l=CommentUtils.getLinkMarkUp(m);return l},CommentUtils.getLinkMarkUp=function(e){var t=e.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" rel="noreferrer" target="_blank">$1</a>');return t},CommentUtils.unescapeHTML=function(e){return J("<div/>").html(e).text()},CommentUtils.updateTextAreaHeight=function(e){if(!CommentModels.isRichCommentsEnabled()){e.style.overflow="hidden";var t=(e.clientHeight,e.scrollHeight);e.style.height=t+"px"}},CommentUtils.autoHeightTextArea=function(e){var t=e.target,i=CommentManager.views.commentCollectionView.$el.scrollTop();t.style.height="",CommentUtils.updateTextAreaHeight(t),CommentManager.views.commentCollectionView.$el.scrollTop(i)},CommentUtils.isAnyCommentRenderedInPane=function(){var e=CommentModels.commentCollection.length;return!!e},CommentUtils.getUsername=function(e){var t;return t=e&&""!==e?ReviewUtil.getUserProp(e,"fname"):"Guest"},CommentUtils.getCoreData=function(e){var t=["id","createdAt","updatedAt","zuid","activityLog","text","doctext","children","parentId","isResolved","contentUpdatedAt","visibility"];return CommentModels.isRichCommentsEnabled()&&t.push("richtext"),commentJSON={},ZWArrayUtils.each(t,function(t){commentJSON[t]=e[t]}),commentJSON},CommentUtils.sendOp=function(e,t){var i=DocOpBuilder.build(e);ZWLogger.log("\nComment sendOp called for ops: "+i.toProtoString());var n=!t;e.length&&CommentModels.queueSyncer.push(e,n)},CommentUtils.setUpPrint=function(){if(document.getElementById("commentPrint"))return!1;var e=document.createElement("iframe");e.id="commentPrint",editor.editorPaneContainer.append(e);var t=e.contentWindow.document,i=fingerPrintObj["styles/writer_min_all.css"].split("/")[1],n=J(document).find('link[href$="'+i+'"]');link=t.createElement("link"),link.href=n.attr("href"),link.rel="stylesheet",J(e).css({height:0,top:"-10px",position:"absolute"}),J(t).find("head").append(link)},CommentUtils.printComments=function(){J("#commentPrint").length||CommentUtils.setUpPrint(),CommentModels.commentCollection.models.forEach(function(e){e.set("isEllipsized",!1),e.get("children").models.forEach(function(e){e.set("isEllipsized",!1)})}),setTimeout(function(){var e=document.getElementById("commentPrint"),t=CommentManager.views.commentCollectionView.$el.clone();t.find("div.ui-ncmt-container").css("width",800),t.find(".reply-textarea").hide(),t.find(".ui-delete-comment").hide(),t.find(".ui-cmt-act-subcont").hide(),t.find(".ui-ncmt-container").removeClass("ui-ncmt-container-selected"),t.find(".cmt-header-menu").hide(),t.find(".reply-list-container").css("margin-left","30px"),t.find("div.ui-ncmt-container").css({"margin-top":"","margin-left":""}),t.find("div.ui-reply-comments").css({display:"block"}),t.find(".reply-list-container").show(),t.find(".js-new-reply-view").hide(),t.find(".ui-ncmt-reply").hide(),t.find(".ui-toggle-comment-height").hide(),t.find(".ui-toggle-replycomment-height").hide(),t.find(".child-comnt-options").hide(),t.find(".ui-ncmt-footer").hide();var i=e.contentWindow.document,n=i.getElementsByTagName("body")[0];n.innerHTML=t[0].innerHTML,e.contentWindow.focus(),e.contentWindow.print(),CommentModels.commentCollection.models.forEach(function(e){e.set("isEllipsized",!0),e.get("children").models.forEach(function(e){e.set("isEllipsized",!0)})})},200)},CommentUtils.getDocumentSharedUsersWithContacts=function(e){var t={};ZWNetworkUtils.ajax({type:"POST",url:ZWNetworkUtils.getNiceUrlPrefix(editor.doc.docInfo.RID+"/util/shareduserswithcontacts"),data:t,dataType:"json",beforeSend:function(e){ZWNetworkUtils.setCsrfTokenInHeader(e)},error:function(){e([])},success:function(t){if("FAILED"!==t.RESPONSE){var i=t.users;ZWArrayUtils.each(i,function(e){e.val=e.emailid,e.fullname=e.fullname?e.fullname:e.emailid});var n={};i.forEach(function(e){if(n[e.zuid]){var t="personal"===n[e.zuid].usertype;t&&(n[e.zuid]=e)}else n[e.zuid]=e}),i=Object.keys(n).map(function(e){return n[e]}),e(i)}else e([])}})},CommentUtils.loadContacts=function(){return!!CommentModels.atMention.enabled()&&void CommentUtils.getDocumentSharedUsersWithContacts(function(e){CommentModels.atMention.loaded=!0,CommentModels.atMention.contacts=e,J(".enable-atmentions").each(function(t,i){var n=J(i).data("plugin_sew");n?n.options.values=e:J(i).atMention()})})},CommentUtils.getContacts=function(){return CommentModels.atMention.contacts},CommentUtils.detectMentions=function(e){var t=e.match(CommentModels.EMAIL_REGEX)||[],i=ZWArrayUtils.removeDuplicates(t);return i.map(function(e,t){var i=e.substr(1);return i})},CommentUtils.detectMentionsFromJSON=function(e,t){var i=CommentUtils.getUniqContacts(t.getNodeAttrsFromJSON("mention",e));return i.map(function(e){var t=e.email;return t})},CommentUtils.getUniqContacts=function(e){return e.filter(function(e,t,i){return i.indexOf(e)==t})},CommentUtils.sendNotificationMail=function(e,t,i,n){var o={},s={};o.purpose="comment",e.forEach(function(e){var t=CommentModels.atMention.contacts.filter(function(t){return t.emailid==e});1==t.length?s[e]=t[0].fullname:s[e]=e.split("@")[0]});var e=[],r=[];for(var m in s)e.push(m),r.push(s[m]);o.mail_toaddress=e.join(",");var l={userNames:r,commentContent:t,commentId:i};n&&(l.replyCommentId=n),o.addinfo=JSON.stringify(l);var a={url:ZWNetworkUtils.getNiceUrlPrefix(editor.doc.docInfo.RID+"/util/sendmail"),data:o,dataType:"json",type:"POST",beforeSend:function(e){ZWNetworkUtils.setCsrfTokenInHeader(e)}};isV8Engine?ZWNetworkUtils.ajax(a):J.ajax(a)},CommentUtils.notifyMentions=function(e,t,i){var n=editorProps.permissionsInfo.appInfo.NAME;if(CommentModels.atMention.enabled&&"CONTRACT_MGMT"!==n){var o=CommentUtils.detectMentions(e);o.length&&(CommentUtils.sendNotificationMail(o,e,t,i),ActivityTracker.trackInAnalytics("Comment","NotifyMentions","ReviewPanel"))}},CommentUtils.showHint=function(e){var t=J(e.target);t.parent().find(".atmention-hint").length&&t.parent().find(".atmention-hint").show()},CommentUtils.hideHint=function(e){var t=J(e.target);setTimeout(function(){t.parent().find(".atmention-hint").hide()},100)},CommentUtils.doneKey=function(e,t,i){(e.ctrlKey||e.metaKey)&&13==e.keyCode&&t.apply(i,[])},CommentUtils.cancelKey=function(e,t,i){27==e.keyCode&&t.apply(i,[])},CommentUtils.refineCommentJSON=function(e){e=JSON.parse(JSON.stringify(e)),e="string"==typeof e?JSON.parse(e):e;for(var t in e)"text"!=t&&"null"===e[t]&&(e[t]=null);var i=[];for(var n in e.children)e.children[n].children=[],e.children[n].doctext=null,e.children[n].deleted||i.push(e.children[n]);return e.children=i,e},CommentUtils.showCurrentCommentSelection=function(e,t){editor.doc.domCursor.comment&&!J.isEmptyObject(editor.doc.domCursor.comment)||(editor.doc.domCursor.comment={zuid:editor.zuid,bgColor:"#F88017",start:{node:"",idx:"",cursor:""},end:{node:"",idx:"",cursor:""}});var i=editor.doc.getSelection("comment")||editor.doc.createSelection("comment"),n=editor.doc.createRange(e,t).setFocus(!1);n.type=ZWRange.TYPE.COMMENT,i.setSelectionType(SEL_AUTO_GEN).removeAllRanges().addRange(n)},CommentUtils.hideCurrentCommentSelection=function(){editor.doc.domCursor.comment&&!J.isEmptyObject(editor.doc.domCursor.comment)&&(J(editor.doc.domCursor.comment.start.cursor).remove(),J(editor.doc.domCursor.comment.end.cursor).remove()),delete editor.doc.domCursor.comment;var e=editor.doc.getSelection("comment");e&&e.removeAllRanges()},CommentUtils.removeCommentUI=function(){CommentModels.commentPane.set("commentCreationDialogShow",!1),CommentModels.commentPane.set("show",!1)},CommentUtils.arrayDiff=function(e,t){var i=[],n=[];return i=t.filter(function(t){return e.indexOf(t)<0}),n=e.filter(function(e){return t.indexOf(e)<0}),{additions:i,deletions:n}},CommentUtils.isResolved=function(e){var t=CommentModels.commentCollection.get(e);return t&&t.get("isResolved")},CommentUtils.isReviewPaneVisible=function(){return EditorLayout.isRightPaneVisible()},CommentUtils.shouldHighlightResolved=function(){return ZWArrayUtils.arrayContains(["REMOTEEDIT","REMOTECOLLABEDIT","TRYEDITOR_WRITER","TRYEDITOR_OFFICEAPI","MAILMERGE_LIBRARY","CRM_VERTICAL_MAILMERGE_LIBRARY","ZFORMS_TEMPLATE","MAILMERGE_ORCHESTLY_TEMPLATE"],editor.doc.getRole())},CommentUtils.getResolvedClass=function(){return CommentModels.SHOULD_HIGHLIGHT_RESOLVED_COMMENTS?"ui-comment-indication-new-resolved":"ui-comment-indication-new-resolved-no-background"},CommentUtils.afterHighlightDraw=function(e,t,i){var n="cmt-hl-"+Utils.randomString(),o=e.filter(CommentUtils.isResolved).length==e.length;o&&t.addClass(CommentUtils.getResolvedClass()),editor.doc.docInfo.FINAL_INFO&&editor.doc.docInfo.FINAL_INFO.STATUS&&t.hide(),t.attr("id",n),e.forEach(function(e){var i=CommentModels.commentCollection.get(e);t.addClass("comment-indicator-"+e),i&&i.get("inFocus")&&t.addClass("ui-comment-indication-new-active"),CommentHighlights.highlightMap.addHighlights(e,[n])}),CommentHighlights.highlightMap.setComments(n,e),CommentHighlights.highlightMap.setElm(n,t),CommentHighlights.highlightMap.setLineMap(i,n)},CommentUtils.drawCommentHighlight=function(e,t,i){if(e===t)return!1;var n=DocLayoutManager.getRectsToDrawSelection(e,t);n.forEach(function(e){var t=DomViewManager.getDOMElemById(e.id);e.rects.forEach(function(n){var o=n;o["z-index"]=ZINDEX.COMMENT_HIGHLIGHT;var s=J(document.createElement("div"));s.addClass("ui-comment-indication-new").css(o).appendTo(t),CommentUtils.afterHighlightDraw(i,s,e.id)})})},CommentUtils.getHighlightSegments=function(e,t){var i=[],n=[],o={start:null,end:null,ids:[]},s={},r=CommentModels.commentIndices.filter(function(e){var t=CommentModels.commentCollection.get(e.id);return t&&t.get("isRangeCharsRendered")}),m=r.filter(function(i){return i.start<e&&i.end>t}),l=r.filter(function(i){return i.start>=e&&i.start<=t&&i.end>t}),a=r.filter(function(i){return i.start<e&&i.end<=t&&i.end>=e}),c=r.filter(function(i){return i.start>=e&&i.start<=t&&i.end<=t&&i.end>=e});ZWArrayUtils.each(m,function(i){s[e]||(s[e]={start:[],end:[]}),s[t]||(s[t]={start:[],end:[]}),s[e].start.push(i.id),s[t].end.push(i.id)}),ZWArrayUtils.each(l,function(e){s[e.start]||(s[e.start]={start:[],end:[]}),s[t]||(s[t]={start:[],end:[]}),s[e.start].start.push(e.id),s[t].end.push(e.id)}),ZWArrayUtils.each(a,function(t){s[e]||(s[e]={start:[],end:[]}),s[t.end]||(s[t.end]={start:[],end:[]}),s[e].start.push(t.id),s[t.end].end.push(t.id)}),ZWArrayUtils.each(c,function(e){s[e.start]||(s[e.start]={start:[],end:[]}),s[e.end]||(s[e.end]={start:[],end:[]}),s[e.start].start.push(e.id),s[e.end].end.push(e.id)});for(var d=e;d<=t;d++)if(s[d])if(s[d].start.length)o.start&&!o.end?(i.length&&n.push({start:o.start,end:d,ids:i.slice()}),o.start=d,o.end=null,o.ids=o.ids.concat(s[d].start),i=i.concat(s[d].start)):(o.start=d,o.end=null,o.ids=o.ids.concat(s[d].start),i=i.concat(s[d].start));else{i.length&&n.push({start:o.start,end:d,ids:i.slice()});for(var u=0;u<s[d].end.length;u++){var h=s[d].end[u],C=i.indexOf(h);C>-1&&i.splice(C,1)}i.length&&(o.start=d,o.end=null,o.ids=i)}return n},CommentUtils.replaceOrAdd=function(e,t){var i=e.filter(function(e){return e.id!=t.id});return i.push(t),i},CommentUtils.loadCommentIndices=function(){for(var e,t=[],i={},n=new RegExp(UNICODE.RANGE_START+"|"+UNICODE.RANGE_END,"g");e=n.exec(editor.doc.getDocumentContent());){var o=editor.doc.getRawFormatAt(e.index),s=e[0];o.type==NODE_TYPE.COMMENT&&s==UNICODE.RANGE_START?(t.push(o.id),i[o.id]||(i[o.id]={}),i[o.id].start=e.index):o.type==NODE_TYPE.COMMENT&&s==UNICODE.RANGE_END&&(i[o.id].end=e.index)}Object.keys(i).forEach(function(e){CommentModels.commentIndices.push({id:e,start:i[e].start,end:i[e].end})})},CommentUtils.sendRTEErrorLog=function(e){var t={};t.errNo=CommentModels.RICH_COMMENT_INVALID_JSON,t.error=e,CommentUtils.sendLogEmail(t)},CommentUtils.sendLogEmail=function(e){var t=ZWLogger.shrinkOperationSequence(ZWCollaboration.operationSequence).join(","),i=e.errNo;ZWLogger.sendErrorDetails(i+"<ZWERROR>"+editor.doc.docInfo.VERSION+"."+editor.doc.docInfo.REVISION+"<ZWERROR>\n Error Log Start \n"+ZWCollaboration.clientInfo+"\n Err No ="+i+" DOC len ="+editor.doc.getDocumentLength()+" Cur St ="+editor.doc.getSelection().getStart()+" Cur end="+editor.doc.getSelection().getEnd()+" MsgQueue = "+ZWCollaboration.msgQueue.toProtoString()+" FULL DOC OP IDS :: "+ZWCollaboration.docOpIds+" buildLabel::: "+buildLabel+"\nOperation Sequence: \n"+t+"\nError Log End \n<ZWERROR>"+ZWCollaboration.mailInfo,e)},CommentUtils.onErrorCallback=function(e){if(CommentModels.queue.reqCount=0,CommentModels.commentPane.set("isReadOnly",!0),e.error)var t=e.error.stack;else{var t=printStackTrace();t=t.join("\n")}e.commentQueue=JSON.stringify(CommentModels.queue.pendingCommentEdits),ZWLogger.log("\nERROR CODE: "+e.errNo+"\nACTION: "+e.action+"\nADDINFO: "+JSON.stringify(e.info)),ZWLogger.log("\n"+t),e.error&&ZWLogger.log("\n Stack: "+e.error.stack),CommentUtils.sendLogEmail(e),CommentUtils.showCommentError(e)},CommentUtils.showCommentError=function(e){ZWCollaboration.stopUpdates=!0,editor.rebindEvents(ERROR_PERMISSION);var t=function(){editor.rebindEvents(),editor.reloadDocumentContent()};UIUtils.showMessagePopup(J.i18n(UIUtils.getUIText("MSG_COMMENT_ERROR")),J.i18n(UIUtils.getUIText("TITLE_COMMENT_ERROR")),"error",t,!0,!1)},CommentUtils.addParticipant=function(){var e=editor.doc.getTrackChangeDetails().isUserParticipated();e||(editor.doc.getTrackChangeDetails().makeUserParticipated(),ReviewUtil.addParticipant())},CommentUtils.shouldLoadComments=function(){var e=editor.getRole().permissions.can("review.comment.view"),t=[EDITOR_VIEWS.MAILMERGE_PREVIEW,EDITOR_VIEWS.PRINT_PREVIEW],i=!ZWArrayUtils.arrayContains(t,editor.getView());return!(!e||!i)},CommentUtils.pushToBuffer=function(e){var t="zw"+Utils.randomString();e.opId=t,CommentModels.appliedCommentOps[t]=editor.zuid,Op.commentMsgBuffer.push(e)},CommentUtils.isEmptyCommentOpHistory=function(e){var t=!0;for(var i in e)ZWArrayUtils.each(e[i],function(e){t=!1});return t},CommentUtils.sendMessage=function(e){var t={};editor.doc.docInfo;t.commentOps=JSON.stringify(e);var i=ZWNetworkUtils.getUrl("comment");t.sid=editor.uuid;var n={type:"POST",dataType:"json",global:!1,timeout:ZWCollaboration.SERVER_SLOW_RESPONSE_TIMEOUT,url:i,data:t,beforeSend:function(e){ZWLogger.log("Comment-SendMessage-beforeSend"),ZWNetworkUtils.setCsrfTokenInHeader(e)}};return isV8Engine?ZWNetworkUtils.ajax(n):J.ajax(n)},CommentUtils.syncCommentOps=function(e){for(var t=e.CHANGES,i=(e.comment_sequence_number,CommentModels.getSequenceNumber()+1);i<=e.comment_sequence_number;i++){var n=t[i];if(!n)return CommentUtils.onErrorCallback({action:"sync_op_missing",info:e,errNo:e.ERR_CODE||CommentModels.COMMENT_SYNC_OP_MISSING_ERROR}),!1;n.sid!=editor.uuid?CommentModelManager.handleCollaboratorOperation(n,n.zuid,i):CommentModels.setSequenceNumber(i)}},CommentUtils.checkSync=function(e,t){return sequenceDiff=CommentUtils.getSequenceDiff(e.comment_sequence_number),t?void(1==sequenceDiff?CommentModels.setSequenceNumber(e.comment_sequence_number):sequenceDiff>1&&CommentUtils.syncup()):void(sequenceDiff>0&&CommentUtils.syncup())},CommentUtils.syncup=function(e){ZWLogger.log("SENDING COMMENT SYNC REQUEST...");var t=ZWNetworkUtils.getUrl("comment/sync");if(params={},params.comment_sequence_number=CommentModels.getSequenceNumber(),params.sid=editor.uuid,currentDocInfo=editor.doc.docInfo,!CommentUtils.shouldLoadComments())return!1;ZWNetworkUtils.ajax({type:"POST",dataType:"json",global:!1,timeout:ZWCollaboration.SERVER_SLOW_RESPONSE_TIMEOUT,url:t,data:params,beforeSend:function(e){ZWNetworkUtils.setCsrfTokenInHeader(e)},error:function(t){ZWLogger.log("COMMENT SYNC REQUEST FAILED BY REQUEST FAILURE."),t.status>=500?(ZWLogger.log("COMMENT SYNC REQUEST FAILED. CHECK SERVER LOGS."),CommentUtils.sendLogEmail({action:"comment_sync",info:{params:params,serverResp:t},errNo:t.ERR_CODE||CommentModels.COMMENT_SYNC_ERROR})):t.status>=400&&(ZWLogger.log("COMMENT SYNC REQUEST: BAD REQUEST FAILURE. CHECK SERVER LOGS."),CommentUtils.sendLogEmail({action:"comment_sync",info:{params:params,serverResp:t},errNo:t.ERR_CODE||CommentModels.COMMENT_SYNC_ERROR})),CommentModelManager.fetchReload().done(function(){e&&e()})},success:function(t){"SUCCESS"==t.RESPONSE?(CommentUtils.syncCommentOps(t),e&&e()):"FAILED"==t.RESPONSE&&t.comments?(CommentModelManager.reload(t),e&&e()):(ZWLogger.log("COMMENT SYNC REQUEST FAILED. CHECK SERVER LOGS."),CommentUtils.sendLogEmail({action:"comment_sync",info:{params:params,serverResp:t},errNo:t.ERR_CODE||CommentModels.COMMENT_SYNC_ERROR}),CommentModelManager.fetchReload().done(function(){e&&e()}))}})},CommentUtils.constructDeleteOp=function(e){var t={},i=editor.doc.docInfo;return t.action="deleteComment",t.rid=i.RID,t.sid=editor.uuid,t.commentData={},t.commentData.id=e.id,t},CommentUtils.getSequenceDiff=function(e){return e-CommentModels.getSequenceNumber()},CommentUtils.freeze=function(){CommentModels.commentPane.set("freeze",!0)},CommentUtils.unfreeze=function(){CommentModels.commentPane.set("freeze",!1)},CommentUtils.constructLog=function(e){return e.errNo+"<ZWERROR>"+editor.doc.docInfo.VERSION+"."+editor.doc.docInfo.REVISION+"<ZWERROR>\n Err No ="+e.errNo+" DOC len ="+editor.doc.getDocumentLength()+" Cur St ="+editor.doc.getSelection().getStart()+" Cur end="+editor.doc.getSelection().getEnd()+" MsgQueue = "+ZWCollaboration.msgQueue.toProtoString()+" FULL DOC OP IDS :: "+ZWCollaboration.docOpIds+" buildLabel::: "+buildLabel+"\n Error Log End \n"},CommentUtils.getCount=function(e){return CommentModels.commentPane.get(e)},CommentUtils.deleteComment=function(e){var t=CommentManager.views.commentCollectionView[e];t.initDelete()},CommentUtils.editComment=function(e){var t=CommentManager.views.commentCollectionView[e];t.initEditMode()},CommentUtils.initComponents=function(e){ZComponents.init(e,null,"ctype")},CommentUtils.initActivityTracking=function(e){UIStateHandler.build(e)},CommentUtils.deleteFilteredComments=function(){MsgDialog.showMessage(CONST.MSG_TYPE_YESNO,CONST.SEVERITY_WARNING,J.i18n("writer.common.DELETE_COMMENTS"),J.i18n("writer.common.DELETE_COMMENTS_MSG"),null,function(e){switch(e){case CONST.BUTTON_YES_CLICKED:CommentManager.views.commentPaneView.deleteFilteredComments()}})},CommentUtils.resolveFilteredComments=function(){MsgDialog.showMessage(CONST.MSG_TYPE_YESNO,CONST.SEVERITY_WARNING,J.i18n("writer.common.RESOLVE_COMMENTS"),J.i18n("writer.common.RESOLVE_COMMENTS_MSG"),null,function(e){switch(e){case CONST.BUTTON_YES_CLICKED:CommentManager.views.commentPaneView.resolveFilteredComments()}})},CommentUtils.positionCommentDialog=function(){var e=CommentManager.views.commentCreationView.$el;CommentUtils.isReviewPaneVisible()?CommentUtils.showDialogInCommentPane(e):CommentUtils.showDialogInEditorPane(e)},CommentUtils.showDialogInCommentPane=function(e){e.hide(),e.css({position:"relative",left:"",top:"",width:"auto"}),e.detach(),e.find(".ui-ncmt-container-div").removeClass("ui-ncmt-container-cmode");var t=function(){for(var e=editor.doc.getSelection().getStart(),t=CommentModels.commentIndices.sort(function(e,t){return t.start<e.start?1:-1}).filter(function(t){return t.start<=e}),i=t.length-1;i>=0;i--){var n=t[i],o=CommentModels.commentCollection.get(n.id);if(o&&!o.get("isResolved")&&CommentModels.commentCollection.isCommentRendered(n.id))return n.id}return null}();if(t){var i=CommentManager.views.commentCollectionView.commentViewMap[t].$el;i.after(e)}else e.prependTo(CommentManager.views.commentCollectionView.$el);var n=J.Deferred();return e.slideDown(200,function(){n.resolve()}),n},CommentUtils.getDialogOffset=function(e){var t={left:0,top:0},i=50,n=CurUtil.offset.start,o=CurUtil.offset.end,s=n.left*editor.zoomFactor,r=o.left*editor.zoomFactor,m=n.top*editor.zoomFactor,l=o.top*editor.zoomFactor,a=Z(ELEM_ID.EDITOROUTERDIV),c={top:a.scrollTop(),bottom:a.scrollTop()+a.height(),left:a.offset().left};return editor.doc.getSelection().isCollapsed()||(s-=a.offset().left,r-=a.offset().left),l+e.height()+o.rects.height<c.bottom?(t.top=l+o.rects.height,t.left=r):m-e.height()>c.top?(t.top=m-e.height(),t.left=s):(t.top=a.offset().top+a.scrollTop(),t.left=i),c.left+t.left+e.outerWidth()+i>window.innerWidth&&(t.left=window.innerWidth-e.outerWidth()-i-c.left),t},CommentUtils.showDialogInEditorPane=function(e){e.hide(),e.find(".ui-ncmt-container-div").addClass("ui-ncmt-container-cmode"),e.detach(),e.appendTo(Z(ELEM_ID.EDITOROUTERDIV));var t=CommentUtils.getDialogOffset(e);e.css({position:"absolute",left:t.left,top:t.top}),e.fadeIn(200)},CommentUtils.closeLikeModal=function(){J("#likelistview").hide(),J("#likelistoverlay").hide()},CommentUtils.showByAuthor=function(e,t){var i=t.options.zuid;CommentModels.commentPane.set("currentAuthor",i)},CommentUtils.toggleSearchBox=function(){CommentModels.commentPane.get("isShowingSearchbox")?CommentManager.views.commentPaneView.cancelSearch():CommentModels.commentPane.set("isShowingSearchbox",!0)},CommentUtils.closeSearchbox=function(){CommentManager.views.commentPaneView.cancelSearch()},CommentUtils.containsSearchTerm=function(e){var t=CommentModels.commentPane.get("searchQuery").toLowerCase().trim();if(e.get("text").toLowerCase().indexOf(t)>-1)return!0;for(var i=0;i<e.get("children").models.length;i++){var n=e.get("children").models[i];if(n.get("text").toLowerCase().indexOf(t)>-1)return!0}return!1},CommentUtils.delay=function(){var e={};return function(t,i,n){var o=e[n];clearTimeout(o),e[n]=setTimeout(t,i)}}(),CommentUtils.setVisibilityForNoResultsDiv=function(){return CommentModels.commentPane.get("currentView")===CommentModels.COMMENTVIEWS.BY_AUTHOR?void CommentManager.views.commentPaneView.$("#noresults-container").hide():void(CommentManager.views.commentCollectionView.$el.contents("div:visible").length?(CommentManager.views.commentPaneView.$("#noresults-container").hide(),CommentModels.commentPane.set("noCommentsToShow",!1)):(CommentManager.views.commentPaneView.$("#noresults-container").show(),CommentModels.commentPane.set("noCommentsToShow",!0)))},CommentUtils.getViewLabel=function(e){return COMMENTVIEWS={1:"ALL",2:"RESOLVED",3:"UNRESOLVED",4:"UNREAD",5:"UNLINKED",8:"TAGGED"},COMMENTVIEWS[e]},CommentUtils.enclosingCommentAtIndex=function(e,t){var i=CommentModels.commentIndices.filter(function(i){var n=e>=i.start&&e<=i.end+1,o=CommentModels.commentCollection.get(i.id);if(!o)return!1;var s=o.get("isResolved");return t?n:n&&!s});return i=i.length>1?i.sort(function(e,t){return e.start<t.start})[0]:i[0]},CommentUtils.triggerCommentFocus=function(e){var t=CommentModels.commentCollection.get(e);if(t)if(t.get("isRangeCharsRendered")){var i=CommentUtils.getCommentRange(e),n=editor.doc.getSelection(),o=editor.doc.createRange(i.start,i.start+1);n.setSelectionType(SEL_AUTO_GEN).removeAllRanges().addRange(o),CommentManager.focusCommentUnderCurrentSelection(editor.uuid)}else CommentManager.updateCommentFocus(t);else CommentUtils.showDeletedInfo()},CommentUtils.showDeletedInfo=function(){MsgDialog.showMessage(CONST.MSG_TYPE_ALERT,CONST.SEVERITY_WARNING,J.i18n("writer.common.COMMENT_NOT_FOUND"),J.i18n("writer.common.DELETED_COMMENTS_MSG"),null,function(e){})},CommentUtils.chunkArray=function(e,t){var i,n,o,t=t||10,s=[];for(i=0,n=e.length;i<n;i+=t)o=e.slice(i,i+t),s.push(o);return s},CommentUtils.toggleViewMenu=function(){CommentModels.commentPane.set("isShowingViewMenu",!CommentModels.commentPane.get("isShowingViewMenu"))},CommentUtils.isPartOfComment=function(e,t){var i=t.get("zuid")===e,n=ZWArrayUtils.arrayContains(t.get("likes"),e),o=t.get("children").filter(function(t){return t.get("zuid")==e}).length;return i||n||o},CommentUtils.showCommentPanel=function(){},CommentUtils.updateFollowers=function(e,t){var i=function(){NotificationSettings.states.PARTICIPATED_COMMENTS&&t.follow(!1,editor.zuid)},n={addComment:function(){NotificationSettings.states.NO_NOTIFICATION||t.follow(!1,editor.zuid)},likeComment:i,addReplyComment:i,resolveComment:i,reopenComment:i,followAllComments:function(){CommentModels.commentCollection.followAllComments(!0,editor.zuid)},unfollowAllComments:function(){CommentModels.commentCollection.unfollowAllComments(!0,editor.zuid)},followParticipatedComments:function(){var e=CommentModels.commentCollection.getRenderedComments().filter(function(e){return!ZWArrayUtils.arrayContains(e.get("followers"),editor.zuid)&&CommentUtils.isPartOfComment(editor.zuid,e)}).map(function(e){return e.id});CommentModels.commentCollection.followComments(!0,editor.zuid,e)}};n[e]&&n[e]()},CommentUtils.sendUnreadCommentDocNotificaion=function(e){var t={};t.zuid=e.get("zuid"),t.time=e.get("createdAt"),t.click=function(){CommentUtils.triggerCommentFocus(e.id)},t.text='<span class="ui-comment-notify-list-username">'+Utils.encodeHTMLString(CommentUtils.getUsername(t.zuid))+"</span> has made a comment";var i=DocNotificationManager.add(t);CommentModels.docnotificationMap[e.id]=i},CommentUtils.removeDocNotification=function(e){var t=CommentModels.docnotificationMap[e];t&&DocNotificationManager.remove(t),t&&delete CommentModels.docnotificationMap[e]},CommentUtils.showAllHighlights=function(){Object.keys(CommentHighlights.highlightMap.el).forEach(function(e){CommentHighlights.highlightMap.el[e].show()})},CommentUtils.hideAllHighlights=function(){Object.keys(CommentHighlights.highlightMap.el).forEach(function(e){CommentHighlights.highlightMap.el[e].hide()})},CommentUtils.isTaggedPerson=function(e){for(var t=!1,i=CommentUtils.getMentionedPeople(e),n=0;n<i.length;n++)if(i[n]===editorProps.userInfo.email){t=!0;break}return t},CommentUtils.getMentionedPeople=function(e){var t=[],i=CommentModels.commentCollection.get(e);return i?(t.push(CommentUtils.detectMentions(i.get("text"))),t.push(i.get("children").map(function(e){return CommentUtils.detectMentions(e.get("text"))})),ZWArrayUtils.flattenArray(t)):[]},CommentUtils.getMentionedContacts=function(e,t){var i=[],n=CommentModels.commentCollection.get(e);return n?(n.get("richtext")?i.push(CommentUtils.detectMentionsFromJSON(n.get("richtext"),t)):i.push(CommentUtils.detectMentions(n.get("text"))),i.push(n.get("children").map(function(e){return e.get("richtext")?void i.push(CommentUtils.detectMentionsFromJSON(e.get("richtext"),t)):CommentUtils.detectMentions(e.get("text"))})),ZWArrayUtils.flattenArray(i)):[]},CommentUtils.isValidZuid=function(e){return e+""!="-1"},CommentUtils.isValidContact=function(e){return e.fullname&&e.emailid&&CommentUtils.isValidZuid(e.zuid)},CommentUtils.atMentionCustomFilter=function(e,t,i,n,o){var s=6;if(e.length>=s)return i(CommentUtils.arrange(e,n,o));var r=s-e.length;Contacts.searchContacts({queryStr:t,limit:r,from:"comment-atmention",success:function(t){var t=ZWJSONUtils.mapJSON(t.contactsList,function(e){var t={};return t.emailid=e.email,t.fullname=e.fullName,t.val=e.email,t.zuid=e.zuid,t.usertype="org",t}).filter(function(e){return CommentUtils.isValidContact(e)});CommentModels.atMention.add(t),t=t.filter(function(t){for(var i=!0,n=0;n<e.length;n++){var o=e[n];if(o.emailid===t.emailid){i=!1;break}}return i}),i(CommentUtils.arrange(t.concat(e),n,o))}})},CommentUtils.arrange=function(e,t,i){var n;n=CommentModels.isRichCommentsEnabled()?CommentUtils.getMentionedContacts(t,i):CommentUtils.getMentionedPeople(t);var o=CommentModels.commentCollection.get(t),s=o&&o.get("zuid"),r=[],m=[],l=[],a=[],c=[];return ZWArrayUtils.each(e,function(e){return s===e.zuid?void l.push(e):void(ZWArrayUtils.arrayContains(n,e.emailid)?r.push(e):"shared"===e.usertype?a.push(e):"personal"===e.usertype?c.push(e):m.push(e))}),r=l.concat(r),r=r.concat(a),r=r.concat(c),r.concat(m)},CommentUtils.invalidCharsRegex=function(){var e=["\u2028","\u2029"];return new RegExp(e.join("|"),"gi")},CommentUtils.removeInvalidChars=function(e){return e.replace(CommentUtils.invalidCharsRegex(),"")},CommentUtils.isImageSegment=function(e,t){return t-e==2&&editor.doc.getCharAt(e+1)===UNICODE.IMAGE},CommentUtils.isRangeCharsPresent=function(e){return CommentModels.commentIndices.filter(function(t){return t.id===e}).length},CommentUtils.isJSONString=function(e){try{return JSON.parse(e),!0}catch(e){return!1}},CommentUtils.updateCurrentView=function(e){CommentModels.commentPane.set("currentView",parseInt(e))},CommentUtils.updateCurrentAuthor=function(e){"all"===e?CommentModels.commentPane.set("currentAuthor",!1):CommentModels.commentPane.set("currentAuthor",e)},CommentUtils.getCurrentFocusedComment=function(){return CommentManager.views.commentPaneView?CommentManager.views.commentPaneView.currentFocusedComment:null},CommentUtils.updateAuthorFilterList=function(){var e=Z("cmt-author-filter");e.zselectbox("removeAllOptions");var t=(CommentModels.commentPane.get("nosAll"),CommentModels.authors),i=J.i18n("writer.common.ALL");e.zselectbox("addOption",{label:i+"("+t.length+")",value:"all"}),t.each(function(t){var i={label:t.get("name"),value:t.get("zuid")};e.zselectbox("addOption",i)});var n=CommentModels.commentPane.get("currentAuthor");n&&CommentModels.authors.get(n)?e.zselectbox("setValue",n):(CommentModels.commentPane.set("currentAuthor",!1),e.zselectbox("setValue","all"))},CommentUtils.updateViewFilterList=function(){var e=Z("cmt-view-filter"),t=CommentModels.commentPane.get("currentAuthor");if(t&&CommentModels.authors.get(t))var i=CommentModels.authors.get(t).get("count");else var i={all:CommentModels.commentPane.get("nosAll"),resolved:CommentModels.commentPane.get("nosResolved"),unresolved:CommentModels.commentPane.get("nosUnresolved"),unread:CommentModels.commentPane.get("noOfUnreadComments"),unlinked:CommentModels.commentPane.get("nosUnlinked"),tagged:CommentModels.commentPane.get("nosTagged")};e.zselectbox("setOptionAttributes",CommentModels.COMMENTVIEWS.ALL.toString(),"label",J.i18n("common","ALL")+" ("+i.all+")"),e.zselectbox("setOptionAttributes",CommentModels.COMMENTVIEWS.ALL.toString(),"label",J.i18n("common","ALL")+" ("+i.all+")"),e.zselectbox("setOptionAttributes",CommentModels.COMMENTVIEWS.RESOLVED.toString(),"label",J.i18n("common","RESOLVED")+" ("+i.resolved+")"),e.zselectbox("setOptionAttributes",CommentModels.COMMENTVIEWS.UNRESOLVED.toString(),"label",J.i18n("common","UNRESOLVED")+" ("+i.unresolved+")"),e.zselectbox("setOptionAttributes",CommentModels.COMMENTVIEWS.UNREAD.toString(),"label",J.i18n("common","UNREAD")+" ("+i.unread+")"),e.zselectbox("setOptionAttributes",CommentModels.COMMENTVIEWS.UNLINKED.toString(),"label",J.i18n("common","UNLINKED")+" ("+i.unlinked+")"),e.zselectbox("setOptionAttributes",CommentModels.COMMENTVIEWS.TAGGED.toString(),"label",J.i18n("common","MENTIONED_ME")+" ("+i.tagged+")");var n=CommentModels.commentPane.get("currentView");e.zselectbox("setValue",n)},CommentUtils.updateFilters=function(){CommentUtils.updateAuthorFilterList(),CommentUtils.updateViewFilterList()},CommentUtils.getTitleCase=function(e){var t=e.split(" ");return titleCasedWords=t.map(function(e){return e&&e[0].toUpperCase()+(e.length>1?e.substring(1):"")}),titleCasedWords.join(" ")},CommentUtils.canResolve=function(){return editor.getRole().permissions.can("review.comment.resolve")},CommentUtils.canDelete=function(e){return e?CommentUtils.canDeleteSelf():CommentUtils.canDeleteAll()},CommentUtils.canDeleteSelf=function(){return editor.getRole().permissions.can("review.comment.deleteself")||editor.getRole().permissions.can("review.comment.deleteall")},CommentUtils.canDeleteAll=function(){return editor.getRole().permissions.can("review.comment.deleteall")},CommentUtils.canEdit=function(e){return!!e&&editor.getRole().permissions.can("review.comment.editself")},CommentUtils.canGetLink=function(){return Utils.isModuleEnabled("getCommentLink")},CommentUtils.canFollow=function(){return editor.getRole().permissions.can("review.comment.follow")&&Utils.isModuleEnabled("review.comment.follow")},zw.define("CommentQueue",[],[],function(){var e=function(){var e=new Array(2),t=[],i=new ZWConsole;this.add=function(t){e[1]?e[1]=e[1].concat(t):e[1]=t},this.push=function(e,n){if(!n)return i.log("CommentQueue: ","retryOp. directly adding to queue without considering WaitingQueue: ",e),this.add(e);if(t.length)i.log("CommentQueue: ","Already some ops are waiting in waitingQueue. So pushing to waitingQueue to maintain order."),t.push(e);else{i.log("CommentQueue: ","No ops in waitingQueue.");var o=e.filter(function(e){return"addComment"==e.action});o.length?(i.log("CommentQueue: ","addComment Op, so pushing to waitingQueue - to wait for next ackReceived event"),t.push(o)):e.length&&(i.log("CommentQueue: ","pushing to queue[1]"),this.add(e))}},this.shift=function(){var t=e[1];return e[0]=t,e[1]=void 0,i.log("CommentQueue: ","shift: ",e[0]),e[0]},this.getAckPendingEdit=function(){return e[0]},this.getPendingToPushEdit=function(){return e[1]},this.ackReceived=function(){e[0]=void 0},this.getWaitingQueue=function(){return t},this.popoutFromWaitingQueue=function(e){i.log("CommentQueue: ","popoutFromWaitingQueue called with id: ",e);for(var n=0,o=0;o<t.length;o++){var s=t[o][0],r=s&&"addComment"===s.action&&s.commentData.id!==e;if(r){i.log("CommentQueue: ","different add comment op found. should push all ops untill this index: ",o,t),n=o;break}}if(n)var m=t.splice(0,n);else{i.log("CommentQueue: ","no other add comment op found. Resetting waitingQueue");var m=t;t=[]}return ZWArrayUtils.flattenArray(m)},this.reqCount=0,this.pendingCommentEdits=e,this.logger=i};return e}),zw.define("CommentQueueSyncer",[],[],function(){var e=function(e){var t=new ZWConsole;this.init=function(e){this.queue=e,this.pendingAckComments=[],this.logger=t,this.listen()},this.listen=function(){PubSub.subscribe("MessageQueue/AckReceived",this.onEditorAckReceived.bind(this)),PubSub.subscribe("Document/ApplyStyle",this.savePendingAckComments.bind(this)),Utils.WriterCallbacks.register("getOpMeta",this.getPendingAckComments.bind(this))},this.push=function(e,i){t.log("CommentQueueSyncer: ","pushing to queue: ",e),t.log("CommentQueueSyncer: ","respectWaitingQueue: ",i),this.queue.push(e,i),this.queue.getAckPendingEdit()||(this.queue.shift(),this.sendOpToServer())},this.sendOpToServer=function(){var e=this.queue.getAckPendingEdit(),i=Deferred();if(e){t.log("CommentQueueSyncer: ","sendOpToServer called. Sending op @ queue[0] to server.",e);var n=Utils.randomString();CommentModels.opLog.push({id:n,ops:e}),ZWLogger.log("SEND COMMENT MUTATION CALLED"),ZWLogger.log("COMMENT QUEUE: \n"+JSON.stringify(this.queue.pendingCommentEdits));var o=this;this.queue.reqCount++;var i=CommentUtils.sendMessage(e).done(function(t){o.onSuccess(t,e,n)}).fail(function(t){o.onError(t,e,n)});return i}},this.processAck=function(){this.queue.ackReceived(),this.queue.reqCount=0,this.queue.getPendingToPushEdit()&&(this.queue.shift(),this.sendOpToServer())},this.onSuccess=function(e,i,n){"SUCCESS"==e.RESPONSE?(t.log("CommentQueueSyncer: ","Successfully sent ops to server",i,e),ZWLogger.log("COMMENT OP SUCCEEDED. CHECKING IF SYNC SHOULD BE DONE."),CommentUtils.getSequenceDiff(e.comment_sequence_number)==i.length?(CommentModels.setSequenceNumber(e.comment_sequence_number),this.processAck()):CommentUtils.syncup(this.processAck.bind(this)),CommentModels.opLog.markSuccess(n,e),CommentModelManager.onOpSuccess(i)):(t.log("CommentQueueSyncer: ","Server cannot save these ops: ",i,e),CommentModels.opLog.markFailure(n,e,CommentModels.COMMENT_SERVER_DATA_MISSING_ERROR),this.processAck(),ZWLogger.log("COMMENT OP FAILED. CHECK SERVER LOGS."),CommentUtils.sendLogEmail({action:"commentop",info:{ops:i,serverResponse:e},errNo:e.ERR_CODE||CommentModels.COMMENT_SERVER_DATA_MISSING_ERROR}))},this.onError=function(e,i,n){t.log("CommentQueueSyncer: ","Network error on sending comment op: ",i,e),ZWLogger.log("COMMENT OP FAILED BY REQUEST FAILURE."),CommentUtils.isJSONString(e.responseText)?(CommentModels.opLog.markFailure(n,e,CommentModels.COMMENT_SERVER_DATA_MISSING_ERROR),this.processAck(),ZWLogger.log("COMMENT OP FAILED. CHECK SERVER LOGS."),CommentUtils.sendLogEmail({action:"commentop",info:{ops:i,serverResponse:e},errNo:CommentModels.COMMENT_SERVER_DATA_MISSING_ERROR})):this.queue.reqCount<=CommentModels.MAX_RETRY_COUNT?(ZWLogger.log("RESENDING REQUEST. COUNT: ",this.queue.reqCount+1),t.log("CommentQueueSyncer: ","Network failure without reaching server. Retrying...",i,e),CommentModels.opLog.remove(n),this.sendOpToServer()):(t.log("CommentQueueSyncer: ","Failed to save ops in server. Marking the ops as failed and popping them out of queue: ",i,e),CommentModels.opLog.markFailure(n,e,CommentModels.COMMENT_REQUEST_FAILURE_ERROR),this.processAck(),CommentUtils.sendLogEmail({action:"commentop",info:{ops:i,serverResp:e},errNo:CommentModels.COMMENT_REQUEST_FAILURE_ERROR}))},this.onEditorAckReceived=function(e){t.log("CommentQueueSyncer: ","EditorAckReceived. checking if any comment range-char ops are sent in this update",e.commentIds);var i=e.commentIds,n=[];ZWArrayUtils.each(i,function(e){var t=this.queue.popoutFromWaitingQueue(e);n=n.concat(t)},this),t.log("CommentQueueSyncer: ","to-send comment ops: ",n),n.length&&this.push(n,!1)},this.savePendingAckComments=function(e){e.styles.begin.type!==NODE_TYPE.COMMENT||ZWArrayUtils.arrayContains(this.pendingAckComments,e.styles.begin.id)||(t.log("CommentQueueSyncer: ","ApplyTo: some comment op has been detected. Pushing it to CommentQueueSyncer.pendingAckComments list",e.styles.begin,this.pendingAckComments),this.pendingAckComments.push(e.styles.begin.id))},this.getPendingAckComments=function(){t.log("CommentQueueSyncer: ","Editor MsgQueue is requesting pendingAckComments: ",this.pendingAckComments);var e=this.pendingAckComments;return this.pendingAckComments=[],{commentIds:e}},this.init(e)};return e}),CommentModels=function(e,t,i){var n={ALL:1,RESOLVED:2,UNRESOLVED:3,UNREAD:4,UNLINKED:5,BY_AUTHOR:6,BY_DATE:7,TAGGED:8},o={REPLY_ADD:1,RESOLVE:2,REOPEN:3,DELETE:4,REPLY_DELETE:5,EDIT:6,REPLY_EDIT:7,LIKE:8,REPLY_LIKE:9,UNLIKE:10,REPLY_UNLIKE:11},s=/@([\w\.\+-]+)@([\w-]+)\.([a-zA-Z\.]{2,22}(\.[a-zA-Z]{2}){0,2})/g,r=/(^|\s)((http|ftp|https|www\.)(:\/\/|)[\w-]+(\.[\w-]+)+([\w.,@?^=\(\)%&amp;:\/~+#-]*[\w@?^\(\)=%&amp;\/~+#-])?)($|\s)/g,m="CCE_101",l="CCE_102",a="CCE_103",c="CCE_104",d="CCE_105",u="CCE_106",h="CCE_107",C=15,g=!1,p=3,f=e.Model.extend({constructor:function(t){defaults={id:"zw"+Utils.randomString(),createdAt:(new Date).getTime(),zuid:editor.zuid,activityLog:new v,text:null,doctext:null,children:new E,parentId:null,isResolved:!1,contentUpdatedAt:(new Date).getTime(),version:editor.doc.docInfo.VERSION,likes:[],followers:[],reads:[],inFocus:!1,inEditingMode:!1,isRangeCharsRendered:!1,focusedFrom:null,unread:!1,isShowingMenu:!1,inDisplay:!0,syncing:!1,failedOps:[],parentComment:null},z()&&(defaults.richtext=null),t=extend(defaults,t),e.Model.apply(this,arguments),this.listenTo(this,"addComment addReplyComment likeComment resolveComment reopenComment",function(e,t,i,n){t&&CommentUtils.updateFollowers(e,this)}),this.listenTo(this,"change:unread",this.updateDocNotification),this.listenTo(this.get("activityLog"),"add",this.bubbleUp)},addReplyComment:function(e,t,i){var i=i||"zw"+Utils.randomString();this.get("children").push(e),e.set("parentComment",this),this.addToActivityLog({activityId:i,action:o.REPLY_ADD,commentId:e.id}),t&&(this.sendReplyCommentToBuffer(e,i),e.set("syncing",!0)),this.trigger("addReplyComment","addReplyComment",t,e)},editReplyComment:function(e,t,i,n,s){var r=r||"zw"+Utils.randomString(),m=e.get("text"),l=e.get("contentUpdatedAt");z()&&e.set("richtext",i),e.set("text",t,{silent:!0}),e.trigger("change:text",e,e.get("text")),e.addToActivityLog({activityId:r,action:o.EDIT,oldText:m,oldTime:l}),this.addToActivityLog({activityId:r,action:o.REPLY_EDIT,commentId:e.id}),n&&(this.sendReplyEditToBuffer(e,t,i,r),e.set("syncing",!0)),this.trigger("editReplyComment","editReplyComment",n,e)},removeReplyComment:function(e,t,i){var i=i||"zw"+Utils.randomString();this.get("children").remove(e),this.addToActivityLog({activityId:i,action:o.REPLY_DELETE,commentId:e.id}),t&&this.sendReplyDeleteToBuffer(e,i),this.trigger("removeReplyComment","removeReplyComment",t,e)},edit:function(e,t,i,n){var n=n||"zw"+Utils.randomString(),s=this.get("text"),r=this.get("contentUpdatedAt");z()&&this.set("richtext",t),this.set("text",e,{silent:!0}),this.trigger("change:text",this,this.get("text")),this.addToActivityLog({activityId:n,action:o.EDIT,oldText:s,oldTime:r}),i?(this.sendEditToBuffer(e,t,n),this.set("syncing",!0)):this.set("reads",[this.get("zuid")],{dontSendDocNotification:!0})},resolve:function(e,t,i,n,s){var n=n||"zw"+Utils.randomString();this.addToActivityLog({activityId:n,action:o.RESOLVE,zuid:t||editor.zuid,time:i||(new Date).getTime()}),this.set("isResolved",!0),e&&(s||(this.sendResolveToBuffer(n),this.set("syncing",!0))),this.trigger("resolveComment","resolveComment",e,this)},reopen:function(e,t,i,n){n=n||"zw"+Utils.randomString(),this.addToActivityLog({activityId:n,action:o.REOPEN,zuid:t||editor.zuid,time:i||(new Date).getTime()}),this.set("isResolved",!1),e&&(this.sendReopenToBuffer(n),this.set("syncing",!0)),this.trigger("reopenComment","reopenComment",e,this)},follow:function(e,t,i){t=t||editor.zuid,i=i||"zw"+Utils.randomString();var n=JSON.parse(JSON.stringify(this.get("followers")));n.push(t),this.set("followers",n),e&&this.sendFollowToBuffer(i)},unfollow:function(e,t,i){t=t||editor.zuid,i=i||"zw"+Utils.randomString();var n=JSON.parse(JSON.stringify(this.get("followers")));n=n.filter(function(e){return e!=t}),this.set("followers",n),e&&this.sendUnfollowToBuffer(i)},read:function(e,t){if(e=e||editor.zuid,t=t||"zw"+Utils.randomString(),ZWArrayUtils.arrayContains(this.get("reads"),e)){if(this.isAnyChildUnread(e)){var i=this.get("children").filter(function(t){return!ZWArrayUtils.arrayContains(t.get("reads"),e)}).map(function(e){return e.id});this.get("children").read(i,e),CommentModels.commentCollection.markRead([this.id],t)}}else this.get("reads").push(e),this.trigger("change:reads",this,this.get("reads")),CommentModels.commentCollection.markRead([this.id],t)},unread:function(e,t){if(e=e||editor.zuid,t=t||"zw"+Utils.randomString(),!ZWArrayUtils.arrayContains(this.get("reads"),e))return!1;var i=this.get("reads").filter(function(t){return e!=t});this.set("reads",i,{dontSendDocNotification:!0}),CommentModels.commentCollection.markUnread([this.id],t)},like:function(e,t,i,n){t=t||editor.zuid,i=i||(new Date).getTime(),n=n||"zw"+Utils.randomString();var o=JSON.parse(JSON.stringify(this.get("likes")));!ZWArrayUtils.arrayContains(o,t)&&o.push(t),this.set("likes",o),e&&(this.sendLikeToBuffer(n),this.set("syncing",!0)),this.trigger("likeComment","likeComment",e,this,t)},unlike:function(e,t,i,n){t=t||editor.zuid,i=i||(new Date).getTime(),n=n||"zw"+Utils.randomString();var o=JSON.parse(JSON.stringify(this.get("likes")));o=o.filter(function(e){return e!=t}),this.set("likes",o),e&&(this.sendUnlikeToBuffer(n),this.set("syncing",!0)),this.trigger("unlikeComment","unlikeComment",e,this,t)},setVisibility:function(e,t,i){this.set("visibility",e);var i=i||"zw"+Utils.randomString();t&&(this.sendVisibilityEditToBuffer(i),this.set("syncing",!0))},isAnyChildUnread:function(){for(var e=0;e<this.get("children").length;e++){var t=this.get("children").models[e];if(!ZWArrayUtils.arrayContains(t.get("reads"),editor.zuid))return!0}return!1},sendReplyCommentToBuffer:function(e,t){var i={},n=editor.doc.docInfo;i.action="addReplyComment",i.rid=n.RID,i.sid=editor.uuid,i.commentData=CommentUtils.getCoreData(e.json()),i.commentData.children={},i.commentData.activityId=t,CommentUtils.sendOp([i])},sendReplyEditToBuffer:function(e,t,i,n){var o={},s=editor.doc.docInfo;o.action="updateReplyComment",o.rid=s.RID,o.sid=editor.uuid,o.commentData={},o.commentData.id=e.id,o.commentData.parentId=this.id,o.commentData.text=t,z()&&(o.commentData.richtext=i),o.commentData.activityId=n,CommentUtils.sendOp([o])},sendReplyDeleteToBuffer:function(e,t){var i={},n=editor.doc.docInfo;i.action="deleteReplyComment",i.rid=n.RID,i.sid=editor.uuid,i.commentData={},i.commentData.id=e.id,i.commentData.parentId=this.id,i.commentData.activityId=t,CommentUtils.sendOp([i])},sendEditToBuffer:function(e,t,i){var n={},o=editor.doc.docInfo;n.action="updateComment",n.rid=o.RID,n.sid=editor.uuid,n.commentData={},n.commentData.id=this.id,n.commentData.text=e,n.commentData.activityId=i,z()&&(n.commentData.richtext=t),CommentUtils.sendOp([n])},sendResolveToBuffer:function(e){var t={},i=editor.doc.docInfo;t.action="resolveComment",t.rid=i.RID,t.sid=editor.uuid,t.commentData={},t.commentData.id=this.id,t.commentData.activityId=e,CommentUtils.sendOp([t])},sendReopenToBuffer:function(e){var t={},i=editor.doc.docInfo;t.action="reopenComment",t.rid=i.RID,t.sid=editor.uuid,t.commentData={},t.commentData.id=this.id,t.commentData.activityId=e,CommentUtils.sendOp([t])},sendLikeToBuffer:function(e){var t={},i=editor.doc.docInfo;t.action=this.get("parentId")?"likeReplyComment":"likeComment",t.rid=i.RID,t.sid=editor.uuid,t.commentData={},t.commentData.id=this.id,t.commentData.activityId=e,this.get("parentId")&&(t.commentData.parentId=this.get("parentId")),CommentUtils.sendOp([t])},sendUnlikeToBuffer:function(e){var t={},i=editor.doc.docInfo;t.action=this.get("parentId")?"unlikeReplyComment":"unlikeComment",t.rid=i.RID,t.sid=editor.uuid,t.commentData={},t.commentData.id=this.id,t.commentData.activityId=e,this.get("parentId")&&(t.commentData.parentId=this.get("parentId")),CommentUtils.sendOp([t])},sendFollowToBuffer:function(e){var t={},i=editor.doc.docInfo;t.action="followComment",t.rid=i.RID,t.sid=editor.uuid,t.commentData={},t.commentData.idList=[this.id],t.commentData.activityId=e,CommentUtils.sendOp([t])},sendUnfollowToBuffer:function(e){var t={},i=editor.doc.docInfo;t.action="unfollowComment",t.rid=i.RID,t.sid=editor.uuid,t.commentData={},t.commentData.idList=[this.id],t.commentData.activityId=e,CommentUtils.sendOp([t])},sendVisibilityEditToBuffer:function(e){var t={},i=editor.doc.docInfo;t.action="setVisibility",t.rid=i.RID,t.sid=editor.uuid,t.commentData={},t.commentData.id=this.id,t.commentData.activityId=e,t.commentData.visibility=this.get("visibility"),CommentUtils.sendOp([t])},receiveReplyCommentFromCollaborators:function(e){var t=e.activityId;delete e.activityId;var i=CommentModels.CommentCollection.createComment(CommentUtils.refineCommentJSON(e));this.addReplyComment(i,!1,t)},receiveReplyEditFromCollaborators:function(e){var t=e.activityId,i=this.get("children").get(e.id);this.editReplyComment(i,e.text,e.richtext,!1,t)},receiveReplyDeleteFromCollaborators:function(e){var t=e.activityId,i=this.get("children").get(e.id);this.removeReplyComment(i,!1,t)},receiveEditFromCollaborators:function(e,t){this.edit(e,!1,t)},json:function(){var e=this.toJSON();return e.activityLog=e.activityLog.map(function(e){return e.toJSON()}),e.children=e.children.map(function(e){return e.json()}),delete e.parentComment,e},addToActivityLog:function(e){e.time||(e.time=(new Date).getTime()),this.get("activityLog").push(e),e.action===o.EDIT&&this.set("contentUpdatedAt",e.time)},bubbleUp:function(e){this.collection&&this.collection.trigger("add:activityLog",this,e)},updateDocNotification:function(e,t,i){return!(e.get("parentId")||isV8Engine||isHeadlessPDF)&&void(t?i.dontSendDocNotification||CommentUtils.sendUnreadCommentDocNotificaion(e):CommentUtils.removeDocNotification(e.id))},getVisibility:function(){return this.get("visibility")}}),v=e.Collection.extend({initialize:function(e){this.sortkey="time"},comparator:function(e,t){return t.get(this.sortkey)<e.get(this.sortkey)?1:-1}}),E=e.Collection.extend({model:f,initialize:function(e){this.listenTo(this,"change:reads remove add",this.updateUnreadCommentCount),this.listenTo(this,"remove",this.addToDeleteCache)},addToDeleteCache:function(e,t,i){CommentModels.opLog.deletedComments.push(e.json())},updateUnreadCommentCount:function(e,t,i){return!(e&&e.get("parentId")||CommentModels.commentPane.get("isLoading"))&&(noOfUnreadComments=this.getRenderedComments().filter(function(e){return ZWArrayUtils.arrayContains(e.get("reads"),editor.zuid)?(e.set("unread",!1,i),!1):(e.set("unread",!0,i),!0)}).length,void CommentModels.commentPane.set("noOfUnreadComments",noOfUnreadComments))},renderComment:function(e){var t=this.get(e);t&&t.set({isRangeCharsRendered:!0})},getComment:function(e){var t=this.get(e);if(!t)throw new Error("The comment cannot be found, for id: "+e);return t},getReplyComment:function(e,t){var i=this.getComment(e),n=i.get("children").get(t);if(!n)throw new Error("Reply comment cannot be found, for id: "+t+" parent-id: "+e);return n},addComment:function(e,t,i,n){t&&i&&n&&(editor.lastOperation="addComment",this.insertRangeChars(e.id,i,n),this.sendCommentToBuffer(e),editor.getDocument().sync(),e.set("syncing",!0)),CommentUtils.getCommentRange(e.id)&&e.set("isRangeCharsRendered",!0),this.add(e),e.trigger("addComment","addComment",t,e)},removeComment:function(e,t,i,n){i=i||"zw"+Utils.randomString(),this.remove(e),t&&(editor.lastOperation="removeComment",this.removeRangeChars(e.id),n||(this.sendDeleteToBuffer(e,i,n),editor.getDocument().sync()))},removeAllComments:function(e,t,i){var n=this;i=i||"zw"+Utils.randomString(),ZWArrayUtils.each(t,function(t){var o=n.get(t);o&&n.removeComment(o,e,i,!0)}),e&&(this.sendDeleteAllToBuffer(t,i),Op.sendMsg())},resolveAllComments:function(e,t,i,n,o){var s=this;o=o||"zw"+Utils.randomString(),ZWArrayUtils.each(n,function(n){var r=s.get(n);r&&r.resolve(e,t,i,o,!0)}),e&&this.sendResolveAllToBuffer(n,o)},followAllComments:function(e,t,i){i=i||"zw"+Utils.randomString(),t=t||editor.zuid,this.getRenderedComments().filter(function(e){return!ZWArrayUtils.arrayContains(e.get("followers"),t)}).map(function(e){return e.follow(!1,t,i),e.id}),e&&this.getRenderedComments().length&&this.sendFollowCommentsToBuffer("followAllComments",[],i)},unfollowAllComments:function(e,t,i){i=i||"zw"+Utils.randomString(),t=t||editor.zuid,this.getRenderedComments().filter(function(e){return ZWArrayUtils.arrayContains(e.get("followers"),t)}).map(function(e){return e.unfollow(!1,t,i),e.id}),e&&this.getRenderedComments().length&&this.sendFollowCommentsToBuffer("unfollowAllComments",[],i)},followComments:function(e,t,i,n,o){n=n||"zw"+Utils.randomString(),t=t||editor.zuid;var s=i.filter(function(e){return this.get(e)&&this.get(e).follow(!1,t,n),this.get(e)},this);e&&s.length&&this.sendFollowCommentsToBuffer("followComment",s,n,o)},unfollowComments:function(e,t,i,n,o){n=n||"zw"+Utils.randomString(),t=t||editor.zuid;var s=i.filter(function(e){return this.get(e)&&this.get(e).unfollow(!1,t,n),this.get(e)},this);e&&s.length&&this.sendFollowCommentsToBuffer("unfollowComment",s,n,o)},sendFollowCommentsToBuffer:function(e,t,i,n){var o={},s=editor.doc.docInfo;o.action=e,o.rid=s.RID,o.sid=editor.uuid,o.commentData={},o.commentData.idList=t,o.commentData.activityId=i,CommentUtils.sendOp([o])},insertRangeChars:function(e,t,i){t=0===t?1:t,editor.doc.getSelection().isCollapsed()||editor.doc.getCharAt(i-1)!=UNICODE.PARA||i--;var n=editor.getDocument().createRange();n.start=t,n.end=i,n.createComment(e)},removeRangeChars:function(e){var t=CommentUtils.getCommentRange(e);return!!t&&void editor.getDocument().removeComment(e)},sendCommentToBuffer:function(e){var t={},i=editor.doc.docInfo;t.action="addComment",t.rid=i.RID,t.sid=editor.uuid,t.commentData=CommentUtils.getCoreData(e.json()),t.commentData.children={},CommentUtils.sendOp([t])},sendDeleteToBuffer:function(e,t,i){var n=CommentUtils.constructDeleteOp(e);n.activityId=t,i||CommentUtils.sendOp([n])},sendDeleteAllToBuffer:function(e,t){var i={},n=editor.doc.docInfo;i.action="deleteAllComments",i.rid=n.RID,i.sid=editor.uuid,i.commentData={},i.commentData.activityId=t,i.commentData.idList=e,CommentUtils.sendOp([i])},sendResolveAllToBuffer:function(e,t){var i={},n=editor.doc.docInfo;i.action="resolveAllComments",i.rid=n.RID,i.sid=editor.uuid,i.commentData={},i.commentData.activityId=t,i.commentData.idList=e,CommentUtils.sendOp([i])},read:function(e,t){t=t||editor.zuid,ZWArrayUtils.each(e,function(e){var i=this.get(e);ZWArrayUtils.arrayContains(i.get("reads"),t)||i.get("reads").push(t)},this),this.updateUnreadCommentCount()},unread:function(e,t,i){t=t||editor.zuid,ZWArrayUtils.each(e,function(e){var i=CommentModels.commentCollection.get(e);if(!ZWArrayUtils.arrayContains(i.get("reads"),t))return!1;var n=i.get("reads").filter(function(e){return t!=e});i.set("reads",n,{dontSendDocNotification:!0,silent:!0})}),this.updateUnreadCommentCount()},markRead:function(e,t){t=t||"zw"+Utils.randomString();var i={},n=editor.doc.docInfo;i.action="markRead",i.rid=n.RID,i.sid=editor.uuid,i.commentData={},i.commentData.activityId=t,i.commentData.idList=e,e.length&&CommentUtils.sendOp([i])},markUnread:function(e,t){t=t||"zw"+Utils.randomString();var i={},n=editor.doc.docInfo;i.action="markUnread",i.rid=n.RID,i.sid=editor.uuid,i.commentData={},i.commentData.activityId=t,i.commentData.idList=e,e.length&&CommentUtils.sendOp([i])},receiveAddCommentFromCollaborators:function(e){var t=CommentUtils.refineCommentJSON(e);commentObj=CommentModels.CommentCollection.createComment(t),this.addComment(commentObj,!1)},receiveDeleteCommentFromCollaborators:function(e){var t=this.get(e.id);this.removeComment(t,!1,e.activityId)},getRenderedComments:function(){return this.models},getCommentsWithRangeChars:function(){return this.filter(function(e){return CommentUtils.getCommentRange(e.id)})},getUnresolvedComments:function(){return this.getRenderedComments().filter(function(e){return!e.get("isResolved")})},isCommentRendered:function(e){return this.get(e)},getParent:function(e){return this.get(e)?this.get(e):this.filter(function(t){return t.get("children").get(e)})[0]},json:function(){var e=this.map(function(e){return e.json()});return e},getCount:function(){var e=CommentModels.CommentCollection.getCountStruct(),t={};return ZWArrayUtils.each(this.getRenderedComments(),function(i){t[i.get("zuid")]=t[i.get("zuid")]||CommentModels.CommentCollection.getCountStruct();var n=t[i.get("zuid")];e.all++,n.all++,!i.get("isResolved")&&(e.unresolved++,n.unresolved++),i.get("isResolved")&&(e.resolved++,n.resolved++),i.get("unread")&&(e.unread++,n.unread++),CommentUtils.isTaggedPerson(i.get("id"))&&(e.tagged++,n.tagged++),!CommentUtils.getCommentRange(i.get("id"))&&(e.unlinked++,n.unlinked++)}),{total:e,authors:t}},applyViewFilter:function(e){var t=CommentModels.commentPane.get("currentView");return e.filter(function(e){return t===CommentModels.COMMENTVIEWS.ALL||(t===CommentModels.COMMENTVIEWS.UNREAD?e.get("unread"):t===CommentModels.COMMENTVIEWS.RESOLVED?e.get("isResolved"):t===CommentModels.COMMENTVIEWS.UNRESOLVED?!e.get("isResolved"):t===CommentModels.COMMENTVIEWS.UNLINKED?!CommentUtils.getCommentRange(e.get("id")):t===CommentModels.COMMENTVIEWS.TAGGED?CommentUtils.isTaggedPerson(e.get("id")):void 0)})},applyAuthorFilter:function(e){var t=CommentModels.commentPane.get("currentAuthor");return e.filter(function(e){return!t||e.get("zuid")===t})},applySearchFilter:function(e){return CommentModels.commentPane.get("searchQuery").trim()?e.filter(function(e){return CommentUtils.containsSearchTerm(e)}):e}},{createComment:function(e){var t=e.activityLog||[],i=e.children||[];delete e.activityLog,delete e.children;var n=new f(e);return ZWArrayUtils.each(t,function(e){n.get("activityLog").add(e)}),ZWArrayUtils.each(i,function(e){var t=CommentModels.CommentCollection.createComment(e);t.set("parentComment",n),n.get("children").push(t)},this),n},getCountStruct:function(){return{all:0,resolved:0,unresolved:0,unread:0,unlinked:0,tagged:0}}}),y=e.Model.extend({defaults:{VIEWS:n,currentView:n.UNRESOLVED,currentAuthor:!1,noOfUnreadComments:0,show:!1,searchQuery:"",isShowingSearchbox:!1,order:new e.Collection,VIEW_NAME_MAP:{1:"All",2:"Resolved",3:"Unresolved",4:"Unread",5:"Unlinked",8:"Tagged"},nosAll:0,nosResolved:0,nosUnresolved:0,nosUnlinked:0,nosTagged:0,commentCreationDialogShow:!1,freeze:!1,noCommentsToShow:!0,isShowingViewMenu:!0,isLoading:!1,isReadOnly:!1},updateNoCommentsToShow:function(){var e,t=CommentModels.commentCollection.getCount(),i=CommentModels.commentPane.get("currentView"),n=CommentModels.commentPane.get("currentAuthor"),o=CommentModels.commentPane.get("VIEW_NAME_MAP");i=o[i].toLowerCase(),e=n&&t.authors[n]?t.authors[n][i]:t.total[i];var s=!e;CommentModels.commentPane.set("noCommentsToShow",s)}}),w=(e.Model.extend({defaults:{display:!0}}),e.Collection.extend({ignoreTypes:["markUnread","markRead","followComment","unfollowComment","followAllComments","unfollowAllComments"],bulkOps:["resolveAllComments","deleteAllComments"],replyCommentOps:["addReplyComment","editReplyComment","likeReplyComment","unlikeReplyComment","updateReplyComment"],deleteOps:["deleteComment","deleteReplyComment"],deletedComments:[],getDeletedCommentById:function(e){return this.deletedComments.filter(function(t){return t.id===e})[0]},getCommentByError:function(e){if(!ZWArrayUtils.arrayContains(this.bulkOps,e.action)){if(ZWArrayUtils.arrayContains(this.deleteOps,e.action)){var t=this.getDeletedCommentById(e.commentData.id);return t}if(ZWArrayUtils.arrayContains(this.replyCommentOps,e.action)){var i=e.commentData.parentId,n=CommentModels.commentCollection.get(i);if(!n)return;return n.get("children").get(e.commentData.id).json()}var o=CommentModels.commentCollection.get(e.commentData.id);return o&&o.json()}},markSuccess:function(e){var t=this.get(e).toJSON();this.remove(e);var i=this,n=t.ops.filter(function(e){return ZWArrayUtils.arrayContains(i.deleteOps,e.action)}).map(function(e){return e.commentData.id});this.deletedComments=this.deletedComments.filter(function(e){return!ZWArrayUtils.arrayContains(n,e.id)})},getCommentByOp:function(e){if(e.comment&&!ZWArrayUtils.arrayContains(this.deleteOps,e.op.action)){if(ZWArrayUtils.arrayContains(this.replyCommentOps,e.op.action)){var t=CommentModels.commentCollection.get(e.comment.parentId),i=t.get("children").get(e.comment.id);return i}var i=CommentModels.commentCollection.get(e.comment.id);return i}},setCommentError:function(e){var t=this.getCommentByOp(e);if(t){var i=t.get("failedOps").slice();i.push(JSON.parse(JSON.stringify(e))),t.set("failedOps",i),t.set("syncing",!1)}},markFailure:function(e,t,i){var n=this.get(e).toJSON(),o=this,s=n.ops.filter(function(e){return!ZWArrayUtils.arrayContains(o.ignoreTypes,e.action)}).map(function(e){return{id:Utils.randomString(),op:e,serverResp:t,errCode:i,comment:o.getCommentByError(e)}});CommentModels.failedOps.push(s),this.remove(e),ZWArrayUtils.each(s,this.setCommentError.bind(this),this)}})),b=e.Collection.extend({initialize:function(){this.listenTo(this,"remove",this.onRemove),this.listenTo(this,"reset",this.onReset)},onRemove:function(e,t,i){var e=e.toJSON(),n=CommentModels.opLog.getCommentByOp(e);n&&n.set("failedOps",[])},onReset:function(e,t){var i=t.previousModels;ZWArrayUtils.each(i,this.onRemove,this)},retryAll:function(){var e=this.toJSON(),t=e.map(function(e){return e.op});this.reset(),CommentUtils.sendOp(t,!0)},retry:function(e){var t=this.get(e);this.remove(e),CommentUtils.sendOp([t.get("op")],!0)},retryMutliple:function(e){var t=e.map(function(e){var t=this.get(e).toJSON();return t.op},this);ZWArrayUtils.each(e,function(e){this.remove(e)},this),CommentUtils.sendOp(t,!0)}}),R=new E,M=new y,O=new b,U=new w,T=!0,S={isLoaded:!1,contacts:[],enabled:function(){return Utils.isModuleEnabled("review.comment.mention")&&editor.getRole().permissions.can("review.comment.mention")},add:function(e){var t={};ZWArrayUtils.each(CommentModels.atMention.contacts,function(e){t[e.emailid]=e}),e=e.filter(function(e){return!t[e.emailid]}),Array.prototype.push.apply(CommentModels.atMention.contacts,e)}},D={},I=[],V={start:null,end:null},A=function(){M.set("currentAuthor",!1,{silent:!0}),R.reset(),CommentModels.commentIndices=[]},L=function(e){return!!CommentUtils.shouldLoadComments()&&void x(e)},x=function(e){var t=[],i=[];for(var n in e){var o=e[n];o=CommentUtils.refineCommentJSON(o),o.deleted||i.push(o)}var s=unread=all=unlinked=tagged=0,r={};ZWArrayUtils.each(i,function(e,i){var n=E.createComment(e);t.push(n);var o=e.zuid;r[o]=r[o]||{resolved:0,unresolved:0,unread:0,all:0,unlinked:0,tagged:0},!CommentUtils.getCommentRange(e.id)&&unlinked++&&r[o].unlinked++,e.isResolved&&s++&&r[o].resolved++,!e.isResolved&&r[o].unresolved++,!ZWArrayUtils.arrayContains(e.reads,editor.zuid)&&unread++&&r[o].unread++,all++&&r[o].all++,CommentModelManager.isLinkedComment(n.id)&&n.set({isRangeCharsRendered:!0})}),ZWArrayUtils.each(t,function(e){R.add(e)}),CommentModels.commentPane.set("nosAll",all),CommentModels.commentPane.set("nosResolved",s),CommentModels.commentPane.set("nosUnresolved",all-s),CommentModels.commentPane.set("noOfUnreadComments",unread),CommentModels.commentPane.set("nosUnlinked",unlinked),CommentModels.commentPane.set("nosTagged",tagged),CommentModels.authors.reset(Object.keys(r).map(function(e){var t=r[e];return{id:e,zuid:e,name:CommentUtils.getUsername(e),count:t}}));var m=editor.getView()===EDITOR_VIEWS.HISTORY||editor.isOffline();CommentModels.commentPane.set("isReadOnly",m)},P=new t,N=new i(P),k=0,$=function(e){k=e},_=function(){return k},j=null,F=new e.Collection,H={},z=function(){return!0},W={_visibility:null,get:function(){return this._visibility},set:function(e){this._visibility=e}},Z=function(e){e&&W.set(e),CommentUtils.loadCommentIndices(),editor.commentCont&&($(editor.commentCont.comment_sequence_number),L(editor.commentCont.comments),Utils.WriterCallbacks.register("unload",J))},J=function(){return!P.getAckPendingEdit()&&!P.getPendingToPushEdit()},B=function(e){var t=e.get("failedOps").length>0,i=!1;if(!t)return i;var n=e.get("failedOps");return n.forEach(function(t){e.get("parentId")?"addReplyComment"===t.op.action&&(i=!0):"addComment"===t.op.action&&(i=!0)},this),i};return{CommentObj:f,CommentPane:y,CommentCollection:E,commentCollection:R,commentPane:M,EMAIL_REGEX:s,URL_REGEX:r,COMMENTVIEWS:n,COMMENT_REQUEST_FAILURE_ERROR:m,COMMENT_SERVER_DATA_MISSING_ERROR:l,COMMENT_COLLABORATION_HANDLING_ERROR:a,COMMENT_SYNC_ERROR:c,COMMENT_SYNC_OP_MISSING_ERROR:d,COMMENT_CLIENT_DATA_MISSING_ERROR:u,SHOULD_HIGHLIGHT_RESOLVED_COMMENTS:g,MAX_RETRY_COUNT:p,RICH_COMMENT_INVALID_JSON:h,updateCommentFocus:T,atMention:S,ACTIVITYLOG:o,cursorSelection:V,highlightNodes:D,commentIndices:I,reset:A,queue:P,queueSyncer:N,getSequenceNumber:_,setSequenceNumber:$,lastError:j,EDITORPANE_HORIZONTALSCROLLBAR_HEIGHT:C,authors:F,docnotificationMap:H,loadModels:L,constructCommentCollection:x,opLog:U,failedOps:O,init:Z,isRichCommentsEnabled:z,isAllCommentsPosted:J,isCommentHasAdditionErrors:B,visibilitySettings:W}}(Backbone,CommentQueue,CommentQueueSyncer),zw.define("CommentModelManager",[],["CommentModels","PubSub"],function(e,t){var i=function(e,t){if(e.SESSIONID==editor.uuid)return 0;if(CommentUtils.getSequenceDiff(e.comment_sequence_number)<=0)return 0;for(var i=CommentModels.getSequenceNumber()+1;i<=e.comment_sequence_number;i++){var o=e.comment[i];if(!o){ZWLogger.log("Expected sequence of op is missing, while recieving collaborator's comment ops. Calling comment sync..."),CommentUtils.syncup();break}n(o,t,i)}},n=function(t,i,n){try{switch(CommentModels.setSequenceNumber(n),t.action){case"addComment":e.commentCollection.receiveAddCommentFromCollaborators(t.commentData);break;case"deleteComment":if(!e.commentCollection.get(t.commentData.id))return!1;e.commentCollection.receiveDeleteCommentFromCollaborators(t.commentData);break;case"updateComment":var o=e.commentCollection.get(t.commentData.id);if(!o)return!1;o.edit(t.commentData.text,t.commentData.richtext,!1,t.commentData.activityId);break;case"resolveComment":var o=e.commentCollection.get(t.commentData.id);if(!o)return!1;o.resolve(!1,i,t.commentData.time,t.commentData.activityId);break;case"reopenComment":var o=e.commentCollection.get(t.commentData.id);if(!o)return!1;o.reopen(!1,i,t.commentData.time,t.commentData.activityId);break;case"addReplyComment":var o=e.commentCollection.get(t.commentData.parentId);if(!o)return!1;o.receiveReplyCommentFromCollaborators(t.commentData);break;case"deleteReplyComment":var o=e.commentCollection.get(t.commentData.parentId);if(!o)return!1;if(!o.get("children").get(t.commentData.id))return!1;o.receiveReplyDeleteFromCollaborators(t.commentData);break;case"updateReplyComment":var o=e.commentCollection.get(t.commentData.parentId);if(!o)return!1;if(!o.get("children").get(t.commentData.id))return!1;o.receiveReplyEditFromCollaborators(t.commentData);break;case"deleteAllComments":e.commentCollection.removeAllComments(!1,t.commentData.idList,t.commentData.activityId);break;case"resolveAllComments":e.commentCollection.resolveAllComments(!1,i,t.commentData.time,t.commentData.idList,t.commentData.activityId);break;case"likeComment":var o=e.commentCollection.get(t.commentData.id);if(!o)return!1;o.like(!1,i,t.commentData.activityId);break;case"likeReplyComment":var o=e.commentCollection.get(t.commentData.parentId);if(!o)return!1;var s=o.get("children").get(t.commentData.id);if(!s)return!1;s.like(!1,i,t.commentData.activityId);break;case"unlikeComment":var o=e.commentCollection.get(t.commentData.id);if(!o)return!1;o.unlike(!1,i,t.commentData.activityId);break;case"unlikeReplyComment":var o=e.commentCollection.get(t.commentData.parentId);if(!o)return!1;var s=o.get("children").get(t.commentData.id);if(!s)return!1;s.unlike(!1,i,t.commentData.activityId);break;case"setVisibility":var o=e.commentCollection.get(t.commentData.id);"remove"==t.type?o&&CommentModels.commentCollection.remove(o.id,{keepRange:!0}):o?(o=e.commentCollection.get(t.commentData.id),o.setVisibility(t.commentData.visibility,!1,t.commentData.activityId)):e.commentCollection.receiveAddCommentFromCollaborators(t.commentData);break;case"dummyOp":}}catch(i){CommentUtils.onErrorCallback({action:t.action,info:t,errNo:e.COMMENT_COLLABORATION_HANDLING_ERROR,error:i})}},o=function(e){e.ALL_CHANGES||e.ALL_COMMENTS?CommentUtils.updateFollowers("followAllComments"):e.NO_NOTIFICATION?CommentUtils.updateFollowers("unfollowAllComments"):e.PARTICIPATED_COMMENTS&&CommentUtils.updateFollowers("followParticipatedComments")},s=function(t,i){e.commentIndices=e.commentIndices.filter(function(e){return e.id!=t});var n,o;for(o=i,i=editor.doc.findPreviousIndexOf(UNICODE.RANGE_START,i);i>-1;){var s=editor.doc.getRawFormatAt(i);if(s&&s.type==NODE_TYPE.COMMENT&&s.id==t){n=i;break}i=editor.doc.findPreviousIndexOf(UNICODE.RANGE_START,i)}e.commentIndices.push({id:t,start:n,end:o})},r=function(e,t){ZWArrayUtils.each(e,function(e){s(e,t)})},m=function(t){e.commentIndices=e.commentIndices.filter(function(e){return e.id!=t})},l=function(e){CommentUtils.getSequenceDiff(e.comment_sequence_number)>0&&(ZWLogger.log("Comments sequence number has incremented, along with this doc op. Calling comment sync..."),CommentUtils.syncup())},a=function(e){var i=editor.doc.getRawFormatAt(e),n=editor.doc.getCharAt(e);i&&i.type===NODE_TYPE.COMMENT&&n===UNICODE.RANGE_END&&(r([i.id],e),t.publish("Comment/RangeEndInserted",[i.id],e))},c=function(e,i){var n=CommentModels.commentIndices.filter(function(t){return t.end>=e&&t.end<i}).map(function(e){return e.id});d(n),t.publish("Comment/RangeEndRemoved",n)},d=function(e){ZWArrayUtils.each(e,function(e){m(e);var t=CommentModels.commentCollection.get(e);t&&t.set("isRangeCharsRendered",!1)})},u=function(e,t,i){CommentModels.commentIndices=CommentModels.commentIndices.map(function(n){var o=ReviewUtil.updateIndex(n,e,t,i);return n.start=o.start,n.end=o.end,n})},h=function(e){var t=e.from,i=e.to,n=editor.doc.getContent(t,i);u(t,n,"is");for(var o=t;o<i;o++)a(o)},C=function(e){c(e.from,e.to),u(e.from,e.chars,"ds")},g=function(){return ZWNetworkUtils.ajax({type:"GET",url:ZWNetworkUtils.getUrl("getcomments")})},p=function(){return g().done(function(e){e.comments&&f(e.comments)})},f=function(i){i.comments&&i.comment_sequence_number&&(e.commentPane.set("isLoading",!0),CommentModels.commentCollection.reset(),CommentModels.setSequenceNumber(i.comment_sequence_number),t.publish("Comment/BeforeLoadModels"),e.loadModels(i.comments),t.publish("Comment/AfterLoadModels"),t.publish("Comment/AfterReload"))},v=function(e){ZWArrayUtils.each(e,function(e){switch("addComment"==e.action&&CommentUtils.notifyMentions(e.commentData.text,e.commentData.id),"addReplyComment"==e.action&&CommentUtils.notifyMentions(e.commentData.text,e.commentData.parentId,e.commentData.id),"updateComment"==e.action&&CommentUtils.notifyMentions(e.commentData.text,e.commentData.id),"updateReplyComment"==e.action&&CommentUtils.notifyMentions(e.commentData.text,e.commentData.parentId,e.commentData.id),e.commentData.id&&e.commentData.parentId?CommentModels.commentCollection.getReplyComment(e.commentData.parentId,e.commentData.id)&&CommentModels.commentCollection.getReplyComment(e.commentData.parentId,e.commentData.id).set("syncing",!1):e.commentData.id&&!e.commentData.parentId&&CommentModels.commentCollection.getComment(e.commentData.id)&&CommentModels.commentCollection.getComment(e.commentData.id).set("syncing",!1),e.action){case"addComment":t.publish("Comment/Added",CommentUtils.getCoreData(CommentModels.commentCollection.get(e.commentData.id).json()));break;case"addReplyComment":t.publish("Comment/ReplyAdded",CommentUtils.getCoreData(CommentModels.commentCollection.get(e.commentData.parentId).get("children").get(e.commentData.id).json()));break;case"resolveComment":t.publish("Comment/Resolved",CommentUtils.getCoreData(CommentModels.commentCollection.get(e.commentData.id).json()));break;case"reopenComment":t.publish("Comment/Reopened",CommentUtils.getCoreData(CommentModels.commentCollection.get(e.commentData.id).json()));break;case"resolveAllComments":t.publish("Comment/ResolvedAll",e.commentData.idList)}})},E=Utils.once(function(){t.subscribe("Comment/CollaboratorOpReceived",i),t.subscribe("Document/CollaboratorOpReceived",l),t.subscribe("Document/Sync",l),e.commentCollection.on("remove",function(e,t,i){i.keepRange||m(e.id)}),t.subscribe("Document/BeforeLoading",e.reset),t.subscribe("Document/ContentAdded/Optimized",h),t.subscribe("Document/ContentDeleted/Optimized",C),t.subscribe("Comment/Reload",p),t.subscribe("Document/MarkupviewChanged",p),t.subscribe("Document/Combined",p),t.subscribe("Document/NotificationSettingsUpdated",o),t.subscribe("Document/EditorReady",CommentModels.init)}),y=function(){var t=e.commentCollection.json(),i={};return ZWArrayUtils.each(t,function(e){var t={};ZWArrayUtils.each(e.children,function(e){t[e.id]=e}),e.children=t,e.isRangeCharsRendered=!1,e.inDisplay=!0,e.inFocus=!1,i[e.id]=e}),i},w=function(){var t=CommentModels.commentIndices.sort(function(e,t){return t.start<e.start?1:-1}).filter(function(t){return e.commentCollection.get(t.id)}).map(function(e){return e.id});return t},b=function(){var t=e.commentCollection.filter(function(e){return!M(e.get("id"))}),i=t.sort(function(e,t){return t.get("createdAt")<e.get("createdAt")?1:-1}).map(function(e){return e.get("id")});return i},R=function(){var e=w(),t=b(),i=e.concat(t);return i},M=function(e){return!!CommentUtils.getCommentRange(e)};return{handleCollaboratorOperation:n,reload:f,fetchReload:p,onOpSuccess:v,init:E,constructCommentsJSON:y,getCommentOrder:R,getLinkedCommentOrder:w,getUnlinkedCommentOrder:b,isLinkedComment:M}}),zw.define("CommentAPI",[],["CommentModels"],function(e){var t=function(t,i,n,o){t=CommentUtils.removeInvalidChars(t);var s={text:t,doctext:editor.doc.getContent(i,n),reads:[editor.zuid]};o&&(s.richtext=o);var r=e.CommentCollection.createComment(s);return e.commentCollection.addComment(r,!0,i,n),r.json()},i=function(t){var i=e.commentCollection.getComment(t);return e.commentCollection.removeComment(i,!0),i.json()},n=function(t,i,n){var o=CommentUtils.removeInvalidChars(i),s=e.commentCollection.getComment(t);return n="undefined"!=typeof n?n:null,s.edit(o,n,!0),s.json()},o=function(t){var i=e.commentCollection.getComment(t);return i.like(!0),i.json()},s=function(t){var i=e.commentCollection.getComment(t);return i.unlike(!0),i.json()},r=function(t){var i=e.commentCollection.getComment(t);return i.follow(!0),i.json()},m=function(t){var i=e.commentCollection.getComment(t);return i.unfollow(!0),i.json()},l=function(t){var i=e.commentCollection.getComment(t);return i.resolve(!0),i.json()},a=function(t){var i=e.commentCollection.getComment(t);return i.reopen(!0),i.json()},c=function(t){var i=e.commentCollection.getComment(t);return i.read(editor.zuid),i.json()},d=function(t){var i=e.commentCollection.getComment(t);return i.unread(editor.zuid),i.json()},u=function(t){e.commentCollection.read(t,editor.zuid)},h=function(t){e.commentCollection.unread(t,editor.zuid)},C=function(t,i,n){var o=e.commentCollection.getComment(t);i=CommentUtils.removeInvalidChars(i);var s=new Date,r=s.getTime(),m={createdAt:r,updatedAt:r,zuid:editor.zuid,text:i,children:null,parentId:t,reads:[editor.zuid]};return n&&(m.richtext=n),replyCommentObj=e.CommentCollection.createComment(m),o.addReplyComment(replyCommentObj,!0),replyCommentObj.json()},g=function(t,i,n,o){var s=e.commentCollection.getComment(t),r=e.commentCollection.getReplyComment(t,i),m=CommentUtils.removeInvalidChars(n);return o="undefined"!=typeof o?o:null,s.editReplyComment(r,m,o,!0),s.json()},p=function(t,i){var n=e.commentCollection.getComment(t),o=e.commentCollection.getReplyComment(t,i);return n.removeReplyComment(o,!0),n.json()},f=function(t,i){var n=e.commentCollection.getReplyComment(t,i);return n.like(!0),n.json()},v=function(t,i){var n=e.commentCollection.getReplyComment(t,i);return n.unlike(!0),n.json()},E=function(t,i){var n=e.commentCollection.getRenderedComments(),o=e.commentPane.get("currentView"),s=e.commentPane.get("currentAuthor");e.commentPane.set("currentView",i),e.commentPane.set("currentAuthor",t),n=e.commentCollection.applyViewFilter(n),n=e.commentCollection.applyAuthorFilter(n),e.commentPane.set("currentView",o),e.commentPane.set("currentAuthor",s);var r={};n.forEach(function(e){var t=e.json();r[t.id]=t});var m=CommentModelManager.getLinkedCommentOrder();return n=[],m.forEach(function(e){r[e]&&n.push(r[e])}),n},y=function(t){return e.commentCollection.getComment(t).json()},w=function(){return CommentModelManager.constructCommentsJSON()},b=function(){var t=[],i=CommentModelManager.getLinkedCommentOrder(),n=CommentModelManager.constructCommentsJSON();return i.forEach(function(i){n[i]&&t.push(e.commentCollection.getComment(i).json())}),t};return{add:t,remove:i,edit:n,like:o,unlike:s,resolve:l,reopen:a,follow:r,unfollow:m,read:c,unread:d,readAll:u,unreadAll:h,addReply:C,editReply:g,removeReply:p,likeReply:f,unlikeReply:v,filter:E,get:y,getAll:b,getCommentFile:w}}),zw.define("CommentEvents",[],["CommentModels"],function(e){var t={onRangeCharsRendered:function(e,t,n){t&&PubSub.publish("CommentModel/Added",e.json()),i(e.get("children"))},onAdd:function(e){e.get("isRangeCharsRendered")&&(PubSub.publish("CommentModel/Added",e.json()),i(e.get("children")))},onDelete:function(e){PubSub.publish("CommentModel/Deleted",e.json())},onResolveStatusChange:function(e,t){t?PubSub.publish("CommentModel/Resolved",e.json()):PubSub.publish("CommentModel/Reopened",e.json())},onReadsChange:function(e,t){t?PubSub.publish("CommentModel/Unread",e.json()):PubSub.publish("CommentModel/Read",e.json())},onLike:function(e,t,i,n){PubSub.publish("CommentModel/Liked",i.json(),n)},onUnlike:function(e,t,i,n){PubSub.publish("CommentModel/Unliked",i.json(),n)},onFocusChange:function(e,t){t?PubSub.publish("CommentModel/Focus",e.json()):PubSub.publish("CommentModel/Blur",e.json())},onActivityLogAdd:function(t,i){if(t.get("parentId")||i.get("action")!==e.ACTIVITYLOG.REPLY_ADD)i.get("action")===e.ACTIVITYLOG.EDIT&&PubSub.publish("CommentModel/Edited",t.json());else{var n=t.get("children").get(i.get("commentId"));PubSub.publish("CommentModel/Added",n.json())}},onFailedOpsUpdated:function(){PubSub.publish("CommentModel/FailedOpsUpdated",e.failedOps.toJSON())}},i=function(e){e.on("change:isRangeCharsRendered",t.onRangeCharsRendered),e.on("add",t.onAdd),e.on("remove",t.onDelete),e.on("change:isResolved",t.onResolveStatusChange),e.on("likeComment",t.onLike),e.on("unlikeComment",t.onUnlike),e.on("change:unread",t.onReadsChange),e.on("inFocus",t.onFocusChange),e.on("add:activityLog",t.onActivityLogAdd),e.each(function(e){i(e.get("children"))})},n=function(e){e.off("change:isRangeCharsRendered",t.onRangeCharsRendered),e.off("add",t.onAdd),e.off("remove",t.onDelete),e.off("change:isResolved",t.onResolveStatusChange),e.off("likeComment",t.onLike),e.off("unlikeComment",t.onUnlike),e.off("change:unread",t.onReadsChange),e.off("inFocus",t.onFocusChange),e.off("add:activityLog",t.onActivityLogAdd),e.each(function(e){n(e.get("children"))})},o=function(){i(e.commentCollection),e.failedOps.on("add remove reset",t.onFailedOpsUpdated)},s=function(){n(e.commentCollection),e.failedOps.off("add remove reset",t.onFailedOpsUpdated)};return{startListening:o,stopListening:s}}),CommentRTE=function(){var e=function(e){return function(t,i,n,o,s){if("mention"===t){for(var r=[],m=CommentUtils.getContacts(),l=0;l<m.length;l++){var a=m[l],c=a.fullname,d=a.emailid,u=i.length;if(CommentUtils.isValidContact(a)){var h=i.toUpperCase()===c.slice(0,u).toUpperCase(),C=i.toUpperCase()===d.slice(0,u).toUpperCase();(h||C)&&r.push(a)}}CommentUtils.atMentionCustomFilter(r,i,n,e,s)}}},t=function(t){return{name:RichTextEditor.CONST.ATMENTION,getSuggestions:e(t)}},i=function(e){var i={formats:[RichTextEditor.CONST.BOLD,RichTextEditor.CONST.HIGHLIGHT,RichTextEditor.CONST.ITALIC,RichTextEditor.CONST.UNDERLINE,RichTextEditor.CONST.LINK,RichTextEditor.CONST.STRIKETHROUGH],features:[]};return CommentModels.atMention.enabled()&&i.features.push(t(e)),ZWRichTextEditor.isProofingEnabled()&&i.features.push(ZWRichTextEditor.getRTEProofing()),Macros.isRemote()||i.features.push({name:RichTextEditor.CONST.EMOJI,hasZomoji:!0}),i},n=function(e,t,n,o,s,r){var m=i(t),l=m.features,a={formats:m.formats,features:l,placeholder:e,menubar:n,onKeyPress:o};return r&&(a.content=r),s&&(a.className=s),a},o=function(){var e={formats:[RichTextEditor.CONST.BOLD,RichTextEditor.CONST.HIGHLIGHT,RichTextEditor.CONST.ITALIC,RichTextEditor.CONST.UNDERLINE,RichTextEditor.CONST.LINK,RichTextEditor.CONST.STRIKETHROUGH],features:[{name:RichTextEditor.CONST.ATMENTION},{name:RichTextEditor.CONST.EMOJI,hasZomoji:!0}]};return e};return{getRichTextOptions:n,getDefaultRichTextOptionsForRendering:o}}(),zw.define("Mixins",[],["U"],function(e){var t,i=function(t){var i=t.prototype.mixins||t.mixins,t=t.prototype||t,n={};return e.each(i,function(i){if(!i)throw new Error("Error in comment view: undefined/null value as an item in mixins list.");e.each(i,function(i,o){if(e.isFunction(i)){if(t[o]===i)return;t[o]&&(n[o]=n.hasOwnProperty(o)?n[o]:[t[o]],n[o].push(i)),t[o]=i}else e.isArray(i)?t[o]=e.union(i,t[o]||[]):e.isObject(i)?t[o]=e.extend({},i,t[o]||{}):o in t||(t[o]=i)})}),e.each(n,function(i,n){t[n]=function(){var t,n=this,o=arguments;return e.each(i,function(e){var i=e.apply(n,o);t=i||t}),t}},this),t},n=function(e){t=e.View.extend;var n=function(e,n){var o=t.call(this,e,n);return o.prototype.mixins&&i(o),o};e.View.extend=n},o=function(t,i){e.each(t,function(e){e.initialize.apply(i)})};return{init:i,monkeyPatch:n,callConstructors:o}}),Mixins.monkeyPatch(Backbone),zw.define("CommentMixins",[],["CommentModels"],function(e){var t={initialize:function(){this.listenTo(this.model.get("activityLog"),"add",this.updateEditInfo)},updateEditInfo:function(){var e=this.model.get("activityLog").filter(function(e){return e.get("action")===CommentModels.ACTIVITYLOG.EDIT}).length;return e?void(this.model.get("parentId")?this.$(".js-reply-edits-container").show():this.$(".js-edits-container").show()):0}},i={initialize:function(){this.listenTo(e.commentPane,"change:isReadOnly",this.updateMode),this.listenTo(this,"commentview:rendered commentbubbleview:rendered replycommentview:rendered replycommentbubbleview:rendered",this.updateMode),this.listenTo(this,"rendered",this.updateMode)},updateMode:function(){var t=e.commentPane.get("isReadOnly"),i=this.$(this.editables.join(",")),n=CommentModels.isCommentHasAdditionErrors(this.model);n||(t?i.hide():i.show())}},n={initialize:function(){this.listenTo(this.model,"change:failedOps",this.updateFailedUi),this.listenTo(this,"rendered",this.updateFailedUi)},updateFailedUi:function(){var t=CommentUtils.getCurrentFocusedComment(),i=t&&t.get("id")===this.model.get("id"),n=CommentModels.isCommentHasAdditionErrors(this.model),o=e.commentPane.get("isReadOnly");n?(this.editables.forEach(function(e){this.$(e).hide()},this),this.$(".js-new-reply-view").hide()):o||(this.editables.forEach(function(e){this.$(e).show()},this),i&&this.$(".js-new-reply-view").show())}},o=function(e){return{isReply:!1,events:function(){return e?{"click .js-replycomment-expand-btn":"expandCommentContent","click .js-replycomment-shrink-btn":"shrinkCommentContent"}:{"click .js-comment-expand-btn":"expandCommentContent","click .js-comment-shrink-btn":"shrinkCommentContent"}}(),initialize:function(){this.isReply=!!this.model.get("parentId"),this.listenTo(this,"rendered",this.initEllipsize),this.listenTo(this.model,"change:text",this.initEllipsize),this.listenTo(this.model,"change:isEllipsized",this.updateEllipsize)},isLargeComment:function(){return this.model.get("text").length>400&&this.model.get("text").length-400>50},initEllipsize:function(){var e=this.isReply?this.$el:this.$(".js-comment-parent-container"),t=this.isReply?".ui-toggle-replycomment-height":".ui-toggle-comment-height";this.isLargeComment()?(e.find(t).show(),this.model.set("isEllipsized",!0,{silent:!0}),this.updateEllipsize()):e.find(t).hide()},updateEllipsize:function(){if(!this.isLargeComment)return!1;var e=this.model.get("isEllipsized"),t=this.isReply?this.$el:this.$(".js-comment-parent-container"),i=(this.isReply?".ui-toggle-replycomment-height":".ui-toggle-comment-height",this.isReply?".js-replycomment-shrink-btn":".js-comment-shrink-btn"),n=this.isReply?".js-replycomment-expand-btn":".js-comment-expand-btn",o=this.isReply?".js-child-text-container":".js-parent-text-container";e?(t.find(o).addClass("commentcontent-shrinked"),t.find(n).show(),t.find(i).hide()):(t.find(o).removeClass("commentcontent-shrinked"),t.find(n).hide(),t.find(i).show())},expandCommentContent:function(){this.model.set("isEllipsized",!1)},shrinkCommentContent:function(){this.model.set("isEllipsized",!0)}}},s={events:{"click .js-comment-menuoption-link":"showLink","click .js-comment-time":"showLink"},showLink:function(){var e=CommentModels.isCommentHasAdditionErrors(this.model);if(!e){var t=editor.base_url+"/open/"+editor.doc.rid+"/comments/"+this.model.id,i=this.$el.find(".ui-auth-txt").offset();Utils.showLink(t,i.top,i.left)}}};return{WillShowEditHint:t,ReactsToReadOnly:i,SupportsEllipsize:o,SupportsLink:s,ReactToFailedComments:n}});var CommentHighlights=function(e){var t=[],i={comments:{},highlights:{},el:{},lines:new Map};extend(i,{getHighlights:function(e){return this.comments[e]||[]},getComments:function(e){return this.highlights[e]||[]},getElm:function(e){return this.el[e]},getElms:function(e){return U.reduce(e,function(e,t){return e.add(this.getElm(t))},J([]),this)},getElmsByComment:function(e){var t=this.getHighlights(e);return this.getElms(t)},setElm:function(e,t){this.el[e]=t},setComments:function(e,t){this.highlights[e]=t},setHighlights:function(e,t){this.comments[e]=t},addHighlights:function(e,t){this.comments[e]=this.comments[e]||[],this.comments[e].push.apply(this.comments[e],t)},removeById:function(e){var t=this.getElm(e);t&&t.remove(),delete this.highlights[e],delete this.el[e]},removeByComment:function(t){var i=this.getHighlights(t);U.each(i,function(i){var n=this.getComments(i),o=this.getElm(i);if(1==n.length)this.removeById(i);else{o.removeClass("ui-comment-indication-new-active");var n=n.filter(function(e){return e!=t});n.filter(e.isResolved).length==n.length&&o.addClass(e.getResolvedClass()),this.setComments(i,n)}},this),this.comments[t]=[]},removeByLine:function(e){if(e){var t=this.getHighlightsByLine(e.getId());U.each(t,function(e){var t=this.getComments(e);U.each(t,function(t){var i=this.getHighlights(t);i=i.filter(function(t){return e!=t}),this.setHighlights(t,i)},this),this.removeById(e)},this),this.lines.delete(e.getId())}},getHighlightsByLine:function(e){return this.lines.get(e)||[]},setLineMap:function(e,t){this.lines.has(e)||this.lines.set(e,[]),this.lines.get(e).push(t)},reset:function(){this.comments={},this.highlights={},this.el={}}});var n=function(e){return t.push.apply(t,e)},o=function(){U.each(t,function(t){var i=e.getCommentRange(t),n=DocLayoutManager.getLineAtIndex(i.start);if(n){ZWLogger.log("\nCalling linesBetween() with start:"+i.start+"  end:"+i.end+"... comment id : "+t);var o=DocLayoutManager.linesBetween(i.start,i.end)}else var o=[];U.each(o,function(t){e.discardHighlights(t);var i=t.absStart,n=t.absEnd,o=e.getHighlightSegments(i,n);U.each(o,function(t){e.drawCommentHighlight(t.start,t.end,t.ids)})})}),t=[]},s=function(t){var i=t.parent,n=i.getIndex();e.discardHighlights(t);var o=n+t.start,s=n+t.end,r=e.getHighlightSegments(o,s);U.each(r,function(t){e.drawCommentHighlight(t.start,t.end,t.ids)})};return{highlightMap:i,pushToHighlightQueue:n,drawHighlight:o,updateHighlight:s}}(CommentUtils);zw.define("CommentPrint",[],["CommentUtils"],function(e){var t=new ZWConsole,i=function(){PubSub.subscribe("Document/Pagination/Complete",n),t.log("listening for Document/Pagination/Complete event, for initiating comment pages render with options: ",editor.options)},n=function(){PubSub.unsubscribe("Document/Pagination/Complete",n),DomViewManager.renderAllPages(),isHeadlessPDF&&(t.log("First time pagination completed inside review-print-iframe"),s(editor.options.include_comments).done(function(){o(),C()}))},o=function(){var e=document.createElement(NODE_NAME.HEAD),t=document.getElementsByClassName("table-theme-style");t.length&&e&&J(t).each(function(){e.appendChild(this.cloneNode(!0))}),J(parent.window.document.head).append(e.children)},s=function(e){var i=new Deferred;return"none"===e?(t.log("include_comments = none | proceeding with next step"),i.resolve(),i):(h().done(function(){t.log("comment pages have been added. drawing highlights and markers"),b(),p(),i.resolve()}),i)},r=function(e){return(e+"px").convertor().inches+"in"},m=function(){var e=u();return[{as:{start:e},id:"commentsectionchar"},{is:""},{as:{end:Object.keys(e)},id:"commentsectionchar"},{as:{start:{type:"paragraph"}},id:"cspara"},{is:"\n"},{as:{end:["type"]},id:"cspara"}]},l=function(){var e=c();return[{as:{start:e},id:"headersectionchar"},{is:""},{as:{end:Object.keys(e)},id:"headersectionchar"},{as:{start:{type:"paragraph"}},id:"hspara"},{is:"\n"},{as:{end:["type"]},id:"hspara"}]},a=function(){var e=d();return[{as:{start:e},id:"footersectionchar"},{is:""},{as:{end:Object.keys(e)},id:"footersectionchar"},{as:{start:{type:"paragraph"}},id:"fspara"},{is:"\n"},{as:{end:["type"]},id:"fspara"}]},c=function(){return{hftype:1,st:"header",type:"section",sid:"header_forcomment"}},d=function(){return{hftype:3,st:"footer",type:"section",sid:"footer_forcomment"}},u=function(){var e=.625,t=DocLayoutManager.docTree.getAllSectionsByType(SECTION_TYPES.CONTENT).last(),i=t.format,n=t.getStylesForNewSection({ml:e+"in",mr:e+"in",sid:"section_forcomment",breakType:2,ps:i.ps,or:i.or,pw:i.pw,ph:i.ph,mt:i.mt,mb:i.mb,ht:i.ht,fb:i.fb,cols:{count:1,width:[r(DocLayoutManager.getLastPage().getContentWidth())],seperator:"0",space:[],iseqwidth:!0},headerIds:["header_forcomment"],footerIds:["footer_forcomment"]});return n},h=function(){var e=new Deferred;CommentModels.init(null,!0),CommentModelManager.init();var i=w(),n=J("<div>"+i+"</div>"),o={isWriterDocument:!0},s=DocLayoutManager.docTree.getAllSectionsByType(SECTION_TYPES.CONTENT).last().end,c=PasteUtil.getComposedOpForCustomContent(n[0],null,o,s-1);c.shift();var d=DocLayoutManager.getLastPage().getDOMViewWidth(),u=.625,h=r(DocLayoutManager.getLastPage().getDOMViewWidth()-2*u),C=E(editor.doc.docInfo.DOCUMENT_NAME),g=[{r:s}].concat(m()).concat(c).concat(l()).concat(CommentPrint.getHeaderContentOpsForCommentPrint(d,h,C)).concat(a()),p=DocOpBuilder.build(g);return PubSub.subscribe("Document/Pagination/Complete",function i(){PubSub.unsubscribe("Document/Pagination/Complete",i),DomViewManager.renderAllPages(),t.log("Pagination complete after applying ops to construct comment pages"),e.resolve()}),p.applyTo(),e},C=function(){t.log("Throwing completed event to parent window"),parent.PubSub.publish("Document/ReviewPrintIframe/Ready")},g=function(){return CommentModelManager.getLinkedCommentOrder().filter(function(t){var i=CommentModels.commentCollection.get(t);if(!i)return!1;var n=e.getCommentRange(t);return!!n&&!i.get("isResolved")})},p=function(){var t={};g().forEach(function(e,i){t[e]=i+1});var i=J(".cmt-range-end");i.each(function(i,n){$rc=J(n);var o=$rc.attr("cid");if(Object.keys(t).contains(o)){var s=$rc.parents(".zw-line-div"),r=e.getCommentRange(o),m=t[o],l=DocLayoutManager.getLeftAtIndex(r.end),a=J(J("#comment-print-marker").html());s.append(a),a.addClass("cmt-marker"),a.height(s.height()+8+"px"),a.css("top","-8px");var c="C"+m;a.find(".cp-flag-top").attr("href",c),a.find(".cp-flag-top").text("C"+m),a.find(".cp-flag-pole").height(s.height()),a.css("left",l-a.outerWidth())}})},f=function(){J(".cmt-marker").remove()},v=function(e,t){var i="";return t-e>60&&(t=e+60,i="..."),editor.doc.getContent(e,t).indexOf("")!=-1?editor.doc.getContent(e,e+editor.doc.getContent(e,t).indexOf(""))+"["+J.i18n("writer.common.IMAGE")+"]"+editor.doc.getContent(e+editor.doc.getContent(e,t).indexOf(""),t)+i:editor.doc.getContent(e,t)+i},E=function(e){if(e.length>50){var t=e.slice(0,50);return t.concat("...")}return e},y=function(){var t=[],i=1;return g().forEach(function(n){var o=CommentModels.commentCollection.get(n),s=e.getCommentRange(o.id),r=DocLayoutManager.getLineAtIndex(s.start),m=r.getView().getPage().getPageNumber(),l=o.json();l.number=i++,l.pageNumber=m,l.doctext=v(s.start,s.end),t.push(l),l.activityLog.forEach(function(e){e.action==CommentModels.ACTIVITYLOG.REPLY_ADD&&l.children.forEach(function(i){i.id==e.commentId&&t.push(o.get("children").get(i.id).json())})})}),t},w=function(e){var t=y(),i='<p data-textformat="{&quot;type&quot;:&quot;text&quot;}" data-margin-bottom="0pt" data_styles="{&quot;type&quot;:&quot;text&quot;}" data-line-height="1.2" class="zw-paragraph" style="margin: 0px 0px 0pt; line-height: 1.2; text-align: left;"><span class="EOP">&nbsp;</span></p>',n=i;return t.forEach(function(e,t){var i="";i=e.parentId?J("#reply-comment-container").html():0===t?J("#parent-comment-container").html():J("#parent-comment-container-with-line").html();var o=Handlebars.compile(i),s=o(e);n+=s}),n},b=function(){CommentModels.commentCollection.each(function(t){var i=e.getCommentRange(t.id);i&&i.start&&i.end&&!t.get("isResolved")&&(t.set("isRangeCharsRendered",!0),CommentHighlights.pushToHighlightQueue([t.id]),CommentHighlights.drawHighlight())})};return i(),{insertMarkers:p,removeMarkers:f,addCommentPages:h,logger:t}}),zw.define("FailedOpsView",[],["Backbone","CommentModels"],function(e,t){var i=e.View.extend({tagName:"div",tpl:Handlebars.compile(Z("failed-ops-detail-view").html()),className:"ui-border-bottom",errorMsg:{resolveAllComments:"writer.common.ERROR_MSG_RESOLVE_ALL",deleteAllComments:"writer.common.ERROR_MSG_DELETE_ALL"},initialize:function(){},events:{"click .js-try-again-btn":"tryAgain"},onRetrying:function(){},onRetryFailed:function(){},tryAgain:function(){t.failedOps.retry(this.model.id)},getCommentLabel:function(e){if(e.bulkOperation)return e.op.commentData.idList.length>1?J.i18n(UIUtils.getUIText("COMMENTS")).toLowerCase():J.i18n(UIUtils.getUIText("COMMENT")).toLowerCase()},getContext:function(){var e=this.model.toJSON();e.op.commentData.id,e.op.commentData.idList;return e.doesCommentExist=!!e.comment,e.bulkOperation=e.op.commentData.idList,e.error_title=J.i18n(CommentManager.opErrorMap[e.op.action]),e.error_title+=e.bulkOperation?" "+e.op.commentData.idList.length+" "+this.getCommentLabel(e):"",e.error_description=e.bulkOperation?J.i18n(this.errorMsg[e.op.action],[e.op.commentData.idList.length]):"",e},render:function(){var e=this.getContext();return this.$el.html(this.tpl(e)),this}}),n=e.View.extend({el:"#comment-error-popup",tpl:Handlebars.compile(Z("failed-ops-list-view").html()),events:{"click .js-ignore-all":"ignoreAll","click .js-retry-all":"retryAll"},initialize:function(){this.detailViews={},this.listenTo(t.failedOps,"remove",this.removeView)},destroy:function(){U.each(this.detailViews,function(e,t){e.remove()}),this.detailViews={}},ignoreAll:function(){CommentModels.failedOps.reset()},retryAll:function(){CommentModels.failedOps.retryAll()},initDetailViews:function(){this.collection.each(function(e){this.detailViews[e.id]=new i({model:e})},this)},removeView:function(e,t,i){var n=this.detailViews[e.id];n&&n.$el.slideUp(100,function(){n.remove()})},render:function(){this.destroy(),this.initDetailViews(),this.$el.html(this.tpl()),U.each(this.detailViews,function(e,t){this.$("#js-failed-ops-list").append(e.render().$el)},this)}}),o=e.View.extend({el:"#js-mount-comment-error-band",tpl:Handlebars.compile(Z("failed-ops-view").html()),isListViewOpen:!1,initialize:function(){this.failedOpsListView=new n({collection:t.failedOps}),this.listenTo(t.failedOps,"add",this.show),this.listenTo(t.failedOps,"add",this.onFailedOpAdd),this.listenTo(t.failedOps,"remove",this.hide),this.listenTo(t.failedOps,"reset",this.hide),this.render(),this.popover=Z("view-now-btn"),this.popover.zpopover({className:"ui-cmt-error-popup-cont",content:Z("comment-error-popup"),beforeopen:this.renderFailedOpsListView.bind(this),beforeclose:this.destroyFailedOpsListView.bind(this)})},renderFailedOpsListView:function(){this.isListViewOpen=!0,this.failedOpsListView.render(),ActivityTracker.trackInAnalytics("Comment","ViewFailed","TopBand")},destroyFailedOpsListView:function(){this.isListViewOpen=!1,this.failedOpsListView.destroy()},onFailedOpAdd:function(){this.isListViewOpen&&this.renderFailedOpsListView()},show:function(){this.$(".js-errorband-container").show()},hide:function(){t.failedOps.length||(this.popover.zpopover("close"),this.$(".js-errorband-container").hide())},render:function(){this.$el.html(this.tpl()),CommentUtils.initActivityTracking(this.el)}});return o}),zw.define("CommentErrorHint",[],["CommentModels"],function(e){var t=Backbone.View.extend({tpl:Handlebars.compile(Z("comment-error-hint").html()),events:{"click .js-try-again-btn":"tryAgain"},tryAgain:function(){var t=this.getErrorOps(),i=t.map(function(e){return e.id});e.failedOps.retryMutliple(i)},getErrorOps:function(){var t=this.model.id,i=e.failedOps.toJSON(),n=i.filter(function(e){return!!e.comment&&e.comment.id===t});return n},render:function(){var e=this.getErrorOps();if(!e.length)return this.$el.html(""),this;if(e.length>1)var t=J.i18n(UIUtils.getUIText("COMMENT_ERROR_MULTIPLE"));else var i=e[0],t=J.i18n(CommentManager.opErrorMap[i.op.action]);return this.$el.html(this.tpl({error_title:t})),this}});return t}),LikeView=function(e,t){var i=e.View.extend({tagName:"div",tpl:Handlebars.compile(Z("like-view").html()),likelistTpl:Handlebars.compile(Z("like-list-view").html()),initialize:function(e){this.listenTo(this.model,"change:likes",this.render),this.render()},events:{"click .js-comment-like-btn":"like","click .js-comment-like-btn-secondary":"like","click .js-comment-like-count-btn":"showLikes"},like:function(e){CommentUtils.addParticipant();var t=this.model.get("likes");t.indexOf(editor.zuid)>-1?this.model.unlike(!0):this.model.like(!0)},showLikes:function(e){if(this.model.get("likes").length){var i=this;J.dialogutil.open("likelistdialog",null,{init:function(e){var n=t(e),o=n.find("#likelist-content-container"),s=i.likelistTpl(i.model.attributes);o.html(s)}})}},render:function(){var e=this,t={};return t.hasLiked=this.model.get("likes").indexOf(editor.zuid)>-1,t.noOfLikes=this.model.get("likes").length,t.isMultipleLikes=this.model.get("likes").length>1,t.likedUsernames=function(){var t=e.model.get("likes").map(function(e){return CommentUtils.getUsername(e)}),i=5,n=t.length;if(n>i+1){var o=n-i;t=t.slice(0,i),t.push(J.i18n("writer.common.AND")+" "+J.i18n("writer.common.OTHERS_LIST",[o]))}return t.join("<br>")}(),this.$el.html(this.tpl(t)),this.delegateEvents(),CommentUtils.initActivityTracking(this.el),this}});return i}(Backbone,jQuery),FollowView=function(e,t){var i=e.View.extend({tagName:"span",tpl:Handlebars.compile(Z("follow-view").html()),initialize:function(e){this.listenTo(this.model,"change:followers",this.render),this.render()},events:{"click .js-comment-follow-btn":"follow"},follow:function(e){CommentUtils.addParticipant();var t=this.model.get("followers");if(t.indexOf(editor.zuid)>-1)this.model.unfollow(!0);else{this.model.follow(!0);var i=CommentManager.views.commentCollectionView.commentViewMap[this.model.id],n=CommentManager.views.commentCollectionView.commentBubbleViewMap[this.model.id];i&&i.showFollowToast(),n&&n.showFollowToast()}},render:function(){var e={};return e.hasFollowed=this.model.get("followers").indexOf(editor.zuid)>-1,this.$el.html(this.tpl(e)),this.delegateEvents(),this}});return i}(Backbone,jQuery),zw.define("VisibilityConst",[],[],function(){return{EXCLUDE_OPT_ORG:"ORG",EXCLUDE_OPT_CUSTOM:"CUSTOM",EXCLUDE_OPT_DOCOWNER:"CREATOR",EXCLUDE_OPT_ONLYME:"ONLYME",ROLE:"ROLE",ZUID:"ZUID",PREDEFINED_GROUP:"PREDEFINED_GROUP",EVERYONE:"EVERYONE",DOCOWNERS:"CREATOR",ROLES:"ROLES"}}),zw.define("Entity",[],["VisibilityConst"],function(e){function t(e,t){this.type=e,this.value=t}function i(i){t.call(this,e.PREDEFINED_GROUP,i)}function n(i){t.call(this,e.ROLE,i)}function o(i){t.call(this,e.ZUID,i)}return t.prototype.equals=function(e){return e.type===this.type&&e.value===this.value},t.prototype.toJSON=function(){return{type:this.type,value:this.value}},i.prototype=Object.create(t.prototype),n.prototype=Object.create(t.prototype),o.prototype=Object.create(t.prototype),{Entity:t,PredefinedGroupEntity:i,RoleEntity:n,ZuidEntity:o}}),zw.define("Visibility",[],["VisibilityConst"],function(e){var t=function(){return CommentModels.visibilitySettings.get()},i=function(){return CommentModels.visibilitySettings.get()},n=function(){return i().adminBoundary},o=function(){return n().entities.filter(function(e){return"ROLE"===e.type}).map(function(e){return e.value})},s=function(){var e=i().defaults;return e||(e={entities:Visibility.getAdminEntities(),withinOrg:Visibility.getWithinOrg()}),e},r=function(e){if(i().usersInfo[e]){var t=i().usersInfo;return t[e].email}},m=function(e){if(i().usersInfo[e]){var t=i().usersInfo;return t[e].name}return ReviewUtil.getUserName(e)},l=function(){return n().entities},a=function(){return n().withinOrg},c=function(t){for(var i=0;i<t.length;i++){var n=t[i],o=new Entity.Entity(n.type,n.value),s=new Entity.PredefinedGroupEntity(e.EVERYONE);if(o.equals(s))return!0}return!1},d=function(e){return J.i18n(i().adminSettings.entityDetails[e].label)},u=function(e){return J.i18n(i().adminSettings.entityDetails[e].description)},h=function(t){if(t.type===e.PREDEFINED_GROUP)return J.i18n(i().adminSettings.entityDetails[t.value].label);if(t.type===e.ROLE){var n=i().adminSettings.roles[t.value],o=n?J.i18n(n.label):"Unknown role ["+t.value+"]";return o}if(t.type===e.ZUID)return m(t.value);throw new Error("Visibility: unknown entity type asks for description: ",t)},C=function(e){var t=i().adminSettings.roles[e];return t.hint&&J.i18n(t.hint)},g=function(e){var t=i().adminSettings.EXCLUDE_OPTIONS||[];return t.indexOf(e)<0},p=function(){return g(e.EXCLUDE_OPT_CUSTOM)},f=function(){return g(e.EXCLUDE_OPT_ORG)},v=function(){return g(e.EXCLUDE_OPT_DOCOWNER)&&editor.doc.docInfo.CREATOR_ZUID!==editor.zuid};return{getEmail:r,getUsername:m,getAllowedRoles:o,getWithinOrg:a,getAdminEntities:l,getEntityLabel:h,isCustomOptionEnabled:p,isOrgOptionEnabled:f,isDocOwnerOptionEnabled:v,isOptionEnabled:g,entitiesContainEveryone:c,getRoleHint:C,isEnabled:t,getOptionLabel:d,getOptionDescription:u,getDefaults:s}}),zw.define("RolesDialog",[],["jQuery","Handlebars","ZWComponentUtil","VisibilityConst"],function(e,t,i,n){var o=new ZWConsole;o.enable(),o.log=o.log.bind(o,"Visibility Roles Dialog: ");var s="comment-vis-role-list-template",r=null,m=function(m,l,a,c){var d={roles:l,withinOrg:a||c},u=e.Deferred(),h=function(){o.log("done callback: ",d);var t=e("#within-org-checkbox")[0].checked;u.resolve(d.roles,t),e.dialogutil.close("visibilityrolesdialog")},C=function(){e.dialogutil.close("visibilityrolesdialog")},g={buttons:[{appearance:"primary",text:e.i18n("writer.common.OK"),click:h,id:"roles-dialog-done-btn"},{text:e.i18n("writer.common.CANCEL"),click:C,id:"roles-dialog-cancel-btn"}],open:function(e,o){var u=m.map(function(e){var t=Visibility.getEntityLabel({type:n.ROLE,value:e});return{value:e,label:t,selected:ZWArrayUtils.arrayContains(l,e),hasHint:!!Visibility.getRoleHint(e),hint:Visibility.getRoleHint(e)}});r=r||t.compile(Z(s).html()),o.dialog.find(".js-roles-list-container").html(r({roles:u})),u.forEach(function(e){o.dialog.find("#role-"+e.value).on("zstatebuttonchange",function(e,t){t.checked?d.roles.push(t.options.appData.action):d.roles=d.roles.filter(function(e){return e!==t.options.appData.action})})}),i.initElem(o.dialog.find("#vis-roles-dialog-content")),Visibility.isOrgOptionEnabled()&&o.dialog.find("#within-org-roles").show();var h=o.dialog.find("#within-org-checkbox");h.zstatebutton("checked",a||c),c&&h.disable()},beforeclose:function(){}};return e.dialogutil.open("visibilityrolesdialog",null,null,g),u};return{logger:o,getRoles:m}}),zw.define("CustomDialog",[],["jQuery","Visibility","VisibilityConst"],function(e,t,i){var n=new ZWConsole;n.enable(),n.log=n.log.bind(n,"Visibility Custom Dialog: ");var o=function(n){if(n.type===i.PREDEFINED_GROUP)return e.i18n("writer.common.GROUP");if(n.type===i.ROLE){var o=e.i18n("writer.common.ROLE");return t.getRoleHint(n.value)&&(o+=" ("+t.getRoleHint(n.value)+")"),o}return n.type===i.ZUID?t.getEmail(n.value)||e.i18n("writer.common.USER"):void 0},s=function(e){return e.value},r=function(t,i){return tokenFieldOptions={dataSource:t,values:i,autocomplete:!0,allowDuplicateValues:!1,dataValidation:!0,appData:{action:""},className:"ui-lock-cont-texarea",placeholder:e.i18n("writer.common.CUSTOM_DIALOG_PLACEHOLDER"),dataMapping:{value:"id",text:"name",informativeText:"description",itemIdentifier:"id",customValues:"entity"},search:{by:"name",criteria:"contains"},dropdownList:{contentType:"text-desc",width:400,highlightKeyword:!0,itemType:"none",sortResults:!0,showNoResultsMessage:!0},tokens:{contentType:"text",editable:!0,animateOnClose:!0,showCloseButtonOnHover:!1}}},m=function(n,m,l,a){var c=e.Deferred(),d=function(){var n=e("#entity-token-field").ztokenfield("getAllValues"),o=n.filter(function(e){return e.entity}).map(function(e){return e.entity});t.entitiesContainEveryone(o)&&(o=o.filter(function(e){var t=new Entity.Entity(e.type,e.value),n=new Entity.PredefinedGroupEntity(i.EVERYONE);return t.equals(n)}));var s=e("#within-org-checkbox-custom")[0].checked;c.resolve(o,s),e.dialogutil.close("visibilitycustomdialog")},u=function(){e.dialogutil.close("visibilitycustomdialog")},h={buttons:[{appearance:"primary",text:e.i18n("writer.common.OK"),click:d,id:"custom-dialog-done-btn"},{text:e.i18n("writer.common.CANCEL"),click:u,id:"custom-dialog-cancel-btn"}],open:function(c,d){ZWComponentUtil.initElem(d.dialog.find("#vis-custom-dialog-content"));var u=n.map(function(e){return{name:t.getEntityLabel(e),id:s(e),description:o(e),entity:e}});t.entitiesContainEveryone(m)&&(m=m.filter(function(e){var t=new Entity.Entity(e.type,e.value),n=new Entity.PredefinedGroupEntity(i.EVERYONE);return t.equals(n)}));var h=m.map(function(e){return{name:t.getEntityLabel(e),id:s(e),description:o(e),entity:e}}),C=r(u,h);e("#entity-token-field").ztokenfield(C),t.isOrgOptionEnabled()&&d.dialog.find("#within-org-custom").show();var g=d.dialog.find("#within-org-checkbox-custom");g.zstatebutton("checked",l),a&&(g.zstatebutton("checked",!0),g.disable())},beforeclose:function(){}};return e.dialogutil.open("visibilitycustomdialog",null,null,h),c};return{logger:n,getEntities:m}}),zw.define("VisibilityDropdownView",[],["VisibilityConst","Visibility","Utils"],function(e,t,i){var n=new ZWConsole;n.enable();var o=null,s=t.entitiesContainEveryone,r=function(t){if(!t.length)return!1;for(var i=0;i<t.length;i++){var n=t[i];if(n.type!==e.ROLE)return!1}return!0},m=function(t){return 1==t.length&&new Entity.PredefinedGroupEntity(e.DOCOWNERS).equals(t[0])},l=function(t){var i=!t.length,n=1==t.length&&t[0].type===e.ZUID&&t[0].value===editor.zuid;return i||n},a=function(e,t,i){o=o||Handlebars.compile(J("#comment-vis-setting-description").html());var n={entitiesContainEveryone:s(e),entitiesContainOnlyRoles:r(e),entitiesContainOnlyMe:l(e),entitiesContainOnlyDocOwner:m(e),stringifiedEntities:c(e),noEntities:!e.length,withinOrg:t,forTooltip:i||!1};return o(n)},c=function(e){var i=e.map(function(e){return t.getEntityLabel(e)}),n=i.length>1?i.pop():null,o=i.join(", \n");return n&&(o+=" "+J.i18n("writer.common.AND")+" "+n),o},d=function(e,i){return{id:i,label:t.getOptionLabel(e),description:t.getOptionDescription(e)}},u=Backbone.View.extend({tagName:"div",tplId:"comment-visibility-template",tpl:"",events:{"click .js-edit-entity-list":"showCustomDialog"},state:{},initialize:function(i){this.state.isTemplateCompiled=!1;var n=[];s(this.model.adminEntities)&&!this.model.withinOrg&&n.push(d(e.EVERYONE,"everyone")),t.isOrgOptionEnabled()&&n.push(d(e.EXCLUDE_OPT_ORG,"org")),this.model.allowedRoles.length&&n.push(d(e.ROLES,"roles")),t.isDocOwnerOptionEnabled()&&n.push(d(e.EXCLUDE_OPT_DOCOWNER,"docowner")),t.isOptionEnabled(e.EXCLUDE_OPT_ONLYME)&&n.push(d(e.EXCLUDE_OPT_ONLYME,"onlyme")),t.isCustomOptionEnabled()&&n.push(d(e.EXCLUDE_OPT_CUSTOM,"custom")),this.tplOptions={viewId:this.cid,id:this.model.id,options:n,readonly:this.model.readonly||!1,dropdownLabel:this.getDropdownLabel(),newtag:this.model.newtag||!1},this.on("value-changed",this.renderIndication,this)},getValue:function(){var t=this.model.currentSelection.entities;return t=s(t)?[new Entity.PredefinedGroupEntity(e.EVERYONE).toJSON()]:t,{entities:t,withinOrg:this.model.currentSelection.withinOrg}},getDropdownLabel:function(){return t.entitiesContainEveryone(this.model.currentSelection.entities)&&!this.model.currentSelection.withinOrg?J.i18n("writer.common.ALL"):l(this.model.currentSelection.entities)?J.i18n("writer.common.ONLYME"):J.i18n("writer.common.RESTRICTED")},getDropdownIcon:function(){return t.entitiesContainEveryone(this.model.currentSelection.entities)&&!this.model.currentSelection.withinOrg?"ui-sprit-lazy ui-icon-eye-blk-sm":"ui-sprit-lazy ui-icon-lock-blk-sm"},getCurrentSelectedOption:function(){var e=this.model.currentSelection.entities,t=this.model.currentSelection.withinOrg;return s(e)&&!t?"everyone":s(e)&&t?"org":r(e)?"roles":m(e)?"docowner":l(e)?"onlyme":"custom"},reset:function(){this.model.currentSelection={entities:t.getDefaults().entities,withinOrg:t.getDefaults().withinOrg},this.trigger("value-changed")},onVisibilityOptionSelect:function(e,t){"everyone"===t.data.itemValue?(ActivityTracker.trackInAnalytics("Comment","VisibleToAll","ReviewPanel"),this.setEveryone(e)):"roles"===t.data.itemValue?(ActivityTracker.trackInAnalytics("Comment","VisibleToSomeRoles","ReviewPanel"),this.showRolesDialog(e)):"custom"===t.data.itemValue?(ActivityTracker.trackInAnalytics("Comment","VisibleToSomeGroups","ReviewPanel"),this.showCustomDialog(e)):"org"===t.data.itemValue?(ActivityTracker.trackInAnalytics("Comment","VisibleToOrgUsers","ReviewPanel"),this.setMyOrg(e)):"docowner"===t.data.itemValue?(ActivityTracker.trackInAnalytics("Comment","VisibleToDocOwner","ReviewPanel"),this.setDocOwner(e)):"onlyme"===t.data.itemValue&&(ActivityTracker.trackInAnalytics("Comment","SetAsPrivate","ReviewPanel"),this.setOnlyMe(e))},setEveryone:function(t){this.model.currentSelection.entities=[new Entity.PredefinedGroupEntity(e.EVERYONE).toJSON()],this.model.currentSelection.withinOrg=!1,this.trigger("value-changed")},setMyOrg:function(e){this.model.currentSelection.entities=this.model.adminEntities,this.model.currentSelection.withinOrg=!0,this.trigger("value-changed")},showRolesDialog:function(t){var i=this,n=this.model.currentSelection.entities.filter(function(t){return t.type===e.ROLE}).map(function(e){return e.value});RolesDialog.getRoles(this.model.allowedRoles,n,this.model.currentSelection.withinOrg,this.model.enforceWithinOrg).done(function(e,t){i.model.currentSelection.entities=e.map(function(e){return new Entity.RoleEntity(e).toJSON()}),i.model.currentSelection.withinOrg=t,i.trigger("value-changed")})},showCustomDialog:function(e){var i=this;Z(this.model.id+"-vis-menu").zmenu("hide"),CustomDialog.getEntities(t.getAdminEntities(),i.model.currentSelection.entities,i.model.currentSelection.withinOrg,i.model.enforceWithinOrg).done(function(e,t){i.model.currentSelection.entities=e,i.model.currentSelection.withinOrg=t,i.trigger("value-changed")})},setDocOwner:function(t){this.model.currentSelection.entities=[new Entity.PredefinedGroupEntity(e.DOCOWNERS).toJSON()],this.model.currentSelection.withinOrg=!1,this.trigger("value-changed")},setOnlyMe:function(e){this.model.currentSelection.entities=[new Entity.ZuidEntity(editor.zuid).toJSON()],this.model.currentSelection.withinOrg=!1,this.trigger("value-changed")},initComponents:function(){var e=this;return this.$el.find(".js-vis-handle").zmenubutton({menuId:this.model.id+"-vis-menu",text:this.getDropdownLabel(),iconClassName:this.getDropdownIcon()}),this.$el.find("#"+this.model.id+"-vis-menu").zmenu({contentType:"icon-text",itemclick:this.onVisibilityOptionSelect.bind(this),width:300}).on("zmenubeforeshow",function(t,i){i.menu.find(".current-vis-setting-description").html(a(e.model.currentSelection.entities,e.model.currentSelection.withinOrg)),i.menu.find(".menu-item-icon").css("visibility","hidden"),i.menu.find(".menu-item-icon-"+e.getCurrentSelectedOption()).css("visibility","visible")}).on("click",".js-edit-entity-list",function(){e.showCustomDialog()}),this},compileTemplate:function(){return this.state.isTemplateCompiled||(this.tpl=Handlebars.compile(Z(this.tplId).html()),this.state.isTemplateCompiled=!0),this},renderIndication:function(){var e=this.$el.find(".js-vis-handle");e.zmenubutton("setAttribute","text",this.getDropdownLabel()),e.zmenubutton("setAttribute","iconClassName",this.getDropdownIcon()),e.attr("title",a(this.model.currentSelection.entities,this.model.currentSelection.withinOrg,!0))},updateModel:function(e){this.model.currentSelection.entities=e.entities,this.model.currentSelection.withinOrg=e.withinOrg,this.renderIndication()},render:function(){return this.compileTemplate(),this.$el.html(this.tpl(this.tplOptions)),this.renderIndication(),this}},{});return u}),CommentCreationView=function(e,t,i,n,o){var s=e.View.extend({el:"#postDialog",events:{"input #textarea":"autoHeightTextArea","keydown #textarea":"listenForKeyBoardShortcuts","click #comment-cancel-btn":"cancel","click #comment-add-btn":"done","focus #textarea":function(e){EventHandler.isDialogOpened=!0},"focusout #textarea":function(e){EventHandler.isDialogOpened=!1},"focus #cmnt-editor-container":function(e){EventHandler.isDialogOpened=!0},"focusout #cmnt-editor-container":function(e){EventHandler.isDialogOpened=!1}},tpl:Handlebars.compile(Z("commentdialog-view-4").html()),initialize:function(e){this.listenTo(this.model,"change:commentCreationDialogShow",this.setVisibility),this.listenTo(t.commentPane,"change:currentView",this.detach),this.listenTo(t.commentCollection,"reset",this.detach),Visibility.isEnabled()&&(this.visibilityView=new n({model:{id:"commentcreationview",currentSelection:{entities:Visibility.getDefaults().entities,withinOrg:Visibility.getDefaults().withinOrg},adminEntities:Visibility.getAdminEntities(),allowedRoles:Visibility.getAllowedRoles(),withinOrg:Visibility.getWithinOrg(),newtag:!0}})),this.render()},setVisibility:function(e,i,n){if(i){if(t.cursorSelection=CommentUtils.selectWord(),t.commentPane.set("noCommentsToShow",!1),CommentUtils.isReviewPaneVisible()){var o=CommentUtils.showDialogInCommentPane(this.$el);this.$el.addClass("ui-ncmt-container-selected"),o.then(CommentUtils.pullCommentInputIntoView)}else CommentUtils.showDialogInEditorPane(this.$el);var s=this;setTimeout(function(){t.isRichCommentsEnabled()?s.editorView.focus():this.$("#textarea").trigger("focus")},200)}else{var s=this;this.$el.slideUp(200,function(){s.$("#textarea").height(""),s.$("#textarea").val(""),s.$el.css("left","-10000px"),s.$el.detach().appendTo("body"),s.$el.css("display","none"),n.then&&n.then()}),this.$el.find(".ui-ncmt-container-div").removeClass("ui-ncmt-container-cmode"),this.$el.removeClass("ui-ncmt-container-selected"),Visibility.isEnabled()&&this.visibilityView.reset(),t.isRichCommentsEnabled()&&this.editorView.reset(),CommentUtils.isAnyCommentRenderedInPane()||t.commentPane.set("noCommentsToShow",!0),CommentUtils.hideCurrentCommentSelection(),t.cursorSelection.start=null,t.cursorSelection.end=null,EditorUtil.focusMultiByteSpan()}return this},autoHeightTextArea:function(e){CommentUtils.autoHeightTextArea(e)},listenForKeyBoardShortcuts:function(e){CommentUtils.doneKey(e,this.done,this),CommentUtils.cancelKey(e,this.handleEscKey.bind(this,e),this)},handleEscKey:function(e){if(t.isRichCommentsEnabled())this.editorView.isEmpty()&&this.cancel();else{if(this.$("#textarea").val().trim())return e.stopPropagation(),!1;this.cancel()}},cancel:function(){t.commentPane.set("commentCreationDialogShow",!1)},done:function(){var e,i;t.isRichCommentsEnabled()?(i=this.editorView.getJSON(),e=this.editorView.getText(i),this.editorView.reset()):e=this.$("#textarea").val();var n=CommentUtils.removeInvalidChars(e);if(""==n.trim())return!1;var o,s,r=editor.doc.getSelection();r.length>1?(s=r.getTargetRange(),o=s.end):o=r.getEnd();var m=t.cursorSelection.start,l=t.cursorSelection.end;CommentUtils.addParticipant();var a={text:n,doctext:editor.doc.getContent(m,l),reads:[editor.zuid]};if(Visibility.isEnabled()){var c=this.visibilityView.getValue();a.visibility=c}t.isRichCommentsEnabled()&&(a.richtext=i);var d=t.CommentCollection.createComment(a);t.commentCollection.addComment(d,!0,m,l),t.commentPane.set("commentCreationDialogShow",!1),editor.doc.getSelection().isCollapsed()||editor.doc.getCharAt(o-1)!=UNICODE.PARA||(o-=1);var u=o+2,r=editor.doc.getSelection(),h=editor.doc.createRange(u);r.setSelectionType(SEL_KEYBOARD).removeAllRanges().addRange(h),EditorUtil.focusMultiByteSpan()},focus:function(){t.isRichCommentsEnabled()?this.editorView.focus():this.$("#textarea").trigger("focus")},detach:function(){this.$el.detach()},onKeyPress:function(e){CommentUtils.doneKey(e,function(){this.done(),ActivityTracker.trackInAnalytics("Comment","AddComment","Shortcut")},this),CommentUtils.cancelKey(e,this.handleEscKey.bind(this,e),this)},initEditor:function(){var e=this.$el.find("#cmnt-editor-container")[0],t=J.i18n(UIUtils.getUIText("ENTER_COMMENT")),i=!0,n=this.model.id,s=this.onKeyPress.bind(this),r="ui-insert-comnt-editor",m=o.getRichTextOptions(t,n,i,s,r);return RichTextEditor.init(e,m)},render:function(){var e={};e.zuid=editor.zuid,e.userImg=ZWNetworkUtils.getUserImageURL(editor.zuid),e.colorCode=ReviewUtil.getUserColour(e.zuid),t.isRichCommentsEnabled()&&(e.isZohoCorpUser=!0);var i=this.tpl(e);return this.$el.html(i),Visibility.isEnabled()&&this.$el.find(".js-visibility-container").html(this.visibilityView.render().initComponents().$el),CommentUtils.initActivityTracking(this.$el[0]),t.isRichCommentsEnabled()&&(ZWRichTextEditor.subscribeProofingEvents(),this.editorView=this.initEditor(),this.editorView.editorView.dom.addEventListener("linkInputOpen",function(){this.$el.find("#comment-add-btn").addClass("ui-zwdisabled"),this.$el.find("#comment-cancel-btn").addClass("ui-zwdisabled")}.bind(this)),this.editorView.editorView.dom.addEventListener("linkInputClose",function(){this.$el.find("#comment-add-btn").removeClass("ui-zwdisabled"),this.$el.find("#comment-cancel-btn").removeClass("ui-zwdisabled")}.bind(this)),PubSub.subscribe(["Document/ScrollEvent","Commentpane/ScrollEvent"],function(){this.editorView.handleScroll()}.bind(this))),this.$("#textarea").atMention(),this}});return s}(Backbone,CommentModels,jQuery,VisibilityDropdownView,CommentRTE),ReplyCommentView=function(e,t,i,n){var o=e.View.extend({tagName:"div",commentTpl:Handlebars.compile(Z("reply-comment-view-4").html()),mixins:[CommentMixins.WillShowEditHint,CommentMixins.ReactsToReadOnly,CommentMixins.SupportsEllipsize(!0),CommentMixins.ReactToFailedComments],initialize:function(e){this.listenTo(this.model,"change:isShowingMenu",this.setMenuVisibility),this.listenTo(this.model,"change:inEditingMode",this.setEditMode),this.listenTo(this.model,"change:text",this.updateCommentContent),this.listenTo(this.model,"change:failedOps",this.updateErrorUI),this.listenTo(this.model,"change:syncing",this.updateSaveState),this.likeView=new LikeView({model:this.model}),this.errorHint=new CommentErrorHint({model:this.model})},events:{mouseover:"showOnMouseOver",mouseout:"hideOnMouseOut","click .reply-comment-container":function(){this.model.set("isShowingMenu",!1)},"mouseover .reply-comment-container":function(){!this.model.get("parentComment").get("isResolved")&&this.$(".child-comnt-options").show()},"mouseout .reply-comment-container":function(){!this.model.get("isShowingMenu")&&this.$(".child-comnt-options").hide()},"click .js-replycomment-menudropdown-handle":"displayMenu","click .js-replycomment-menuoption-edit":"initEditMode","click .js-replycomment-menuoption-delete":"showDeleteConfirmation","click .js-replycomment-delete-cancel":"hideDeleteConfirmation","click .js-replycomment-delete-confirm":"initDelete","keyup .js-replycomment-edit-textarea":"autoHeightTextArea","keydown .js-replycomment-edit-textarea":"listenForKeyBoardShortcuts","click .js-replycomment-edit-btn":"edit","click .js-replycomment-edit-cancel-btn":"cancelEditMode","focus .js-replycomment-edit-textarea":function(e){EventHandler.isDialogOpened=!0},"focusout .js-replycomment-edit-textarea":function(e){EventHandler.isDialogOpened=!1},"focus .js-replycomment-edit-editor":function(e){EventHandler.isDialogOpened=!0},"focusout .js-replycomment-edit-editor":function(e){EventHandler.isDialogOpened=!1}},editables:[".js-replycomment-menuoption-edit",".js-replycomment-menuoption-delete",".js-child-like-container"],displayMenu:function(e){this.model.set("isShowingMenu",!0),this.stopPropagation(e)},updateErrorUI:function(){var e=this.model.get("failedOps").length>0;e?(this.errorHint.setElement(this.$(".js-error-hint-container-reply")).render(),this.$(".js-error-hint-container-reply").slideDown()):this.$(".js-error-hint-container-reply").hide()},setMenuVisibility:function(e,t,i){t?(this.$(".child-menu").show(),this.$(".child-menudropdown-handle").addClass("ui-comnt-edt-options-active")):(this.$(".child-menu").hide(),this.$(".child-menudropdown-handle").removeClass("ui-comnt-edt-options-active"))},updateSaveState:function(e,t){var i=this.model.get("activityLog").filter(function(e){return e.get("action")===CommentModels.ACTIVITYLOG.EDIT}).length;t?(this.$(".ui-ncmt-child .js-syncing-status-text").show(),this.$(".ui-ncmt-child .js-syncing-status-dynamic-time").hide(),this.$(".ui-ncmt-child .js-syncing-status-reply-edits-container").hide()):(this.$(".ui-ncmt-child .js-syncing-status-text").hide(),this.$(".ui-ncmt-child .js-syncing-status-dynamic-time").show(),i&&this.$(".ui-ncmt-child .js-syncing-status-reply-edits-container").show())},autoHeightTextArea:function(e){CommentUtils.autoHeightTextArea(e)},listenForKeyBoardShortcuts:function(e){CommentUtils.doneKey(e,this.edit,this),CommentUtils.cancelKey(e,this.cancelEditMode,this)},initEditMode:function(){this.model.set("inEditingMode",!0),this.model.set("isShowingMenu",!1)},showDeleteConfirmation:function(){this.$(".ui-delete-comment-child").show()},hideDeleteConfirmation:function(){this.$(".ui-delete-comment-child").hide()},editModeOnKeyPress:function(e){CommentUtils.doneKey(e,function(){this.edit(),ActivityTracker.trackInAnalytics("Comment","EditReply","Shortcut")},this),CommentUtils.cancelKey(e,this.cancelEditMode,this)},_handleScrollForEditEditor:function(){this.editEditor.handleScroll()},initEditEditor:function(e){var t=e.get("richtext"),i=this.$el.find("#edit-replycmnt-editor-container")[0],o=J.i18n("writer.common.REPLY_HERE"),s=!0,r=this.editModeOnKeyPress.bind(this),m=this.model.get("parentId"),l=t||this.model.get("text"),a="ui-insert-comnt-editor",c=n.getRichTextOptions(o,m,s,r,a,l);return RichTextEditor.init(i,c)},setEditMode:function(e,i,n){if(i){if(this.$(".js-child-text-container").hide(),this.$(".child-edit-cont").show(),this.$(".ui-ncmt-footer").hide(),t.isRichCommentsEnabled())this.editEditor=this.initEditEditor(e),this.editEditor.editorView.dom.addEventListener("linkInputOpen",function(){this.$el.find(".ui-comment-add-btn").addClass("ui-zwdisabled"),this.$el.find(".ui-comment-cancel-btn").addClass("ui-zwdisabled")}.bind(this)),this.editEditor.editorView.dom.addEventListener("linkInputClose",function(){this.$el.find(".ui-comment-add-btn").removeClass("ui-zwdisabled"),this.$el.find(".ui-comment-cancel-btn").removeClass("ui-zwdisabled")}.bind(this)),PubSub.subscribe(["Document/ScrollEvent","Commentpane/ScrollEvent"],this._handleScrollForEditEditor,{context:this}),this.editEditor.focus();else{var o=this.model.get("text");this.$(".js-replycomment-edit-textarea").val(o)}this.$(".ui-toggle-replycomment-height").hide(),CommentUtils.updateTextAreaHeight(this.$(".js-replycomment-edit-textarea")[0]),this.$(".js-replycomment-edit-textarea").trigger("focus")}else t.isRichCommentsEnabled()&&this.editEditor&&(PubSub.unsubscribe(["Document/ScrollEvent","Commentpane/ScrollEvent"],this._handleScrollForEditEditor,{context:this}),this.editEditor.remove(),delete this.editEditor),this.$(".js-child-text-container").show(),this.$(".child-edit-cont").hide(),this.$(".ui-ncmt-footer").show()},edit:function(){var e,i;if(t.isRichCommentsEnabled()){if(i=this.editEditor.getJSON(),e=this.editEditor.getText(i),""==e.trim()||JSON.stringify(i)==JSON.stringify(this.model.get("richtext")))return this.model.set("inEditingMode",!1),!1}else if(e=CommentUtils.removeInvalidChars(this.$(".js-replycomment-edit-textarea").val()),""==e.trim()||e==this.model.get("text"))return this.model.set("inEditingMode",!1),!1;this.model.set("inEditingMode",!1),this.model.get("parentComment").editReplyComment(this.model,e,i,!0)},updateCommentContent:function(e,i,o){if(t.isRichCommentsEnabled()&&e.get("richtext"))this.$(".js-child-text-container").html(RichTextEditor.getHTML(e.get("richtext"),n.getDefaultRichTextOptionsForRendering()));else{var i=e.get("text");this.$(".js-child-text-container").html(CommentUtils.getMarkedupCommentContent(Utils.encodeHTMLString(i)))}},cancelEditMode:function(){this.model.set("inEditingMode",!1)},initDelete:function(){var e=this;this.$el.slideUp(200,function(){e.model.get("parentComment").removeReplyComment(e.model,!0)})},delete:function(e){},stopPropagation:function(e){e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault()},showOnMouseOver:function(){this.$(".show-on-hover").show()},hideOnMouseOut:function(){this.$(".show-on-hover").hide()},render:function(){var e=this.model.attributes,i=editor.zuid===e.zuid;e.showDelete=CommentUtils.canDelete(i),e.showEdit=CommentUtils.canEdit(i),e.canShowOptions=e.showDelete||e.showEdit,e.colorCode=ReviewUtil.getUserColour(e.zuid),e.currentUserColorCode=ReviewUtil.getUserColour(editor.zuid),e.isEdited=this.model.get("activityLog").filter(function(e){return e.get("action")===CommentModels.ACTIVITYLOG.EDIT}).length;var o=e.richtext&&Object.keys(e.richtext).length;if(t.isRichCommentsEnabled()&&o){try{e.RTEHtml=RichTextEditor.getHTML(e.richtext,n.getDefaultRichTextOptionsForRendering())}catch(e){CommentUtils.sendRTEErrorLog(e),this.model.set("richtext",null)}e.isZohoCorpUser=!0}else t.isRichCommentsEnabled()&&!o?e.isZohoCorpUser=!0:e.isZohoCorpUser=!1;return this.$el.html(this.commentTpl(e)),this.$(".js-child-like-container").html(this.likeView.render().$el),this.$(".enable-atmentions").atMention({commentId:this.model.get("parentId")}),CommentUtils.initComponents(this.$el),this.trigger("rendered"),this.updateErrorUI(),this.hideOnMouseOut(),this}});return o}(Backbone,CommentModels,jQuery,CommentRTE),ReplyCommentBubbleView=function(e,t,i,n){var o=e.View.extend({tagName:"div",mixins:[CommentMixins.WillShowEditHint,CommentMixins.ReactsToReadOnly,CommentMixins.SupportsEllipsize(!0),CommentMixins.ReactToFailedComments],commentTpl:Handlebars.compile(Z("reply-comment-bubble-view-4").html()),initialize:function(e){this.listenTo(this.model,"change:text",this.updateCommentContent),this.listenTo(this.model,"change:inEditingMode",this.setEditMode),this.listenTo(this.model.get("parentComment"),"bubbleOpened",this.initEditRTE),this.listenTo(this.model.get("parentComment"),"bubbleClosed",this.destroyEditEditor),this.listenTo(this.model,"change:syncing",this.updateSaveState),this.likeView=new LikeView({model:this.model})},events:{"click .js-replycomment-menuoption-edit":"initEditMode","click .js-replycomment-menuoption-delete":"showDeleteConfirmation","click .js-replycomment-delete-cancel":"hideDeleteConfirmation","click .js-replycomment-delete-confirm":"initDelete","keyup .js-replycomment-edit-textarea":"autoHeightTextArea","keydown .js-replycomment-edit-textarea":"listenForKeyBoardShortcuts","click .js-replycomment-edit-btn":"edit","click .js-replycomment-edit-cancel-btn":"cancelEditMode","focus .js-replycomment-edit-textarea":function(e){EventHandler.isDialogOpened=!0},"focusout .js-replycomment-edit-textarea":function(e){EventHandler.isDialogOpened=!1},"focus .js-replycomment-edit-editor":function(e){EventHandler.isDialogOpened=!0},"focusout .js-replycomment-edit-editor":function(e){EventHandler.isDialogOpened=!1}},editables:[".js-replycomment-menuoption-edit",".js-replycomment-menuoption-delete",".js-child-like-container"],initDelete:function(){var e=this;this.$el.slideUp(200,function(){e.model.get("parentComment").removeReplyComment(e.model,!0)})},showDeleteConfirmation:function(){this.$(".ui-delete-comment-child").show()},hideDeleteConfirmation:function(){this.$(".ui-delete-comment-child").hide()},autoHeightTextArea:function(e){CommentUtils.autoHeightTextArea(e)},listenForKeyBoardShortcuts:function(e){CommentUtils.doneKey(e,this.edit,this),CommentUtils.cancelKey(e,this.cancelEditMode,this)},initEditMode:function(){this.model.set("inEditingMode",!0),this.model.set("isShowingMenu",!1)},updateSaveState:function(e,t){var i=this.model.get("activityLog").filter(function(e){return e.get("action")===CommentModels.ACTIVITYLOG.EDIT}).length;t?(this.$(".ui-ncmt-child .js-syncing-status-text").show(),this.$(".ui-ncmt-child .js-syncing-status-dynamic-time").hide(),this.$(".ui-ncmt-child .js-syncing-status-reply-edits-container").hide()):(this.$(".ui-ncmt-child .js-syncing-status-text").hide(),this.$(".ui-ncmt-child .js-syncing-status-dynamic-time").show(),i&&this.$(".ui-ncmt-child .js-syncing-status-reply-edits-container").show())},editModeOnKeyPress:function(e){CommentUtils.doneKey(e,function(){this.edit(),ActivityTracker.trackInAnalytics("Comment","EditReply","Shortcut")},this),CommentUtils.cancelKey(e,this.cancelEditMode,this)},initEditEditor:function(e){var t=e.get("richtext"),i=this.$el.find("#edit-replycmntbbl-editor-container")[0],o=J.i18n("writer.common.REPLY_HERE"),s=!0,r=this.editModeOnKeyPress.bind(this),m=this.model.get("parentId"),l=t||this.model.get("text"),a="ui-insert-comnt-editor",c=n.getRichTextOptions(o,m,s,r,a,l);return RichTextEditor.init(i,c)},destroyEditEditor:function(){this.editEditor&&(PubSub.unsubscribe(["Document/ScrollEvent","Commentpane/ScrollEvent"],this._handleScrollForEditEditor,{context:this}),this.editEditor.remove(),delete this.editEditor)},initEditRTE:function(){t.isRichCommentsEnabled()&&this.model.get("inEditingMode")&&this.setEditModeForRTE()},setEditMode:function(e,i,n){if(i){if(this.$(".js-child-text-container").hide(),this.$(".child-edit-cont").show(),this.$(".ui-ncmt-footer").hide(),t.isRichCommentsEnabled()&&!CommentUtils.isReviewPaneVisible())this.setEditModeForRTE();else if(!t.isRichCommentsEnabled()){var o=this.model.get("text");this.$(".js-replycomment-edit-textarea").val(o)}CommentUtils.updateTextAreaHeight(this.$(".js-replycomment-edit-textarea")[0]),this.$(".js-replycomment-edit-textarea").trigger("focus")}else t.isRichCommentsEnabled()&&this.editEditor&&this.destroyEditEditor(),this.$(".js-child-text-container").show(),this.$(".child-edit-cont").hide(),this.$(".ui-ncmt-footer").show()},edit:function(){var e,i;if(t.isRichCommentsEnabled()){if(i=this.editEditor.getJSON(),e=this.editEditor.getText(i),""==e.trim()||JSON.stringify(i)==JSON.stringify(this.model.get("richtext")))return this.model.set("inEditingMode",!1),!1}else if(e=CommentUtils.removeInvalidChars(this.$(".js-replycomment-edit-textarea").val()),""==e.trim()||e==this.model.get("text"))return this.model.set("inEditingMode",!1),!1;this.model.set("inEditingMode",!1),this.model.get("parentComment").editReplyComment(this.model,e,i,!0)},updateCommentContent:function(e,i,o){if(t.isRichCommentsEnabled()&&e.get("richtext"))this.$(".js-child-text-container").html(RichTextEditor.getHTML(e.get("richtext"),n.getDefaultRichTextOptionsForRendering()));else{var i=e.get("text");this.$(".js-child-text-container").html(CommentUtils.getMarkedupCommentContent(Utils.encodeHTMLString(i)))}},_handleScrollForEditEditor:function(){this.editEditor.handleScroll()},setEditModeForRTE:function(){t.isRichCommentsEnabled()&&!this.editEditor&&(this.editEditor=this.initEditEditor(this.model),this.editEditor.editorView.dom.addEventListener("linkInputOpen",function(){this.$el.find(".ui-comment-add-btn").addClass("ui-zwdisabled"),this.$el.find(".ui-comment-cancel-btn").addClass("ui-zwdisabled")}.bind(this)),this.editEditor.editorView.dom.addEventListener("linkInputClose",function(){this.$el.find(".ui-comment-add-btn").removeClass("ui-zwdisabled"),this.$el.find(".ui-comment-cancel-btn").removeClass("ui-zwdisabled")}.bind(this)),PubSub.subscribe(["Document/ScrollEvent","Commentpane/ScrollEvent"],this._handleScrollForEditEditor,{context:this}),CommentUtils.isReviewPaneVisible()||this.editEditor.focus())},cancelEditMode:function(){this.model.set("inEditingMode",!1)},render:function(){var e=this.model.attributes,i=editor.zuid===e.zuid;e.showDelete=CommentUtils.canDelete(i),e.showEdit=i,e.canShowOptions=e.showDelete||e.showEdit,e.colorCode=ReviewUtil.getUserColour(e.zuid),e.currentUserColorCode=ReviewUtil.getUserColour(editor.zuid);var o=e.richtext&&Object.keys(e.richtext).length;if(t.isRichCommentsEnabled()&&o){try{e.RTEHtml=RichTextEditor.getHTML(e.richtext,n.getDefaultRichTextOptionsForRendering())}catch(e){CommentUtils.sendRTEErrorLog(e),this.model.set("richtext",null)}e.isZohoCorpUser=!0}else t.isRichCommentsEnabled()&&!o?e.isZohoCorpUser=!0:e.isZohoCorpUser=!1;return this.$el.html(this.commentTpl(e)),this.$(".js-child-like-container").html(this.likeView.render().$el),this.$(".enable-atmentions").atMention({commentId:this.model.get("parentId")}),this.trigger("rendered"),this}});return o}(Backbone,CommentModels,jQuery,CommentRTE),ReplyCommentCollectionView=function(e,t,i,n){var o=t.View.extend({tagName:"div",initialize:function(e){this.parentCommentObj=e.parentComment,this.activityLog=this.parentCommentObj.get("activityLog"),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.activityLog,"add",this.render),this.listenTo(this.collection,"remove",this.removeComment)},commentViewMap:{},resolveTpl:Handlebars.compile(Z("resolve-view-4").html()),reopenTpl:Handlebars.compile(Z("reopen-view-4").html()),resolveArg1Tpl:Handlebars.compile('<b style="text-transform:capitalize;"> {{ getUsername zuid userName }} </b><span style="text-transform:lowercase;">'),resolveArg2Tpl:Handlebars.compile('</span><b class="ui-clr-blue">'),resolveArg3Tpl:Handlebars.compile('</b><b style="text-transform:lowercase;white-space: nowrap;" title="{{zwdatetime time}} "> {{zwtimeAgo time}} </b>'),reopenArg1Tpl:Handlebars.compile('<b style="text-transform:capitalize;"> {{ getUsername zuid userName }} </b><b class="ui-clr-blue">'),reopenArg2Tpl:Handlebars.compile("</b><span>"),reopenArg3Tpl:Handlebars.compile('</span><b style="text-transform:lowercase;white-space: nowrap;" title="{{zwdatetime time}}">{{zwtimeAgo time}}</b>'),removeComment:function(e,t){var i=this.commentViewMap[e.id];i&&i.remove(),delete this.commentViewMap[e.id]},renderLog:function(t){if(t.get("action")==i.ACTIVITYLOG.REPLY_ADD){var n=this.collection.get(t.get("commentId"));n&&(replyCommentView=new e({model:n}),this.commentViewMap[n.id]&&this.commentViewMap[n.id].remove(),this.commentViewMap[n.id]=replyCommentView,this.$el.append(replyCommentView.render().$el))}else if(t.get("action")==i.ACTIVITYLOG.RESOLVE){var o=this.resolveArg1Tpl(t.attributes),s=this.resolveArg2Tpl(),r=this.resolveArg3Tpl(t.attributes),m=J.i18n("writer.common.MARKED_AS_RESOLVED",[o,s,r]);this.$el.append(this.resolveTpl({text:m}))}else if(t.get("action")==i.ACTIVITYLOG.REOPEN){var o=this.reopenArg1Tpl(t.attributes),s=this.reopenArg2Tpl(),r=this.reopenArg3Tpl(t.attributes),m=J.i18n("writer.common.REOPENED_CONVERSATION",[o,s,r]);this.$el.append(this.reopenTpl({text:m}))}CommentUtils.initComponents(this.$el)},render:function(){var e=this;return this.$el.empty(),this.activityLog.each(function(t){t.get("activityId")&&e.renderLog(t)}),CommentUtils.initActivityTracking(this.$el[0]),this}});return o}(ReplyCommentView,Backbone,CommentModels,jQuery),ReplyCommentCollectionBubbleView=function(e,t,i,n){var o=t.View.extend({tagName:"div",initialize:function(e){this.parentCommentObj=e.parentComment,this.activityLog=this.parentCommentObj.get("activityLog"),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.activityLog,"add",this.render),this.listenTo(this.collection,"remove",this.removeComment)},commentViewMap:{},resolveTpl:Handlebars.compile(Z("resolve-bubble-view-4").html()),reopenTpl:Handlebars.compile(Z("reopen-bubble-view-4").html()),resolveArg1Tpl:Handlebars.compile('<b style="text-transform:capitalize;"> {{ getUsername zuid userName }} </b><span style="text-transform:lowercase;">'),resolveArg2Tpl:Handlebars.compile('</span><b class="ui-clr-blue">'),resolveArg3Tpl:Handlebars.compile('</b><b style="text-transform:lowercase;white-space: nowrap;" title="{{zwdatetime time}}"> {{zwtimeAgo time}} </b>'),reopenArg1Tpl:Handlebars.compile('<b style="text-transform:capitalize;"> {{ getUsername zuid userName }} </b><b class="ui-clr-blue">'),reopenArg2Tpl:Handlebars.compile("</b><span>"),reopenArg3Tpl:Handlebars.compile('</span><b style="text-transform:lowercase;white-space: nowrap;" title="{{zwdatetime time}}">{{zwtimeAgo time}}</b>'),removeComment:function(e,t){var i=this.commentViewMap[e.id];i&&i.remove(),delete this.commentViewMap[e.id]},renderLog:function(t){if(t.get("action")==i.ACTIVITYLOG.REPLY_ADD){var n=this.collection.get(t.get("commentId"));n&&(replyCommentView=new e({model:n}),this.commentViewMap[n.id]=replyCommentView,this.$el.append(replyCommentView.render().$el))}else if(t.get("action")==i.ACTIVITYLOG.RESOLVE){var o=this.resolveArg1Tpl(t.attributes),s=this.resolveArg2Tpl(),r=this.resolveArg3Tpl(t.attributes),m=J.i18n("writer.common.MARKED_AS_RESOLVED",[o,s,r]);this.$el.append(this.resolveTpl({text:m}))}else if(t.get("action")==i.ACTIVITYLOG.REOPEN){var o=this.reopenArg1Tpl(t.attributes),s=this.reopenArg2Tpl(),r=this.reopenArg3Tpl(t.attributes),m=J.i18n("writer.common.REOPENED_CONVERSATION",[o,s,r]);this.$el.append(this.reopenTpl({text:m}))}},render:function(){var e=this;return this.$el.empty(),this.activityLog.each(function(t){t.get("activityId")&&e.renderLog(t)}),CommentUtils.initActivityTracking(this.$el[0]),this}});return o}(ReplyCommentBubbleView,Backbone,CommentModels,jQuery),CommentView=function(e,t,i,n,o,s){var r=t.View.extend({tagName:"div",mixins:[CommentMixins.WillShowEditHint,CommentMixins.ReactsToReadOnly,CommentMixins.SupportsEllipsize(),CommentMixins.SupportsLink,CommentMixins.ReactToFailedComments],events:{"click .ui-ncmt-container":"initFocus","click .js-comment-reply-add":"addReply","click .js-comment-reply-cancel":"cancelReply","keydown .js-comment-reply-textarea":"listenForKeyBoardShortcuts","input .js-comment-reply-textarea":"autoHeightTextArea","click .js-comment-menudropdown-handle":"displayMenu","click .js-comment-menuoption-edit":"initEditMode","click .js-comment-edit-btn":"edit","click .js-comment-edit-cancel-btn":"cancelEditMode","click .js-comment-menuoption-resolve":"initResolve","click .js-comment-menuoption-reopen":"initReopen","click .js-comment-menuoption-delete":"showDeleteConfirmation","click .js-comment-menuoption-markunread":"markAsUnread","click .js-comment-delete-cancel":"hideDeleteConfirmation","click .js-comment-delete-confirm":"initDelete","input .js-comment-edit-textarea":"autoHeightTextArea","keydown .js-comment-edit-textarea":"listenForKeyBoardShortcuts","click .js-hide-replies-btn":"hideReplies","click .js-show-replies-btn":"showReplies","click .js-reply-comment-trigger-btn":"showReplyTextArea","click .js-new-reply-view":"stopPropagation","click .prosemirror-mention-node":"showProfileCard","focus .js-comment-edit-textarea":function(e){EventHandler.isDialogOpened=!0},"focusout .js-comment-edit-textarea":function(e){EventHandler.isDialogOpened=!1},"focus .js-comment-reply-textarea":function(e){EventHandler.isDialogOpened=!0},"focusout .js-comment-reply-textarea":function(e){EventHandler.isDialogOpened=!1},"focus .js-comment-edit-editor":function(e){EventHandler.isDialogOpened=!0},"focusout .js-comment-edit-editor":function(e){EventHandler.isDialogOpened=!1},"focus .js-comment-reply-editor":function(e){EventHandler.isDialogOpened=!0},"focusout .js-comment-reply-editor":function(e){EventHandler.isDialogOpened=!1},"focus .js-comment-reply-hidden-textarea":"focusReply"},editables:[".js-resolve-reopen-container",".js-comment-menuoption-edit",".js-comment-menuoption-delete",".js-follow-container",".js-like-container",".js-comment-menudropdown-handle",".js-visibility-container"],initialize:function(t){var n=this;if(this.replyCommentCollection=this.model.get("children"),this.replyCommentCollectionView=new e({collection:this.replyCommentCollection,parentComment:this.model}),this.likeView=new LikeView({model:this.model}),this.followView=new FollowView({model:this.model}),this.errorHint=new CommentErrorHint({model:this.model}),Visibility.isEnabled()){var o=this.getVisibilityViewOptions();this.visibilityView=new VisibilityDropdownView(o),this.visibilityView.on("value-changed",function(){n.model.setVisibility(n.visibilityView.getValue(),!0)})}this.listenTo(this.model,"change:inFocus",this.focusComment),this.listenTo(this.model.get("activityLog"),"add",this.displayReplyListToggle),this.listenTo(this.model.get("activityLog"),"add remove",this.updateCountsInReplyListToggle),this.listenTo(this.model.get("children"),"remove",this.hideReplyListToggle),this.listenTo(this.model,"change:inDisplay",this.setVisibility),this.listenTo(this.model,"change:isShowingMenu",this.setMenuVisibility),this.listenTo(this.model,"change:inEditingMode",this.setEditMode),this.listenTo(this.model,"change:text",this.updateCommentContent),this.listenTo(this.model,"change:isResolved",this.updateResolvedStateUI),this.listenTo(this.model,"change:unread",this.updateUnreadStateUI),this.listenTo(this.model,"change:isRangeCharsRendered",this.setUnlinkedStatus),this.listenTo(i.commentPane,"change:isReadOnly",this.setReplyTextareaVisibility),this.listenTo(this.model,"change:failedOps",this.updateErrorUI),this.listenTo(this.model,"change:syncing",this.updateSaveState),Visibility.isEnabled()&&this.listenTo(this.model,"change:visibility",this.updateVisibilityUI),J("body").click(function(e){n.model.set("isShowingMenu",!1)})},commentTpl:Handlebars.compile(Z("comment-view-4").html()),showProfileCard:function(e){var t=this.$(e.target).data("mentionZuid");return UIUtils.showProfileInfoEvent(e,t),!1},listenForKeyBoardShortcuts:function(e){this.$(e.target).hasClass("reply-textarea")?(CommentUtils.doneKey(e,this.addReply,this),CommentUtils.cancelKey(e,this.handleEscKey.bind(this,e),this)):(CommentUtils.doneKey(e,this.edit,this),CommentUtils.cancelKey(e,this.cancelEditMode,this))},handleEscKey:function(e){if(i.isRichCommentsEnabled())this.replyEditor.isEmpty()&&this.cancelReply();else{var t=this.$(e.target);if(t.val().trim())return e.stopPropagation(),!1;this.cancelReply()}},updateErrorUI:function(){var e=this.model.get("failedOps").length>0;e?(this.errorHint.setElement(this.$(".js-error-hint-container-parent")).render(),this.$(".js-error-hint-container-parent").slideDown()):this.$(".js-error-hint-container-parent").hide()},setReplyTextareaVisibility:function(){var e=i.commentPane.get("isReadOnly");e&&this.$(".js-new-reply-view").hide()},updateVisibilityUI:function(){this.visibilityView.updateModel(this.model.get("visibility"))},updateSaveState:function(e,t){var i=this.model.get("activityLog").filter(function(e){return e.get("action")===CommentModels.ACTIVITYLOG.EDIT}).length;t?(this.$(".ui-ncmt-parent .js-syncing-status-text").show(),this.$(".ui-ncmt-parent .js-syncing-status-dynamic-time").hide(),this.$(".ui-ncmt-parent .js-syncing-status-edits-container").hide(),this.$(".ui-ncmt-parent .js-syncing-status-comment").hide()):(this.$(".ui-ncmt-parent .js-syncing-status-text").hide(),this.$(".ui-ncmt-parent .js-syncing-status-dynamic-time").show(),this.$(".ui-ncmt-parent .js-syncing-status-comment").show(),i&&this.$(".ui-ncmt-parent .js-syncing-status-edits-container").show())},getVisibilityViewOptions:function(){var e={model:{id:"comment-"+this.model.id,currentSelection:{},adminEntities:Visibility.getAdminEntities(),allowedRoles:Visibility.getAllowedRoles(),withinOrg:Visibility.getWithinOrg(),readonly:editor.zuid!=this.model.get("zuid")}};if(this.model.getVisibility())e.model.currentSelection={entities:this.model.getVisibility().entities,withinOrg:this.model.getVisibility().withinOrg};else if(!this.model.getVisibility()){var t=new Entity.PredefinedGroupEntity(o.EVERYONE);e.model.currentSelection={entities:[t.toJSON()],withinOrg:!1}}return e},initResolve:function(e){this.model.resolve(!0),this.stopPropagation(e)},initReopen:function(e){this.model.reopen(!0),this.showReplies(),this.stopPropagation(e)},initEditMode:function(e){this.model.set("inEditingMode",!0)},cancelEditMode:function(){this.model.set("inEditingMode",!1)},editModeOnKeyPress:function(e){CommentUtils.doneKey(e,function(){this.edit(),ActivityTracker.trackInAnalytics("Comment","EditComment","Shortcut")},this),CommentUtils.cancelKey(e,this.cancelEditMode,this)},replyModeOnKeyPress:function(e){CommentUtils.doneKey(e,function(){this.addReply(),ActivityTracker.trackInAnalytics("Comment","AddReply","Shortcut")},this),CommentUtils.cancelKey(e,this.handleEscKey.bind(this,e),this)},initEditEditor:function(e){var t=e.get("richtext"),i=this.$el.find("#cmnt-editor-container-edit")[0],n=J.i18n(UIUtils.getUIText("ENTER_COMMENT")),o=!0,r=this.editModeOnKeyPress.bind(this),m=this.model.id,l=t||this.model.get("text"),a="ui-insert-comnt-editor",c=s.getRichTextOptions(n,m,o,r,a,l);return RichTextEditor.init(i,c)},setEditMode:function(e,t,n){if(t){if(e.get("children").each(function(e){e.set("inEditingMode",!1)}),this.$(".js-parent-text-container").hide(),this.$(".parent-edit-cont").show(),this.$(".ui-ncmt-footer").hide(),i.isRichCommentsEnabled())this.editEditor=this.initEditEditor(e),this.editEditor.editorView.dom.addEventListener("linkInputOpen",function(){this.$el.find(".ui-comment-add-btn").addClass("ui-zwdisabled"),this.$el.find(".ui-comment-cancel-btn").addClass("ui-zwdisabled")}.bind(this)),this.editEditor.editorView.dom.addEventListener("linkInputClose",function(){this.$el.find(".ui-comment-add-btn").removeClass("ui-zwdisabled"),this.$el.find(".ui-comment-cancel-btn").removeClass("ui-zwdisabled")}.bind(this)),PubSub.subscribe(["Document/ScrollEvent","Commentpane/ScrollEvent"],this._handleScrollForEditEditor,{context:this}),this.editEditor.focus();else{var o=this.model.get("text");this.$(".js-comment-edit-textarea").val(o)}CommentUtils.updateTextAreaHeight(this.$(".js-comment-edit-textarea")[0]),this.$(".ui-toggle-comment-height").hide(),i.isRichCommentsEnabled()||this.$(".js-comment-edit-textarea").trigger("focus")}else i.isRichCommentsEnabled()&&this.editEditor&&(PubSub.unsubscribe(["Document/ScrollEvent","Commentpane/ScrollEvent"],this._handleScrollForEditEditor,{context:this}),this.editEditor.remove(),delete this.editEditor),this.$(".js-parent-text-container").show(),this.$(".parent-edit-cont").hide(),this.$(".ui-ncmt-footer").show()},edit:function(){var e,t;if(i.isRichCommentsEnabled()){if(t=this.editEditor.getJSON(),e=this.editEditor.getText(t),""==e.trim()||JSON.stringify(t)==JSON.stringify(this.model.get("richtext")))return this.model.set("inEditingMode",!1),!1}else if(e=CommentUtils.removeInvalidChars(this.$(".js-comment-edit-textarea").val()),""==e.trim()||e==this.model.get("text"))return this.model.set("inEditingMode",!1),!1;this.model.set("inEditingMode",!1),this.model.edit(e,t,!0)},updateCommentContent:function(e,t,n){if(i.isRichCommentsEnabled()&&e.get("richtext"))this.$(".js-parent-text-container").html(RichTextEditor.getHTML(e.get("richtext"),s.getDefaultRichTextOptionsForRendering()));else{var t=e.get("text");this.$(".js-parent-text-container").html(CommentUtils.getMarkedupCommentContent(Utils.encodeHTMLString(t)))}},updateResolvedStateUI:function(e,t,i){var n=CommentUtils.canResolve();t?(n&&(this.$(".js-comment-menuoption-resolve").hide(),this.$(".js-comment-menuoption-reopen").show()),this.$(".parent-comnt-options").hide(),this.$(".js-resolve-mark").show(),CommentUtils.resolveHighlights(e.id),this.hideReplies(),this.hideReplyTextArea()):(n&&(this.$(".js-comment-menuoption-resolve").show(),this.$(".js-comment-menuoption-reopen").hide()),this.$(".parent-comnt-options").show(),this.$(".js-resolve-mark").hide(),CommentUtils.unresolveHighlights(e.id),this.showReplies())},showDeleteConfirmation:function(){this.$(".ui-delete-comment-child").hide(),this.$(".ui-delete-comment-parent").show()},hideDeleteConfirmation:function(){this.$(".ui-delete-comment-child").hide(),this.$(".ui-delete-comment-parent").hide(),EditorUtil.focusMultiByteSpan()},initDelete:function(e){var t=this;this.$el.slideUp(200,function(){t.model.collection.removeComment(t.model,!0),CommentUtils.removeFocusLine()}),EditorUtil.focusMultiByteSpan()},initFocus:function(e){if(this.model.get("inFocus")){var t=this;if(CommentModelManager.isLinkedComment(t.model.id)){var i=CommentUtils.pullCommentedDoctextIntoView(t.model.id);i&&i.promise().then(function(){CommentUtils.drawFocusLine(t.model.id)})}else CommentUtils.drawFocusLine(t.model.id)}this.model.set("focusedFrom","commentpane"),this.model.set("inFocus",!0),this.model.set("isShowingMenu",!1)},focusComment:function(e,t,n){t?(this.highlight(),!editor.isOffline()&&!i.commentPane.get("isReadOnly")&&!this.model.get("isResolved")&&this.showReplyTextArea(),this.updatePositionNumber(),this.model.read(editor.zuid)):(this.deHighlight(),i.isRichCommentsEnabled()&&this.replyEditor&&this.replyEditor.isEmpty()?(this.destroyReplyEditor(),this.hideReplyTextArea()):this.$(".js-comment-reply-textarea").val()||this.hideReplyTextArea())},highlight:function(){this.$(".ui-ncmt-container-div").addClass("ui-ncmt-container-selected")},deHighlight:function(){this.$(".ui-ncmt-container-div").removeClass("ui-ncmt-container-selected")},displayMenu:function(e){this.model.set("isShowingMenu",!0),this.model.read(editor.zuid),this.stopPropagation(e),ZWArrayUtils.each(CommentModels.commentCollection.getRenderedComments(),function(e){e.id!=this.model.id&&e.set("isShowingMenu",!1)},this)},setMenuVisibility:function(e,t,i){t?(this.$(".js-parent-menu").show(),this.$(".js-parent-menudropdown-handle").addClass("ui-comnt-edt-options-active")):(this.$(".js-parent-menu").hide(),this.$(".js-parent-menudropdown-handle").removeClass("ui-comnt-edt-options-active"))},stopPropagation:function(e){e&&(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault())},showOptionsHandle:function(e){editor.isOffline()||!this.model.get("isResolved")&&this.$(".parent-comnt-options").show()},hideOptionsHandle:function(e){editor.isOffline()||!this.model.get("isShowingMenu")&&this.$(".parent-comnt-options").hide()},destroyReplyEditor:function(e){this.replyEditor&&(PubSub.unsubscribe(["Document/ScrollEvent","Commentpane/ScrollEvent"],this._handleScrollForReplyEditor,{context:this}),this.replyEditor.remove(),delete this.replyEditor,this.$el.find("#replycmnt-editor-container").hide(),this.$el.find("#hidden-reply-textarea").show(),this.$(".js-reply-actions").hide())},addReply:function(){if(i.isRichCommentsEnabled())var e=this.replyEditor.getJSON(),t=this.replyEditor.getText(e),n=CommentUtils.removeInvalidChars(t);else{var n=CommentUtils.removeInvalidChars(this.$(".js-comment-reply-textarea").val());this.$(".js-comment-reply-textarea").css("height","")}if(""==n.trim())return!1;this.$(".reply-textarea").val("");var o=new Date,s=o.getTime(),r={id:"zw"+Utils.randomString(),createdAt:s,updatedAt:s,zuid:editor.zuid,text:n,children:null,parentId:this.model.id,inEditingMode:!1,reads:[editor.zuid]};i.isRichCommentsEnabled()&&(r.richtext=e,this.destroyReplyEditor()),replyCommentObj=i.CommentCollection.createComment(r),this.model.addReplyComment(replyCommentObj,!0),this.showReplies(),this.$(".js-new-reply-view").hide(),this.showReplyTextArea()},cancelReply:function(){i.isRichCommentsEnabled()&&this.replyEditor.isEmpty()?this.destroyReplyEditor():(this.$(".js-comment-reply-textarea").css("height",""),this.$(".js-comment-reply-textarea").val(""),this.$(".js-comment-reply-textarea").trigger("blur"))},displayReplyListToggle:function(e,t,n){ZWArrayUtils.arrayContains([i.ACTIVITYLOG.REPLY_ADD,i.ACTIVITYLOG.RESOLVE,i.ACTIVITYLOG.REOPEN],e.get("action"))&&this.$(".js-replylist-display-controller").css("display","inline-block")},hideReplyListToggle:function(e,t,i){this.model.get("children").length||this.$(".js-replylist-display-controller").css("display","none")},autoHeightTextArea:function(e){CommentUtils.autoHeightTextArea(e)},setVisibility:function(e,t,i){t?i.animate?this.$el.slideDown():this.$el.show():i.animate?this.$el.slideUp(200):this.$el.hide()},updateUnreadStateUI:function(e,t,i){t?(this.$(".unread-comment-badge").show(),this.$(".ui-ncmt-container").addClass("ui-ncmt-unread-bg"),this.$(".ui-ncmt-container").addClass("ui-comment-unread"),this.$(".js-comment-parent-container").addClass("ui-unread-cmt-cont")):(this.$(".unread-comment-badge").hide(),this.$(".ui-ncmt-container").removeClass("ui-ncmt-unread-bg"),this.$(".ui-ncmt-container").removeClass("ui-comment-unread"),this.$(".js-comment-parent-container").removeClass("ui-unread-cmt-cont"))},hideReplies:function(e){this.$(".js-reply-list-container").hide(),this.$(".js-show-replies-btn").css("display","inline-block"),this.$(".js-hide-replies-btn").hide(),!this.model.get("isResolved"),e||this.stopPropagation(e)},showReplies:function(e,t){this.getChildViewsLength()&&(this.$(".js-reply-list-container").show(),!this.model.get("isResolved")&&(t?this.hideReplyTextArea():this.showReplyTextArea()),this.$(".js-show-replies-btn").hide(),this.$(".js-hide-replies-btn").show(),e||this.stopPropagation(e))},showReplyTextArea:function(e){if(!CommentModels.isCommentHasAdditionErrors(this.model)){this.$(".js-new-reply-view").slideDown(200,function(){}),this.stopPropagation(e)}},hideReplyTextArea:function(){this.$(".js-new-reply-view").slideUp(200)},getChildViewsLength:function(){var e=this.model.get("children").length,t=this.model.get("activityLog").filter(function(e){return e.get("action")==i.ACTIVITYLOG.RESOLVE||e.get("action")==i.ACTIVITYLOG.REOPEN}).length;return e+t},updateCountsInReplyListToggle:function(){var e=1==this.getChildViewsLength()?"Reply":"Replies";this.$(".js-show-replies-btn").html(this.getChildViewsLength()+" "+e)},updatePositionNumber:function(){var e=CommentModels.commentCollection;e=i.commentCollection.applyViewFilter(e),e=i.commentCollection.applyAuthorFilter(e),e=e.map(function(e){return e.id});var t=CommentModelManager.getCommentOrder().filter(function(e){return CommentModels.commentCollection.get(e)}).filter(function(t){return e.indexOf(t)>-1}),n=t.indexOf(this.model.id)+1,o=t.length,s=Handlebars.compile(Z("cmt-nav-view").html());this.$el.find(".js-cmt-nav-container").html(s({currentIdx:n,total:o,first:1===n,last:n===o,commentpane:!0})),CommentUtils.initActivityTracking(this.$el.find(".js-cmt-nav-container")[0])},showFollowToast:function(){var e=this;this.$(".js-follow-toast").slideDown(100,function(){setTimeout(function(){e.$(".js-follow-toast").slideUp(500)},2e3)})},markAsUnread:function(e){this.model.unread(editor.zuid),this.stopPropagation(e),this.model.set("isShowingMenu",!1)},canDelete:function(){var e=editor.zuid===this.model.get("zuid");return CommentUtils.canDelete(e)},initReplyEditor:function(){var e=this.$el.find("#replycmnt-editor-container")[0],t=J.i18n("writer.common.REPLY_HERE"),i=!0,n=this.replyModeOnKeyPress.bind(this),o=this.model.id,r="ui-insert-comnt-editor",m=s.getRichTextOptions(t,o,i,n,r);return RichTextEditor.init(e,m)},_handleScrollForReplyEditor:function(){this.replyEditor.handleScroll()},_handleScrollForEditEditor:function(){this.editEditor.handleScroll()},focusReply:function(){if(EventHandler.isDialogOpened=!0,i.isRichCommentsEnabled()&&!this.replyEditor){this.$el.find("#hidden-reply-textarea").hide();var e=this.$el.find("#replycmnt-editor-container")[0];e.style.display="block",this.replyEditor=this.initReplyEditor(),this.$el.find(".js-reply-actions").show(),this.replyEditor.editorView.dom.addEventListener("linkInputOpen",function(){this.$el.find(".ui-comment-add-btn").addClass("ui-zwdisabled")}.bind(this)),this.replyEditor.editorView.dom.addEventListener("linkInputClose",function(){this.$el.find(".ui-comment-add-btn").removeClass("ui-zwdisabled")}.bind(this)),PubSub.subscribe(["Document/ScrollEvent","Commentpane/ScrollEvent"],this._handleScrollForReplyEditor,{context:this}),this.replyEditor.focus()}},setUnlinkedStatus:function(e){e.get("isRangeCharsRendered")?this.$el.find(".ui-cmt-brokenlink-btn").hide():this.$el.find(".ui-cmt-brokenlink-btn").show();},render:function(){var e=this.model.attributes,t=editor.zuid===e.zuid;e.canShowEditOption=CommentUtils.canEdit(t),e.canDelete=this.canDelete(),e.currentUserZuid=editor.zuid,e.canGetLink=CommentUtils.canGetLink(),e.canFollow=CommentUtils.canFollow(),e.canReply=editor.getRole().permissions.can("review.comment.reply"),e.canResolve=CommentUtils.canResolve()&&!e.isResolved,e.canReopen=CommentUtils.canResolve()&&e.isResolved,e.colorCode=ReviewUtil.getUserColour(e.zuid),e.currentUserColorCode=ReviewUtil.getUserColour(editor.zuid),e.isEdited=this.model.get("activityLog").filter(function(e){return e.get("action")===CommentModels.ACTIVITYLOG.EDIT}).length,e.childrenLen=this.getChildViewsLength(),e.isMultipleChildren=e.childrenLen>1,e.isSeperatorNeeded=e.canFollow||e.canGetLink,e.isImported=this.model.get("zuid").startsWith("I");var n=e.richtext;if(i.isRichCommentsEnabled()&&n){try{e.RTEHtml=RichTextEditor.getHTML(e.richtext,s.getDefaultRichTextOptionsForRendering())}catch(e){CommentUtils.sendRTEErrorLog(e),this.model.set("richtext",null)}e.isZohoCorpUser=!0}else i.isRichCommentsEnabled()&&!n?e.isZohoCorpUser=!0:e.isZohoCorpUser=!1;this.$el.html(this.commentTpl(e)),Utils.applyExcludes(this.$el[0]),this.$(".js-reply-list-container").html(this.replyCommentCollectionView.render().$el),this.$(".js-like-container").html(this.likeView.render().$el),this.$(".js-follow-container").html(this.followView.render().$el),Visibility.isEnabled()&&this.$el.find(".js-visibility-container").html(this.visibilityView.render().initComponents().$el),this.delegateEvents(),this.$(".enable-atmentions").atMention({commentId:this.model.id});var o,r=!0;return this.showReplies(o,r),CommentUtils.initComponents(this.$el),this.trigger("rendered"),this.updateErrorUI(),CommentUtils.initActivityTracking(this.$el[0]),this}});return r}(ReplyCommentCollectionView,Backbone,CommentModels,jQuery,VisibilityConst,CommentRTE),CommentBubbleView=function(e,t,i,n,o){var s=t.View.extend({tagName:"div",mixins:[CommentMixins.WillShowEditHint,CommentMixins.ReactsToReadOnly,CommentMixins.SupportsEllipsize(),CommentMixins.SupportsLink,CommentMixins.ReactToFailedComments],events:{click:"stopPropagation","click .ui-ncmt-container":"initFocus","click .js-comment-menuoption-edit":"initEditMode","click .js-comment-edit-btn":"edit","click .js-comment-edit-cancel-btn":"cancelEditMode","input .js-comment-edit-textarea":"autoHeightTextArea","keydown .js-comment-edit-textarea":"listenForKeyBoardShortcuts","click .js-comment-reply-add":"addReply","click .js-comment-reply-cancel":"cancelReply","keydown .js-comment-reply-textarea":"listenForKeyBoardShortcuts","input .js-comment-reply-textarea":"autoHeightTextArea","click .js-comment-menudropdown-handle":"displayMenu","click .js-comment-menuoption-resolve":"initResolve","click .js-comment-menuoption-reopen":"initReopen","click .js-comment-menuoption-delete":"showDeleteConfirmation","click .js-comment-menuoption-markunread":"markAsUnread","click .js-comment-delete-cancel":"hideDeleteConfirmation","click .js-comment-delete-confirm":"initDelete","click .js-hide-replies-btn":"hideReplies","click .js-show-replies-btn":"showReplies","click .js-reply-comment-trigger-btn":"showReplyTextArea","click .js-new-reply-view":"stopPropagation","click .prosemirror-mention-node":"showProfileCard","click .js-cmt-nav-prev":"focusPrev","click .js-cmt-nav-next":"focusNext","focus .js-comment-edit-textarea":function(e){EventHandler.isDialogOpened=!0},"focusout .js-comment-edit-textarea":function(e){EventHandler.isDialogOpened=!1},"focus .js-comment-reply-textarea":function(e){EventHandler.isDialogOpened=!0},"focusout .js-comment-reply-textarea":function(e){EventHandler.isDialogOpened=!1},"focus .js-comment-edit-editor":function(e){EventHandler.isDialogOpened=!0},"focusout .js-comment-edit-editor":function(e){EventHandler.isDialogOpened=!1},"focus .js-comment-reply-editor":function(e){EventHandler.isDialogOpened=!0},"focusout .js-comment-reply-editor":function(e){EventHandler.isDialogOpened=!1},"focus .js-comment-reply-hidden-textarea":"focusReply"},initialize:function(e){if(this.replyCommentCollection=this.model.get("children"),this.replyCommentCollectionView=new ReplyCommentCollectionBubbleView({collection:this.replyCommentCollection,parentComment:this.model}),this.likeView=new LikeView({model:this.model}),this.followView=new FollowView({model:this.model}),Visibility.isEnabled()){var t=this.getVisibilityViewOptions();this.visibilityView=new VisibilityDropdownView(t),this.visibilityView.on("value-changed",function(){i.model.setVisibility(i.visibilityView.getValue(),!0)})}var i=this;PubSub.subscribe("Document/ModeOpened",function(e){e!=LAYOUTS.COMPOSE&&e!=LAYOUTS.COMPLETE&&i.hideBubble()}),PubSub.subscribe("Reviewpane/opened",function(){i.hideBubble()}),J("body").click(function(e){i.model.set("isShowingMenu",!1)}),PubSub.subscribe("Document/ViewChanged",i.hideBubble),this.listenTo(this.model,"change:inFocus",this.toggleBubble),this.listenTo(this.model,"change:isResolved",this.updateResolvedStateUI),this.listenTo(this.model.get("activityLog"),"add",this.displayReplyListToggle),this.listenTo(this.model.get("children"),"remove",this.hideReplyListToggle),this.listenTo(this.model,"change:inDisplay",function(e,t,i){EditorLayout.isRightPaneVisible()||this.setVisibility(e,t,i)}),this.listenTo(this.model,"change:isShowingMenu",this.setMenuVisibility),this.listenTo(this.model,"change:inEditingMode",this.setEditMode),this.listenTo(this.model,"change:text",this.updateCommentContent),this.listenTo(this.model,"change:unread",this.updateUnreadStateUI),this.listenTo(this.model,"change:isRangeCharsRendered",this.setVisibility),this.listenTo(this,"showBubble",this.showBubble),this.listenTo(this.model,"change:syncing",this.updateSaveState),Visibility.isEnabled()&&this.listenTo(this.model,"change:visibility",this.updateVisibilityUI),this.initPopup()},commentTpl:Handlebars.compile(Z("comment-bubble-view-4").html()),editables:[".js-resolve-reopen-container",".js-comment-menuoption-edit",".js-comment-menuoption-delete",".js-follow-container",".js-like-container",".js-visibility-container",".js-new-reply-view"],showProfileCard:function(e){var t=this.$(e.target).data("mentionZuid");return UIUtils.showProfileInfoEvent(e,t),!1},initPopup:function(){Z("commentpopup-cont").append(Z("comment-popup"))},initFocus:function(){this.model.set("isShowingMenu",!1)},focusPrev:function(){var e=CommentModelManager.getLinkedCommentOrder().filter(function(e){return CommentModels.commentCollection.get(e)&&CommentModels.commentCollection.get(e).get("isRangeCharsRendered")}),t=e.indexOf(this.model.id);if(t>0){var i=e[t-1];CommentUtils.triggerCommentFocus(i)}},focusNext:function(){var e=CommentModelManager.getLinkedCommentOrder().filter(function(e){return CommentModels.commentCollection.get(e)&&CommentModels.commentCollection.get(e).get("isRangeCharsRendered")}),t=e.indexOf(this.model.id);if(t<e.length){var i=e[t+1];CommentUtils.triggerCommentFocus(i)}},updateVisibilityUI:function(){this.visibilityView.updateModel(this.model.get("visibility"))},updateSaveState:function(e,t){var i=this.model.get("activityLog").filter(function(e){return e.get("action")===CommentModels.ACTIVITYLOG.EDIT}).length;t?(this.$(".ui-ncmt-parent .js-syncing-status-text").show(),this.$(".ui-ncmt-parent .js-syncing-status-dynamic-time").hide(),this.$(".ui-ncmt-parent .js-syncing-status-edits-container").hide(),this.$(".ui-ncmt-parent .js-syncing-status-comment").hide()):(this.$(".ui-ncmt-parent .js-syncing-status-text").hide(),this.$(".ui-ncmt-parent .js-syncing-status-dynamic-time").show(),this.$(".ui-ncmt-parent .js-syncing-status-comment").show(),i&&this.$(".ui-ncmt-parent .js-syncing-status-edits-container").show())},getVisibilityViewOptions:function(){var e={model:{id:"comment-bubble-"+this.model.id,currentSelection:{},adminEntities:Visibility.getAdminEntities(),allowedRoles:Visibility.getAllowedRoles(),withinOrg:Visibility.getWithinOrg(),readonly:editor.zuid!=this.model.get("zuid")}};if(this.model.getVisibility())e.model.currentSelection={entities:this.model.getVisibility().entities,withinOrg:this.model.getVisibility().withinOrg};else if(!this.model.getVisibility()){var t=new Entity.PredefinedGroupEntity(VisibilityConst.EVERYONE);e.model.currentSelection={entities:[t.toJSON()],withinOrg:!1}}return e},initResolve:function(e){this.model.resolve(!0),this.stopPropagation(e)},initReopen:function(e){this.model.reopen(!0),this.showReplies(),this.stopPropagation(e)},destroyReplyEditor:function(e){this.replyEditor&&(PubSub.unsubscribe(["Document/ScrollEvent","Commentpane/ScrollEvent"],this._handleScrollForReplyEditor,{context:this}),this.replyEditor.remove(),delete this.replyEditor,this.$el.find("#replycmntbbl-editor-container").hide(),this.$el.find("#hidden-reply-textarea").show(),this.$(".js-reply-actions").hide())},destroyEditEditor:function(){this.editEditor&&(PubSub.unsubscribe(["Document/ScrollEvent","Commentpane/ScrollEvent"],this._handleScrollForEditEditor,{context:this}),this.editEditor.remove(),delete this.editEditor)},addReply:function(){var e;if(i.isRichCommentsEnabled()){e=this.replyEditor.getJSON();var t=this.replyEditor.getText(e),n=CommentUtils.removeInvalidChars(t)}else var n=CommentUtils.removeInvalidChars(this.$(".js-comment-reply-textarea").val());if(this.$(".js-comment-reply-textarea").css("height",""),""==n.trim())return!1;n=n,this.$(".reply-textarea").val("");var o=new Date,s=o.getTime(),r={id:"zw"+Utils.randomString(),createdAt:s,updatedAt:s,zuid:editor.zuid,text:n,children:null,parentId:this.model.id,inEditingMode:!1,reads:[editor.zuid]};i.isRichCommentsEnabled()&&(r.richtext=e,this.destroyReplyEditor()),replyCommentObj=i.CommentCollection.createComment(r);this.model.addReplyComment(replyCommentObj,!0),this.showReplies(),this.$(".js-new-reply-view").hide(),this.showReplyTextArea()},cancelReply:function(){i.isRichCommentsEnabled()&&this.replyEditor.isEmpty()?this.destroyReplyEditor():(this.$(".js-comment-reply-textarea").css("height",""),this.$(".js-comment-reply-textarea").val(""),this.$(".js-comment-reply-textarea").trigger("blur"))},showDeleteConfirmation:function(){this.$(".ui-delete-comment-child").hide(),this.$(".ui-delete-comment-parent").show()},hideDeleteConfirmation:function(){this.$(".ui-delete-comment-child").hide(),this.$(".ui-delete-comment-parent").hide(),EditorUtil.focusMultiByteSpan()},toggleBubble:function(e,t){t&&"editor"==e.get("focusedFrom")&&!CommentUtils.isReviewPaneVisible()?this.showBubble():this.hideBubble()},positionCommentBubble:function(e){var t=e.offset().left+e.width()+10;if(t>J(document).width()){var i=t-J(document).width(),n=editor.doc.getDomCursorNode(editor.uuid,editor.zuid);n&&e.css({left:e.position().left-(i+20),top:CurUtil.offset.start.top+J(n).height()})}},showBubble:function(){function e(){this.$el.appendTo(Z("popup-menu-cmnt-container")).show(),ReviewPopupHandler.positionPopup(),ReviewPopupHandler.drawFocusLine(ReviewPopupHandler.POPUP_TYPES.COMMENT,"#fad76e")}function t(){var e=Z("comment-popup-cmt-cont");J(e.children()[0]).detach(),Z("commentpopup-cont").show(),this.$el.appendTo(e).show(),ReviewUtil.positionPopUp("comment")}return!CommentUtils.isReviewPaneVisible()&&(this.$el.find(".dynamic-time").each(function(e,t){Jelm=J(t),Jelm.text(Utils.getTimeFromNow(parseInt(Jelm.attr("data-dynamic-time"))))}),editor.getView()===EDITOR_VIEWS.HISTORY?t.call(this):e.call(this),TimeUpdater.updateTime([this.$el]),void this.updatePositionNumber())},updatePositionNumber:function(){var e=CommentModelManager.getLinkedCommentOrder().filter(function(e){return CommentModels.commentCollection.get(e)&&CommentModels.commentCollection.get(e).get("isRangeCharsRendered")}),t=e.indexOf(this.model.id)+1,i=e.length,n=Handlebars.compile(Z("cmt-nav-view").html());this.$el.find(".js-cmt-nav-container").html(n({currentIdx:t,total:i,first:1===t,last:t===i,commentpane:!1})),CommentUtils.initActivityTracking(this.$el.find(".js-cmt-nav-container")[0])},hideBubble:function(){if(!this.$el)return!1;this.$el.fadeOut(200);var e=this;setTimeout(function(){i.isRichCommentsEnabled()&&(this.replyEditor&&this.replyEditor.isEmpty()&&this.destroyReplyEditor(),this.editEditor&&this.destroyEditEditor(),this.model.trigger("bubbleClosed")),e.$el.detach()}.bind(this),200);var t=Z("commentpopup-cont").find(this.el).length;t&&Z("commentpopup-cont").hide(),ReviewPopupHandler.removeFocusLine()},initEditMode:function(e){this.model.set("inEditingMode",!0)},initDelete:function(e){var t=this;this.$el.slideUp(200,function(){t.model.collection.removeComment(t.model,!0),ReviewPopupHandler.removeFocusLine()}),EditorUtil.focusMultiByteSpan()},cancelEditMode:function(){this.model.set("inEditingMode",!1)},editModeOnKeyPress:function(e){CommentUtils.doneKey(e,function(){this.edit(),ActivityTracker.trackInAnalytics("Comment","EditComment","Shortcut")},this),CommentUtils.cancelKey(e,this.cancelEditMode,this)},replyModeOnKeyPress:function(e){CommentUtils.doneKey(e,function(){this.addReply(),ActivityTracker.trackInAnalytics("Comment","AddReply","Shortcut")},this),CommentUtils.cancelKey(e,this.handleEscKey.bind(this,e),this)},initEditEditor:function(e){var t=e.get("richtext"),i=this.$el.find("#cmntbbl-editor-container-edit")[0],n=J.i18n(UIUtils.getUIText("ENTER_COMMENT")),s=!0,r=this.editModeOnKeyPress.bind(this),m=this.model.id,l=t||this.model.get("text"),a="ui-insert-comnt-editor",c=o.getRichTextOptions(n,m,s,r,a,l);return RichTextEditor.init(i,c)},setEditMode:function(e,t,n){if(t){if(this.$(".js-parent-text-container").hide(),this.$(".parent-edit-cont").show(),this.$(".ui-ncmt-footer").hide(),i.isRichCommentsEnabled()&&!CommentUtils.isReviewPaneVisible())this.setEditModeForRTE();else if(!i.isRichCommentsEnabled()){var o=this.model.get("text");this.$(".js-comment-edit-textarea").val(o)}CommentUtils.updateTextAreaHeight(this.$(".js-comment-edit-textarea")[0]),this.$(".ui-toggle-comment-height").hide(),this.$(".js-comment-edit-textarea").trigger("focus")}else i.isRichCommentsEnabled()&&this.editEditor&&this.destroyEditEditor(),this.$(".js-parent-text-container").show(),this.$(".parent-edit-cont").hide(),this.$(".ui-ncmt-footer").show()},edit:function(){var e,t;if(i.isRichCommentsEnabled()){if(t=this.editEditor.getJSON(),e=this.editEditor.getText(t),""==e.trim()||JSON.stringify(t)==JSON.stringify(this.model.get("richtext")))return this.model.set("inEditingMode",!1),!1}else if(e=CommentUtils.removeInvalidChars(this.$(".js-comment-edit-textarea").val()),""==e.trim()||e==this.model.get("text"))return this.model.set("inEditingMode",!1),!1;this.model.set("inEditingMode",!1),this.model.edit(e,t,!0)},updateResolvedStateUI:function(e,t,i){var n=CommentUtils.canResolve();t?(n&&(this.$(".js-comment-menuoption-resolve").hide(),this.$(".js-comment-menuoption-reopen").show()),this.$(".parent-comnt-options").hide(),this.$(".js-resolve-mark").show(),this.hideReplyTextArea()):(n&&(this.$(".js-comment-menuoption-resolve").show(),this.$(".js-comment-menuoption-reopen").hide()),this.$(".parent-comnt-options").show(),this.$(".js-resolve-mark").hide(),this.showReplyTextArea())},autoHeightTextArea:function(e){CommentUtils.autoHeightTextArea(e)},listenForKeyBoardShortcuts:function(e){this.$(e.target).hasClass("reply-textarea")?(CommentUtils.doneKey(e,this.addReply,this),CommentUtils.cancelKey(e,this.handleEscKey.bind(this,e),this)):(CommentUtils.doneKey(e,this.edit,this),CommentUtils.cancelKey(e,this.cancelEditMode,this))},handleEscKey:function(e){if(i.isRichCommentsEnabled())this.replyEditor.isEmpty()&&this.cancelReply();else{var t=this.$(e.target);if(t.val().trim())return e.stopPropagation(),!1;this.cancelReply()}},displayReplyListToggle:function(e,t,n){e.get("action")===i.ACTIVITYLOG.REPLY_ADD&&this.$(".js-replylist-display-controller").show()},hideReplyListToggle:function(e,t,i){this.model.get("children").length||this.$(".js-replylist-display-controller").hide()},autoHeightTextArea:function(e){CommentUtils.autoHeightTextArea(e)},setVisibility:function(e,t,i){t?(this.$el.show(),ReviewPopupHandler.positionPopup(),ReviewPopupHandler.drawFocusLine(ReviewPopupHandler.POPUP_TYPES.COMMENT,"#fad76e")):(this.$el.hide(),ReviewPopupHandler.removeFocusLine())},updateUnreadStateUI:function(e,t,i){t?this.$(".ui-ncmt-container").addClass("ui-comment-unread"):this.$(".ui-ncmt-container").removeClass("ui-comment-unread")},hideReplies:function(){this.$(".js-reply-list-container").hide(),this.$(".js-show-replies-btn").show(),this.$(".js-hide-replies-btn").hide()},showReplies:function(){this.$(".js-reply-list-container").show(),this.$(".js-show-replies-btn").hide(),this.$(".js-hide-replies-btn").show()},showReplyTextArea:function(){CommentModels.isCommentHasAdditionErrors(this.model)||(this.$(".js-reply-comment-trigger-btn").hide(),this.$(".js-new-reply-view").slideDown(200))},hideReplyTextArea:function(){this.$(".js-reply-comment-trigger-btn").show(),this.$(".js-new-reply-view").slideUp(200)},_handleScrollForReplyEditor:function(){this.replyEditor.handleScroll()},_handleScrollForEditEditor:function(){this.editEditor.handleScroll()},initReplyEditor:function(){var e=this.$el.find("#replycmntbbl-editor-container")[0],t=J.i18n("writer.common.REPLY_HERE"),i=!0,n=this.replyModeOnKeyPress.bind(this),s=this.model.id,r="ui-insert-comnt-editor",m=o.getRichTextOptions(t,s,i,n,r);return RichTextEditor.init(e,m)},focusReply:function(){if(EventHandler.isDialogOpened=!0,i.isRichCommentsEnabled()&&!this.replyEditor){this.$el.find("#hidden-reply-textarea").hide();var e=this.$el.find("#replycmntbbl-editor-container")[0];e.style.display="block",this.replyEditor=this.initReplyEditor(),this.$(".js-reply-actions").show(),this.replyEditor.editorView.dom.addEventListener("linkInputOpen",function(){this.$el.find(".ui-comment-add-btn").addClass("ui-zwdisabled")}.bind(this)),this.replyEditor.editorView.dom.addEventListener("linkInputClose",function(){this.$el.find(".ui-comment-add-btn").removeClass("ui-zwdisabled")}.bind(this)),PubSub.subscribe(["Document/ScrollEvent","Commentpane/ScrollEvent"],this._handleScrollForReplyEditor,{context:this}),this.replyEditor.focus()}},setEditModeForRTE:function(){i.isRichCommentsEnabled()&&!this.editEditor&&(this.editEditor=this.initEditEditor(this.model),this.editEditor.editorView.dom.addEventListener("linkInputOpen",function(){this.$el.find(".ui-comment-add-btn").addClass("ui-zwdisabled"),this.$el.find(".ui-comment-cancel-btn").addClass("ui-zwdisabled")}.bind(this)),this.editEditor.editorView.dom.addEventListener("linkInputClose",function(){this.$el.find(".ui-comment-add-btn").removeClass("ui-zwdisabled"),this.$el.find(".ui-comment-cancel-btn").removeClass("ui-zwdisabled")}.bind(this)),PubSub.subscribe(["Document/ScrollEvent","Commentpane/ScrollEvent"],this._handleScrollForEditEditor,{context:this}),CommentUtils.isReviewPaneVisible()||this.editEditor.focus())},stopPropagation:function(e){e.stopPropagation(),e.stopImmediatePropagation()},updateCommentContent:function(e,t,n){if(i.isRichCommentsEnabled()&&e.get("richtext"))this.$(".js-parent-text-container").html(RichTextEditor.getHTML(e.get("richtext"),o.getDefaultRichTextOptionsForRendering()));else{var t=e.get("text");this.$(".js-parent-text-container").html(CommentUtils.getMarkedupCommentContent(Utils.encodeHTMLString(t)))}},displayMenu:function(e){this.model.set("isShowingMenu",!0),this.model.read(editor.zuid),this.stopPropagation(e),ZWArrayUtils.each(CommentModels.commentCollection.getRenderedComments(),function(e){e.id!=this.model.id&&e.set("isShowingMenu",!1)},this)},setMenuVisibility:function(e,t,i){t?(this.$(".js-parent-menu").show(),this.$(".js-parent-menudropdown-handle").addClass("ui-comnt-edt-options-active")):(this.$(".js-parent-menu").hide(),this.$(".js-parent-menudropdown-handle").removeClass("ui-comnt-edt-options-active"))},showFollowToast:function(){var e=this;this.$(".js-follow-toast").slideDown(100,function(){setTimeout(function(){e.$(".js-follow-toast").slideUp(500)},2e3)})},markAsUnread:function(e){this.model.unread(editor.zuid),this.stopPropagation(e),this.model.set("isShowingMenu",!1)},canDelete:function(){var e=editor.zuid===this.model.get("zuid");return CommentUtils.canDelete(e)},render:function(){var e=this.model.attributes,t=editor.zuid===e.zuid;editor.getView()!==EDITOR_VIEWS.HISTORY?e.showMoreOptions=!0:e.showMoreOptions=!1,e.canShowEditOption=CommentUtils.canEdit(t),e.canDelete=this.canDelete(),e.canFollow=CommentUtils.canFollow(),e.canReply=editor.getRole().permissions.can("review.comment.reply"),e.canResolve=CommentUtils.canResolve()&&!e.isResolved,e.canReopen=CommentUtils.canResolve()&&e.isResolved,e.canGetLink=CommentUtils.canGetLink(),e.currentUserZuid=editor.zuid,e.colorCode=ReviewUtil.getUserColour(e.zuid),e.currentUserColorCode=ReviewUtil.getUserColour(editor.zuid),e.isEdited=this.model.get("activityLog").filter(function(e){return e.get("action")===CommentModels.ACTIVITYLOG.EDIT}).length,e.isSeperatorNeeded=e.canGetLink||e.canFollow,e.isImported=this.model.get("zuid").startsWith("I");var n=e.richtext&&Object.keys(e.richtext).length;if(i.isRichCommentsEnabled()&&n){try{e.RTEHtml=RichTextEditor.getHTML(e.richtext,o.getDefaultRichTextOptionsForRendering())}catch(e){CommentUtils.sendRTEErrorLog(e),this.model.set("richtext",null)}e.isZohoCorpUser=!0}else i.isRichCommentsEnabled()&&!n?e.isZohoCorpUser=!0:e.isZohoCorpUser=!1;return this.$el.html(this.commentTpl(e)),Utils.applyExcludes(this.$el[0]),this.$(".js-reply-list-container").html(this.replyCommentCollectionView.render().$el),this.$(".js-like-container").html(this.likeView.render().$el),this.$(".js-follow-container").html(this.followView.render().$el),Visibility.isEnabled()&&this.$el.find(".js-visibility-container").html(this.visibilityView.render().initComponents().$el),this.$(".enable-atmentions").atMention({commentId:this.model.id}),this.delegateEvents(),CommentUtils.initComponents(this.$el),this.$el.hide(),this.trigger("rendered"),CommentUtils.initActivityTracking(this.$el[0]),this}});return s}(ReplyCommentCollectionView,Backbone,CommentModels,jQuery,CommentRTE),CommentCollectionView=function(e,t,i,n){var o=t.View.extend({el:"#comment-list-container",events:{},listen:function(){this.listenTo(i.commentCollection,"change:isRangeCharsRendered",this.addHighlight),this.listenTo(i.commentCollection,"add",this.highlightAndRenderComment),this.listenTo(i.commentCollection,"remove",this.removeComment),this.listenTo(i.commentPane,"change:currentView",this.onCurrentViewChange),this.listenTo(i.commentPane,"change:currentAuthor",this.onCurrentAuthorChange),this.listenTo(i.commentPane,"change:noCommentsToShow",this.setVisibility),this.listenTo(i.commentCollection,"reset",this.removeAllViews),this.listenTo(i.commentCollection,"reset",this.render),this.listenTo(i.commentPane,"change:searchQuery",this.render),this.listenTo(i.commentCollection,"change:isResolved",this.onResolveReopen),this.listenTo(i.commentCollection,"change:isRangeCharsRendered",function(e){this.reOrderComment(e),e.changed.isRangeCharsRendered&&this.drawHighlight(e)})},initialize:function(e){this.listen();var t=this;t.$el.on("scroll",function(){CommentUtils.delay(function(){PubSub.publish("Commentpane/ScrollEvent")},500,"comment-scroll")})},commentViewMap:{},commentBubbleViewMap:{},reOrderComment:function(e){var t=CommentModelManager.isLinkedComment(e.id),n=this.commentViewMap[e.id];n&&n.$el.detach();var o=i.commentCollection.applyViewFilter([e]);o=i.commentCollection.applyAuthorFilter(o),o=i.commentCollection.applySearchFilter(o),o.length&&this.injectByOrder(e),t?this.createBubbleView(e):this.removeBubbleView(e);var s=CommentManager.views.commentPaneView.currentFocusedComment;if(s){var r=this.commentViewMap[s.id],m=this.commentBubbleViewMap[s.id];r&&r.updatePositionNumber(),m&&m.updatePositionNumber()}CommentUtils.removeFocusLine()},onResolveReopen:function(e,t){if(t){if(i.commentPane.get("currentView")===i.COMMENTVIEWS.UNRESOLVED)CommentUtils.removeFocusLine(),e.set("inFocus",!1),e.set("inDisplay",!1,{animate:!0}),this.removeCommentView(e);else if(i.commentPane.get("currentView")===i.COMMENTVIEWS.RESOLVED){this.renderComment(e);var n=this.commentViewMap[e.id];n&&n.updateResolvedStateUI(e,t)}}else if(i.commentPane.get("currentView")===i.COMMENTVIEWS.RESOLVED)CommentUtils.removeFocusLine(),e.set("inFocus",!1),e.set("inDisplay",!1,{animate:!0}),this.removeCommentView(e);else if(i.commentPane.get("currentView")===i.COMMENTVIEWS.UNRESOLVED){this.renderComment(e);var n=this.commentViewMap[e.id];n&&n.updateResolvedStateUI(e,t)}},createBubbleView:function(e){if(!this.commentBubbleViewMap[e.id]){var t=new CommentBubbleView({model:e});this.commentBubbleViewMap[e.id]=t,t.render()}},removeBubbleView:function(e){var t=this.commentBubbleViewMap[e.id];t&&t.remove(),delete this.commentBubbleViewMap[e.id]},removeCommentView:function(e){var t=this.commentViewMap[e.id];t&&t.remove(),delete this.commentViewMap[e.id]},removeComment:function(e,t){this.removeCommentView(e),this.removeBubbleView(e)},removeAllViews:function(e,t){for(id in this.commentViewMap)this.commentViewMap[id]&&this.commentViewMap[id].remove(),delete this.commentViewMap[id];for(id in this.commentBubbleViewMap)this.commentBubbleViewMap[id]&&this.commentBubbleViewMap[id].remove(),delete this.commentBubbleViewMap[id]},onCurrentAuthorChange:function(e,t,i){i.dontRender?null:this.render({}),i.dontRender||(i.sync?this.render({sync:!0,hardReload:!1}):this.render({}))},onCurrentViewChange:function(e,t,i){i.sync?this.render({sync:!0,hardReload:!1}):this.render({})},injectByOrder:function(t){var i=this.commentViewMap[t.id];i?i.$el.detach():i=new e({model:t});var n=this.getPreviouslyRenderedComment(t);return n?n.$el.after(i.render().$el):this.$el.prepend(i.render().$el),this.commentViewMap[t.id]||(this.commentViewMap[t.id]=i),t.set("inDisplay",!0,{animate:!0}),!0},getPreviouslyRenderedComment:function(e){var t=CommentModelManager.getCommentOrder(),i=t.indexOf(e.id);if(0==i)return null;for(var o=i-1;o>=0;o--){prevCommentId=t[o];var s=this.commentViewMap[prevCommentId];if(s&&n.contains(this.$el[0],s.$el[0]))return this.commentViewMap[prevCommentId]}return null},renderComment:function(e){var t=[e];t=i.commentCollection.applyViewFilter(t),t=i.commentCollection.applyAuthorFilter(t),t=i.commentCollection.applySearchFilter(t);var n=t.length;return n?this.injectByOrder(e):this.commentViewMap[e.id]&&this.removeCommentView(e),!this.commentBubbleViewMap[e.id]&&CommentModelManager.isLinkedComment(e.id)&&this.createBubbleView(e),n},drawHighlight:function(e){CommentHighlights.pushToHighlightQueue([e.id]),CommentHighlights.drawHighlight()},highlightAndRenderComment:function(e,t){CommentModelManager.isLinkedComment(e.id)&&this.drawHighlight(e);var i=this.renderComment(e);return i},renderCommentCollection:function(t){var n=function(){r&&CommentUtils.setVisibilityForNoResultsDiv(),o.updatePositionNumbers(),r||CommentModels.commentPane.updateNoCommentsToShow()},o=this,s=[];i.commentCollection.length&&(s=CommentModelManager.getCommentOrder().map(function(e){return i.commentCollection.get(e)}));var r=i.commentPane.get("searchQuery").trim(),m=function(t){var n=CommentModelManager.isLinkedComment(t.id),s=o.commentBubbleViewMap[t.id];!s&&n&&(o.createBubbleView(t),o.drawHighlight(t));var m=i.commentCollection.applyViewFilter([t]);if(m=i.commentCollection.applyAuthorFilter(m),m=i.commentCollection.applySearchFilter(m),!m.length)return t.set("inFocus",!1),t.set("inDisplay",!1),void o.removeCommentView(t);var l=o.commentViewMap[t.id],a=!!l;if(a||(l=new e({model:t}),o.commentViewMap[t.id]=l),o.$el.append(l.render().$el),l.delegateEvents(),t.set("inFocus",!1),t.set("inDisplay",!0),r){l.showReplies(),t.set("isEllipsized",!1);var c=t.get("children");c.each(function(e){e.set("isEllipsized",!1)})}};if(t.sync)s.forEach(m),n();else{i.commentPane.set("isLoading",!0),i.commentPane.set("renderInProgress",!0),this.renderLoop&&this.renderLoop.stop(),this.renderLoop=new CommentManager.DelayableAsyncForEach(s,m,10,{on:CommentManager.COMMENTLIST_RENDER_DELAY_EVENTS,timeout:CommentManager.COMMENTLIST_RENDER_DELAY_TIME});var l=this.renderLoop.start();l.done(function(){t.hardReload&&CommentManager.executeAfterInitCallbacks(),i.commentPane.set("renderInProgress",!1),i.commentPane.set("isLoading",!1),n(),this.renderLoop=null})}},updatePositionNumbers:function(){var e=i.commentCollection.getRenderedComments();e=i.commentCollection.applyViewFilter(e),e=i.commentCollection.applyAuthorFilter(e);var t=e.length;J(".js-comments-in-display-count").text(t)},setVisibilityBasedOnActiveSearchQuery:function(e,t){i.commentPane.get("searchQuery").trim()&&(CommentUtils.containsSearchTerm(t)?e.showReplies():t.set("inDisplay",!1),CommentUtils.setVisibilityForNoResultsDiv())},setVisibility:function(e,t,i){t&&this.$el.hide()||this.$el.show()},expandRepliesForAllComments:function(){Object.keys(this.commentViewMap).forEach(function(e){var t=this.commentViewMap[e];t.showReplies()},this)},collapseRepliesForAllComments:function(){Object.keys(this.commentViewMap).forEach(function(e){var t=this.commentViewMap[e];t.hideReplies()},this)},detachCommentDialog:function(){CommentManager.views.commentCreationView&&CommentManager.views.commentCreationView.detach()},render:function(e){return i.commentPane.set("commentCreationDialogShow",!1),this.$el.empty(),CommentModels.commentPane.set("noCommentsToShow",!1),this.renderCommentCollection(e||{}),this}});return o}(CommentView,Backbone,CommentModels,jQuery),CommentPaneView=function(e,t,i,n,o){var s=t.View.extend({el:"#mount-commentpaneview",topbandTpl:Handlebars.compile(Z("commentpane-template-4").html()),arg1Tpl:Handlebars.compile("<span class='ui-noresults-search-term ui-semibold'>{{ searchQuery }}</span>"),arg2Tpl:Handlebars.compile("<span class='ui-semibold'>{{ viewLabel }}</span>"),events:{"click #commentpane-comment-add":"openNewCommentDialog","keydown #comments-search-textbox":"listenForKeyboardShortcuts","keyup #comments-search-textbox":"updateSearchQuery","focus #comments-search-textbox":"setDialogFlag","focusout #comments-search-textbox":"unsetDialogFlag"},listen:function(){this.listenTo(this.model,"updateCount",this.updateCount),this.listenTo(i.commentCollection,"add",this.firstCommentHandler),this.listenTo(i.commentCollection,"change:isRangeCharsRendered",this.updateCount),this.listenTo(i.commentCollection,"change:text add addReplyComment editReplyComment removeReplyComment",this.updateCount),this.listenTo(i.commentCollection,"change:isResolved",this.updateCount),this.listenTo(i.commentCollection,"change:inFocus",this.focusComment),this.listenTo(i.commentCollection,"remove",this.lastCommentHandler),this.listenTo(i.commentCollection,"remove",this.updateCount),this.listenTo(i.commentCollection,"reset",this.lastCommentHandler),this.listenTo(i.commentCollection,"reset",this.hideCommentPopup),this.listenTo(i.commentCollection,"reset",this.updateCount),this.listenTo(this.model,"change:currentAuthor",this.setAuthorFilterVal),this.listenTo(this.model,"change:currentAuthor",CommentUtils.updateViewFilterList),this.listenTo(this.model,"change:currentView",this.setViewFilterVal),this.listenTo(this.model,"change:currentView change:currentAuthor",this.onCurrentViewChange),this.listenTo(this.model,"change:freeze",this.updateFreezeStateUI),this.listenTo(this.model,"change:noOfUnreadComments",this.updateCount),this.listenTo(this.model,"change:noOfUnreadComments",this.updateHeaderCounts),this.listenTo(this.model,"change:isShowingSearchbox",this.updateSearchboxVisibility),this.listenTo(this.model,"change:searchQuery",this.updateNoResultsDiv),this.listenTo(this.model,"change:currentView",this.updateNoResultsDiv),this.listenTo(this.model,"change:isLoading",this.setLoaderVisibility),this.listenTo(this.model,"change:noCommentsToShow",this.setCommentListPlaceholderVisiblity),this.listenTo(this.model,"change:isReadOnly",this.updateMode),this.listenTo(this,"rendered",this.updateMode),this.listenTo(i.commentCollection,"focusUnlinkedComment",CommentManager.updateCommentFocus);},initialize:function(){this.searchTimer=Math.ceil(1e4*Math.random()),this.focusLineTimer=Math.ceil(1e4*Math.random()),this.listen(),this.render(),ReviewUtil.isReadCommentMode()&&(this.renderShowHideLabel(),this.loadReadCommentModeUi()),this.$("#cmt-view-filter").on("zselectboxchange",this.onViewChange),this.$("#cmt-author-filter").on("zselectboxchange",this.onAuthorChange),Z("comments-viewmenu-opt").on("zmenubeforeshow",this.updateLabels),PubSub.subscribe(["Document/History/BeforeVersionLoad","Document/History/BackToEditor"],this.hideCommentPopup)},editables:["#resolve-all-menu-opt","#delete-all-menu-opt","#mark-all-read","#mark-all-unread"],updateMode:function(){var e=i.commentPane.get("isReadOnly");Z("comments-viewmenu-opt").zmenu("setMenuItemsAttribute",this.editables,"disabled",e)},onViewChange:function(e,t){var i=t.selectedValue;CommentUtils.updateCurrentView(i),ActivityTracker.trackInAnalytics("Comment","FilterByView","ReviewPanel")},onAuthorChange:function(e,t){var i=t.selectedValue;CommentUtils.updateCurrentAuthor(i),ActivityTracker.trackInAnalytics("Comment","FilterByUser","ReviewPanel")},updateLabels:function(){var e=i.commentPane.get("currentAuthor"),t=i.commentPane.get("currentView"),n=CommentUtils.getViewLabel(t),o=J.i18n(UIUtils.getUIText("COMMENTS")),s=J.i18n("writer.common."+n),r=J.i18n("writer.common.DELETEALL"),m=J.i18n("writer.common.RESOLVEALL");if(label=t===i.COMMENTVIEWS.ALL?" "+o:" "+s+" "+o,e){var l=J.i18n("writer.common.BY_NAME",[ReviewUtil.getUserName(e)]);label+=" "+l}var a=CommentUtils.getTitleCase(m+label),c=CommentUtils.getTitleCase(r+label);Z("comments-viewmenu-opt").zmenu("setMenuItemsAttribute",["#resolve-all-menu-opt"],"label",a),Z("comments-viewmenu-opt").zmenu("setMenuItemsAttribute",["#delete-all-menu-opt"],"label",c),CommentManager.views.commentPaneView.setViewFilterVal(i.commentPane,t),Macros.isRemote()&&Z("comments-viewmenu-opt").zmenu("hideMenuItems",["show-notification-dialog"])},setViewFilterVal:function(e,t,n){this.$("#cmt-view-filter").zselectbox("setValue",t),t===i.COMMENTVIEWS.RESOLVED||t===i.COMMENTVIEWS.UNLINKED?Z("comments-viewmenu-opt").zmenu("hideMenuItems",["resolve-all-menu-opt"]):t===i.COMMENTVIEWS.TAGGED?Z("comments-viewmenu-opt").zmenu("hideMenuItems",["resolve-all-menu-opt","delete-all-menu-opt"]):Z("comments-viewmenu-opt").zmenu("showMenuItems",["resolve-all-menu-opt","delete-all-menu-opt"])},setAuthorFilterVal:function(e,t,i){t?this.$("#cmt-author-filter").zselectbox("setValue",t):this.$("#cmt-author-filter").zselectbox("setValue","all")},setDialogFlag:function(){EventHandler.isDialogOpened=!0},unsetDialogFlag:function(){EventHandler.isDialogOpened=!1},firstCommentHandler:function(e){this.model.set("noCommentsToShow",!1),this.commentCollectionView.$el.show(),Z("review_tab").find("#comment-actions-opt").show()},lastCommentHandler:function(e,t){CommentUtils.isAnyCommentRenderedInPane()||(this.model.set("noCommentsToShow",!0),Z("review_tab").find("#comment-actions-opt").hide())},updateCount:function(e,t,n){if(i.commentPane.get("isLoading"))return!0;var o=i.commentCollection.getCount();this.model.set("nosAll",o.total.all),this.model.set("nosResolved",o.total.resolved),this.model.set("nosUnresolved",o.total.unresolved),this.model.set("nosUnlinked",o.total.unlinked),this.model.set("nosTagged",o.total.tagged),PubSub.publish("Document/Comment/CountUpdated",o),this.commentCollectionView.updatePositionNumbers(),this.updateAuthorList(o),CommentUtils.updateFilters(),this.updateButtonLabel(this),this.model.updateNoCommentsToShow()},updateAuthorList:function(e){var t=ZWJSONUtils.mapJSON(e.authors,function(e,t){return{id:t,zuid:t,name:CommentUtils.getUsername(t),count:e}});i.authors.reset(t)},updateHeaderCounts:function(e){},openNewCommentDialog:function(){CommentManager.newComment()},focusFromPane:function(e){var t=CommentUtils.getCommentRange(e.id);if(CommentUtils.removeFocusLine(),!t)return CommentUtils.drawFocusLine(e.id),!1;var i=DocLayoutManager.getLineAtIndex(t.start);if(!i)return!1;CommentUtils.highlightCommentedDoctext(e.id);var n=CommentUtils.pullCommentedDoctextIntoView(e.id);n&&n.promise().then(CommentUtils.drawFocusLine.bind(null,e.id))},focusFromEditor:function(e){var t=CommentModelManager.isLinkedComment(e.id);t&&CommentUtils.highlightCommentedDoctext(e.id);var i=Z("review_tab").ztabpanel("getActiveTab"),n=CommentUtils.isReviewPaneVisible()&&"li-comments-tab-header"===i.id,o=this,s=CommentUtils.pullCommentIntoView(e.id);n&&s&&s.promise().then(function(){CommentUtils.delay(CommentUtils.drawFocusLine.bind(null,e.id),10,o.focusLineTimer)})},focusComment:function(e,t,i){if(t&&e.get("focusedFrom")){this.currentFocusedComment&&this.currentFocusedComment.set("inFocus",!1),this.currentFocusedComment=e;"commentpane"===e.get("focusedFrom")?this.focusFromPane(e):this.focusFromEditor(e)}else this.currentFocusedComment=null,CommentUtils.removeCommentedDoctextHighlight(e.id)},onCurrentViewChange:function(e,t,n){i.commentPane.set("commentCreationDialogShow",!1),CommentUtils.removeFocusLine()},deleteFilteredComments:function(){var e=i.commentCollection.getRenderedComments();e=i.commentCollection.applyViewFilter(e),e=i.commentCollection.applyAuthorFilter(e);var t=e.map(function(e){return e.id});i.commentCollection.removeAllComments(!0,t)},resolveFilteredComments:function(){var e=i.commentCollection.getRenderedComments();e=i.commentCollection.applyViewFilter(e),e=i.commentCollection.applyAuthorFilter(e);var t=e.map(function(e){return e.id});i.commentCollection.resolveAllComments(!0,editor.zuid,(new Date).getTime(),t)},markAllCommentsAsRead:function(e){var t=i.commentCollection.getRenderedComments().filter(function(e){return e.get("unread")}).map(function(e){return e.id});i.commentCollection.read(t,editor.zuid),i.commentCollection.markRead(t)},markAllCommentsAsUnread:function(e){var t=i.commentCollection.getRenderedComments().filter(function(e){return!e.get("unread")}).map(function(e){return e.id});i.commentCollection.unread(t,editor.zuid),i.commentCollection.markUnread(t)},updateFreezeStateUI:function(e,t,i){t?this.$(".comment-freeze-overlay").show():this.$(".comment-freeze-overlay").hide()},initComponents:function(){CommentUtils.initComponents(this.$el)},listenForKeyboardShortcuts:function(e){CommentUtils.cancelKey(e,this.cancelSearch,this)},cancelSearch:function(){this.model.set("isShowingSearchbox",!1),this.model.set("searchQuery",""),this.$("#comments-search-textbox").val(""),this.$("#noresults-container").hide(),CommentUtils.removeFocusLine()},showLoading:function(){},hideLoading:function(){},updateSearchQuery:function(e){var t=this;this.showLoading(),CommentUtils.delay(function(){t.hideLoading();var e=t.$("#comments-search-textbox").val();e.trim().length>2?t.model.set("searchQuery",e):t.model.set("searchQuery","")},1e3,this.searchTimer)},updateSearchboxVisibility:function(e,t,i){var n=this,o=document.getElementById("ztab_reviews");t?this.$("#search-container").slideDown(100,function(){o&&o.classList.add("ui-search-container-tgl"),n.$("#comments-search-textbox").trigger("focus")}):this.$("#search-container").slideUp(100,function(){o&&o.classList.remove("ui-search-container-tgl")})},updateNoResultsDiv:function(e,t,n){var t=i.commentPane.get("searchQuery").trim(),o=J.i18n("writer.common."+CommentUtils.getViewLabel(i.commentPane.get("currentView")));if(!t)return void this.$("#noresults-container").hide();var s=this.arg1Tpl({searchQuery:t}),r=this.arg2Tpl({viewLabel:o}),m=J.i18n("writer.common.COMMENT_NO_SEARCH_RESULTS",[s,r]);this.$("#noresults-container").html(m)},setLoaderVisibility:function(e,t,i){t?Z("cmt-loader-img").show():Z("cmt-loader-img").hide()},setCommentListPlaceholderVisiblity:function(e,t,i){t?(this.$(".no-comments-div-container").show(),this.commentCollectionView.$el.hide()):(this.$(".no-comments-div-container").hide(),this.commentCollectionView.$el.show())},render:function(){var t=this.model.attributes;return t.unreadCommentsExist=this.model.get("noOfUnreadComments")>0,t.authorCount=CommentModels.authors.length,this.$el.html(this.topbandTpl(t)),this.commentCollectionView=new e({collection:i.commentCollection}),this.$("#comment-list-container").html(this.commentCollectionView.render({sync:!1,hardReload:!0}).$el),this.initComponents(),CommentUtils.initActivityTracking(this.el),CommentModels.commentCollection.length?this.firstCommentHandler():CommentManager.executeAfterInitCallbacks(),this},updateCommentPaneVariables:function(){var e=this;EditorLayout.isRightPaneVisible()?e.model.set("show",!0):e.model.set("show",!1),e.updateButtonLabel(e)},updateButtonLabel:function(e){var t=n("#topband-showhide-cmnt"),i=e.model.get("nosAll"),o=e.model.get("noOfUnreadComments"),s=e.model.get("show")?J.i18n(UIUtils.getUIText("HIDE_COMMENTS"))+" ("+i+")":J.i18n(UIUtils.getUIText("SHOW_COMMENTS"))+" ("+i+")";t.length>0&&(t.znotificationbutton("setAttribute","label",s),o>0?(t.znotificationbutton("showBadge"),t.znotificationbutton("setAttribute","badgeText",o)):t.znotificationbutton("hideBadge"))},renderShowHideLabel:function(){CommentUtils.isReviewPaneVisible()?this.model.set("show",!0):this.model.set("show",!1),this.updateButtonLabel(this)},loadReadCommentModeUi:function(){var e=document.getElementById("editor-rightPanel");e.classList.add("ui-readcomment-mode")},hideCommentPopup:function(){Z("commentpopup-cont").hide()}});return s}(CommentCollectionView,Backbone,CommentModels,jQuery,LayoutManager);var CommentManager=function(e){var t={},i=!1,n=[],o=!1,s=["Editor/MouseDown","Editor/KeyDown","Document/ScrollEvent"],r=2e3,m={addComment:UIUtils.getUIText("ERROR_COMMENTADD"),addReplyComment:"writer.common.ERROR_REPLYADD",resolveComment:UIUtils.getUIText("ERROR_RESOLVE"),reopenComment:UIUtils.getUIText("ERROR_REOPEN"),markRead:UIUtils.getUIText("ERROR_MARKREAD"),markUnread:"writer.common.MARKUNREAD",likeComment:"writer.common.ERROR_LIKE",unlikeComment:"writer.common.ERROR_UNLIKE",likeReplyComment:"writer.common.ERROR_LIKE",unlikeReplyComment:"writer.common.ERROR_UNLIKE",updateComment:UIUtils.getUIText("ERROR_EDIT"),updateReplyComment:UIUtils.getUIText("ERROR_EDIT"),deleteComment:UIUtils.getUIText("ERROR_DELETE"),deleteReplyComment:UIUtils.getUIText("ERROR_DELETE"),resolveAllComments:"writer.common.ERROR_RESOLVE_ALL",deleteAllComments:"writer.common.ERROR_DELETE_ALL",setVisibility:UIUtils.getUIText("ERROR_EDIT")},l=function(){CommentUtils.removeFocusLine()},a=function(i){var n=t.commentPaneView,o=CommentModelManager.isLinkedComment(i.id);if(i)if(n.currentFocusedComment===i){var s=EditorLayout.isRightPaneVisible()&&!ReviewPane.isCommentsTabActive();s&&ReviewPane.switchTab("comments"),CommentUtils.pullCommentIntoView(i.id)}else{CommentUtils.removeFocusLine();var r=!EditorLayout.isRightPaneVisible()&&!o&&!ReviewUtil.isReadCommentMode();r&&ModeManager.switchMode(LAYOUTS.COLLABORATE);var m;m=e.commentPane.get("currentView")!==e.COMMENTVIEWS.ALL&&(i.get("isResolved")?e.commentPane.get("currentView")!==e.COMMENTVIEWS.RESOLVED:e.commentPane.get("currentView")!==e.COMMENTVIEWS.UNRESOLVED);var s=EditorLayout.isRightPaneVisible()&&!ReviewPane.isCommentsTabActive();s&&ReviewPane.switchTab("comments"),e.commentPane.set("currentAuthor",!1,{dontRender:m}),m&&e.commentPane.set("currentView",e.COMMENTVIEWS.ALL),e.commentPane.get("renderInProgress")?e.commentPane.once("change:renderInProgress",function(e,t,n){t||(i.set("focusedFrom","editor"),i.set("inFocus",!0))}):(i.set("focusedFrom","editor"),i.set("inFocus",!0))}},c=function(e){editor.doc.getSelection().selectionType!==SEL_AUTO_GEN&&d(e)},d=function(i){var n,o=t.commentPaneView;if(i===editor.uuid&&editor.getRole().permissions.can("review.comment.view")&&e.updateCommentFocus){var s=e.SHOULD_HIGHLIGHT_RESOLVED_COMMENTS||editor.doc.getSelection().selectionType===SEL_AUTO_GEN;if(n=CommentUtils.enclosingCommentAtIndex(editor.doc.getSelection().getStart(),s),!n)return o.currentFocusedComment&&o.currentFocusedComment.set("inFocus",!1),!1;var r=e.commentCollection.get(n.id);a(r)}},u=function(t){var i=editor.doc.getSelection().createCursorOp(e.cursorSelection.start,e.cursorSelection.end);i=DocOpBuilder.build(i);var n=DocOpBuilder.xform(i,t),o=n.first.getCursorPos()[0];e.cursorSelection.start=o.start>=0?o.start:o.end,e.cursorSelection.end=o.end>=0?o.end:o.start},h=function(){t.commentPaneView||(t.commentCreationView=new CommentCreationView({model:e.commentPane}),t.commentPaneView=new CommentPaneView({model:e.commentPane}),t.commentCollectionView=t.commentPaneView.commentCollectionView,t.failedOpsView=new FailedOpsView,t.focusLine=new FocusLine("comment"),t.unlinkedFocusLine=new FocusLine("unlinked-comment",!0))},C=function(){n.forEach(function(e){e.func.apply(CommentManager,e.args)})},g=function(e,t,i,n){this.list=e,this.callback=t,this.timeout=i,this.delayOptions=n,this.timeoutId=null,this.dfd=J.Deferred(),this.currentIdx=0;var o=this;this._processItem=function(e,t,i){this.currentIdx=t,this.timeoutId=setTimeout(function(){o._callback(e,t)},i)},this._callback=function(t,i){this.callback(t,i),e[i+1]?(i++,this._processItem(e[i],i,this.timeout)):this._done()},this._addSubscribers=function(){PubSub.subscribe(this.delayOptions.on,this._delay)},this._removeSubscribers=function(){PubSub.unsubscribe(this.delayOptions.on,this._delay)},this._delay=function(t){clearTimeout(o.timeoutId),o._processItem(e[o.currentIdx],o.currentIdx,o.delayOptions.timeout)},this.start=function(){return this.list.length?(this._addSubscribers(),this._processItem(this.list[0],0,this.timeout),this.dfd):this._done()},this._done=function(){return this._removeSubscribers(),this.dfd.resolve(),this.dfd},this.stop=function(){clearTimeout(this.timeoutId),this._done()},this.pause=function(){},this.resume=function(){}},p=function(){e.commentPane.get("commentCreationDialogShow")&&e.cursorSelection.start&&e.cursorSelection.end&&CommentUtils.showCurrentCommentSelection(e.cursorSelection.start,e.cursorSelection.end)},f=function(){if(editor.isOffline()||!o||CommentModels.commentPane.get("isReadOnly"))return!1;if(v(),J.dialogutil.isDialogOpened("findandreplace")&&J.dialogutil.close("findandreplace"),PopupHandler.closePopup("smartToolbar"),editor.clientActiveSection&&editor.clientActiveSection.className.indexOf("zw-contentpane")==-1||editor.doc.getSelection().canEditLockRange()||editor.doc.getSelection().isListItemSelection)return!1;t.commentPaneView.currentFocusedComment&&t.commentPaneView.currentFocusedComment.set("inFocus",!1),ReviewPane.switchTab("comments");var i=e.commentPane.get("currentAuthor"),n=e.commentPane.get("currentView"),s=i||n!==e.COMMENTVIEWS.UNRESOLVED&&n!==e.COMMENTVIEWS.ALL;s&&(e.commentPane.set("currentAuthor",!1,{dontRender:!0}),e.commentPane.set("currentView",e.COMMENTVIEWS.UNRESOLVED,{sync:!0})),t.commentPaneView.cancelSearch();var r;if(CommentModels.isRichCommentsEnabled()){var m=t.commentCreationView.editorView;r=!m.isEmpty()}else r=t.commentCreationView.$el.find("#textarea").val().trim();e.commentPane.get("commentCreationDialogShow")&&r?(t.commentCreationView.$el.find("#textarea").trigger("focus"),p()):e.commentPane.get("commentCreationDialogShow")&&!r?e.commentPane.set("commentCreationDialogShow",!1,{then:function(){e.commentPane.set("commentCreationDialogShow",!0)}}):(CommentModels.isRichCommentsEnabled()&&t.commentCreationView.editorView.reset(),e.commentPane.set("commentCreationDialogShow",!0))},v=function(){var e=editor.doc.getSelection().getParents(NODE_TYPE.IMAGE);if(e){var t=editor.doc.createRange(e.getStart(),e.getEnd());editor.doc.getSelection().setSelectionType(SEL_AUTO_GEN).removeAllRanges().addRange(t),ActivityTracker.trackInAnalytics("Comment","CommentOnImage","ReviewPanel")}},E=function(e){CommentHighlights.highlightMap.removeByComment(e),CommentUtils.removeDocNotification(e)},y=function(i){e.commentPane.set("isReadOnly",i),e.commentCollection.each(function(e){if(t.commentCollectionView){t.commentCollectionView.commentViewMap[e.id];e.set("inEditingMode",!1)}}),e.commentPane.set("commentCreationDialogShow",!1)},w=function(t){e.commentPane.set("isReadOnly",t)},b=function(){if(i)return!1;i=!0,PubSub.subscribe("Comment/RangeEndInserted",function(e,t){CommentHighlights.pushToHighlightQueue(e)}),e.commentCollection.on("remove",function(e){E(e.id)}),PubSub.subscribe("Comment/RangeEndRemoved",function(e){ZWArrayUtils.each(e,function(e){CommentHighlights.highlightMap.removeByComment(e)})});var t=["DocOperation/CommandComplete","DocOperation/CollabCommandComplete"];ZWArrayUtils.each(t,function(t){PubSub.subscribe(t,function(t,i){e.commentPane.get("commentCreationDialogShow")&&u(i)})}),PubSub.subscribe("Document/BeforeLoading",function(){CommentManager.reset()}),PubSub.subscribe("UI/OfflineMode",y),PubSub.subscribe("Document/EditorReady",W),Utils.WriterCallbacks.register("unload",Utils.negate(_)),Utils.WriterCallbacks.register("onmenuhide",Utils.negate(CommentModels.isAllCommentsPosted)),Utils.WriterCallbacks.register("onOfflineSave",x),Utils.WriterCallbacks.register("beforeprint",P),Utils.WriterCallbacks.register("beforeTCNoMarkupLoad",x)},R=function(){PubSub.subscribe(DOMVIEW.LINE_ADDED,CommentHighlights.updateHighlight),PubSub.subscribe(DOMVIEW.LINE_UPDATED,CommentHighlights.updateHighlight),PubSub.subscribe("Document/ModeOpened",I),PubSub.subscribe(["Reviewpane/closed","Reviewpane/opened"],I),PubSub.subscribe(DOCVIEW.PARAVIEW_BEFORE_REMOVE,function(e){ZWArrayUtils.each(e,function(e){ZWArrayUtils.each(e.nodeLines,function(e){CommentUtils.discardHighlights(e)})})}),PubSub.subscribe("lineview/before/remove",CommentUtils.discardHighlights),PubSub.subscribe("Comment/RangeEndInserted",function(e){ZWArrayUtils.each(e,function(e){var t=CommentModels.commentCollection.get(e);t&&t.set("isRangeCharsRendered",!0)})}),PubSub.subscribe("Document/CursorPositionChanged",l),PubSub.subscribe("Document/CursorPositionChanged",function(e){isFindSelection=J(".overlay.zw-find").length,isFindSelection?t.commentPaneView.currentFocusedComment&&t.commentPaneView.currentFocusedComment.set("inFocus",!1):c(e)}),PubSub.subscribe("Document/History/BeforeLoad",function(){t.commentPaneView.currentFocusedComment&&t.commentPaneView.currentFocusedComment.set("inFocus",!1)}),PubSub.subscribe("DocOperation/CommandComplete",CommentHighlights.drawHighlight),PubSub.subscribe("DocOperation/CommandProgress",p),PubSub.subscribe("DocOperation/CommandComplete",p),PubSub.subscribe("Document/ViewChanged",function(){var t=[EDITOR_VIEWS.HISTORY,EDITOR_VIEWS.MAILMERGE_PREVIEW,EDITOR_VIEWS.PRINT_PREVIEW,EDITOR_VIEWS.TEMPLATEI_EDIT,EDITOR_VIEWS.VERSIONVIEW];ZWArrayUtils.arrayContains(t,editor.getView())?CommentUtils.removeCommentUI():e.commentPane.set("show",!0)}),PubSub.subscribe("Document/ModeOpened",function(){M()}),PubSub.subscribe(["Reviewpane/opened","Reviewpane/closed"],function(){M()}),PubSub.subscribe("UiEvents/EditorParentOffsetChanged",CommentUtils.updateFocusLine),PubSub.subscribe("Document/FinalStateModified",function(e){t.commentPaneView.currentFocusedComment&&t.commentPaneView.currentFocusedComment.set("inFocus",!1),e.STATUS?CommentUtils.hideAllHighlights():CommentUtils.showAllHighlights()}),PubSub.subscribe("Editor/Freeze",function(){w(!0)}),PubSub.subscribe("Editor/Unfreeze",function(){w(!1)}),PubSub.subscribe("Comment/BeforeLoadModels",F),PubSub.subscribe("Comment/AfterLoadModels",H),PubSub.subscribe("Comment/AfterReload",z)},M=function(){CommentUtils.removeFocusLine(),e.commentPane.get("commentCreationDialogShow")&&(CommentUtils.positionCommentDialog(),t.commentCreationView.focus())},O=function(){return e.commentPane.get("commentCreationDialogShow")},U=function(t){return void 0!=e.commentCollection.get(t)},T=function(t){return e.commentCollection.get(t)},S=function(){e.commentPane.set("commentCreationDialogShow",!1)},D=function(){var e=t.commentPaneView.currentFocusedComment;if(e){var i=t.commentCollectionView.commentBubbleViewMap[e.id];i&&i.trigger("showBubble")}},I=function(){t.commentPaneView.updateCommentPaneVariables(),CommentUtils.isReviewPaneVisible()||D()},V=function(){CommentManager.views.commentPaneView.currentFocusedComment=null,CommentHighlights.highlightMap.reset()},A=function(e,t){n.push({func:e,args:t})},L=function(){var t=docProps.subAction&&docProps.subAction.comments,i=e.SHOULD_HIGHLIGHT_RESOLVED_COMMENTS||t,n=CommentUtils.enclosingCommentAtIndex(editor.doc.getSelection().getStart(),i);if(t&&(n=docProps.subAction.comments),n&&e.commentCollection.get(n)){var o=e.commentCollection.get(n);o.get("isResolved")?e.commentPane.set("currentView",e.COMMENTVIEWS.RESOLVED):e.commentPane.set("currentView",e.COMMENTVIEWS.UNRESOLVED),o.set("focusedFrom","editor").set("inFocus",!0)}},x=function(){return{comments:{comment_sequence_number:e.getSequenceNumber(),comments:CommentModelManager.constructCommentsJSON()}}},P=function(){var e=!!CommentModels.commentCollection.length;return{comments:e}},N=function(){var t=docProps.subAction&&docProps.subAction.comments;if(t){var i=CommentModels.commentCollection.get(t),n=i&&i.get("isResolved");n&&CommentModels.commentPane.set("currentView",e.COMMENTVIEWS.RESOLVED)}CommentManager.afterInit(L),CommentManager.afterInit(function(){e.commentPane.set("isLoading",!1),e.commentCollection.updateUnreadCommentCount(),e.commentPane.trigger("updateCount")}),h(),R(),k()},k=function(){var e=Handlebars.compile(Z("unlinked-floating-icon").html()),t=J(e())[0];document.body.appendChild(t)},$=function(){if(!editor.getRole().permissions.can("review.comment.reply"))return!1;var e,i=ZWJSONUtils.mapJSON(t.commentCollectionView.commentViewMap,function(e){return e}).concat(ZWJSONUtils.mapJSON(t.commentCollectionView.commentBubbleViewMap,function(e){return e}));return e=CommentModels.isRichCommentsEnabled()?i.filter(function(e){return e.replyEditor&&!e.replyEditor.isEmpty()}):i.filter(function(e){return e.$el.find(".js-comment-reply-textarea").val().trim()}),!!e.length},_=function(){if(CommentModels.isRichCommentsEnabled()){var i=t.commentCreationView.editorView;if(e.commentPane.get("commentCreationDialogShow")&&!i.isEmpty())return!0}else if(e.commentPane.get("commentCreationDialogShow")&&t.commentCreationView.$el.find("#textarea").val().trim())return!0;return $()},j=function(){return!!CommentModels.commentCollection.getCount().total.all},F=function(){CommentManager.views.commentPaneView.stopListening(),CommentManager.views.commentCollectionView.stopListening()},H=function(){CommentManager.views.commentPaneView.listen(),CommentManager.views.commentCollectionView.listen()},z=function(){CommentManager.views.commentCollectionView.render({}),CommentModels.commentCollection.length&&CommentManager.views.commentPaneView.firstCommentHandler()},W=function(){o=!0,b(),editor.isOffline()||editor.isNonEditableView()||isV8Engine||CommentUtils.loadContacts(),e.SHOULD_HIGHLIGHT_RESOLVED_COMMENTS=CommentUtils.shouldHighlightResolved()};return{commentCollection:e.commentCollection,commentPane:e.commentPane,views:t,newComment:f,EMAIL_REGEX:e.EMAIL_REGEX,renderCommentPane:h,createCommentObj:e.CommentCollection.createComment,getCommentObj:T,isCommentCreationDialogInDisplay:O,isCommentExist:U,closeCommentCreationDialog:S,reset:V,afterInit:A,initViews:N,isUnposted:_,DelayableAsyncForEach:g,reload:reload,docHasComments:j,init:W,updateCommentFocus:a,executeAfterInitCallbacks:C,COMMENTLIST_RENDER_DELAY_EVENTS:s,COMMENTLIST_RENDER_DELAY_TIME:r,opErrorMap:m,focusCommentUnderCurrentSelection:d}}(CommentModels);!function(e,t,i){function n(i,n){this.textarea=i,this.$textarea=t(i);var o=n.commentId||this.$textarea.parent(".ui-ncmt-container").attr("cid");if(!e.atMention.enabled())return!1;var s=6,r='<div class="-sew-item-container"><div style="height:30px;width:30px;float:left;height:30px;width:30px;float:left;margin-right: 10px;margin-left: 10px;margin-top: 10px;" class="-sew-item-icon"><img style="border-radius: 100%;height:35px;width:35px;border:1px solid #e0e0e0;" id="contact-img" title=""></div><div class="-sew-item-text" style="float:left;padding:3px;"><div style="" class="-sew-item-fullname"><a style="white-space:nowrap;" class="ui-corner-all ui-cmt-atmention-fname" tabindex="-1"><span class="-full-name"></span></a></div><div class="-sew-item-email"><span class="graytxt">&nbsp;</span></div></div></div>',m='<ul class="ui-autocomplete ui-menu ui-widget ui-widget-content ui-corner-all zdc_shareautocompletedialog -sew-list-container -sew-list" role="listbox" aria-activedescendant="ui-active-menuitem" style="display: none; position: fixed;width:350px;"></ul>',l='<li class="ui-menu-item -sew-list-item clearfix" role="menuitem"></li>',a=function(e,t){JcustomItemTemplate=J(r),JcustomItemTemplate.find(".-full-name").text(t.fullname),JcustomItemTemplate.find(".graytxt").text("<"+t.emailid+">"),JcustomItemTemplate.find("#contact-img").attr("src",ZWNetworkUtils.getUserImageURL(t.zuid)),e.append(JcustomItemTemplate)},c=function(e,t){var i=e.values,n=e.query;if(""===n)return t([]);var o=i.filter(function(e,t){return!(!e.emailid||!e.fullname)&&(e.fullname.toLowerCase().startsWith(n.toLowerCase())||e.emailid.toLowerCase().startsWith(n.toLowerCase()))});CommentUtils.atMentionCustomFilter(o,n,t,this.extras.commentId)},d=function(e,t){var i=(t.offset().top,J(".comnt-stack-view-container").scrollTop(),function(){var i=e.offset(),n=e.getCaretPosition();t.detach().appendTo("body"),t.css({left:i.left+n.left,top:i.top+n.top}),t.css("left",4+i.left+"px"),t.css("top",parseInt(t.css("top"))+13+"px"),t.removeClass("shadow-top"),t.addClass("shadow-bottom");var o=parseInt(t.css("top"));if(heightOfSuggestionBox=t.outerHeight(),o>400){var s=o-heightOfSuggestionBox-33;t.css("top",s),t.removeClass("shadow-bottom"),t.addClass("shadow-top")}});i(),J(".comnt-stack-view-container").data("atmentionScrollHandlerAttached")||J(".comnt-stack-view-container").data("atmentionScrollHandlerAttached",!0).bind("scroll",function(e){t.is(":visible")&&i()})},u=function(t){e.atMention.isShowing=!0,t.is(":visible")||t.fadeIn(200)},h=function(t){e.atMention.isShowing=!1,t.is(":visible")&&t.fadeOut(200)},C=CommentUtils.getContacts();e.isRichCommentsEnabled()||this.$textarea.sew({values:C,elementFactory:a,filterFn:c,menuTemplate:m,listItemTemplate:l,maxNoOfSuggestions:s,renderCallback:d,show:u,hide:h,extras:{commentId:o}}),this.$textarea.on("mention-selected",function(e,t){J(e.target).trigger("input"),CommentUtils.showHint(e)}),this.$textarea.on("blur",function(e){CommentUtils.hideHint(e)})}var o="atMention";t.fn[o]=function(e){return this.each(function(){t.data(this,"plugin_"+o)||t.data(this,"plugin_"+o,new n(this,e||{}))})}}(CommentModels,jQuery,U);