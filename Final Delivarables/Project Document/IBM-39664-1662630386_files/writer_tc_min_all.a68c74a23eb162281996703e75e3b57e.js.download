zw.define("TCPopup",[],[],function(){var e,t,n=!1,i=!1,o=!1,r=function(){editor.getRole().permissions.can("document.edit")&&editor.doc.getTrackChangeDetails().getDisplayMode()===TCConstants.ALL_MARKUP_VIEW?(C(),E()):(s(),_())},a=function(e){try{var t=Z("tc-popup"),i=TrackChangeUI.RevisionNodeDOMHandler.getHtml(e,!0);Z("tc-popup-changes-cont").empty().append(i),i.removeAttr("data-zw-action"),UIStateHandler.build(i[0]),n?ReviewUtil.positionPopUp("tc"):(t.show(),ReviewPopupHandler.showPopupCont(ReviewPopupHandler.POPUP_TYPES.TC,ReviewUtil.getUserColour(e.getLastModifiedUser())))}catch(e){throw ZWLogger.log("Exception occurred while showing TC popup"),ZWLogger.log("Exception: "+(e.stack||e)),ZWLogger.log("Range start : "+rng.start+"... end : "+rng.end),e}},c=function(t){try{var n=editor.doc.getSelection();if(s(),!t&&n.selectionType!=SEL_MOUSE)return;t=t||TcManager.getNodeAtIndex(n.getStart()),t&&(a(t),e=t,i=!0,ActivityTracker.trackInAnalytics("Tc","ViewChange","Popup"),setTimeout(function(){!o&&i&&(J(document).on("click",s),PubSub.subscribe("Document/CursorPositionChanged",s),o=!0)},50))}catch(e){ZWLogger.log("Exception occurred while opening TC popup"),ZWLogger.log("Exception: "+(e.stack||e)),t&&ZWLogger.log("Node start : "+t.getStart()+"... end : "+t.getEnd())}},s=function(){try{e&&(Z("tc-popup").hide(),n||ReviewPopupHandler.hidePopupCont(ReviewPopupHandler.POPUP_TYPES.TC),e=void 0,J(document).off("click",s),PubSub.unsubscribe("Document/CursorPositionChanged",s),o=!1),i=!1}catch(e){ZWLogger.log("Exception occurred while closing TC popup"),ZWLogger.log("Exception: "+(e.stack||e))}},l=function(t){e&&TCHandler.accept(e,t)},u=function(t){e&&TCHandler.reject(e,t)},E=function(){s();var e=Z("tc-popup");n=EditorLayout.isRightPaneVisible()&&LayoutManager.getCurrentLayout()!=LAYOUTS.FULLSCREEN,n?(e.css("position","absolute"),Z("tcpopup-cont").append(e),Z("tc-popup-peak-div").show(),Z("tc-popup-content").empty()):(e.css({position:"relative",top:0,left:0}),e.appendTo(Z("popup-menu-tc-container")),Z("tc-popup-peak-div").hide())},d=function(){var t=function(e){var t=e.currentTarget,n=e.target,i=e.target.className,o=!1,r=n.parentElement.className||"";if(i.indexOf("js-changes-acpt")>=0||r.indexOf("js-changes-acpt")>=0)l(),o=!0;else if(i.indexOf("js-changes-rejt")>=0||r.indexOf("js-changes-rejt")>=0)u(),o=!0;else if(i.indexOf("js-tc-expand-btn")>=0){var a=J(t);n.style.display="none",a.find(".js-content").removeClass("tc-reviewcontent-shrinked"),a.find(".js-tc-collapse-btn")[0].style.display="inline-block"}else if(i.indexOf("js-tc-collapse-btn")>=0){var a=J(t);n.style.display="none",a.find(".js-content").addClass("tc-reviewcontent-shrinked"),a.find(".js-tc-expand-btn")[0].style.display="inline-block"}o||DomUtil.stopEvent(e)},n=function(e){var t=e.currentTarget,n=e.target,i=e.target.className,o=n.parentElement.className||"",r=!1;t.getAttribute("node-id");if(i.indexOf("js-tc-radio-bt")>=0)n.parentElement.querySelector(".js-tc-checkbox").checked=!0,e.stopPropagation();else if(i.indexOf("js-changes-acpt")>=0||o.indexOf("js-changes-acpt")>=0){var a=t.querySelector("input:checked"),c=0;a&&(c=a.getAttribute("data-changeId")),l([c,!1]),r=!0}else(i.indexOf("js-changes-rejt")>=0||o.indexOf("js-changes-rejt")>=0)&&(u([!1]),r=!0);r||DomUtil.stopEvent(e)},i=function(e){var t=e.getStart(),n=e.getEnd();e.getType()!==NODE_TYPE.ROW&&e.getType()!==NODE_TYPE.TABLE||(t+=1);var i=editor.doc.createRange(t,n);editor.doc.getSelection().setSelectionType(SEL_AUTO_GEN).removeAllRanges().addRange(i);var o=DomUtil.scrollElementIntoView(editor.doc.getCursorPortionNode());return o},o=function(){var t,n,o=editor.doc.getSelection().getStart(),r=-1;e&&(r=TcManager.getCollection().getNodeIndex(e)),n=TcManager.getCollection().getAllNodes();for(var a=r+1,s=n.length;a<s&&(t=n[a],t.isHiddenNode()||!(r>=0||t.getStart()>o));a++);if(t||(t=n[0]),t){var l=i(t);l&&l.promise().then(function(){c(t)})}},r=function(){var t,n,o=editor.doc.getSelection().getStart(),r=-1;e&&(r=TcManager.getCollection().getNodeIndex(e)),n=TcManager.getCollection().getAllNodes(),len=r>0?r:n.length;for(var a=len-1;a>=0&&(t=n[a],t.isHiddenNode()||!(r>=0||t.getStart()<o));a--);if(t||(t=n[n.length-1]),t){var s=i(t);s&&s.promise().then(function(){c(t)})}};Z("tc-popup").on("click","span.js-tc-nav-prev",r),Z("tc-popup").on("click","span.js-tc-nav-next",o),Z("tc-popup").on("click","div.js-tc-card-cont",t),Z("tc-popup").on("click","div.js-tc-fillablefiled-cont",n)};d();var T=function(){e&&(clearTimeout(t),t=setTimeout(function(){e&&a(e)},500))},g=function(e){e===KEYS.ESC&&s()},C=function(){PubSub.subscribe("Cursor/Collapsed",c),PubSub.subscribe("Document/BeforeKeyDown",g),EditorLayout.isRightPaneVisible()?PubSub.subscribe("UiEvents/EditorParentOffsetChanged",T):PubSub.unsubscribe("UiEvents/EditorParentOffsetChanged",T)},_=function(){PubSub.unsubscribe("Cursor/Collapsed",c),PubSub.unsubscribe("Document/BeforeKeyDown",g),PubSub.unsubscribe("UiEvents/EditorParentOffsetChanged",T)};return PubSub.subscribe(["Document/TC/ViewChanged","Document/LayoutChanged"],r),Macros.isRemote()&&PubSub.subscribe(["Reviewpane/opened","Reviewpane/closed"],r),{init:r}});var TrackChangeUI=function(){var e,t,n,i,o,r=UNICODE.IMAGE+UNICODE.TAB+UNICODE.PARA+UNICODE.HR+UNICODE.BR+UNICODE.RANGE_START+UNICODE.RANGE_END,a=new RegExp("([^"+r+"]+){1}|(["+r+"]+){1}","g"),c=null,s=!0,l={};l[TCConstants.ALL_MARKUP_VIEW]="<div>"+J.i18n("trackchange","ALL_MARKUP_VIEW_MESSAGE")+"</div>",l[TCConstants.NO_MARKUP_VIEW]='<div><span class="ui-fl ui-right-margin-verysmall">'+J.i18n("trackchange","NO_MARKUP_VIEW_MESSAGE",['</span><button id="tc-banner-nomarkup" zui-disable="state.offline,state.freeze" ctype="zmenubutton" class="ui-fl ui-transbtn-blue-txt" data-menu-id="tcviewsmenu" data-arrow-icon-class-name= "ui-btn-arrow-down-fill" >','</button><span class="ui-fl ui-left-margin-verysmall">'])+'</span><span class="ui-fl ui-icon-close-black-sm ui-left-margin-small ui-ms-pointer" onclick="TrackChangeUI.closeTcViewBanner()" title="Close"></span></div>',l[TCConstants.ORIGINAL_VIEW]='<div><span class="ui-fl ui-right-margin-verysmall">'+J.i18n("trackchange","ORIGINAL_VIEW_MESSAGE",['</span><button id="tc-banner-original" zui-disable="state.offline,state.freeze" ctype="zmenubutton" class="ui-fl ui-transbtn-blue-txt" data-menu-id="tcviewsmenu" data-arrow-icon-class-name= "ui-btn-arrow-down-fill" >','</button><span class="ui-fl ui-left-margin-verysmall">'])+'</span><span class="ui-fl ui-icon-close-black-sm ui-left-margin-small ui-ms-pointer" onclick="TrackChangeUI.closeTcViewBanner()" title="Close"></span></div>';var u,E=function(){var e={owner:{show:["#bbar-trackall-cont","#review-trackall-cont"],hide:["#bbar-trackself-cont","#bbar-tc-on-cont","#review-trackself-cont","#review-tc-on-cont"]},collab:{tcAlreadyEnabledByOwner:{show:["#bbar-tc-on-cont","#review-tc-on-cont"],hide:["#bbar-trackself-cont","#review-trackself-cont"]},tcNotEnabledByOwner:{show:["#bbar-trackself-cont","#review-trackself-cont"],hide:["#bbar-tc-on-cont","#review-tc-on-cont"]}}};return e},d=function(){var e={owner:{show:["#view-lpnl-trackall-cont"],hide:["#view-lpnl-trackself-cont","#view-lpnl-tc-on-cont"]},collab:{tcAlreadyEnabledByOwner:{show:["#view-lpnl-tc-on-cont"],hide:["#view-lpnl-trackself-cont"]},tcNotEnabledByOwner:{show:["#view-lpnl-trackself-cont"],hide:["#view-lpnl-tc-on-cont"]}}};return e},T=function(){g(),le(),$(),W(),i=new FocusLine("trackchange"),Utils.WriterCallbacks.register("beforeprint",f),ModeManager.getCurrentMode()===EDITOR_MODES.COLLABORATE&&LayoutManager.getCurrentLayout()!=LAYOUTS.FULLSCREEN&&Y(),R(),_e.init()},g=function(){e=J("#review-tb"),t=e.find("#review-tb-tcallmarkup"),n=J("#bottombar"),u=J(".js-trackchange-switch")},C=function(e,t){t?J(e.show.join(",")).css("display","flex"):J(e.show.join(",")).show(),J(e.hide.join(",")).hide()},_=function(){var e=editor.doc.getBodyFormat(),t=editor.doc.getTrackChangeDetails(),n=(editor.doc.docInfo,e[ATTR_BODY.TC_ON_BY_ZUID]?ReviewUtil.getUserProp(e[ATTR_BODY.TC_ON_BY_ZUID],"fname_HTML"):"Owner");n=Utils.encodeHTMLString(n),t.isEnabled()&&t.isONByOwner()&&(t.isOwner()?t.isOwner()&&editor.zuid!==e[ATTR_BODY.TC_ON_BY_ZUID]&&UIUtils.showMessage("info",J.i18n("trackchange","TC_TURNED_ON",[n]),"showclose","normalfont",4e3):UIUtils.showMessage("info",J.i18n("trackchange","TC_TURNED_ON_BY_OWNER",[n]),"showclose","normalfont",4e3))},b=function(){editor.getRole().permissions.can("document.edit")&&!isV8Engine&&(_(),R())},L=function(e,t){var n=editor.doc.getTrackChangeDetails(),i=n.isOwner()?"owner":"collab";if(n.isEnabled()&&n.isONByOwner()){A(),C(e[i].tcAlreadyEnabledByOwner,t);var o=editor.doc.getBodyFormat(),r=o[ATTR_BODY.TC_ON_BY_ZUID]?ReviewUtil.getUserProp(o[ATTR_BODY.TC_ON_BY_ZUID],"fname_HTML"):"Owner";r=Utils.encodeHTMLString(r);var a=J.i18n("trackchange","TC_ON_BY_TOOLTIP",[r]);return Z("bbar-tcswitch-outer").find("#bbar-tcswitch-on").attr("title",a),void Z("review-tcswitch-on").attr("title",a)}p(),C(e[i].tcNotEnabledByOwner,t)},A=function(){u.ztoggleswitch("disable")},p=function(){u.ztoggleswitch("enable")},R=function(e){var t=editor.doc.getTrackChangeDetails();if(editor.getRole().permissions.can("review.changes.trackself")||editor.getRole().permissions.can("review.changes.trackall")){var n=t.isOwner()?"owner":"collab",i=e===!0?d():E();"collab"===n?L(i,e):(C(i.owner,e),p()),t.isEnabled()?u.ztoggleswitch("switchOn"):u.ztoggleswitch("switchOff"),editor.doc.docInfo.CHECKEDOUT&&editor.doc.docInfo.CHECKEDOUTBY_ZUID!=editor.zuid&&A()}},f=function(){var e=!TcManager.docHasTrackedChanges();return{TC:e}},I=function(){var e=editor.doc.getTrackChangeDetails(),t=new DocOpBuilder;t.operation="load";var n=editor.doc.getSelection().getLastRange();t.cursorStart=n.start,t.cursorEnd=n.end,t.cursor.push(n.offset()),DocTreeManager.refreshTree(),t.postApplyTo(),e.getDisplayMode()===TCConstants.ALL_MARKUP_VIEW||e.getDisplayMode()===TCConstants.NO_MARKUP_VIEW?CurUtil.blinkCursor():CurUtil.stopBlinking()},N=function(){var e=editor.doc.getTrackChangeDetails();e.getDisplayMode()===TCConstants.ORIGINAL_VIEW?editor.rebindEvents(TRACKCHANGE_PERMISSION):editor.rebindEvents()},D=function(){var e=editor.doc.getTrackChangeDetails(),t=e.getDisplayMode();t===TCConstants.ORIGINAL_VIEW?(y(!1),editor.jeditorPane.find("div.spell-error, div.grammar-error").hide(),N(),CurUtil.stopBlinking()):y(!0)},h=function(){var e=editor.doc.getTrackChangeDetails().getDisplayMode();e!==TCConstants.ALL_MARKUP_VIEW&&m(TCConstants.ALL_MARKUP_VIEW)},v=function(){var e=editor.doc.getTrackChangeDetails().getDisplayMode(),t=l[e],n=e===TCConstants.ALL_MARKUP_VIEW?3e3:0;s&&(U(),c=ZAlertBanner.show({message:t,hideDelay:n,type:"warning",isMessageHTMLEncoded:!0,closeButton:!1}),UIUtils.initComponent(c),UIStateHandler.build(J("#"+c)[0]))},S=function(){s=!1,U()},U=function(){c&&ZAlertBanner.hide("#"+c)},O=function(e){var t=editor.doc.getTrackChangeDetails(),n=t.getDisplayMode();t.setDisplayMode(e);var i=editor.doc.getUserData()[editor.zuid];if(i[TCConstants.TC_VIEW]=e,N(),n===TCConstants.ALL_MARKUP_VIEW)e===TCConstants.NO_MARKUP_VIEW?TcNoMarkupHandler.setup():e===TCConstants.ORIGINAL_VIEW&&I();else if(n===TCConstants.NO_MARKUP_VIEW)UIUtils.showLoadingMsg(J.i18n("writer.common.LOADING")),PubSub.subscribe("Document/LoadingStart",P),editor.reloadDocumentContent(),PubSub.publish("Document/MarkupviewChanged");else if(n===TCConstants.ORIGINAL_VIEW){if(e===TCConstants.ALL_MARKUP_VIEW)I();else if(e===TCConstants.NO_MARKUP_VIEW){t.setDisplayMode(TCConstants.ALL_MARKUP_VIEW),I(),t.setDisplayMode(TCConstants.NO_MARKUP_VIEW),TcNoMarkupHandler.setup();var o=editor.doc.createRange();editor.doc.getSelection().removeAllRanges().addRange(o)}PubSub.publish("Document/MarkupviewChanged")}v(),D(),PubSub.publish("Document/TC/ViewChanged")},m=function(e){e=parseInt(e);var t=0;if(editor.doc.getTrackChangeDetails().getDisplayMode()!==e){O(e);var n=function(e){},i=function(){t++,t<=3&&Macros.review.setTcView(e,n,i)};Macros.review.setTcView(e,n,i)}},P=function(){editor.initDocument(),UIUtils.hideLoadingMsg(),PubSub.unsubscribe("Document/LoadingStart",P)},w=function(){EditorLayout.hideRightPanel(),editor.onResize()},M=function(){EditorLayout.showRightPanel(),editor.onResize()},F=function(){var e=J(".ui-nav.ui-navbar-nav.ui-side-menu").children();e.push(Z("view-lpnl-reader"),Z("view-lpnl-zoom-cont"),Z("view-lpnl-navigatepane"),Z("view-lpnl-pilcrow")),e.push(Z("view-lpnl-gridlines"),Z("view-lpnl-layout-cont")),UIUtils.disableMenuTabs(e),J("#menu-view-parent").removeClass("ui-zwdisabled")},k=function(){var e=J(".ui-nav.ui-navbar-nav.ui-side-menu").children();e.push(Z("view-lpnl-reader"),Z("view-lpnl-zoom-cont"),Z("view-lpnl-navigatepane"),Z("view-lpnl-pilcrow")),e.push(Z("view-lpnl-gridlines"),Z("view-lpnl-layout-cont")),UIUtils.enableMenuTabs(e)},y=function(e){if(e){if(!editor.getRole().permissions.can("document.edit"))return;J("#topband-modes").zselectbox("enable"),UIUtils.hideWrappers(!1),R(),UIUtils.toggleCollabActionButtons(),LayoutManager.getCurrentLayout()===LAYOUTS.COLLABORATE&&M(),LayoutManager.isRichEditActive()&&LeftPanel.isPanelVisible(ELEM_ID.VIEWPANEL)&&k()}else J("#topband-modes").zselectbox("disable"),A(),UIUtils.hideWrappers(!0),LayoutManager.getCurrentLayout()===LAYOUTS.COLLABORATE&&w(),LayoutManager.isRichEditActive()&&(LeftPanel.isPanelVisible(ELEM_ID.VIEWPANEL)?F():LeftPanel.toggleLeftPanel())},V=function(){var e=editor.doc.getTrackChangeDetails(),t=e.getDisplayMode(),n="";t===TCConstants.ALL_MARKUP_VIEW?n=J.i18n("trackchange","ALL_MARKUP"):t===TCConstants.NO_MARKUP_VIEW?n=J.i18n("trackchange","NO_MARKUP"):t===TCConstants.ORIGINAL_VIEW&&(n=J.i18n("trackchange","ORIGINAL_ONLY")),Z("review-tb-tcallmarkup").zmenubutton("changeLabel",n)},B=function(){UIUtils.showMessagePopup(J.i18n(UIUtils.getUIText("TC_CONTENT_LOADING_ERROR")),J.i18n("error","UH_OH"),"error",function(){location.reload()},!0),PubSub.unsubscribe("trackchange/errormsg",B)},W=function(){editor.getView()!==EDITOR_VIEWS.HISTORY&&editor.getView()!==EDITOR_VIEWS.MAILMERGE_PREVIEW&&(clearTimeout(o),o=setTimeout(function(){var e=TcManager.getCollection().getVisibleNodesCountDetails().all;if(e>0){var t=e>99?"99+":e;Z("bbar-tc-review-count").text(t).attr("title",J.i18n("trackchange","REVIEW_CHANGES_PENDING",[e])).show()}else Z("bbar-tc-review-count").hide()},100))},x=function(e,t){e!==t&&(e===LAYOUTS.VERSIONHISTORY||e===LAYOUTS.MAILMERGEPREVIEW||e===LAYOUTS.PRINTPREVIEW?ReviewUtil.showUserListPanel():t!==LAYOUTS.VERSIONHISTORY&&t!==LAYOUTS.MAILMERGEPREVIEW&&t!==LAYOUTS.PRINTPREVIEW||(ReviewUtil.hideUserListPanel(),editor.doc.getTrackChangeDetails().getDisplayMode()!=TCConstants.ALL_MARKUP_VIEW&&(editor.doc.getTrackChangeDetails().setDisplayMode(TCConstants.ALL_MARKUP_VIEW),D())),t===LAYOUTS.COMPOSE||t===LAYOUTS.COLLABORATE||t===LAYOUTS.COMPLETE?editor.doc.getTrackChangeDetails().getDisplayMode()!=TCConstants.ALL_MARKUP_VIEW&&v():U(),t===LAYOUTS.COLLABORATE?Y():j())},Y=function(){V(),H(),PubSub.subscribe("Document/TC/ViewChanged",V),PubSub.subscribe("Document/TC/CountUpdated",H),PubSub.subscribe("Document/TCPropertiesChanged",H)},j=function(){PubSub.unsubscribe("Document/TC/ViewChanged",V),PubSub.unsubscribe("Document/TC/CountUpdated",H),PubSub.unsubscribe("Document/TCPropertiesChanged",H)},H=function(){if(!(editor.isOfflineMode||editor.doc.docInfo.CHECKEDOUT&&editor.doc.docInfo.CHECKEDOUTBY_ZUID!=editor.zuid)){var e=0!==TcManager.getCollection().getVisibleNodesCountDetails().all||editor.doc.getTrackChangeDetails().isEnabled();e?t.zmenubutton("enable"):t.zmenubutton("disable")}},z=function(){var e=editor.doc.getTrackChangeDetails().getDisplayMode();Z("view-lpnl-tcmarkup").find("input[type=radio][value="+e+"]")[0].checked=!0,G()},G=function(){if(!editor.isOfflineMode){var e=0!==TcManager.getCollection().getVisibleNodesCountDetails().all||editor.doc.getTrackChangeDetails().isEnabled();e?Z("view-lpnl-tcmarkup").removeClass("ui-disabled-elem"):Z("view-lpnl-tcmarkup").addClass("ui-disabled-elem")}},K=function(){TCAdaptor.drawLeftPanelTcStatus(!0)},X=function(e){e===ELEM_ID.VIEWPANEL&&editor.getRole().permissions.can("review.changes.view")&&((editor.getRole().permissions.can("review.changes.trackself")||editor.getRole().permissions.can("review.changes.trackall"))&&(K(),PubSub.subscribe("Document/TCPropertiesChanged",K)),z(),PubSub.subscribe(["Document/TC/CountUpdated","Document/TCPropertiesChanged"],G),PubSub.subscribe("Document/TC/ViewChanged",z))},q=function(e){e===ELEM_ID.VIEWPANEL&&editor.getRole().permissions.can("review.changes.view")&&((editor.getRole().permissions.can("review.changes.trackself")||editor.getRole().permissions.can("review.changes.trackall"))&&PubSub.unsubscribe("Document/TCPropertiesChanged",K),PubSub.unsubscribe(["Document/TC/CountUpdated","Document/TCPropertiesChanged"],G),PubSub.unsubscribe("Document/TC/ViewChanged",z))},$=function(){if(!(isHeadlessPDF||isHeadlessHTML||editor.isOffline())&&editor.getRole().permissions.can("document.edit")){var e=0;Z("review-tb-usercolor").zbutton().zbutton("disable");var t=function(e){var t=J("#usercolor-wrapper");Z("review-tb-usercolor").zbutton("enable");for(var n=0,i=e.length;n<i;n++){var o=DomUtil.createElement(NODE_NAME.SPAN,{class:"js-collab-color","data-zw-action":"ChangeColor","data-color":e[n].color});o.style.backgroundColor=e[n].color,t.append(o)}UIStateHandler.build(t[0]),t.find(".js-collab-color").on("click",function(){var e=this.getAttribute("data-color"),t=editor.doc.getUserData()[editor.zuid].color;if(t!=e){var n=Q(e);if(ne(),n.length)for(var i=0,o=n.length;i<o;i++)n[i].zuid!=editor.zuid&&te(J.i18n("writer.common.COLOR_ALREADY_CHOOSEN_INFO",[n[i].fname]));ee(e),TcUtil.setUserColor(e)}}),Z("usercolor-checkbox").on("click",function(){var e=J(this).is(":checked"),t=Z("usercolor-dialog").find("span[data-color-selected=true]").attr("data-color");TcUtil.setDefaultUserColor(e,t)});var r=editor.doc.getUserData()[editor.zuid].color;ee(r),UIUtils.initComponent("usercolor-dialog")},n=function(e,i){if(i++,i<3)Macros.getUserColors(t,n,i);else{var o=ZWCollaboration.TC_USER_COLORS_NOT_LOADED;ZWLogger.sendErrorDetails(o+" <ZWERROR>\n Error Log Start \n\n Err No ="+o+" DOC len ="+editor.doc.getDocumentLength()+" buildLabel::: "+buildLabel+"\n Error Log End \n<ZWERROR>",null,o)}};Macros.getUserColors(t,n,e)}},Q=function(e){var t=[],n=editor.doc.getUserData();for(var i in n)n.hasOwnProperty(i)&&n[i].color===e&&t.push(n[i]);return t},ee=function(e){var t=editor.doc.getUserData()[editor.zuid];Z("usercolor-dialog").find("span[data-color-selected=true]").removeClass("ui-usercolor-selected").removeAttr("data-color-selected"),Z("usercolor-dialog").find("span[data-default-color-selected=true]").removeClass("ui-usercolor-default-selected").removeAttr("data-default-color-selected").removeAttr("title"),t.default_color&&t.default_color!=e&&Z("usercolor-dialog").find("span[data-color="+t.default_color+"]").addClass("ui-usercolor-default-selected").attr({title:"Your default color","data-default-color-selected":!0}),Z("usercolor-dialog").find("span[data-color="+e+"]").addClass("ui-usercolor-selected").attr("data-color-selected",!0),t.default_color&&t.default_color==e?Z("usercolor-checkbox").prop("checked",!0):Z("usercolor-checkbox").prop("checked",!1)},te=function(e){Z("usercolor-popup-infomsg").text(e),Z("usercolor-popup-info").show()},ne=function(){Z("usercolor-popup-info").hide()},ie=function(e){var t,n=e.start,i=e.end,o=e.type,r=[],a=editor.doc.getRawFormatAt(n);if(o===NODE_TYPE.TABLE)t=DomUtil.createElement(NODE_NAME.SPAN,null,"< Table >"),r.push(t);else if(o===NODE_TYPE.ROW)t=DomUtil.createElement(NODE_NAME.SPAN,null,"< Row >"),r.push(t);else if(o===NODE_TYPE.AUTOFIELD)t=DomUtil.createElement(NODE_NAME.SPAN,null,TcUtil.getAutoFieldValue(a,n,i)+""),r.push(t);else if(o===NODE_TYPE.SIGNERFIELD){var c=a[ATTR_SIGNERFIELD.SFINFO],s=c[ATTR_SIGNERFIELD.SFTYPE];if(a[ATTR_SIGNERFIELD.SIGNTYPE]!==SIGN_TYPE.ESIGN||s!==SIGNERFIELD_TYPE.SIGNATURE&&s!==SIGNERFIELD_TYPE.INITIAL)t=DomUtil.createElement(NODE_NAME.SPAN,null,c[ATTR_SIGNERFIELD.VALUE]||"");else{var l=DomUtil.processImgSrc(c[ATTR_SIGNERFIELD.SRC]);t=DomUtil.createElement(NODE_NAME.IMAGE,{src:l,"data-zw-imagesrc":l,class:"tc-shrink-img"})}r.push(t)}else if(o===NODE_TYPE.TOC)t=DomUtil.createElement(NODE_NAME.SPAN,null,"< Table of Content >"),r.push(t);else if(o===NODE_TYPE.FOOTNOTE)t=DomUtil.createElement(NODE_NAME.SPAN,null,"< Footnote >"),r.push(t);else if(o===NODE_TYPE.ENDNOTE)t=DomUtil.createElement(NODE_NAME.SPAN,null,"< Endnote >"),r.push(t);else if(o===NODE_TYPE.FILLABLEFIELD)t=DomUtil.createElement(NODE_NAME.SPAN,null,"< Fillable Field >"),r.push(t);else if(o===NODE_TYPE.MAILMERGEFIELD)t=DomUtil.createElement(NODE_NAME.SPAN,null,editor.doc.getContent(n+1,i-1)),r.push(t);else{var u=editor.doc.getContent(n,i);r=oe(n,u)}return r},oe=function(e,t){var n,i=[];a.lastIndex=0;for(var o=a.exec(t);o;){var r=o[1],c=o[2];if(r&&(n=DomUtil.createElement(NODE_NAME.SPAN,null,r),i.push(n)),c)for(var s,l,u,n,E=0,d=c.length;E<d;E++)if(l=c.charAt(E),s=e+o.index+E,u=editor.doc.getRawFormatAt(s),l===UNICODE.IMAGE)if(u.type===NODE_TYPE.IFRAME)n=DomUtil.createElement(NODE_NAME.SPAN,null,"< Iframe >"),i.push(n);else if(u.shapeData&&"SHAPE"==u.shapeData.type)n=DomUtil.createElement(NODE_NAME.SPAN,null,"< Shape Object >"),i.push(n);else if("textbox"==u[ATTR_COMMON.SUBTYPE])n=u.hasOwnProperty(ATTR_FILLABLEFIELD.FF_INFO)&&u[ATTR_FILLABLEFIELD.FF_INFO][ATTR_FILLABLEFIELD.FF_SUBTYPE]===FILLABLEFIELD_TYPE.MULTILINE?DomUtil.createElement(NODE_NAME.SPAN,null,"< Multiline Fillable Field >"):DomUtil.createElement(NODE_NAME.SPAN,null,"< Textbox >"),i.push(n);else{var T=DomUtil.processImgSrc(u.src);n=DomUtil.createElement("img",{src:T,"data-zw-imagesrc":T,class:"tc-shrink-img"}),i.push(n)}else if(l===UNICODE.PARA)n=DomUtil.createElement(NODE_NAME.SPAN),J(n).html("&#182;").css({"font-size":"15px",color:"rgb(3, 187, 247)"}),i.push(n),i.push(document.createElement("br"));else if(l===UNICODE.TAB)n=DomUtil.createElement(NODE_NAME.SPAN),J(n).html("&#8594;").css({"font-size":"15px",color:"rgb(3, 187, 247)",padding:"0px 5px"}),i.push(n);else if(l===UNICODE.HR)n=DomUtil.createElement(NODE_NAME.DIV),J(n).css({border:"1px solid #999"}),i.push(n);else if(l===UNICODE.BR)n=DomUtil.createElement(NODE_NAME.DIV),J(n).html("&#8203;").attr("class","writer-glyphs-soft-return-line-break"),i.push(n);else if(l===UNICODE.RANGE_START||l===UNICODE.RANGE_END)continue;o=a.exec(t)}return i},re=function(e){editor.getView()===EDITOR_VIEWS.HISTORY||editor.isVersionView()||ReviewUtil.addUserInUserListPanel(e)},ae=function(e){ReviewUtil.removeUserInUserListPanel(e)},ce=function(){ReviewUtil.positionUserListPanel()},se=function(){ReviewUtil.removeUsersInUserListPanel();var e=TcManager.getCollection().getVisibleNodesCountDetails(),t=e.authors;for(zuid in t)t.hasOwnProperty(zuid)&&re(zuid);ce()},le=function(){if(editor.getView()!=EDITOR_VIEWS.MAILMERGE_PREVIEW){var e=editor.doc.getTrackChangeDetails().getDisplayMode();se(),e!=TCConstants.ALL_MARKUP_VIEW&&v(),D()}},ue=function(e){var t=ReviewUtil.getUserColour(e);e="$"==e.toString().charAt(0)?e.slice(1,e.length):e,Z("userlist-panel").find("#user_"+e+" span").css("border-color",t)},Ee=function(e){if(!editor.doc.getTrackChangeDetails().isNoMarkupON()){var t=TcManager.getCollection().getVisibleNodesCountDetails().authors[e];if(t&&(t[TCConstants.INSERT]>0||t[TCConstants.DELETE]>0)){for(var n,i,o=TcManager.getCollection().getAllNodes(),r=new DocOpBuilder,a=0,c=o.length;a<c;a++)n=o[a],n.getUser()===e&&(i=DocOpBuilder.build(n.getTcIndicesOp(n.getStart(),n.getEnd())),r=DocOpBuilder.compose(r,i),r=DocOpBuilder.concise(r));editor.doc.snapShotManager&&editor.doc.snapShotManager.setSkipSnapShot(!0),r.applyTo(),editor.doc.snapShotManager&&editor.doc.snapShotManager.setSkipSnapShot(!1)}}},de=function(e){Ee(e),ue(e)},Te=function(e){e!=editor.zuid&&de(e)},ge=function(e){var t=TcManager.getCollection().get(e),n=t.getType()===NODE_TYPE.TABLE||t.getType()===NODE_TYPE.ROW?t.getStart()+1:t.getStart(),o=DocLayoutManager.getLineAtIndex(n),r=J(DomViewManager.getDOMElem(o)).offset(),a=TcPane.getNodeElementMap()[e],c=a.offset(),s={};s.left=CurUtil.offset.start.left,s.top=r.top;var l=a.find(".js-author_img");c.top=l.offset().top+l.height(),i.drawLine(s,"ui-editor-outer-div",c,"reviewpane",ReviewUtil.getUserColour(t.getLastModifiedUser()))},Ce=function(){i.remove()},_e=function(){var e,t,n=210,i=function(){e=Handlebars.compile(J("#tc-fillablefield-view").html()),t=Handlebars.compile(J("#tc-card-view").html())},o=function(e,t){return l(e,t)},r=function(e,t){"string"==typeof t&&(t=parseInt(t));var n=new ZWDateTime(t,null,editorProps.userInfo.language),i=n.format("DD MMM YYYY hh mm"),o=e.find(".js-time");o.attr("data-dynamic-time",t),o.attr("title",i),o.text(Utils.getTimeFromNow(t))},a=function(e){var t,n,i,o,r=[],a=e.getDetails()||[];for(t=a.length-1;t>=0;t--)o={},n=a[t],i=n.zuid,o.color=ReviewUtil.getUserColour(i),o.imgurl=ZWNetworkUtils.getUserImageURL(i),o.name=ReviewUtil.getUserName(i),o.time=Utils.getTimeFromNow(n.time),o.timelong=n.time,o.value=TcUtil.getFillableFieldValue(e.getStart(),n.value),o.value===FILLABLEFIELD_PROPS.CHECKED_SYMBOL?o.value="< Checked >":o.value===FILLABLEFIELD_PROPS.UNCHECKED_SYMBOL&&(o.value="< Not Checked >"),o.changeid=n.id,r.push(o);return r},c=function(e){var t,n=e.getDetails()||[],i=null;return n.length&&n[0].value&&(t=n[0].value.prevInfo,t&&t[ATTR_FILLABLEFIELD.FF_INFO]&&""!=t[ATTR_FILLABLEFIELD.FF_INFO].value&&(i=TcUtil.getFillableFieldValue(e.getStart(),t))),i===FILLABLEFIELD_PROPS.CHECKED_SYMBOL?i="< Checked >":i===FILLABLEFIELD_PROPS.UNCHECKED_SYMBOL&&(i="< Not Checked >"),i},s=function(e){var t=e.getAction(),n="";return t===TCConstants.INSERT?n=J.i18n("trackchange","INSERTED"):t===TCConstants.DELETE?n=J.i18n("trackchange","DELETED"):t===TCConstants.REPLACE?n=J.i18n("trackchange","REPLACED"):t===TCConstants.FF_VALUE_UPDATE&&(n=J.i18n("trackchange","FIELD_UPDATED")),n},l=function(n,i){var o={};try{var r,l,E,d=n.getId(),T=[],g=n.getUser(),C=!1;if(!g){var _=n.getDetails();g=_[0]&&_[0].zuid}C=n.getAction()===TCConstants.FF_VALUE_UPDATE,r=C?e:t,o.id="revision_"+d,o.nodeid=d,o.actiontxt=s(n),o.userid=g,C?(o.ffdata=a(n),o.radioid=Utils.randomId("ffvalue"),o.prevfilledvalue=c(n)||"",o.prevfilledvalue=o.prevfilledvalue.trim()):(o.color=ReviewUtil.getUserColour(g),o.imgurl=ZWNetworkUtils.getUserImageURL(g),o.name=ReviewUtil.getUserName(g),o.timelong=n.getTime(),o.time=Utils.getTimeFromNow(o.timelong)),editor.doc.getTrackChangeDetails().canReview()?(o.canaccept=!0,o.canreject=!0):C?(T=n.getAllParticipatedUsers(),o.canreject=1===T.length&&T[0]===editor.zuid):o.canreject=editor.zuid===g,i&&(l=TcManager.getCollection().getVisibleNodesCountDetails()[TCConstants.ALL],E=TcManager.getCollection().getNodeIndex(n)+1,o.canNavigate=!0,o.navTxt=E+"/"+l,o.first=1===E,o.last=E===l);var b=J(r(o));u(n,b)}catch(e){throw ZWLogger.log("TC Node HTML construction error: "+n.toString()),e}return b},u=function(e,t){try{if(t.find(".js-content").empty(),e.getAction()===TCConstants.REPLACE){t.find(".js-replace-elm").show();var i=e.getHeadChildNode().getAction()===TCConstants.DELETE?e.getHeadChildNode():e.getTailChildNode(),o=e.getTailChildNode().getAction()===TCConstants.INSERT?e.getTailChildNode():e.getHeadChildNode();t.find(".js-content").html(ie(i)),t.find(".js-replace-content").empty().html(ie(o))}else t.find(".js-replace-elm").hide(),t.find(".js-content").html(ie(e));e.getAction()!=TCConstants.FF_VALUE_UPDATE&&(r(t,e.getTime()),t.find(".js-action-txt").text(s(e))),!e.isBlock&&e.end-e.start>n?(t.find(".js-content").addClass("tc-reviewcontent-shrinked"),t.find(".js-tc-collapse-btn").hide(),t.find(".js-tc-expand-btn")[0].style.display="inline-block"):(t.find(".js-content").removeClass("tc-reviewcontent-shrinked"),t.find(".js-tc-collapse-btn,.js-tc-expand-btn").hide())}catch(t){throw ZWLogger.log("TC Node HTML updation error: "+e.toString()),ZWLogger.log("Trackchange All Nodes: "+TcManager.getCollection().toString()),t}};return{init:i,getHtml:o,updateTime:r,updateContent:u}}();return PubSub.subscribe(["Document/EditorReady"],le),PubSub.subscribe("Document/TC/UserAdded",re),PubSub.subscribe("Document/TC/UserRemoved",ae),PubSub.subscribe("Document/LayoutChanged",x),PubSub.subscribe("UiEvents/EditorParentOffsetChanged",ce),PubSub.subscribe("Collaboration/UsercolorUpdated",Te),PubSub.subscribe("Document/UsercolorUpdated",de),PubSub.subscribe("trackchange/errormsg",B),PubSub.subscribe("Document/TC/CountUpdated",W),PubSub.subscribe("BeforePanelOpen",X),PubSub.subscribe("BeforePanelClose",q),PubSub.subscribe("Document/Error",h),PubSub.subscribe("Document/TCPropertiesChanged",b),{init:T,drawTCStatus:R,changeDisplayMode:m,closeTcViewBanner:S,selectColorInColorPopup:ee,hideInfoMsgInColorPopup:ne,convertContentToDOMElements:ie,drawLineToFocus:ge,clearFocusingLines:Ce,RevisionNodeDOMHandler:_e}}(),TcPane=function(e,t,n,i,o,r,a,c){var s,l={},u=null,E=0;viewFilter=t.ALL_FILTER,userFilter=t.ALL_FILTER;var d,T,g={REVIEWPANE:"reviewpane",EMPTY_REVIEWPANE:"empty_reviewpane",VIEW_FILTER:"tc-view-menu",USER_FILTER:"tc-user-menu",REVIEWALL_MENU:"tc-reviewall-menu",MOREOPTION_BUTTON:"tc-more-opt",TC_VIEW_CONT:"tc-views",LOADING_IMG:"loading_revisions"},C=27,_=function(){var e=[],t=function(){e=[]},n=function(t){var n,i;for(n=0,i=e.length;n<i;n++)if(t==e[n].getId())return!0;return!1},i=function(t,n){e.splice(t,0,n)},o=function(t){i(e.length,t)},r=function(e){var t,n,i;for(t=0,n=e.length;t<n;t++)i=e[t],o(i)},a=function(t){var n,i;for(n=0,i=e.length;n<i;n++)if(e[n].getId()==t){e.splice(n,1);break}},c=function(){var t=e[0];return a(t.getId()),t},s=function(){return e.length},l=function(t){var r,a,c,s=0,l=0,u=t.length,E=e.length;if(E>0){for(;s<u&&l<E;)a=t[s],n(a.getId())?s++:(c=e[l],node1Start=a.getStart(),node2Start=c.getStart(),node1Start===node2Start?(i(l,a),s++,l++):node1Start<node2Start?(i(l,a),s++,l++):l++);if(s!==u)for(r=s;r<u;r++)o(t[r])}else for(s=0;s<u;s++)o(t[s])},u=function(){var t,n,i,o=[];for(t=0,n=e.length;t<n;t++)i=e[t],o.push(i.toJson());return o},E=function(){var t,n,i,o="";for(t=0,n=e.length;t<n;t++)i=e[t],o+="\n"+JSON.stringify(i.toJson());return o};return{init:t,has:n,addAll:r,remove:a,shift:c,length:s,injectNodes:l,toJson:u,toString:E}}(),b=function(){ce(),v(),editor.doc.getTrackChangeDetails().canReview()?Z("tc-more-opt").show():Z("tc-more-opt").hide(),PubSub.subscribe("Document/LayoutChanged",ce),(Macros.isRemote()||"screenplay"==Macros.getDocumentType())&&PubSub.subscribe("Reviewpane/opened",ce)},L=function(){var e=t.ALL;return viewFilter===t.ADDED_FILTER?e=t.INSERT:viewFilter===t.DELETED_FILTER?e=t.DELETE:viewFilter===t.REPLACED_FILTER?e=t.REPLACE:viewFilter===t.FF_VALUE_UPDATE_FILTER&&(e=t.FF_VALUE_UPDATE),e},A=function(){return userFilter!=t.ALL_FILTER?s:null},p=function(){return e.filterNodes(e.getCollection().getAllNodes(),L(),A())},R=function(){return _},f=function(){return l},I=function(){l={}},N=function(e){var t=e.getId();_.has(t)&&_.remove(t),J(l[t]).remove(),delete l[t]},D=function(e){_.injectNodes([e])},h=function(){clearInterval(u)},v=function(){var t=function(t){var i=t.currentTarget,o=t.target,r=t.target.className,a=o.parentElement.className||"",c=i.getAttribute("node-id"),s=e.getCollection().get(c);if(r.indexOf("js-tc-radio-bt")>=0)o.parentElement.querySelector(".js-tc-checkbox").checked=!0,w(c);else if(r.indexOf("js-changes-acpt")>=0||a.indexOf("js-changes-acpt")>=0){var l=i.querySelector("input:checked"),u=0;l&&(u=l.getAttribute("data-changeId")),n.accept(s,[u,!1])}else r.indexOf("js-changes-rejt")>=0||a.indexOf("js-changes-rejt")>=0?n.reject(s,[!1]):w(c)},i=function(t){var i=t.currentTarget,o=t.target,r=t.target.className,a=o.parentElement.className||"",c=i.getAttribute("node-id");if(r.indexOf("js-changes-acpt")>=0||a.indexOf("js-changes-acpt")>=0){var s=P(c);s&&s.promise().then(function(){n.accept(e.getCollection().get(c))})}else if(r.indexOf("js-changes-rejt")>=0||a.indexOf("js-changes-rejt")>=0){var s=P(c);s&&s.promise().then(function(){n.reject(e.getCollection().get(c));})}else if(r.indexOf("js-tc-expand-btn")>=0){var l=J(i);o.style.display="none",l.find(".js-content").removeClass("tc-reviewcontent-shrinked"),l.find(".js-tc-collapse-btn")[0].style.display="inline-block"}else if(r.indexOf("js-tc-collapse-btn")>=0){var l=J(i);o.style.display="none",l.find(".js-content").addClass("tc-reviewcontent-shrinked"),l.find(".js-tc-expand-btn")[0].style.display="inline-block"}else w(c)};Z(g.REVIEWPANE).on("click","div.js-tc-card-cont",i),Z(g.REVIEWPANE).on("click","div.js-tc-fillablefiled-cont",t)},S=function(e){for(var t,n=Z(g.REVIEWPANE).children(),i=0,o=n.length;i<o;i++)if(t=n[i],t.getAttribute("node-id")===e)return i+1;return 0},O=function(e){var t=J.Deferred(),n=l[e];if(n)return Z(g.REVIEWPANE).scrollTop(0),Z(g.REVIEWPANE).animate({scrollTop:n.position().top-200},function(){t.resolve(!0)}),t},m=function(e){M();var t=l[e];if(t){var n=S(e)+"/"+E;t.find(".js-tc-nav-txt").text(n),t.addClass("ui-tc-revision-selected"),T=!0,i.drawLineToFocus(e),PubSub.subscribe("Document/CursorPositionChanged",M),setTimeout(function(){J(document).on("click",M)},0)}},P=function(t){var n=editor.doc.getSelection();if(n&&t){var i=e.getCollection().get(t).toJson(),o=i.start,r=i.end;i.type!==NODE_TYPE.TABLE&&i.type!==NODE_TYPE.ROW||(o+=1);var a=editor.doc.createRange(o,r);n.removeAllRanges().setSelectionType(SEL_AUTO_GEN).addRange(a);var s=c.scrollElementIntoView(editor.doc.getCursorPortionNode());return s}},w=function(e){i.clearFocusingLines();var t=P(e);t&&t.promise().then(function(){m(e)})},M=function(){if(T){var e=Z(g.REVIEWPANE).find(".ui-tc-revision-selected");e.length&&e.removeClass("ui-tc-revision-selected"),i.clearFocusingLines(),J(document).off("click",M),PubSub.unsubscribe("Document/CursorPositionChanged",M)}T=!1},F=function(){d&&(clearTimeout(d),d=void 0),d=setTimeout(function(){var e=H();Z(g.VIEW_FILTER).zselectbox("setOptionAttributes",t.ALL_FILTER.toString(),"label",J.i18n("trackchange","ALL_COUNT",[e[t.ALL]])),Z(g.VIEW_FILTER).zselectbox("setOptionAttributes",t.ADDED_FILTER.toString(),"label",J.i18n("trackchange","INSERTIONS_COUNT",[e[t.INSERT]])),Z(g.VIEW_FILTER).zselectbox("setOptionAttributes",t.DELETED_FILTER.toString(),"label",J.i18n("trackchange","DELETIONS_COUNT",[e[t.DELETE]])),Z(g.VIEW_FILTER).zselectbox("setOptionAttributes",t.REPLACED_FILTER.toString(),"label",J.i18n("trackchange","REPLACED_COUNT",[e[t.REPLACE]])),Z(g.VIEW_FILTER).zselectbox("setOptionAttributes",t.FF_VALUE_UPDATE_FILTER.toString(),"label",J.i18n("trackchange","FIELD_UPDATE_COUNT",[e[t.FF_VALUE_UPDATE]]))},500)},k=function(){var n=e.getCollection().getVisibleNodesCountDetails(),i=n.authors,o=Z(g.USER_FILTER);o.zselectbox("removeAllOptions"),o.zselectbox("addOption",{label:J.i18n("writer.common.ALL"),value:t.ALL_FILTER});for(var r in i){var c={label:a.getUserName(r),value:r};o.zselectbox("addOption",c)}i&&o.zselectbox("setOptionAttributes",t.ALL_FILTER.toString(),"label",J.i18n("trackchange","ALL_COUNT",[U.keys(i).length])),o.zselectbox("setValue",t.ALL_FILTER.toString())},y=function(n){var i={label:a.getUserName(n),value:a.removeSplCharsInZuid(n)};Z(g.USER_FILTER).zselectbox("addOption",i);var o=e.getCollection().getVisibleNodesCountDetails().authors;Z(g.USER_FILTER).zselectbox("setOptionAttributes",t.ALL_FILTER.toString(),"label",J.i18n("trackchange","ALL_COUNT",[U.keys(o).length]))},V=function(n){userFilter===t.AUTHOR_BY_FILTER&&s===n&&X(viewFilter,t.ALL_FILTER),Z(g.USER_FILTER).zselectbox("removeOption",a.removeSplCharsInZuid(n));var i=e.getCollection().getVisibleNodesCountDetails().authors;Z(g.USER_FILTER).zselectbox("setOptionAttributes",t.ALL_FILTER.toString(),"label",J.i18n("trackchange","ALL_COUNT",[U.keys(i).length]))},B=function(){var e,n,i={},o=userFilter===t.AUTHOR_BY_FILTER,r=o?a.getUserName(s):"";return viewFilter===t.ADDED_FILTER?(e=o?J.i18n("trackchange","ACCEPT_ALL_INSERTIONS_BY_USER",[r]):J.i18n("trackchange","ACCEPT_ALL_INSERTIONS"),n=o?J.i18n("trackchange","REJECT_ALL_INSERTIONS_BY_USER",[r]):J.i18n("trackchange","REJECT_ALL_INSERTIONS")):viewFilter===t.DELETED_FILTER?(e=o?J.i18n("trackchange","ACCEPT_ALL_DELETIONS_BY_USER",[r]):J.i18n("trackchange","ACCEPT_ALL_DELETIONS"),n=o?J.i18n("trackchange","REJECT_ALL_DELETIONS_BY_USER",[r]):J.i18n("trackchange","REJECT_ALL_DELETIONS")):viewFilter===t.REPLACED_FILTER?(e=o?J.i18n("trackchange","ACCEPT_ALL_REPLACEMENTS_BY_USER",[r]):J.i18n("trackchange","ACCEPT_ALL_REPLACEMENTS"),n=o?J.i18n("trackchange","REJECT_ALL_REPLACEMENTS_BY_USER",[r]):J.i18n("trackchange","REJECT_ALL_REPLACEMENTS")):viewFilter===t.FF_VALUE_UPDATE_FILTER?(e=o?J.i18n("trackchange","ACCEPT_ALL_FIELDS_UPDATED_BY_USER",[r]):J.i18n("trackchange","ACCEPT_ALL_FIELDS_UPDATED"),n=o?J.i18n("trackchange","REJECT_ALL_FIELDS_UPDATED_BY_USER",[r]):J.i18n("trackchange","REJECT_ALL_FIELDS_UPDATED")):(e=o?J.i18n("trackchange","ACCEPT_ALL_CHANGES_BY_USER",[r]):J.i18n("trackchange","ACCEPT_ALL_CHANGES"),n=o?J.i18n("trackchange","REJECT_ALL_CHANGES_BY_USER",[r]):J.i18n("trackchange","REJECT_ALL_CHANGES")),i.acceptAll=e,i.rejectAll=n,i},W=function(){var e=Z(g.REVIEWALL_MENU);e.zmenu("removeAllMenuItems");var n=B();userFilter===t.ALL_FILTER?(e.zmenu("addMenuItem",{label:n.acceptAll,title:n.acceptAll,action:"TcPane.acceptAll"}),e.zmenu("addMenuItem",{label:n.rejectAll,title:n.rejectAll,action:"TcPane.rejectAll"})):userFilter===t.AUTHOR_BY_FILTER&&(e.zmenu("addMenuItem",{label:n.acceptAll,title:n.acceptAll,action:"TcPane.acceptUserChanges"}),e.zmenu("addMenuItem",{label:n.rejectAll,title:n.rejectAll,action:"TcPane.rejectUserChanges"}))},x=function(){Z(g.LOADING_IMG).show(),u=setInterval(function(){var n=1;if(!(E>0))return Z(g.EMPTY_REVIEWPANE).show(),Z(g.REVIEWPANE).hide(),Z(g.LOADING_IMG).hide(),Z(g.MOREOPTION_BUTTON).zmenubutton("disable"),void h();Z(g.MOREOPTION_BUTTON).zmenubutton("enable"),Z(g.EMPTY_REVIEWPANE).hide(),Z(g.REVIEWPANE).show();for(var o=function(t){var n=i.RevisionNodeDOMHandler.getHtml(t),o=e.getFilteredPrevNode(t,L(),A());if(o){var r=o.getId(),a=l[r];J(a).after(n)}else Z(g.REVIEWPANE).prepend(n);l[t.getId()]=J(n),UIStateHandler.build(n[0])},r=L();n<=50&&_.length();){var a=_.shift();if(a.isHiddenNode())n++;else{var c=l[a.getId()];r==t.ALL||a.getAction()==r?(a.getMode()===t.CREATE_MODE?o(a):a.getMode()===t.UPDATE_MODE&&(c?(i.RevisionNodeDOMHandler.updateContent(a,c),l[a.getId()]=J(c)):o(a)),n++):(c&&N(a),n++)}}0==_.length()&&(h(),Z(g.LOADING_IMG).hide()),re()},500)},Y=function(e){e&&(viewFilter=e,userFilter=t.ALL_FILTER,Z(g.VIEW_FILTER).zselectbox("setValue",e.toString()),Z(g.USER_FILTER).zselectbox("setValue",t.ALL_FILTER.toString())),editor.doc.getTrackChangeDetails().canReview()?Z(g.MOREOPTION_BUTTON).show():Z(g.MOREOPTION_BUTTON).hide(),j(),k()},j=function(){h(),Z(g.REVIEWPANE).empty(),_.init(),I();var n=e.getCollection();n.setMode(t.CREATE_MODE);var i=e.filterNodes(n.getAllNodes(),L(),A());_.addAll(i),W(),F(),z(),x()},H=function(){var n=e.getCollection().getVisibleNodesCountDetails(),i=userFilter===t.AUTHOR_BY_FILTER?n.authors[s]:n;return i||(i={ins:0,del:0,replace:0,ffValueUpdate:0,all:0}),i},z=function(){var e=H();E=viewFilter===t.ALL_FILTER?e.all:viewFilter===t.ADDED_FILTER?e[t.INSERT]:viewFilter===t.DELETED_FILTER?e[t.DELETE]:viewFilter===t.REPLACED_FILTER?e[t.REPLACE]:e[t.FF_VALUE_UPDATE]},G=function(e){e=parseInt(e[0]),X(e)},K=function(e){e=e[0],e==t.ALL_FILTER?X(viewFilter,t.ALL_FILTER):X(viewFilter,t.AUTHOR_BY_FILTER,e)},X=function(e,n,o){Z(g.REVIEWPANE).empty(),e&&(viewFilter=parseInt(e)),n&&(userFilter=n,n===t.AUTHOR_BY_FILTER&&(s=o)),i.clearFocusingLines(),T&&editor.doc.getSelection().removeAllRanges(),j()},q=function(){var e,n,i=userFilter===t.AUTHOR_BY_FILTER,o=E>1,r=i?a.getUserName(s):"",c=!i&&viewFilter===t.ALL_FILTER,l=J.i18n("trackchange","ACCEPT_CHANGES"),u=J.i18n("trackchange","REJECT_CHANGES"),d=J.i18n("trackchange",c?"ACCEPT_ALL_CHANGES":"ACCEPT_SELECTED_CHANGES"),T=J.i18n("trackchange",c?"REJECT_ALL_CHANGES":"REJECT_SELECTED_CHANGES");viewFilter===t.ADDED_FILTER?i?(e="ACCEPT_USER_INSERTIONS_CONFIRM_TEXT",n="REJECT_USER_INSERTIONS_CONFIRM_TEXT"):(e=o?"ACCEPT_INSERTIONS_COUNT_CONFIRM_TEXT":"ACCEPT_INSERTIONS_CONFIRM_TEXT",n=o?"REJECT_INSERTIONS_COUNT_CONFIRM_TEXT":"REJECT_INSERTIONS_CONFIRM_TEXT"):viewFilter===t.DELETED_FILTER?i?(e="ACCEPT_USER_DELETIONS_CONFIRM_TEXT",n="REJECT_USER_DELETIONS_CONFIRM_TEXT"):(e=o?"ACCEPT_DELETIONS_COUNT_CONFIRM_TEXT":"ACCEPT_DELETIONS_CONFIRM_TEXT",n=o?"REJECT_DELETIONS_COUNT_CONFIRM_TEXT":"REJECT_DELETIONS_CONFIRM_TEXT"):viewFilter===t.REPLACED_FILTER?i?(l=J.i18n("trackchange","ACCEPT_USER_REPLACEMENTS",[r]),u=J.i18n("trackchange","REJECT_USER_REPLACEMENTS",[r]),d=J.i18n("trackchange","ACCEPT_ALL_REPLACEMENTS"),T=J.i18n("trackchange","REJECT_ALL_REPLACEMENTS"),e="ACCEPT_USER_REPLACEMENTS_CONFIRM_TEXT",n="REJECT_USER_REPLACEMENTS_CONFIRM_TEXT"):(l=J.i18n("trackchange","ACCEPT_REPLACEMENTS"),u=J.i18n("trackchange","REJECT_REPLACEMENTS"),d=J.i18n("trackchange","ACCEPT_REPLACEMENTS"),T=J.i18n("trackchange","REJECT_REPLACEMENTS"),e=o?"ACCEPT_REPLACEMENTS_COUNT_CONFIRM_TEXT":"ACCEPT_REPLACEMENTS_CONFIRM_TEXT",n=o?"REJECT_REPLACEMENTS_COUNT_CONFIRM_TEXT":"REJECT_REPLACEMENTS_CONFIRM_TEXT"):viewFilter===t.FF_VALUE_UPDATE_FILTER?i?(l=J.i18n("trackchange","ACCEPT_USER_CHANGES",[r]),u=J.i18n("trackchange","REJECT_USER_CHANGES",[r]),d=J.i18n("trackchange","ACCEPT_CHANGES"),T=J.i18n("trackchange","REJECT_CHANGES"),e="ACCEPT_USER_FIELDS_UPDATED_CONFIRM_TEXT",n="REJECT_USER_FIELDS_UPDATED_CONFIRM_TEXT"):(l=J.i18n("trackchange","ACCEPT_FIELDS_UPDATED"),u=J.i18n("trackchange","REJECT_FIELDS_UPDATED"),d=J.i18n("trackchange","ACCEPT_FIELDS_UPDATED"),T=J.i18n("trackchange","REJECT_FIELDS_UPDATED"),e=o?"ACCEPT_FIELDS_UPDATED_COUNT_CONFIRM_TEXT":"ACCEPT_FIELDS_UPDATED_CONFIRM_TEXT",n=o?"REJECT_FIELDS_UPDATED_COUNT_CONFIRM_TEXT":"REJECT_FIELDS_UPDATED_CONFIRM_TEXT"):i?(e="ACCEPT_USER_CHANGES_CONFIRM_TEXT",n="REJECT_USER_CHANGES_CONFIRM_TEXT"):(e=o?"ACCEPT_ALL_COUNT_CONFIRM_TEXT":"ACCEPT_ALL_CONFIRM_TEXT",n=o?"REJECT_ALL_COUNT_CONFIRM_TEXT":"REJECT_ALL_CONFIRM_TEXT");var g,C;return i?(g=J.i18n("trackchange",e,[r]),C=J.i18n("trackchange",n,[r])):o?(g=J.i18n("trackchange",e,[E]),C=J.i18n("trackchange",n,[E])):(g=J.i18n("trackchange",e),C=J.i18n("trackchange",n)),{acceptAllTxt:g,rejectAllTxt:C,acceptDlgTitle:l,rejectDlgTitle:u,acceptAllButtonTxt:d,rejectAllButtonTxt:T}},$=function(){var e=p();n.acceptChanges(e),ActivityTracker.trackInAnalytics("Tc","AcceptAll","ReviewPanel")},Q=function(){var e=p();n.rejectChanges(e),ActivityTracker.trackInAnalytics("Tc","RejectAll","ReviewPanel")},ee=function(){var e=q();MsgDialog.showMessage([e.acceptAllButtonTxt,J.i18n("common","CANCEL")],CONST.SEVERITY_WARNING,e.acceptDlgTitle,e.acceptAllTxt,null,function(e){switch(e){case CONST.BUTTON_YES_CLICKED:$()}})},te=function(){var e=q();MsgDialog.showMessage([e.rejectAllButtonTxt,J.i18n("common","CANCEL")],CONST.SEVERITY_WARNING,e.rejectDlgTitle,e.rejectAllTxt,null,function(e){switch(e){case CONST.BUTTON_YES_CLICKED:Q()}})},ne=function(){var e=q();MsgDialog.showMessage([e.acceptAllButtonTxt,J.i18n("common","CANCEL")],CONST.SEVERITY_WARNING,e.acceptDlgTitle,e.acceptAllTxt,null,function(e){switch(e){case CONST.BUTTON_YES_CLICKED:$()}})},ie=function(){var e=q();MsgDialog.showMessage([e.rejectAllButtonTxt,J.i18n("common","CANCEL")],CONST.SEVERITY_WARNING,e.rejectDlgTitle,e.rejectAllTxt,null,function(e){switch(e){case CONST.BUTTON_YES_CLICKED:Q()}})},oe=function(){ModeManager.getCurrentMode()===EDITOR_MODES.COLLABORATE&&LayoutManager.getCurrentLayout()!=LAYOUTS.FULLSCREEN&&Y()},re=function(){if(Z(g.REVIEWPANE)&&Z(g.EMPTY_REVIEWPANE)){var e=J(window).innerHeight()-(Z("li-review-tab-header").offset().top+Z("li-review-tab-header").outerHeight())-UIUtils.bottomBar.outerHeight();Z("wmstoolbar").is(":visible")&&(e-=Z("wmstoolbar").outerHeight());var t=Z(g.TC_VIEW_CONT).attr("data-visible");"false"!=t&&(e-=C)}},ae=function(e){var t=Z(g.REVIEWPANE).find("[data-userid="+e+"]"),n=a.getUserColour(e);t.find(".js-author_img").css("border-color",n),t.find(".js-action-txt").css({"border-color":n,color:n})},ce=function(){EditorLayout.isRightPaneVisible()&&LayoutManager.getCurrentLayout()!=LAYOUTS.FULLSCREEN?(Y(t.ALL_FILTER),se()):le()},se=function(){PubSub.subscribe("Document/TC/NodeRemoved",N),PubSub.subscribe("Document/TC/NodeCreated",D),PubSub.subscribe("Document/TC/NodeUpdated",D),PubSub.subscribe("Document/TC/ModelUpdationStarted",h),PubSub.subscribe("Document/TC/ModelUpdated",x),PubSub.subscribe("Document/EditorReady",oe),PubSub.subscribe("Document/TC/UserAdded",y),PubSub.subscribe("Document/TC/UserRemoved",V),PubSub.subscribe("Document/TC/CountUpdated",z),PubSub.subscribe("Document/TC/CountUpdated",F),PubSub.subscribe("UiEvents/EditorParentOffsetChanged",M),PubSub.subscribe("Document/Resize",re),PubSub.subscribe("Collaboration/UsercolorUpdated",ae),PubSub.subscribe("Document/UsercolorUpdated",ae)},le=function(){PubSub.unsubscribe("Document/TC/NodeRemoved",N),PubSub.unsubscribe("Document/TC/NodeCreated",D),PubSub.unsubscribe("Document/TC/NodeUpdated",D),PubSub.unsubscribe("Document/TC/ModelUpdationStarted",h),PubSub.unsubscribe("Document/TC/ModelUpdated",x),PubSub.unsubscribe("Document/EditorReady",oe),PubSub.unsubscribe("Document/TC/UserAdded",y),PubSub.unsubscribe("Document/TC/UserRemoved",V),PubSub.unsubscribe("Document/TC/CountUpdated",z),PubSub.unsubscribe("Document/TC/CountUpdated",F),PubSub.unsubscribe("UiEvents/EditorParentOffsetChanged",M),PubSub.unsubscribe("Collaboration/UsercolorUpdated",ae),PubSub.unsubscribe("Document/UsercolorUpdated",ae),i.clearFocusingLines()};return{init:b,getNodesToUpdate:R,getNodeElementMap:f,drawRightPane:Y,toggleView:X,subscribe:se,unsubscribe:le,selectRevision:m,unSelectRevision:M,scrollRevisionIntoView:O,showFilterByUser:K,showFilterByView:G,updateUserColorInNodes:ae,acceptAll:ee,rejectAll:te,acceptUserChanges:ne,rejectUserChanges:ie,highlightRevision:w}}(TcManager,TCConstants,TCHandler,TrackChangeUI,TcUtil,Utils,ReviewUtil,DomUtil);