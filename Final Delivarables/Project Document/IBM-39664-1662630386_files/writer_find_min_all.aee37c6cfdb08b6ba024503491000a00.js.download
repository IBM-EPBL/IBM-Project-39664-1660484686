var BulletinManager=function(e,t,n){this.bulletinCont=document.getElementById(e),this.bulletinDiv=null,this.props=t||{},this.titleHt=15,this.docHt=0,this.bulletinConHt=0,this.bulletinMap={},this.jobScheduler=new JobScheduler,this.drawtimer=0,this.onBullentinClick=n,this.init(e),this.bindEvents()};extend(BulletinManager.prototype,{init:function(e){this.bulletinDiv=document.createElement("div"),this.bulletinDiv.setAttribute("id",e+"-bulletins"),this.bulletinCont.appendChild(this.getTitleElem()),this.bulletinCont.appendChild(this.bulletinDiv),this.jobScheduler.setJobHandler(this.drawBulletin.bind(this)),this.jobScheduler.setTimer(this.props.timer||5)},getTitleElem:function(){var e=document.createElement("div"),t=document.createElement("span"),n="float:left; margin-top:2px; margin-bottom:2px; width:10px; height:10px;";return n+="background-color: "+(this.props.bgColor||"rgb(255, 245, 0)")+";",n+="border: 1px solid "+(this.props.borderColor||"rgb(255, 173, 0)")+";",t.style.cssText=n,e.style.cssText="border-bottom:1px solid red; display:inline-block;",e.appendChild(t),e},bindEvents:function(){if(this.onBullentinClick){var e=this;this.bulletinDiv.addEventListener("click",function(t){var n=t.target,i=t.target.className,a=n.getAttribute("nodeId");i.indexOf("js-bulletin")>=0&&a&&e.bulletinMap[a]&&e.onBullentinClick(a,e.bulletinMap[a])})}},calculateBulletinTop:function(e){try{var t=0,n=DocLayoutManager.getLineAtIndex(e),i=n&&DomViewManager.getDOMElem(n),a=0,o=0;if(i&&(a=PUtil.offset(i),o=a?a.top:0),!i||o<=0){var r=DocLayoutManager.getPageAtIndex(e),c=J(DomViewManager.getDOMElem(r)).position();t=c?c.top:0}else t=o;return t*editor.zoomFactor*this.bulletinConHt/this.docHt+this.titleHt}catch(t){ZWLogger.log("Exception@ BulletinManager on calculateBulletinTop, index: "+e);var l=t.stack||t;ReviewUtil.sendErrorMail(ZWCollaboration.COMMON_BULLETIN_ERROR,l)}},getBullentin:function(e){var t=document.createElement("span"),n="js-bulletin quick-bulletin"+(this.props.class||"");return this.props.bgColor&&(t.style.backgroundColor=this.props.bgColor),this.props.borderColor&&(t.style.border="1px solid "+this.props.borderColor),t.setAttribute("id",e),t.setAttribute("class",n),t.setAttribute("nodeId",e),t},drawBulletin:function(e){var t=e.start,n=e.end,i=e.id;if(this.bulletinMap[i]&&this.bulletinMap[i].elm)return void this.updateBulletin(t,n,i);this.bulletinMap[i]={start:t,end:n};var a=this.getBullentin(i),o=this.calculateBulletinTop(t);this.bulletinMap[i].elm=a,a.style.top=o+"px",this.bulletinDiv.appendChild(a)},addBulletin:function(e,t,n){this.jobScheduler.add({start:e,end:t,id:n})},updateBulletin:function(e,t,n){this.bulletinMap[n]&&this.bulletinMap[n].elm&&(this.bulletinMap[n].start=e,this.bulletinMap[n].end=t,this.bulletinMap[n].elm.style.top=this.calculateBulletinTop(e)+"px")},updateBulletinPositions:function(){var e,t=this.bulletinMap;for(var n in t)t.hasOwnProperty(n)&&(e=t[n],this.jobScheduler.add({start:e.start,end:e.end,id:n}))},removeBulletin:function(e){var t=this.bulletinMap[e];t?(t.elm&&this.bulletinDiv.removeChild(t.elm),delete this.bulletinMap[e]):this.jobScheduler.remove(e)},removeAllBulletins:function(){this.jobScheduler.reset(),this.bulletinDiv.innerHTML="",this.bulletinMap={}},updateDocHt:function(){try{var e=DocLayoutManager.getLastPage();this.docHt=DomViewManager.getDOMElem(e).getBoundingClientRect().height*DocLayoutManager.getPageCount(),clearTimeout(this.drawtimer);var t=this;this.drawtimer=setTimeout(function(){t.updateBulletinPositions()},100)}catch(e){ZWLogger.log("Exception@ BulletinManager on updating document height");var n=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.COMMON_BULLETIN_ERROR,n)}},updateBulletinContHt:function(){try{this.bulletinConHt=editor.editorPaneContainerHt,clearTimeout(this.drawtimer);var e=this;this.drawtimer=setTimeout(function(){e.updateBulletinPositions()},100)}catch(e){ZWLogger.log("Exception@ BulletinManager on updating bulletin container height");var t=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.COMMON_BULLETIN_ERROR,t)}},showBulletinContainer:function(){this.updateBulletinContHt(),this.updateDocHt(),this.bulletinCont.style.display="block",PubSub.subscribe(["Document/ContentAdded","Document/ContentDeleted"],this.updateDocHt,{context:this}),PubSub.subscribe("Document/Resize",this.updateBulletinContHt,{context:this})},hideBulletinContainer:function(){this.bulletinCont.style.display="none",PubSub.unsubscribe(["Document/ContentAdded","Document/ContentDeleted"],this.updateDocHt,{context:this}),PubSub.unsubscribe("Document/Resize",this.updateBulletinContHt,{context:this})}});var RangeHighlighter=function(e,t,n){this.jobScheduler=new JobScheduler,this.type=e,this.onCompleteCb=n,this.props=t||{},this.props.type=this.props.type||"selection",this.className="js-"+this.type+"-overlay",this.init()};extend(RangeHighlighter.prototype,{init:function(){this.jobScheduler.reset(),this.jobScheduler.setJobHandler(this.draw.bind(this)),this.jobScheduler.setTimer(this.props.timer||5),this.onCompleteCb&&this.jobScheduler.events.on("idle",this.onCompleteCb)},addRanges:function(e,t){this.jobScheduler.add(e,t)},removeRanges:function(e){var t,n,i,a,o,r,c=[];for(i=0,a=e.length;i<a;i++)r=e[i],this.jobScheduler.remove(r.id),c.push("#"+this.getElemId(r.id));if(t=DocTreeManager.getTreeNodeById(r.paraId),t&&(n=DocLayoutManager.getViews(t)))for(i=0,a=n.length;i<a;i++)o=n[i],o&&DomViewManager.getDOMElem(o)&&J(DomViewManager.getDOMElem(o)).find(c.join(",")).remove()},length:function(){return this.jobScheduler.length()},getClassName:function(){return this.className},getElemId:function(e){return this.type+"-"+e},draw:function(e){var t,n;try{if(t=DocTreeManager.getTreeNodeById(e.paraId),!t||e.start===e.end)return;this.drawHighLight(e,t)}catch(e){n=e.stack||e,ReviewUtil.sendErrorMail(ZWCollaboration.COMMON_RANGE_HIGHLIGHTER_ERROR,n)}},updateProps:function(e,t){this.props[e]=t},getElement:function(e,t){var n=J(document.createElement("div"));"wavyline"===this.props.type&&n.html("&nbsp");var i=(this.getClassName()+" "+(this.props.class||"")).trim();return n.attr("id",this.getElemId(e.id)),n.attr("class",i),n.css(t),n},isInvisibleContent:function(e){return e&&1===e.length&&e===UNICODE.BR||e===UNICODE.PARA},isParaInHeaderFooter:function(e){var t,n=e.parent;return!(!n||(t=n.format,!t||t[ATTR_COMMON.TYPE]!==NODE_TYPE.SECTION||t[ATTR_COMMON.ST]!==SECTION_TYPES.HEADER&&t[ATTR_COMMON.ST]!==SECTION_TYPES.FOOTER))},drawHighLight:function(e,t){var n=e.start+t.getIndex(),i=e.end+t.getIndex();if(!this.isParaInHeaderFooter(t)){var a=DocLayoutManager.getLineAtIndex(n);if(a)for(var o,r,c,l,u=DocLayoutManager.getLeftAtIndex(n),d=DocLayoutManager.getLeftAtIndex(i),s=DocLayoutManager.linesBetween(n,i),g=Utils.isRTL(t.getContent()),p=s.length>1,f=0;f<s.length;f++)if(a=s[f],l=DomViewManager.getDOMElem(a)){var h=editor.doc.getComputedFormatAt(a.parent.getEndIndex(),NODE_TYPE.PARAGRAPH)||{},E=h[ATTR_PARAGRAPH.PS_AL]||0,b=J(l),m=3===E?0:a.remainingWidth*E/2,o=a.listRight?a.listRight:0;d=d?d:a.left+a.width;var T={};T.position="absolute",p?0===f?(T.left=u,T.width=a.left+a.width-u+m+o):f==s.length-1?(T.left=m+o,T.width=d-m-o):(T.left=m+o,T.width=a.width):g?(T.left=d,T.width=u-d):(T.left=u,T.width=d-u),T.top=parseFloat(b.css("padding-top")||0),T.width<=0&&(r=n>a.absStart?n:a.absStart,c=i>a.absEnd+1?a.absEnd+1:i,T.width=this.isInvisibleContent(editor.doc.getContent(r,c))?10:T.width),"selection"===this.props.type&&(T.height=a.height,this.props.class||(T["z-index"]=ZINDEX.COMMENT_HIGHLIGHT,T["background-color"]="#fcd126")),"wavyline"===this.props.type&&(T.top+=a.contentHeight,T.width=2*T.width,T.letterSpacing=T.width);var v=this.getElement(e,T);v.appendTo(b[0])}}},drawOnDemand:function(e){this.jobScheduler.isQueued(e.id)&&this.jobScheduler.remove(e.id),this.draw(e)},removeHighlights:function(){editor.jeditorPane.find("."+this.getClassName()).remove()},reset:function(){this.jobScheduler.reset(),this.removeHighlights()}});var FIND_COMPONENTS={INPUTBOX:"inputbox",DROPDOWN:"dropdown"},FIND_DATATYPE={CONTENT:"content",STYLES:"styles",PARA_STYLE:"paraStyle",COMMENTS:"comments"},DEFAULT_SEARCH_EVENTS={modifyEvents:["Document/NodeAdded","Document/NodeModified"],removeEvents:["Document/NodeRemoved"]},findConfigurations={text:{UI:{name:J.i18n("mailmergepopup","PLAIN_TEXT"),input:{type:FIND_COMPONENTS.INPUTBOX,placeholder:J.i18n("common","FIND_TEXT_PLACEHOLDER")},canReplace:"document.edit",canSelectAll:"document.content.copy"},handler:{action:"TextFinder.find",findObj:"TextFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT]},searchEvents:DEFAULT_SEARCH_EVENTS}},anyletter:{UI:{name:J.i18n("common","ANY_LETTER"),input:{type:FIND_COMPONENTS.INPUTBOX,placeholder:"/\\p{L}/gu",value:"anyletter",disable:!0},canReplace:"document.edit",canSelectAll:"document.content.copy"},handler:{action:"TextFinder.findAllLetters",findObj:"TextFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT]},searchEvents:DEFAULT_SEARCH_EVENTS}},anydigit:{UI:{name:J.i18n("common","ANY_DIGIT"),input:{type:FIND_COMPONENTS.INPUTBOX,placeholder:"\\d",value:"\\d",disable:!0},canReplace:"document.edit",canSelectAll:"document.content.copy"},handler:{action:"TextFinder.searchPattern",findObj:"TextFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT]},searchEvents:DEFAULT_SEARCH_EVENTS}},tab:{UI:{name:J.i18n("common","TAB_CHARACTER"),input:{type:FIND_COMPONENTS.INPUTBOX,placeholder:"\\t",value:"\\t",disable:!0},canReplace:"document.edit",canSelectAll:"document.content.copy"},handler:{action:"TextFinder.searchPattern",findObj:"TextFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT]},searchEvents:DEFAULT_SEARCH_EVENTS}},whitespace:{UI:{name:J.i18n("common","WHITE_SPACE"),input:{type:FIND_COMPONENTS.INPUTBOX,placeholder:"\\s",value:"\\s",disable:!0},canReplace:"document.edit",canSelectAll:"document.content.copy",separator:!0},handler:{action:"TextFinder.searchPattern",findObj:"MainContentFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT]},searchEvents:DEFAULT_SEARCH_EVENTS}},headings:{UI:{name:J.i18n("common","HEADING"),input:{type:FIND_COMPONENTS.DROPDOWN,data:"FindManager.getHeadings"}},handler:{action:"HeadingsFinder.find",findObj:"HeadingFindObj",customData:{searchContent:[FIND_DATATYPE.PARA_STYLE]},searchEvents:DEFAULT_SEARCH_EVENTS}},bookmarks:{UI:{name:J.i18n("common","BOOKMARK"),input:{type:FIND_COMPONENTS.INPUTBOX,placeholder:J.i18n("common","ALL_BOOKMARKS"),disable:!0,value:"bookmark"}},handler:{action:"BookmarkFinder.find",findObj:"BookmarkFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT,FIND_DATATYPE.STYLES]},searchEvents:DEFAULT_SEARCH_EVENTS}},fields:{UI:{name:J.i18n("common","FIELD"),input:{type:FIND_COMPONENTS.DROPDOWN,data:"FindManager.getFieldsOptions"},separator:!0},handler:{action:"FieldFinder.find",findObj:"FindBaseObj",customData:{searchContent:[FIND_DATATYPE.STYLES]},searchEvents:DEFAULT_SEARCH_EVENTS}},linebreaks:{UI:{name:J.i18n("common","LINE_BREAK"),input:{type:FIND_COMPONENTS.INPUTBOX,placeholder:J.i18n("common","ALL_LINE_BREAKS"),value:"\\u000b",disable:!0},canSelectAll:"document.content.copy"},handler:{action:"TextFinder.searchPattern",findObj:"TextFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT]},searchEvents:DEFAULT_SEARCH_EVENTS}},parabreaks:{UI:{name:J.i18n("common","PARAGRAPH_BREAK"),input:{type:FIND_COMPONENTS.INPUTBOX,placeholder:J.i18n("common","ALL_PARAGRAPHS_BREAKS"),value:"\\n",disable:!0},canSelectAll:"document.content.copy"},handler:{action:"TextFinder.searchPattern",findObj:"MainContentFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT]},searchEvents:DEFAULT_SEARCH_EVENTS}},emptypara:{UI:{name:J.i18n("common","EMPTY_PARAGRAPH"),input:{type:FIND_COMPONENTS.INPUTBOX,placeholder:J.i18n("common","ALL_EMPTY_PARAGRAPHS"),value:"^\\n$",disable:!0},separator:!0,canSelectAll:"document.content.copy"},handler:{action:"TextFinder.searchPattern",findObj:"MainContentFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT]},searchEvents:DEFAULT_SEARCH_EVENTS}},objects:{UI:{name:J.i18n("common","OBJECT"),input:{type:FIND_COMPONENTS.DROPDOWN,data:"FindManager.getOtherOptions"}},handler:{action:"MoreFinder.find",findObj:"ObjectsFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT,FIND_DATATYPE.STYLES,FIND_DATATYPE.PARA_STYLE]},searchEvents:DEFAULT_SEARCH_EVENTS}}},FIND_COMPONENTS={INPUTBOX:"inputbox",DROPDOWN:"dropdown"},FIND_DATATYPE={CONTENT:"content",STYLES:"styles",PARA_STYLE:"paraStyle",COMMENTS:"comments"},DEFAULT_SEARCH_EVENTS={modifyEvents:["Document/NodeAdded","Document/NodeModified"],removeEvents:["Document/NodeRemoved"]},findConfigurationsBeta={text:{handler:{action:"TextFinder.findTextWithSplChar",findObj:"TextFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT]},searchEvents:DEFAULT_SEARCH_EVENTS}},textpattern:{handler:{action:"TextFinder.searchWildCard",findObj:"TextFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT]},searchEvents:DEFAULT_SEARCH_EVENTS}},textstyle:{handler:{action:"TextFinder.searchPattern",findObj:"TextFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT]},searchEvents:DEFAULT_SEARCH_EVENTS}},headings:{isObject:!0,UI:{name:J.i18n("common","HEADING"),type:FIND_COMPONENTS.DROPDOWN,data:[{name:J.i18n("common","ALL_HEADINGS"),value:"all"},{name:J.i18n("digisign","TITLE"),value:"title"},{name:J.i18n("styles","SUBTITLE"),value:"subtitle"},{name:J.i18n("styles","HEADING_1"),value:"headings1"},{name:J.i18n("styles","HEADING_2"),value:"headings2"},{name:J.i18n("styles","HEADING_3"),value:"headings3"},{name:J.i18n("styles","HEADING_4"),value:"headings4"},{name:J.i18n("styles","HEADING_5"),value:"headings5"},{name:J.i18n("styles","HEADING_6"),value:"headings6"},{name:J.i18n("styles","QUOTE"),value:"quote"}]},handler:{action:"HeadingsFinder.find",findObj:"HeadingFindObj",customData:{searchContent:[FIND_DATATYPE.PARA_STYLE]},searchEvents:DEFAULT_SEARCH_EVENTS}},bookmarks:{isObject:!0,UI:{name:J.i18n("common","BOOKMARK"),value:NODE_TYPE.BOOKMARK},handler:{action:"BookmarkFinder.find",findObj:"BookmarkFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT,FIND_DATATYPE.STYLES]},searchEvents:DEFAULT_SEARCH_EVENTS}},fields:{isObject:!0,UI:{name:J.i18n("common","FIELD"),type:FIND_COMPONENTS.DROPDOWN,data:[{name:J.i18n("common","ALL_FIELDS"),value:"all"},{name:J.i18n("common","AUTO_FIELDS"),value:NODE_TYPE.AUTOFIELD},{name:J.i18n("common","FILLABLE_FIELDS"),value:NODE_TYPE.FILLABLEFIELD},{name:J.i18n("common","MERGE_FIELDS"),value:NODE_TYPE.MAILMERGEFIELD}],separator:!0},handler:{action:"FieldFinder.find",findObj:"FindBaseObj",customData:{searchContent:[FIND_DATATYPE.STYLES]},searchEvents:DEFAULT_SEARCH_EVENTS}},table:{isObject:!0,UI:{name:J.i18n("common","TABLES"),value:NODE_TYPE.TABLE},handler:{action:"TableFinder.find",findObj:"TableFindObj",customData:{searchContent:[FIND_DATATYPE.PARA_STYLE]},searchEvents:DEFAULT_SEARCH_EVENTS}},image:{isObject:!0,UI:{name:J.i18n("common","IMAGES"),value:NODE_TYPE.IMAGE},handler:{action:"ImageFinder.find",findObj:"FindBaseObj",customData:{searchContent:[FIND_DATATYPE.STYLES]},searchEvents:DEFAULT_SEARCH_EVENTS}},endnote:{isObject:!0,UI:{name:J.i18n("common","ENDNOTES"),value:NODE_TYPE.ENDNOTE},handler:{action:"MoreFinder.find",findObj:"ObjectsFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT,FIND_DATATYPE.STYLES,FIND_DATATYPE.PARA_STYLE]},searchEvents:DEFAULT_SEARCH_EVENTS}},footnote:{isObject:!0,UI:{name:J.i18n("common","FOOTNOTES"),value:NODE_TYPE.FOOTNOTE},handler:{action:"MoreFinder.find",findObj:"ObjectsFindObj",customData:{searchContent:[FIND_DATATYPE.CONTENT,FIND_DATATYPE.STYLES,FIND_DATATYPE.PARA_STYLE]},searchEvents:DEFAULT_SEARCH_EVENTS}}};findConfigurations=findConfigurationsBeta;var FindComponent=function(){"use strict";var e={TEXTBOX:"find-textbox",SELECTBOX:"find-selectbox",CONTAINER:"find-input-cont"},t=function(){var t=function(t){var n=Z(e.TEXTBOX)[0];t.placeholder&&(n.placeholder=t.placeholder),t.disable?n.setAttribute("disabled",!0):n.removeAttribute("disabled"),n.value="",Z(e.CONTAINER).addClass("ui-hide-selectbox"),Z(e.CONTAINER).removeClass("ui-hide-input ui-find-input-gray"),Z(e.TEXTBOX)[0].focus()};return{update:t}}(),n=function(){var t={},n=function(){t={}},i=function(e){return t[e]},a=function(i){n();var a=Utils.getAsFunction(i.data).fn(),o=Z(e.SELECTBOX);o.zselectbox("removeOption");for(var r=0,c=a.length;r<c;r++){var l=a[r];t[r]=l.value,o.zselectbox("addOption",{label:l.name,value:r})}o.zselectbox("refresh"),Z(e.CONTAINER).addClass("ui-hide-input ui-find-input-gray"),Z(e.CONTAINER).removeClass("ui-hide-selectbox")},o=function(t){return Z(e.SELECTBOX).zselectbox("setValue",t)};return{update:a,chooseOption:o,getOptionValue:i}}(),i={};return i[FIND_COMPONENTS.INPUTBOX]=t,i[FIND_COMPONENTS.DROPDOWN]=n,i}(),FindUtils=function(){"use strict";var e=new RegExp("^/(.+)/([gimsuy]+)?$","g"),t=new RegExp("g"),n=function(n){e.lastIndex=0;var i=e.exec(n),a=n,o="g";return i&&(a=i[1],o=i[2]||o),t.test(o)||(o="g"+o),new RegExp(a,o)},i=function(e){var t=!0;try{var e=n(e)}catch(e){t=!1}return t},a=function(t){e.lastIndex=0;var n=e.exec(t),i=t,a="";return n&&(i=n[1],a=n[2]||a),new RegExp(i,a)},o={'"':'\\"',"\\":"\\\\","/":"\\/","\b":"\\b","\f":"\\f","\n":"\\n","\r":"\\r","\t":"\\t","\v":"\\u000b"},r=/\uffff/.test("ï¿¿")?/[\\\"\x00-\x1f\x7f-\uffff]/g:/[\\\"\x00-\x1f\x7f-\xff]/g,c=function(e){return o.hasOwnProperty(e)&&o[e]?o[e]:e=e.replace(r,function(e){var t=e.charCodeAt(0),n="\\u";return 16>t?n+="000":256>t?n+="00":4096>t&&(n+="0"),o[e]=n+t.toString(16)})},l=function(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()},u=function(e,t){var n=t;return e.toUpperCase()===e?n=t.toUpperCase():l(e)===e&&(n=l(t)),n},d=function(e,t){for(;t>0&&!e.getRawFormatAt(t);)t--;return t>0?e.getRawFormatAt(t):null},s=function(e,t,n){for(var i,a=t;a<=n;a++)if(i=d(e,a),i&&i.cls&&("mergeField"===i.cls||"autoformula"===i.cls||"fillablefield"===i.cls||"signerfield"===i.cls||"autodocname"===i.cls||"autoauthor"===i.cls||"autodocversion"===i.cls))return!0;return!1},g=function(e,t){var n,i,a,o=[];for(n=0,i=t.length;n<i;n++)a=t[n],s(e,a.start,a.end)||o.push(a);return o},p=function(e,t,n,i){var a,o=e.createRange(),r=e.createRange();o.start=t.start,o.end=t.end,a=o.getStartNode(),r.start=t.start-a.start,r.end=t.end-a.start;var c;c=a.type===NODE_TYPE.BR?1:(a.text||"").substring(r.start,r.end).length,r.end=r.start+c;for(var l=a,u=[];l&&l.end<t.end;){for(l=l.getNextSibling();l&&l.type!==NODE_TYPE.TEXT&&l.type!==NODE_TYPE.BR&&l.end<t.end;)l=l.getNextSibling();u.push(l)}if(i){var d=a.getParent();d.splitAt(t.end-d.start)}e.replaceTextAtRange(a,r,n),t.end+=n.length-c,u.forEach(function(n){!n||n.type!=NODE_TYPE.TEXT&&n.type!=NODE_TYPE.BR||(r.start=0,r.end=(t.end>n.end?n.end:t.end)-n.start,c=n.type===NODE_TYPE.BR?1:(n.text||"").substring(r.start,r.end).length,e.replaceTextAtRange(n,r,""),t.end-=c)})},f=function(e,t,n,i){return p(e,t,n,i),e.getChanges()},h=function(e,t,n,i){var a,o;for(a=t.length-1;a>=0;a--)o=t[a],p(e,o,n,i);return e.getChanges()},E=function(e,t){t=t||{};var n,i=e.flags||"",a=e.source;return t.startWith&&(a="\\b"+a),t.endWith&&(a+="\\b"),t.matchWord&&(a="\\b"+a+"\\b"),t.matchCase&&e.ignoreCase&&(i=i.replace("i","")),n=new RegExp(a,i)},b=function(e,t){var n="";return(e.global||t.global)&&(n+="g"),(e.ignoreCase||t.ignoreCase)&&(n+="i"),(e.multiline||t.multiline)&&(n+="m"),(e.sticky||t.sticky)&&(n+="s"),(e.unicode||t.unicode)&&(n+="u"),(e.dotAll||t.dotAll)&&(n+="y"),n},m=function(){for(var e,t=editor.doc.getLocks().getDocOps(),n=0,i=[],a=0,o=t.length;a<o;a++)e=t[a],e.isRetain()?n+=e.retain_count:e.isLock()&&(i.push({start:n,end:n+e.length()}),n+=e.length());return i},T=function(e,t){for(var n,i,a,o,r=m(),c=[],l=!1,u=0,d=t.length;u<d;u++){i=t[u],a=e+i.start,o=e+i.end,l=!1;for(var s=0,g=r.length;s<g;s++)if(n=r[s],n.start<=a&&a<=n.end||n.start<=o&&o<=n.end||a<=n.start&&n.start<=o||a<=n.end&&n.end<=o){l=!0;break}l||c.push(i)}return c},v=function(e){return e=e.replaceAll(/(\^t)/g,UNICODE.TAB),e=e.replaceAll(/(\^l)/g,UNICODE.BR)};return{isValidRegex:i,getValidRegex:n,getRegex:a,mergeFlags:b,escapeSplChars:c,getTransformedText:u,removeRangesInsideField:g,getReplaceOps:f,getReplaceAllOps:h,applyRegexCriteria:E,removeLockContentRange:T,getReplaceSplChars:v}}();zw.define("FindUI",[],[],function(){"use strict";var e,t,n,i,a,o={FIND_MSG_CONTAINER:"find-msg-cont",FIND_TEXTBOX:"find-textbox",SELECTBOX:"find-selectbox",POPUP:"findpopup",OPTIONS_CONTAINER:"find-options",REPLACE_CONTAINER:"find-rpl-cont",REPLACE_BUTTON_CONTAINER:"find-rpl-button-cont",REPLACE_OPTION:"find-rpl-opt",SELECT_ALL:"find-selectall",FILTER:"find-filter",TRACK:"find-track",REPLACE_TEXTBOX:"find-rpl-textbox",LOADING:"find-result-loader",TITLE:"find-title"},r={error:"ui-clr-red",success:"ui-clr-green"},c=!1,l=function(){UIUtils.initComponent(o.POPUP),u(),p()},u=function(){Z(o.POPUP).bind("click",function(){T()})},d=function(){t=null},s=function(){T(),x(),e?g():(Z(o.FILTER).zselectbox("setValue","text"),f(["text"]))},g=function(){var t=findConfigurations[e].UI;y(t)},p=function(){var e,t=Z(o.FILTER);t.zselectbox();for(var n in findConfigurations)if(findConfigurations.hasOwnProperty(n)){if(e=findConfigurations[n].UI,!e)throw"UI configuration is mandatory";t.zselectbox("addOption",{label:e.name,value:n}),e.separator&&t.zselectbox("addOption",{separator:!0})}},f=function(i){e=i[0];var a=findConfigurations[e].UI;FindComponent[a.input.type].update(a.input),d(),a.input.type===FIND_COMPONENTS.DROPDOWN?(FindComponent[FIND_COMPONENTS.DROPDOWN].chooseOption("0"),t=FindComponent[FIND_COMPONENTS.DROPDOWN].getOptionValue("0")):a.input.type===FIND_COMPONENTS.INPUTBOX&&(a.input.value&&(t=a.input.value),n=a.input.validation?Utils.getAsFunction(a.input.validation):null),y(a),_(c&&I(a)),j(),FindManager.onFilterChange(e,t),ActivityTracker.track("Find","ChangeFilter","Popup")},h=function(){return e},E=function(){return t},b=function(e){t!=e&&(t=e,FindManager.onFindValueChange(t))},m=function(e,t){setTimeout(function(){var n=r[t];Z(o.FIND_MSG_CONTAINER).removeClass("ui-clr-red ui-clr-green").addClass(n||"").text(e).show()},50)},T=function(){Z(o.FIND_MSG_CONTAINER).hide()},v=function(){var e,t=Z(o.FIND_TEXTBOX)[0].value;return n&&(e=n.fn(t),"error"===e.status)?(e.msg&&m(e.msg,"error"),void b("")):void b(t)},N=function(){var e=Z(o.FIND_TEXTBOX)[0].value;clearTimeout(i),""===e?v():i=setTimeout(function(){v()},500)},O=function(e){13===e.keyCode?e.shiftKey?FindResultNavigator.prev():FindResultNavigator.next():e.keyCode===KEYS.ESC&&P()},F=function(e){13===e.keyCode?(L(),Z(o.REPLACE_TEXTBOX)[0].focus()):e.keyCode===KEYS.ESC&&P()},C=function(t){"objects"===e&&ActivityTracker.track("Find","ChangeFilter","Popup")},D=function(e){var n=FindComponent[FIND_COMPONENTS.DROPDOWN].getOptionValue(e[0]||"");t=n,C(n),FindManager.onFindValueChange(t)},A=function(){s(),Z(o.POPUP).slideDown(100,function(){setTimeout(function(){CurUtil.stopBlinking()},100),Z(o.FIND_TEXTBOX)[0].focus(),Z(o.FIND_TEXTBOX)[0].select()}),FindResultNavigator.setNavigationTextContainer(Z("find-nav-txt")),FindManager.onFindOpen(e,t),H(),ActivityTracker.track("Find","Open","Popup")},I=function(e){return e.canReplace&&editor.getRole().permissions.can(e.canReplace)},R=function(){A();var t=findConfigurations[e].UI;_(I(t)),ActivityTracker.track("Find","OpenReplace","Popup")},P=function(){Z(o.POPUP)[0].style.display="none",FindManager.onFindClose(),W()},S=function(e){return e&&editor.getRole().permissions.can(e)?"block":"none"},y=function(e){Z(o.REPLACE_OPTION)[0].style.display=S(e.canReplace||null),Z(o.SELECT_ALL)[0].style.display=S(e.canSelectAll||null)},_=function(e){e?M():x()},M=function(){c=!0,Z(o.TITLE)[0].innerHTML=J.i18n("writer.common.FIND_AND_REPLACE"),Z(o.OPTIONS_CONTAINER)[0].style.display="none",Z(o.REPLACE_CONTAINER)[0].style.display="block",Z(o.REPLACE_BUTTON_CONTAINER)[0].style.display="block",t&&Z(o.REPLACE_TEXTBOX)[0].focus()},x=function(){c=!1,Z(o.TITLE)[0].innerHTML=J.i18n("writer.common.FIND"),Z(o.OPTIONS_CONTAINER)[0].style.display="block",Z(o.REPLACE_CONTAINER)[0].style.display="none",Z(o.REPLACE_BUTTON_CONTAINER)[0].style.display="none"},L=function(){var e=t,n=Z(o.REPLACE_TEXTBOX)[0].value;e.length&&(FindManager.replace(n),ActivityTracker.track("Find","Replace","Popup"))},U=function(){var e=t,n=Z(o.REPLACE_TEXTBOX)[0].value,i=FindManager.getCollection().getNodesLength();e.length&&i&&(FindManager.replaceAll(n),m(J.i18n("common","REPLACE_ALL_MESSAGE",[i]),"success"),ActivityTracker.track("Find","ReplaceAll","Popup"))},B=function(){var e=FindManager.getCollection().getAllNodes();P(),ActivityTracker.track("Find","SelectAll","Popup"),FindManager.selectAll(e)},w=function(e,t){t!==LAYOUTS.COMPOSE&&t!==LAYOUTS.COLLABORATE&&t!==LAYOUTS.COMPLETE&&P()},k=function(){clearTimeout(a),a=setTimeout(function(){FindWorkerHandler.isQueueEmpty()?j():Z(o.LOADING)[0].style.display="block"},100)},j=function(){Z(o.LOADING)[0].style.display="none"},H=function(){PubSub.subscribe("Document/LayoutChanged",w),PubSub.subscribe(["Document/Find/ProcessingPara","Document/Find/SearchComplete","Document/Find/AllMatchesRemoved"],k)},W=function(){PubSub.unsubscribe("Document/LayoutChanged",w),PubSub.unsubscribe(["Document/Find/ProcessingPara","Document/Find/SearchComplete","Document/Find/AllMatchesRemoved"],k)};return{init:l,selectFilter:f,onTextChange:N,onInputBoxKeyDown:O,onReplaceBoxKeyDown:F,onDropDownValueChange:D,getFilter:h,getValue:E,openFind:A,openReplace:R,closeFind:P,showReplaceOptions:M,hideReplaceOptions:x,replace:L,replaceAll:U,selectAll:B}}),zw.define("FindUIBeta",[],[],function(){"use strict";var e,t,n,i,a,o={FIND_MSG_CONTAINER:"find-msg-cont",FIND_TEXTBOX:"find-textbox",OBJ_MENU:"findpopup-objects-menu",OBJ_MENU_BUTTON:"findpopup-obj-button",POPUP:"findpopup",OPTIONS_CONTAINER:"find-options",REPLACE_CONTAINER:"find-rpl-cont",REPLACE_BUTTON_CONTAINER:"find-rpl-button-cont",REPLACE_OPTION:"find-rpl-opt",FILTER:"find-filter",FILTER_BUTTON:"find-filter-button",REPLACE_TEXTBOX:"find-rpl-textbox",LOADING:"find-result-loader",INPUT_CONTAINER:"findpopup-input-cont",TITLE:"find-title"},r={error:"ui-clr-red",success:"ui-clr-green"},c={text:J.i18n("mailmergepopup","PLAIN_TEXT"),wildcard:J.i18n("common","WILDCARD"),objects:J.i18n("common","OBJECTS")},l="text",u=!1,d=["#find-prev","#find-next"],s=["#find-rpl","#find-rpl-all"],g={},p=function(){UIUtils.initComponent(o.POPUP),f(),T(findConfigurations)},f=function(){Z(o.POPUP).bind("click",function(){U()})},h=function(){e=null},E=function(){U(),te(),l?"text"!=l&&P("objects"):P("text")},b=function(e,t){return"findpopup-"+e+(t?"-"+t:"")},m=function(e,t){var n="findpopup-"+t+"-menu",i=J("<ul id="+n+" ctype='zmenu'></ul>");return i[0].setAttribute("data",'{"contentType":"icon-text", "width":"160px", "beforeshow": "FindUI.onSubTypeBeforeShow" }'),document.body.append(i[0]),i.zmenu(),e.forEach(function(e){i.zmenu("addMenuItem",{label:e.name,itemType:"radio",id:b(t,e.value),name:"objOpt",action:"FindUI.onSubTypeChange",itemValue:[t,e.value]})}),n},T=function(e){var t,n,i=Z(o.OBJ_MENU);for(var a in e)if(e.hasOwnProperty(a)&&e[a].isObject){if(t=e[a].UI,!t)throw"UI configuration is mandatory";if(n={label:t.name,itemType:"radio",id:b(a),name:"objs",action:"FindUI.onValueChange",itemValue:a},t.type&&t.type===FIND_COMPONENTS.DROPDOWN){var r=m(t.data,a);n.menuId=r,g[a]=r}i.zmenu("addMenuItem",n),t.separator&&i.zmenu("addMenuItem",{itemType:"separator"})}},v=function(t,n){var i,a=findConfigurations[t].UI;l=t,e=n,a.type===FIND_COMPONENTS.DROPDOWN?(i=O(t,n),g[t]&&J("#"+g[t]).zmenu("setMenuItemsAttribute",["#"+b(t,n)],"checked",!0)):i=a.name,FindManager.getFindType()!=t?FindManager.onFilterChange(t,n):FindManager.onFindValueChange(n),Z(o.OBJ_MENU).zmenu("setMenuItemsAttribute",["#"+b(t)],"checked",!0),N(i)},N=function(e){Z(o.OBJ_MENU_BUTTON).zmenubutton("changeLabel",e)},O=function(e,t){for(var n=findConfigurations[e].UI,i=n.data,a=0,o=i.length;a<o;a++)if(i[a].value===t)return i[a].name},F=function(e,t){var n,i=t.options.itemValue,a=findConfigurations[i].UI;n=a.type===FIND_COMPONENTS.DROPDOWN?a.data[0].value:a.value,v(i,n)},C=function(e,t){var n=t.options.itemValue,i=n[0],a=n[1];v(i,a)},D=function(e,t){if(FindManager.getFindType()!=t.itemValue){var n=t.element;n.zmenu("setMenuItemsAttribute",n.find("[checked=checked]"),"checked",!1)}},A=function(t){var n,i;if(l&&"text"!=l&&e)return{objType:l,objVal:e};for(var a in t)if(t.hasOwnProperty(a)&&t[a].isObject){var o=t[a].UI;n=a,i=o.type&&o.type===FIND_COMPONENTS.DROPDOWN?o.data[0].value:o.value;break}return{objType:n,objVal:i}},I=function(){Z(o.INPUT_CONTAINER)[0].classList.add("ui-find-input-gray"),Z(o.INPUT_CONTAINER)[0].classList.add("ui-hide-input"),Z(o.OBJ_MENU_BUTTON)[0].classList.remove("ui-hide"),Z("findpopup-search-menu").find("li[name=finddlgitem-exp]").addClass("ui-state-disabled")},R=function(){Z(o.INPUT_CONTAINER)[0].classList.remove("ui-find-input-gray"),Z(o.INPUT_CONTAINER)[0].classList.remove("ui-hide-input"),Z(o.OBJ_MENU_BUTTON)[0].classList.add("ui-hide"),Z("findpopup-search-menu").find("li[name=finddlgitem-exp]").removeClass("ui-state-disabled")},P=function(t){if("objects"===t){I();var n=A(findConfigurations);v(n.objType,n.objVal)}else R(),l=t,FindManager.onFilterChange(t,e),Z(o.FIND_TEXTBOX)[0].value=e||"";Z(o.FILTER_BUTTON).zmenubutton("changeLabel",c[t]),q(t),re(),ActivityTracker.trackInAnalytics("Find",S(t),"Popup")},S=function(e){switch(e){case"text":return"PlainText";case"wildcard":return"Wildcard";case"objects":return"Objects"}},y=function(e){h(),P(e)},_=function(){return l},M=function(){return e},x=function(t){e!=t&&(e=t,FindManager.onFindValueChange(e))},L=function(e,t){setTimeout(function(){var n=r[t];Z(o.FIND_MSG_CONTAINER).removeClass("ui-clr-red ui-clr-green").addClass(n||"").text(e).show()},50)},U=function(){Z(o.FIND_MSG_CONTAINER).hide()},B=function(){var e,n=Z(o.FIND_TEXTBOX)[0].value;return t&&(e=t.fn(n),"error"===e.status)?(e.msg&&L(e.msg,"error"),void x("")):void x(n)},w=function(){var e=Z(o.FIND_TEXTBOX)[0].value;clearTimeout(n),ce(e)?k():j(),""===e?B():n=setTimeout(function(){B()},500)},k=function(){Z(o.REPLACE_TEXTBOX).addClass("ui-state-disabled")},j=function(){Z(o.REPLACE_TEXTBOX).removeClass("ui-state-disabled")},H=function(e){var t;t="^e"==e?e:Z(o.FIND_TEXTBOX)[0].value+e,Z(o.FIND_TEXTBOX)[0].value=t,w()},W=function(e){13===e.keyCode?e.shiftKey?FindResultNavigator.prev():FindResultNavigator.next():e.keyCode===KEYS.ESC&&Q()},V=function(e){13===e.keyCode?(ne(),Z(o.REPLACE_TEXTBOX)[0].focus()):e.keyCode===KEYS.ESC&&Q()},Y=function(t){var n=FindComponent[FIND_COMPONENTS.DROPDOWN].getOptionValue(t[0]||"");e=n,FindManager.onFindValueChange(e)},X=function(){E(),Z(o.POPUP).slideDown(100,function(){setTimeout(function(){CurUtil.stopBlinking()},100),Z(o.FIND_TEXTBOX)[0].focus(),Z(o.FIND_TEXTBOX)[0].select()}),FindResultNavigator.setNavigationTextContainer(Z("find-nav-txt")),FindManager.onFindOpen(l,e),le(),pe(),ActivityTracker.trackInAnalytics("Find","Open","Popup"),FindDialogHandler.close()},G=function(){Q(),FindDialogHandler.open()},z=function(){return editor.getRole().permissions.can("document.edit")&&"text"===l},K=function(){X(),$(z()),ActivityTracker.trackInAnalytics("Find","OpenReplace","Popup")},Q=function(){Z(o.POPUP)[0].style.display="none",fe(),FindManager.onFindClose()},q=function(e){"objects"===e?($(!1),Z(o.REPLACE_OPTION)[0].style.display="none"):Z(o.REPLACE_OPTION)[0].style.display="block"},$=function(e){e?ee():te()},ee=function(){u=!0,Z(o.TITLE)[0].innerHTML=J.i18n("writer.common.FIND_AND_REPLACE"),Z(o.OPTIONS_CONTAINER)[0].style.display="none",Z(o.REPLACE_CONTAINER)[0].style.display="block",Z(o.REPLACE_BUTTON_CONTAINER)[0].style.display="block",e?Z(o.REPLACE_TEXTBOX)[0].focus():Z(o.FIND_TEXTBOX)[0].focus()},te=function(){u=!1,Z(o.TITLE)[0].innerHTML=J.i18n("writer.common.FIND"),Z(o.OPTIONS_CONTAINER)[0].style.display="block",Z(o.REPLACE_CONTAINER)[0].style.display="none",Z(o.REPLACE_BUTTON_CONTAINER)[0].style.display="none"},ne=function(){var t=e,n=Z(o.REPLACE_TEXTBOX)[0].value;t.length&&(FindManager.replace(n),ActivityTracker.trackInAnalytics("Find","Replace","Popup"));},ie=function(){var t=e,n=Z(o.REPLACE_TEXTBOX)[0].value,i=FindManager.getCollection().getNodesLength();t.length&&i&&(FindManager.replaceAll(n),L(J.i18n("common","REPLACE_ALL_MESSAGE",[i]),"success"),ActivityTracker.trackInAnalytics("Find","ReplaceAll","Popup"))},ae=function(e,t){t!==LAYOUTS.COMPOSE&&t!==LAYOUTS.COLLABORATE&&t!==LAYOUTS.COMPLETE&&Q()},oe=function(){clearTimeout(i),i=setTimeout(function(){FindWorkerHandler.isQueueEmpty()?re():Z(o.LOADING)[0].style.display="block"},100)},re=function(){Z(o.LOADING)[0].style.display="none"},ce=function(e){return e.indexOf("^p")>=0||e.indexOf("^e")>=0},le=function(){clearTimeout(a),a=setTimeout(function(){var t=FindManager.getCollection().getNodesLength();t>0&&"text"===l&&!ce(e)?s.forEach(function(e){J(e).removeClass("ui-state-disabled")}):s.forEach(function(e){J(e).addClass("ui-state-disabled")}),t>0?d.forEach(function(e){J(e).removeClass("ui-state-disabled")}):d.forEach(function(e){J(e).addClass("ui-state-disabled")})},50)},ue=function(e){J(e).closest(".js-find-focus").addClass("ui-zw-focus")},de=function(e){J(e).closest(".js-find-focus").removeClass("ui-zw-focus")},se=function(){FindResultNavigator.prev(),ActivityTracker.trackInAnalytics("Find","Navigate","Popup")},ge=function(){FindResultNavigator.next(),ActivityTracker.trackInAnalytics("Find","Navigate","Popup")},pe=function(){PubSub.subscribe("Document/LayoutChanged",ae),PubSub.subscribe(["Document/Find/ProcessingPara","Document/Find/SearchComplete","Document/Find/AllMatchesRemoved"],oe),PubSub.subscribe(["Document/Find/Para/MatchesFound","Document/Find/Para/MatchesRemoved","Document/Find/AllMatchesRemoved"],le)},fe=function(){PubSub.unsubscribe("Document/LayoutChanged",ae),PubSub.unsubscribe(["Document/Find/ProcessingPara","Document/Find/SearchComplete","Document/Find/AllMatchesRemoved"],oe),PubSub.unsubscribe(["Document/Find/Para/MatchesFound","Document/Find/Para/MatchesRemoved","Document/Find/AllMatchesRemoved"],le)};return{init:p,selectFilter:P,updateFilter:y,onTextChange:w,onInputBoxKeyDown:W,onReplaceBoxKeyDown:V,focusInput:ue,focusOutInput:de,onDropDownValueChange:Y,getFilter:_,getValue:M,openFind:X,openAdvancedFind:G,openReplace:K,closeFind:Q,showReplaceOptions:ee,hideReplaceOptions:te,replace:ne,replaceAll:ie,appendValue:H,onValueChange:F,onSubTypeChange:C,onSubTypeBeforeShow:D,navigateToPrevious:se,navigateToNext:ge}}),FindUI=FindUIBeta,zw.define("FindDialogHandler",[],[],function(){"use strict";var e,t,n,i={text:{show:["#finddlg-text-input-cont"],hide:[]},wildcard:{show:["#finddlg-wildcard-input-cont","#finddlg-replace-wildcard"],hide:[],disable:["#finddlg-opt-matchcase","#finddlg-opt-matchcprefix","#finddlg-opt-wholeword","#finddlg-opt-matchcsuffix","list:#finddlg-all-menu,finddlgitem-exp","list:#finddlg-replace-menu,finddlgitem-exp"]},style:{show:[],hide:[]},objects:{show:["#finddlg-objects-input-cont"],hide:[],disable:["#finddlg-opt-matchcase","#finddlg-opt-matchcprefix","#finddlg-opt-includelock","#finddlg-opt-wholeword","#finddlg-opt-matchcsuffix","#finddlg-replace-opt-menu","#finddlg-replace-input","#finddlg-replace-wildcard","list:#finddlg-all-menu,finddlgitem-exp","list:#finddlg-replace-menu,finddlgitem-exp"]}},a={text:J.i18n("mailmergepopup","PLAIN_TEXT"),wildcard:J.i18n("common","WILDCARD"),objects:J.i18n("common","OBJECTS"),para:J.i18n("common","PARAGRAPH")},o={},r="text",c=!1,l=["#finddlg-next"],u=["#finddlg-rpl","#finddlg-rpl-all"],d=["#finddlg-all-menu","#finddlg-replace-menu","#finddlg-objects-menu","#finddlg-hypen-submenu","#finddlg-rpl-hypen-submenu","#finddlg-rpl-space-submenu","#finddlg-space-submenu","#finddlg-wildcrd-menu","#finddlg-rpl-wildcrd-menu","#finddlg-wildcard-eg"],s=function(){var e,t,n="text",i=!1,a={inputbox:"#finddlg-text-input",navText:"#finddlg-nav-txt",replacebox:"#finddlg-replace-input",loader:"#finddlg-text-loader"},o=function(){var e=FindUI.getFilter()===n&&FindUI.getValue()||"";J(a.inputbox)[0].value=e,J(a.inputbox).focus(),J(a.inputbox).select(),FindResultNavigator.setNavigationTextContainer(J(a.navText)),FindManager.onFindOpen("text","",FindDialogHandler.getOptions()),d(),c(e)},r=function(){J(a.replacebox)[0].value="",i=!1},c=function(n){clearTimeout(e),t=n,l(t)?u():!i&&d(),""===t?FindManager.onFindValueChange(t):e=setTimeout(function(){FindManager.onFindValueChange(t)},500)},l=function(e){return e.indexOf("^p")>=0||e.indexOf("^e")>=0},u=function(){J(a.replacebox).addClass("ui-state-disabled")},d=function(){J(a.replacebox).removeClass("ui-state-disabled")},s=function(e){i=e,e?(J(a.replacebox)[0].value="^p",u()):(J(a.replacebox)[0].value="",m()&&d())},g=function(){var e=J(a.replacebox).val();null!=e&&FindManager.replace(FindUtils.getReplaceSplChars(e),i)},p=function(){var e=J(a.replacebox).val();if(null!=e){var t=FindManager.getCollection().getNodesLength();FindManager.replaceAll(FindUtils.getReplaceSplChars(e),i),t&&FindDialogHandler.showReplaceMsg(J.i18n("common","REPLACE_ALL_MESSAGE",[t]))}},f=function(){return J(a.loader)},h=function(e){var t;t="^e"==e?e:J(a.inputbox)[0].value+e,J(a.inputbox)[0].value=t,c(t)},E=function(e){var t=J(a.replacebox)[0].value+e;J(a.replacebox)[0].value=t},b=function(e){J(a.inputbox)[0].value=e,c(e)},m=function(){return!l(J(a.inputbox).val())},T=function(){return i};return{init:o,destroy:r,getLoadingElem:f,onValueChange:c,setValue:b,appendValue:h,appendReplaceValue:E,canEnableReplace:m,replace:g,replaceAll:p,setReplacePara:s,isReplaceParaSelected:T}}(),g=function(){var e,t,n=!1,i={inputbox:"#finddlg-wildcard-input",navText:"#finddlg-wildcard-nav-txt",replacebox:"#finddlg-replace-input",replaceOpt:"#finddlg-replace-wildcard",errorMsg:"#finddlg-wildcard-error-msg",loader:"#finddlg-wildcard-loader"},a={};a["?"]=".",a["<"]="\\b",a[">"]="\\b",a["@"]="{1,}",a["*"]=".{0,}",a["^t"]="\\t",a["^l"]=UNICODE.BR;var o={"<":{text:"<ENTER_YOUR_TEXT",start:1,end:15},">":{text:"ENTER_YOUR_TEXT>",start:0,end:14},"[-]":{text:"[A-z]",start:1,end:3},"[!]":{text:"[!A-z]",start:2,end:4},"{,}":{text:"CHARACTER{0,1}",start:0,end:8},"@":{text:"CHARACTER@",start:0,end:8},"*":{text:"a*b",start:0,end:2}},r=function(){t="",J(i.inputbox)[0].value=t,J(i.inputbox).focus(),FindResultNavigator.setNavigationTextContainer(J(i.navText)),FindManager.onFindOpen("textpattern","",FindDialogHandler.getOptions()),b(t),N()},c=function(){u(),J(i.replacebox)[0].value="",n=!1},l=function(e){J(i.errorMsg).text(e).delay(1e3).show()},u=function(){J(i.errorMsg).hide()},d={"{":"}","}":"{","[":"]","]":"[","(":")",")":"("},s=["+",".","^","$","*","\\","?","|"],g=function(e){return d[e]},p=function(e){var t=parseInt(e);return!isNaN(t)&&t>0&&t.toString()===e.toString()},f=function(e,t){for(var n,i=t.substring(e),a=g(t.charAt(e)),o=0,r=i.length;o<r;o++)if(n=i.charAt(o),"\\"!==n){if(n===a)return e+o}else o++;return-1},h=function(e){var t,n,i,o,r,c="",l=!0,u=e.substring(1,e.length-1);if(!u||"["===e.charAt(0)&&1===u.length&&"!"===u)return n=J.i18n("common","ENTER_VALID_EXPRESSION_MSG"),{isValid:!1,wildcardReg:c,errorMsg:n};if("["===e.charAt(0)){for(c+="[",i=0,o=u.length;i<o;i++)if(r=u.charAt(i),0===i&&"!"===r&&(r="^"),"\\"===r){i++;var t=u.charAt(i);c+="\\"===t||"]"===t||"^"===r?r+t:t}else if("^"===r){var t=u.charAt(i+1);"t"===t||"l"===t?(c+=a[r+t],i++):c+=r}else c+=r;c+="]"}else if("{"===e.charAt(0)){var d=u.split(","),s=parseInt(d[0]),g=parseInt(d[1]);(0==s||p(s))&&d.length<=2&&(!g||p(g)&&g>=s)?c+=e:(n=J.i18n("common","ENTER_VALID_NUM_OCCURRENCE_MSG"),l=!1)}return{isValid:l,wildcardReg:c,errorMsg:n}},E=function(e){var t,n,i,o,r="",c=!0;for(t=0,n=e.length;t<n;t++)if(i=e.charAt(t),"\\"===i){t++;var l=e.charAt(t);r+=d.hasOwnProperty(l)||a.hasOwnProperty(l)||s.indexOf(l)>=0?i+l:l}else{if("["===i||"{"===i){var u=f(t,e);if(u<0){o=J.i18n("common","NOT_A_VALID_EXPRESSION_MSG"),c=!1;break}var g=h(e.substring(t,u+1));if(g.isValid){r+=g.wildcardReg,t=u;continue}o=g.errorMsg,c=!1;break}if("]"===i||"}"===i){o=J.i18n("common","NOT_A_VALID_EXPRESSION_MSG"),c=!1;break}if(a.hasOwnProperty(i))if(">"===i||"@"===i){var p=e.charAt(t-1);if(!p){o=J.i18n("common","SHOULD_HAVE_CHARACTER_IN_PREFIX_MSG",[i]),c=!1;break}r+=a[i]}else if("<"===i){var l=e.charAt(t+1);if(!l){o=J.i18n("common","SHOULD_HAVE_CHARACTER_IN_SUFFIX_MSG",[i]),c=!1;break}r+=a[i]}else r+=a[i];else if("^"===i){var l=e.charAt(t+1);"t"===l||"l"===l?(r+=a[i+l],t++):r+="[\\"+i+"]"}else i=FindUtils.escapeSplChars(i),"]"===i&&(i="\\]"),r+="["+i+"]"}try{new RegExp(r,"g")}catch(e){c=!1,o=J.i18n("common","NOT_A_VALID_EXPRESSION_MSG")}return{isValid:c,wildcardReg:r,errorMsg:o}},b=function(n){clearTimeout(e),t=n;var i;""===t?(FindManager.onFindValueChange(t),u()):e=setTimeout(function(){i=E(t),i.isValid?(FindManager.onFindValueChange(i.wildcardReg),u()):(FindManager.onFindValueChange(""),l(i.errorMsg))},500)},m=function(){var e=J(i.replacebox).val();null!=e&&FindManager.replace(FindUtils.getReplaceSplChars(e),n)},T=function(){var e=J(i.replacebox).val();if(null!=e){var t=FindManager.getCollection().getNodesLength();FindManager.replaceAll(FindUtils.getReplaceSplChars(e),n),t&&FindDialogHandler.showReplaceMsg(J.i18n("common","REPLACE_ALL_MESSAGE",[t]))}},v=function(){J(i.replacebox).addClass("ui-state-disabled"),J(i.replaceOpt).disable()},N=function(){J(i.replacebox).removeClass("ui-state-disabled"),J(i.replaceOpt).enable()},O=function(e){n=e,e?(J(i.replacebox)[0].value="^p",v()):(J(i.replacebox)[0].value="",N())},F=function(){return J(i.loader)},C=function(e,t){var n=o[t],a=e.length;J(i.inputbox)[0].setSelectionRange(a+n.start,a+n.end+1),setTimeout(function(){J(i.inputbox)[0].focus()},200)},D=function(e){var t,n;o.hasOwnProperty(e)?(n=J(i.inputbox)[0].value,t=n+o[e].text,J(i.inputbox)[0].value=t,C(n,e)):(t=J(i.inputbox)[0].value+e,J(i.inputbox)[0].value=t),b(t)},A=function(e){var t=J(i.replacebox)[0].value+e;J(i.replacebox)[0].value=t},I=function(e){J(i.inputbox)[0].value=e,b(e)},R=function(){return!0},P=function(){return n};return{init:r,destroy:c,getLoadingElem:F,onValueChange:b,appendValue:D,setValue:I,setReplacePara:O,isReplaceParaSelected:P,appendReplaceValue:A,canEnableReplace:R,replace:m,replaceAll:T}}(),p=function(){var e={},t={objectsmenu:"#finddlg-objects-menu",objButton:"#finddlg-obj-button",navText:"#finddlg-obj-nav-txt",loader:"#finddlg-obj-loader"},n=function(){i()||(a(),o(findConfigurations));var e=c(findConfigurations);J(t.objButton).focus(),FindResultNavigator.setNavigationTextContainer(J(t.navText)),FindManager.onFindOpen("text","",FindDialogHandler.getOptions()),s(e.objType,e.objVal)},i=function(){return J(t.objectsmenu).has("li").length>0},a=function(){J(t.objButton).zmenubutton(),J(t.objectsmenu).zmenu()},o=function(n){var i,a,o=J(t.objectsmenu);for(var c in n)if(n.hasOwnProperty(c)&&n[c].isObject){if(i=n[c].UI,!i)throw"UI configuration is mandatory";if(a={label:i.name,itemType:"radio",id:u(c),name:"objs",action:"FindDialogHandler.ObjectsHandler.onValueChange",itemValue:c},i.type&&i.type===FIND_COMPONENTS.DROPDOWN){var l=r(i.data,c);a.menuId=l,e[c]=l}o.zmenu("addMenuItem",a),i.separator&&o.zmenu("addMenuItem",{itemType:"separator"})}},r=function(e,t){var n="finddlg-"+t+"-menu",i=J("<ul id="+n+" ctype='zmenu'></ul>");return i[0].setAttribute("data",'{"contentType":"icon-text", "width":"160px", "beforeshow": "FindDialogHandler.ObjectsHandler.onSubTypeBeforeShow" }'),document.body.append(i[0]),i.zmenu(),e.forEach(function(e){i.zmenu("addMenuItem",{label:e.name,itemType:"radio",id:u(t,e.value),name:"objOpt",action:"FindDialogHandler.ObjectsHandler.onSubTypeChange",itemValue:[t,e.value]})}),n},c=function(e){var t,n;for(var i in e)if(e.hasOwnProperty(i)&&e[i].isObject){var a=e[i].UI;t=i,n=a.type&&a.type===FIND_COMPONENTS.DROPDOWN?a.data[0].value:a.value;break}return{objType:t,objVal:n}},l=function(e){J(t.objButton).zmenubutton("changeLabel",e)},u=function(e,t){return"finddlg-"+e+(t?"-"+t:"")},d=function(e,t){for(var n=findConfigurations[e].UI,i=n.data,a=0,o=i.length;a<o;a++)if(i[a].value===t)return i[a].name},s=function(n,i){var a,o=findConfigurations[n].UI;o.type===FIND_COMPONENTS.DROPDOWN?(a=d(n,i),e[n]&&J("#"+e[n]).zmenu("setMenuItemsAttribute",["#"+u(n,i)],"checked",!0)):a=o.name,FindManager.getFindType()!=n?FindManager.onFilterChange(n,i,FindDialogHandler.getOptions()):FindManager.onFindValueChange(i),J(t.objectsmenu).zmenu("setMenuItemsAttribute",["#"+u(n)],"checked",!0),l(a)},g=function(e,t){var n,i=t.options.itemValue,a=findConfigurations[i].UI;n=a.type===FIND_COMPONENTS.DROPDOWN?a.data[0].value:a.value,s(i,n)},p=function(e,t){var n=t.options.itemValue,i=n[0],a=n[1];s(i,a)},f=function(e,t){if(FindManager.getFindType()!=t.itemValue){var n=t.element;n.zmenu("setMenuItemsAttribute",n.find("[checked=checked]"),"checked",!1)}},h=function(){},E=function(){},b=function(){},m=function(){return J(t.loader)},T=function(){return!0};return{init:n,destroy:h,getLoadingElem:m,onValueChange:g,onSubTypeChange:p,onSubTypeBeforeShow:f,canEnableReplace:T,replace:E,replaceAll:b}}(),f={};f.text=s,f.objects=p,f.wildcard=g;var h,E={init:function(e){J(e).find("[ctype=zmenu]").off("zmenuitemclick").on("zmenuitemclick",function(e,t){UIUtils._itemClicked(e,t)})},get:function(e){var t=e.action;return"includeLock"===t?(o.includeLock=!0,!0):"startWith"===t||"endWith"===t||"matchCase"===t||"matchWord"===t||"includeField"===t?o[t]||!1:void 0},set:function(e,t,n){var i=e.action;if("startWith"===i||"endWith"===i||"matchCase"===i||"matchWord"===i||"includeField"===i||"includeLock"===i||"searchIn"===i){v(i,t);var a=b(i);a&&ActivityTracker.trackInAnalytics("Find",a,"Dialog")}else"prev"===i?(FindResultNavigator.prev(),ActivityTracker.trackInAnalytics("Find","Navigate","Dialog")):"next"===i?(FindResultNavigator.next(),ActivityTracker.trackInAnalytics("Find","Navigate","Dialog")):"replace"===i?(I(),ActivityTracker.trackInAnalytics("Find","Replace","Dialog")):"replaceall"===i?(R(),ActivityTracker.trackInAnalytics("Find","ReplaceAll","Dialog")):"closepopup"===i&&S()}},b=function(e){switch(e){case"startWith":return"MatchPrefix";case"endWith":return"MatchSuffix";case"matchCase":return"MatchCase";case"matchWord":return"WholeWord";case"includeLock":return"IncludeLockContent";case"searchIn":return"SearchInRange";case"text":return"PlainText";case"wildcard":return"Wildcard";case"objects":return"Objects"}},m=function(e){13===e.keyCode&&(e.shiftKey?FindResultNavigator.prev():FindResultNavigator.next())},T=function(e){13===e.keyCode&&I()},v=function(e,t){o[e]=t,FindManager.onFindCriteriaChange(e,t)},N=function(e){J("#finddlg-msg-cont").text(e),J("#finddlg-msg-cont").show(),setTimeout(function(){J("#finddlg-msg-cont").slideUp("slow")},3e3)},O=function(){J("#finddlg-msg-cont").hide()},F=function(e){t.onValueChange(e)},C=function(e){t.appendValue(e)},D=function(e){t.isReplaceParaSelected&&t.isReplaceParaSelected()&&U(!1),t.appendReplaceValue(e)},A=function(e){t.setValue(e)},I=function(){t.replace()},R=function(){t.replaceAll()},P=function(){J.dialogutil.open("advancedfindreplacedialog",void 0,E),ActivityTracker.trackInAnalytics("Find","Open","Dialog")},S=function(){J.dialogutil.close("advancedfindreplacedialog")},y=function(){return o},_=function(){e=r,L(e),z(),$()},M=function(){c=!1,FindManager.onFindClose(),Y(),ee(),x()},x=function(){J(d.join(",")).remove()},L=function(n){H(n),Y(),J("#finddlg-find-opt-menu").zmenubutton("changeLabel",a[n]),"objects"!=n&&J("#finddlg-replace-opt-menu").zmenubutton("changeLabel",a[n]),t&&t.destroy(),e=n,t=f[n],t.init(),ActivityTracker.trackInAnalytics("Find",b(n),"Dialog"),PubSub.publish("Document/FindUI/SearchTypeUpdated",n)},U=function(n){t.setReplacePara(n),n?J("#finddlg-replace-opt-menu").zmenubutton("changeLabel",a.para):J("#finddlg-replace-opt-menu").zmenubutton("changeLabel",a[e])},B=function(e){J(e.show.join(",")).hide(),J(e.hide.join(",")).show()},w=function(e){var t,n=e.disable;n&&n.forEach(function(e){if(e.indexOf("list:")>=0){var n=e.substring(5).split(",");J(n[0]).find("li[name="+n[1]+"]").addClass("ui-state-disabled")}else t=J(e),t.attr("ctype")?t.disable():t.addClass("ui-state-disabled")})},k=function(e){var t,n=e.disable;n&&n.forEach(function(e){if(e.indexOf("list:")>=0){var n=e.substring(5).split(",");J(n[0]).find("li[name="+n[1]+"]").removeClass("ui-state-disabled")}else t=J(e),t.attr("ctype")?t.enable():t.removeClass("ui-state-disabled")})},j=function(e){J(e.show.join(",")).show(),J(e.hide.join(",")).hide()},H=function(t){B(i[e]),k(i[e]),j(i[t]),w(i[t])},Z=function(e,t){t!==LAYOUTS.COMPOSE&&t!==LAYOUTS.COLLABORATE&&t!==LAYOUTS.COMPLETE&&S()},W=function(){if(t)return t.getLoadingElem()},V=function(){clearTimeout(n),n=setTimeout(function(){if(FindWorkerHandler.isQueueEmpty())Y();else{var e=W();e&&e.show()}},100)},Y=function(){var e=W();e&&e.hide()},X=function(e){J(e).closest(".ui-find-inputbox-container").addClass("ui-zw-focus")},G=function(e){J(e).closest(".ui-find-inputbox-container").removeClass("ui-zw-focus")},z=function(){clearTimeout(h),h=setTimeout(function(){var n=FindManager.getCollection().getNodesLength();n>0&&"objects"!=e&&t.canEnableReplace()?u.forEach(function(e){J(e).enable()}):u.forEach(function(e){J(e).disable()}),n>0?l.forEach(function(e){J(e).enable()}):l.forEach(function(e){J(e).disable()})},50)},K=function(e){var t;(e.ctrlKey||e.metaKey)&&c&&("z"==String.fromCharCode(e.which).toLowerCase()?(t=editor.doc.snapShotManager.isUndoQueueEmpty(),!t&&editor.doc.execCmd("undo"),e.preventDefault()):"y"==String.fromCharCode(e.which).toLowerCase()&&(t=editor.doc.snapShotManager.isRedoQueueEmpty(),!t&&editor.doc.execCmd("redo"),e.preventDefault()))},Q=function(){c=!0},q=function(){c=!1},$=function(){PubSub.subscribe("Document/LayoutChanged",Z),PubSub.subscribe(["Document/Find/ProcessingPara","Document/Find/SearchComplete","Document/Find/AllMatchesRemoved"],V),PubSub.subscribe(["Cursor/Collapsed","Cursor/Selected"],Q),PubSub.subscribe(["Document/Find/Para/MatchesFound","Document/Find/Para/MatchesRemoved","Document/Find/AllMatchesRemoved"],z),J("#advancedfinddlg").on("click",q),J(window).on("keydown",K)},ee=function(){PubSub.unsubscribe("Document/LayoutChanged",Z),PubSub.unsubscribe(["Document/Find/ProcessingPara","Document/Find/SearchComplete","Document/Find/AllMatchesRemoved"],V),PubSub.unsubscribe(["Cursor/Collapsed","Cursor/Selected"],Q),PubSub.unsubscribe(["Document/Find/Para/MatchesFound","Document/Find/Para/MatchesRemoved","Document/Find/AllMatchesRemoved"],z),J("#advancedfinddlg").off("click",q),J(window).off("keydown",K)},te=function(){Utils.safeWindowOpen(editorProps.urls.helpPageURL+"document-tools.html#Wildcards")};return{loadFindType:L,open:P,close:S,showReplaceMsg:N,hideReplaceMsg:O,onValueChange:F,setExpression:C,setReplaceExpression:D,selectReplacePara:U,setExpressionExample:A,onInputBoxKeyDown:m,onReplaceKeyDown:T,focusInput:X,focusOutInput:G,ObjectsHandler:p,replace:I,replaceAll:R,getOptions:y,onDialogOpen:_,onDialogClose:M,openWildcardHelpPage:te}}),zw.define("FindManager",[],[],function(){"use strict";var e,t=!1,n=function(){var e=[],t={},n=function(n,a){if(a&&0!==a.length){var o,r,c,l,u,d=0;for(t.hasOwnProperty(n)&&i(n),l=DocTreeManager.getTreeNodeById(n).getIndex(),o=0,r=e.length;o<r;o++)if(c=e[o],u=DocTreeManager.getTreeNodeById(c.getParaId())){if(!(u.getIndex()<l)){d=o;break}o+=t[u.id].length-1,d=o+1}t[n]=a,e.splice.apply(e,[d,0].concat(a)),PubSub.publish("Document/Find/Para/MatchesFound",n,a)}},i=function(n){var i,o,r,c=a(n),l=0;if(c.length){for(i=0,o=e.length;i<o;i++){if(r=e[i],r.getParaId()==n){l=i;break}i+=a(r.getParaId()).length-1}var u=e.splice(l,c.length);delete t[n],u.length&&PubSub.publish("Document/Find/Para/MatchesRemoved",n,u)}},a=function(e){return t[e]||[]},o=function(t){return e[t]||null},r=function(){return e},c=function(){return e.length},l=function(){e=[],t={},PubSub.publish("Document/Find/AllMatchesRemoved")},u=function(t){for(var n=t.getId(),i=0,a=e.length;i<a;i++)if(e[i].getId()===n)return i;return-1},d=function(e){return o(s(e))},s=function(t){var n,i,a,o,r,c,l=!1,u=-1;for(i=0,a=e.length;i<a;i++)if(o=e[i],n=DocTreeManager.getTreeNodeById(o.getParaId()),n&&(r=n.getIndex()+o.getStart(),c=n.getIndex()+o.getEnd(),r<=t&&t<c||t<r)){u=i,l=!0;break}return l||(u=0),u},g=function(t){var n,i,a;for(n=0,i=e.length;n<i;n++)if(a=e[n],a.getId()===t)return a;return null};return{addNodes:n,removeNodes:i,getAllNodes:r,getNodesLength:c,getNodes:a,getNodeAt:o,getNearestNodeIndex:s,getNearestNode:d,getNodeIndex:u,reset:l,getNodeById:g}}(),i=function(){if(!t){var e={};for(var n in findConfigurations)findConfigurations.hasOwnProperty(n)&&(e[n]=findConfigurations[n].handler.action);var i=function(){t=!0},a=function(e){ZWLogger.log("Exception@ FindManager Actionconfiguration failed"),ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,e)};ZWJsThreadExecutor.execFn("FindWorker.updateFindActionConfiguration",e,{success:i,error:a})}},a=function(e,t){try{r(e,t),v(),PubSub.publish("Document/Find/Opened")}catch(e){ZWLogger.log("Exception@ FindManager onOpen");var n=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,n)}},o=function(){try{l(),e.terminate(),N(),PubSub.publish("Document/Find/Closed")}catch(e){ZWLogger.log("Exception@ FindManager onClose");var t=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,t)}},r=function(t,n){try{e&&(l(),e.terminate());var i=findConfigurations[t],a=Utils.getAsFunction(i.handler.findObj).fn||FindObj;e=new a(t,"find",null,i.handler.searchEvents,i.handler.customData),n&&e.updateValue(n),PubSub.publish("Document/Find/FilterChanged",t,n)}catch(e){ZWLogger.log("Exception@ FindManager on Filter change");var o=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,o)}},c=function(t){try{l(),e.updateValue(t),PubSub.publish("Document/Find/ValueChanged",t)}catch(e){ZWLogger.log("Exception@ FindManager on value change");var n=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,n)}},l=function(){n.reset()},u=function(e){try{n.removeNodes(e)}catch(e){ZWLogger.log("Exception@ FindManager on Paragraph processing");var t=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,t)}},d=function(t,i){try{var a=[];i=i||[];for(var o,r=e.getType(),c=0,l=i.length;c<l;c++)o=i[c],a.push(new FindResultNode(o.start,o.end,r,t));a.length&&n.addNodes(t,a)}catch(e){ZWLogger.log("Exception@ FindManager on Processing result");var u=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,u)}},s=function(){return n},g=function(e){try{var t=editor.doc.getSelection().getStart(),i=FindResultNavigator.getHighlightedNode()||n.getNearestNode(t);if(!i)return;var a,o=i.getParaId(),r=n.getNodes(o),c=DocTreeManager.getTreeNodeById(o).getIndex(),l=e.length-(i.getEnd()-i.getStart()),u=c+i.getStart(),d=c+i.getEnd(),s=editor.doc.getContent(u,d),g=editor.doc.getTrackChangeDetails().getProcessingTC(),p=editor.doc.getTrackChangeDetails().getDisplayMode()===TCConstants.NO_MARKUP_VIEW;g&&!p&&(l=e.length),a=d+l;var f=FindUtils.getReplaceOps(editor.getDocument(),{start:u,end:d,text:s},e);Op.processMsg(f.toJson()),Op.sendMsg();var h=editor.doc.createRange(a,a);editor.doc.getSelection().removeAllRanges().setSelectionType(SEL_AUTO_GEN).addRange(h);for(var E,b=0,m=r.length;b<m;b++)E=r[b],i.getId()!==E.getId()?E.getStart()>i.getStart()&&(E.setStart(E.getStart()+l),E.setEnd(E.getEnd()+l)):(r.splice(b,1),m--,b--);n.addNodes(o,r),FindResultNavigator.moveToNextReplace(n.getNearestNode(a))}catch(e){ZWLogger.log("Exception@ FindManager replace");var T=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,T)}},p=function(e){try{var t,i,a,o,r=n.getAllNodes(),c=[];r.forEach(function(e){t=DocTreeManager.getTreeNodeById(e.getParaId()),t&&(i=t.getIndex(),a=i+e.getStart(),o=i+e.getEnd(),c.push({start:a,end:o,text:editor.doc.getContent(a,o)}))});var l=FindUtils.getReplaceAllOps(editor.getDocument(),c,e);Op.processMsg(l.toJson()),Op.sendMsg(),PubSub.publish("Document/Warning",WARNING_MSG.REPLACE_SEARCH_COMPLETED_MSG,c.length)}catch(e){ZWLogger.log("Exception@ FindManager replaceAll");var u=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,u)}},f=function(e){try{var t,i,a,o,r,c,l=[],u=editor.doc.getSelection();u.removeAllRanges();var e=e||n.getAllNodes();if(0===e.length)return;for(i=0,a=e.length;i<a;i++)o=e[i],t=DocTreeManager.getTreeNodeById(o.getParaId()),t&&(r=t.getIndex()+o.getStart(),c=t.getIndex()+o.getEnd(),l.push(editor.doc.createRange(r,c)));u.setSelectionType(SEL_AUTO_GEN).addRanges(l).mapAllSelectionsToBulletin(),EditorUtil.focusMultiByteSpan()}catch(e){ZWLogger.log("Exception@ FindManager SelectAll");var d=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,d)}},h=function(){var e=[];return e.push({name:J.i18n("common","ALL_HEADINGS"),value:"all"}),e.push({name:J.i18n("digisign","TITLE"),value:"title"}),e.push({name:J.i18n("styles","SUBTITLE"),value:"subtitle"}),e.push({name:J.i18n("styles","HEADING_1"),value:"headings1"}),e.push({name:J.i18n("styles","HEADING_2"),value:"headings2"}),e.push({name:J.i18n("styles","HEADING_3"),value:"headings3"}),e.push({name:J.i18n("styles","HEADING_4"),value:"headings4"}),e.push({name:J.i18n("styles","HEADING_5"),value:"headings5"}),e.push({name:J.i18n("styles","HEADING_6"),value:"headings6"}),e.push({name:J.i18n("styles","QUOTE"),value:"quote"}),e},E=function(){var e=[];return e.push({name:J.i18n("common","ALL_FIELDS"),value:"all"}),e.push({name:J.i18n("common","AUTO_FIELDS"),value:NODE_TYPE.AUTOFIELD}),e.push({name:J.i18n("common","FILLABLE_FIELDS"),value:NODE_TYPE.FILLABLEFIELD}),e.push({name:J.i18n("common","MERGE_FIELDS"),value:NODE_TYPE.MAILMERGEFIELD}),e},b=function(){var e=[];return e.push({name:J.i18n("common","TABLES"),value:"table"}),e.push({name:J.i18n("common","IMAGES"),value:"image"}),e.push({name:J.i18n("common","ENDNOTES"),value:NODE_TYPE.ENDNOTE}),e.push({name:J.i18n("common","FOOTNOTES"),value:NODE_TYPE.FOOTNOTE}),e},m=function(){return e&&e.getType()},T=function(){return e&&e.getValue()},v=function(){PubSub.subscribe("Document/Find/SearchComplete",d),PubSub.subscribe("Document/Find/ProcessingPara",u)},N=function(){PubSub.unsubscribe("Document/Find/SearchComplete",d),PubSub.unsubscribe("Document/Find/ProcessingPara",u)};return{init:i,getCollection:s,replace:g,replaceAll:p,selectAll:f,getFindType:m,getFindValue:T,onFilterChange:r,onFindValueChange:c,onFindOpen:a,onFindClose:o,getHeadings:h,getFieldsOptions:E,getOtherOptions:b}}),zw.define("FindManagerBeta",[],[],function(){"use strict";var e,t=!1,n=function(){var e=[],t={},n=function(n,a){if(a&&0!==a.length){var o,r,c,l,u,d=0;for(t.hasOwnProperty(n)&&i(n),l=DocTreeManager.getTreeNodeById(n).getIndex(),o=0,r=e.length;o<r;o++)if(c=e[o],u=DocTreeManager.getTreeNodeById(c.getParaId())){if(!(u.getIndex()<l)){d=o;break}o+=t[u.id].length-1,d=o+1}t[n]=a,e.splice.apply(e,[d,0].concat(a)),PubSub.publish("Document/Find/Para/MatchesFound",n,a)}},i=function(n){var i,o,r,c=a(n),l=0;if(c.length){for(i=0,o=e.length;i<o;i++){if(r=e[i],r.getParaId()==n){l=i;break}i+=a(r.getParaId()).length-1}var u=e.splice(l,c.length);delete t[n],u.length&&PubSub.publish("Document/Find/Para/MatchesRemoved",n,u)}},a=function(e){return t[e]||[]},o=function(t){return e[t]||null},r=function(){return e},c=function(){return e.length},l=function(){e=[],t={},PubSub.publish("Document/Find/AllMatchesRemoved")},u=function(t){for(var n=t.getId(),i=0,a=e.length;i<a;i++)if(e[i].getId()===n)return i;return-1},d=function(e){return o(s(e))},s=function(t){var n,i,a,o,r,c,l=!1,u=-1;for(i=0,a=e.length;i<a;i++)if(o=e[i],n=DocTreeManager.getTreeNodeById(o.getParaId()),n&&(r=n.getIndex()+o.getStart(),c=n.getIndex()+o.getEnd(),r<=t&&t<c||t<r)){u=i,l=!0;break}return l||(u=0),u},g=function(t){var n,i,a;for(n=0,i=e.length;n<i;n++)if(a=e[n],a.getId()===t)return a;return null};return{addNodes:n,removeNodes:i,getAllNodes:r,getNodesLength:c,getNodes:a,getNodeAt:o,getNearestNodeIndex:s,getNearestNode:d,getNodeIndex:u,reset:l,getNodeById:g}}(),i=function(){if(!t){var e={};for(var n in findConfigurations)findConfigurations.hasOwnProperty(n)&&(e[n]=findConfigurations[n].handler.action);var i=function(){t=!0},a=function(e){ZWLogger.log("Exception@ FindManager Actionconfiguration failed"),ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,e)};ZWJsThreadExecutor.execFn("FindWorker.updateFindActionConfiguration",e,{success:i,error:a})}},a=function(e,t,n){try{r(e,t,n),b(),PubSub.publish("Document/Find/Opened")}catch(e){ZWLogger.log("Exception@ FindManager onOpen");var i=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,i)}},o=function(){try{u(),e.terminate(),m(),PubSub.publish("Document/Find/Closed")}catch(e){ZWLogger.log("Exception@ FindManager onClose");var t=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,t)}},r=function(t,n,i){try{e&&(u(),e.terminate());var a=findConfigurations[t],o=Utils.getAsFunction(a.handler.findObj).fn||FindObj;e=new o(t,"find",null,a.handler.searchEvents,a.handler.customData,i),n&&e.updateValue(n),PubSub.publish("Document/Find/FilterChanged",t,n)}catch(e){ZWLogger.log("Exception@ FindManager on Filter change");var r=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,r)}},c=function(t){try{u(),e.updateValue(t),PubSub.publish("Document/Find/ValueChanged",t)}catch(e){ZWLogger.log("Exception@ FindManager on value change");var n=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,n)}},l=function(t,n){try{u(),e.setCriteria(t,n)}catch(e){ZWLogger.log("Exception@ FindManager on criteria change");var i=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,i)}},u=function(){n.reset()},d=function(e){try{n.removeNodes(e)}catch(e){ZWLogger.log("Exception@ FindManager on Paragraph processing");var t=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,t)}},s=function(t,i){try{var a=[];i=i||[];for(var o,r=e.getType(),c=0,l=i.length;c<l;c++)o=i[c],a.push(new FindResultNode(o.start,o.end,r,t));a.length&&n.addNodes(t,a)}catch(e){ZWLogger.log("Exception@ FindManager on Processing result");var u=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,u)}},g=function(){return n},p=function(e,t){try{var i=editor.doc.getSelection().getStart(),a=FindResultNavigator.getHighlightedNode()||n.getNearestNode(i);if(!a)return;t&&(e="");var o,r=a.getParaId(),c=n.getNodes(r),l=DocTreeManager.getTreeNodeById(r).getIndex(),u=(t?1:e.length)-(a.getEnd()-a.getStart()),d=l+a.getStart(),s=l+a.getEnd(),g=editor.doc.getContent(d,s),p=editor.doc.getTrackChangeDetails().getProcessingTC(),f=editor.doc.getTrackChangeDetails().getDisplayMode()===TCConstants.NO_MARKUP_VIEW;p&&!f&&(u=e.length),o=s+u;var h=FindUtils.getReplaceOps(editor.getDocument(),{start:d,end:s,text:g},e,t);if(Op.processMsg(h.toJson()),Op.sendMsg(),editor.doc.getSelection().isCollapsed()){var E=editor.doc.createRange(o,o);editor.doc.getSelection().removeAllRanges().setSelectionType(SEL_AUTO_GEN).addRange(E)}for(var b,m=0,T=c.length;m<T;m++)b=c[m],a.getId()!==b.getId()?t?(b.setStart(b.getStart()-a.getEnd()),b.setEnd(b.getEnd()-a.getEnd())):b.getStart()>a.getStart()&&(b.setStart(b.getStart()+u),b.setEnd(b.getEnd()+u)):(c.splice(m,1),T--,m--);n.addNodes(r,c),FindResultNavigator.moveToNextReplace(n.getNearestNode(o))}catch(e){ZWLogger.log("Exception@ FindManager replace");var v=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,v)}},f=function(e,t){try{var i,a,o,r,c=n.getAllNodes(),l=[];t&&(e=""),c.forEach(function(e){i=DocTreeManager.getTreeNodeById(e.getParaId()),i&&(a=i.getIndex(),o=a+e.getStart(),r=a+e.getEnd(),l.push({start:o,end:r,text:editor.doc.getContent(o,r)}))});var u=FindUtils.getReplaceAllOps(editor.getDocument(),l,e,t);Op.processMsg(u.toJson()),Op.sendMsg(),PubSub.publish("Document/Warning",WARNING_MSG.REPLACE_SEARCH_COMPLETED_MSG,l.length)}catch(e){ZWLogger.log("Exception@ FindManager replaceAll");var d=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,d)}},h=function(){return e&&e.getType()},E=function(){return e&&e.getValue()},b=function(){PubSub.subscribe("Document/Find/SearchComplete",s),PubSub.subscribe("Document/Find/ProcessingPara",d),PubSub.subscribe("Document/Find/Reset",u)},m=function(){PubSub.unsubscribe("Document/Find/SearchComplete",s),PubSub.unsubscribe("Document/Find/ProcessingPara",d),PubSub.unsubscribe("Document/Find/Reset",u)};return{init:i,getCollection:g,replace:p,replaceAll:f,getFindType:h,getFindValue:E,onFilterChange:r,onFindValueChange:c,onFindCriteriaChange:l,onFindOpen:a,onFindClose:o}}),FindManager=FindManagerBeta;var FindBaseObj=function(e,t,n,i,a,o){this.type=e,this.value=n,this.origin=t,this.modifyEvents=i.modifyEvents||[],this.removeEvents=i.removeEvents||[],this.customData=a||{},this.searchContent=this.customData.searchContent||[],this.id=this.generateId(),this.criteria=o||{}};extend(FindBaseObj.prototype,{generateId:function(){return"FC_"+("x"+Math.random()).replace(/\D/g,"")},getId:function(){return this.id},getType:function(){return this.type},getValue:function(){return this.value},updateValue:function(e){this.terminate(),this.id=this.generateId(),this.value=e,this.value&&this.start()},setCriteria:function(e,t){this.criteria[e]=t,this.terminate(),this.id=this.generateId(),this.start()},processResult:function(e){return e.result||[]},getSearchData:function(e){var t=this.getData(e)||{};return t.findId=this.getId(),t.type=this.getType(),t.value=this.getValue(),t.criteria=this.criteria,t},canAddPara:function(e){return"para"===e.type},isParaInSearchBlock:function(e){var t=this.criteria.searchIn||null;if(!t||"wholedoc"===t)return!0;switch(t){case"selection":return this.isRangeInSelection(e.getIndex(),e.getEndIndex());case"table":return e.parent&&"cell"===e.parent.type;case"footnote":return e.parent&&"endnote"===e.parent.sectionType||"footnote"===e.parent.sectionType}return!1},startProcess:function(){for(var e,t,n=DocTreeManager.doc.getAllSections(),i=(this.criteria.searchIn||null,editor.doc.getSelection(),0),a=n.length;i<a;i++){e=DocTreeManager.doc.getAllChildren(n[i]);for(var o=0,r=e.length;o<r;o++)t=e[o],this.isParaInSearchBlock(t)&&this.canAddPara(e[o])&&this.sendToWorker(e[o].id)}},onModify:function(e){this.isParaInSearchBlock(e)&&this.canAddPara(e)&&this.sendToWorker(e.id)},onRemove:function(e){this.removeFromWorker(e.id)},getData:function(e){var t=DocTreeManager.getTreeNodeById(e),n={};return t?(this.searchContent.forEach(function(e){switch(e){case FIND_DATATYPE.CONTENT:n[FIND_DATATYPE.CONTENT]=t.getContent();break;case FIND_DATATYPE.STYLES:n[FIND_DATATYPE.STYLES]=editor.doc.getFormats().slice(t.getIndex(),t.getEndIndex()+1);break;case FIND_DATATYPE.PARA_STYLE:n[FIND_DATATYPE.PARA_STYLE]=t.getFormat()}}),n):n},onSearchComplete:function(e){try{if(e.findId!=this.getId())return;var t=this.processResult(e);t=this.isCurrentSelectionOnly()&&t.length?this.filterResult(e.id,t):t,PubSub.publish(this.getEventName(),e.id,t)}catch(e){ZWLogger.log("Exception@FindObj onSearch complete");var n=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,n)}},sendToWorker:function(e){FindWorkerHandler.addToQueue(e,this),PubSub.publish(this.getProcessEventName(),e)},removeFromWorker:function(e){FindWorkerHandler.removeFromQueue(e,this),PubSub.publish(this.getProcessEventName(),e)},getProcessEventName:function(){return"Document/Find/ProcessingPara"},getEventName:function(){return"Document/Find/SearchComplete"},getResetEventName:function(){return"Document/Find/Reset"},onCursorAction:function(){PubSub.publish(this.getResetEventName()),editor.doc.getSelection().isCollapsed()||this.startProcess()},isCurrentSelectionOnly:function(){return"selection"===this.criteria.searchIn},filterResult:function(e,t){var n=DocTreeManager.getTreeNodeById(e);if(!n)return t;var i=n.getIndex(),a=this;return t=t.filter(function(e){return a.isFullyInSelection(i+e.start,i+e.end)})},isFullyInSelection:function(e,t){for(var n,i=editor.doc.getSelection(),a=0,o=i.length;a<o;a++)if(n=i[a],n.start<=e&&t<=n.end)return!0;return!1},isRangeInSelection:function(e,t){for(var n,i,a,o=editor.doc.getSelection(),r=0,c=o.length;r<c;r++)if(n=o[r],i=n.start,a=n.end,e<i&&i<t||i<=e&&t<=a||e<a&&a<t)return!0;return!1},start:function(){PubSub.subscribe(this.modifyEvents,this.onModify,{context:this}),PubSub.subscribe(this.removeEvents,this.onRemove,{context:this}),this.isCurrentSelectionOnly()&&PubSub.subscribe(["Cursor/Collapsed","Cursor/Selected"],this.onCursorAction,{context:this}),this.startProcess()},terminate:function(){PubSub.unsubscribe(this.modifyEvents,this.onModify,{context:this}),PubSub.unsubscribe(this.removeEvents,this.onRemove,{context:this}),PubSub.unsubscribe(["Cursor/Collapsed","Cursor/Selected"],this.onCursorAction,{context:this}),FindWorkerHandler.clearQueue()}});var TextFindObj=function(e,t,n,i,a,o){FindBaseObj.apply(this,[e,t,n,i,a,o])};TextFindObj.prototype=Object.create(FindBaseObj.prototype),extend(TextFindObj.prototype,{isRangeInsideField:function(e,t){if(!e||!t)return!1;for(var n,i=e;i<=t;i++){n=ReviewUtil.getNearestFormat(i);var a=new RegExp(CONT_REGEXP.AUTOFIELD_USER_FIELD);if(n&&("mergeField"===n.cls||"autoformula"===n.cls||"fillablefield"===n.cls||"signerfield"===n.cls||"autodocname"===n.cls||"autoauthor"===n.cls||"autodocversion"===n.cls||"autodate"===n.cls||a.test(n.cls)))return!0}return!1},isParaInMainSection:function(e){var t,n,i=DocTreeManager.doc.getAllSectionsByType(SECTION_TYPES.CONTENT),a=i.length;for(n=0;n<a;n++)if(t=i[n],t.start<=e.getIndex()&&e.getEndIndex()<=t.end)return!0;return!1},isValueContainsPara:function(){return"^e"===this.value||this.value.indexOf("^p")>=0},processResult:function(e){var t,n,i,a,o=e.result||[],r=[],c=DocTreeManager.getTreeNodeById(e.id);if(!c||0===o.length||this.isValueContainsPara()&&!this.isParaInMainSection(c))return[];if(a=c.getIndex(),this.criteria.includeField)r=o;else for(t=0,n=o.length;t<n;t++)i=o[t],this.isRangeInsideField(a+i.start,a+i.end)||r.push(i);return this.criteria.includeLock||(r=FindUtils.removeLockContentRange(a,r)),r}});var HeadingFindObj=function(e,t,n,i,a){FindBaseObj.apply(this,[e,t,n,i,a])};HeadingFindObj.prototype=Object.create(FindBaseObj.prototype),extend(HeadingFindObj.prototype,{processResult:function(e){var t=[],n=DocTreeManager.getTreeNodeById(e.id);return n&&e.result&&0!==e.result.length?[{start:0,end:n.getEndIndex()-n.getIndex()}]:t}});var TableFindObj=function(e,t,n,i,a){FindBaseObj.apply(this,[e,t,n,i,a])};TableFindObj.prototype=Object.create(FindBaseObj.prototype),extend(TableFindObj.prototype,{canAddPara:function(e){return!0},processResult:function(e){var t=e.result||{},n=DocTreeManager.getTreeNodeById(e.id);return n?t:[]}});var BookmarkFindObj=function(e,t,n,i,a){FindBaseObj.apply(this,[e,t,n,i,a])};BookmarkFindObj.prototype=Object.create(FindBaseObj.prototype),extend(BookmarkFindObj.prototype,{processResult:function(e){var t,n,i=e.result||[],a=[],o=DocTreeManager.getTreeNodeById(e.id);return o?(t=o.getIndex(),i.forEach(function(e){n=DocUtil.getRangeEnd(t+e)+1-t,a.push({start:e,end:n})}),a):a}});var MainContentFindObj=function(e,t,n,i,a){FindBaseObj.apply(this,[e,t,n,i,a])};MainContentFindObj.prototype=Object.create(FindBaseObj.prototype),extend(MainContentFindObj.prototype,{isParaInMainSection:function(e){var t,n,i=DocTreeManager.doc.getAllSectionsByType(SECTION_TYPES.CONTENT),a=i.length;for(n=0;n<a;n++)if(t=i[n],t.start<=e.getIndex()&&e.getEndIndex()<=t.end)return!0;return!1},processResult:function(e){var t=e.id,n=e.result||[],i=(e.value,DocTreeManager.getTreeNodeById(t));return i?(this.isParaInMainSection(i)||(n=[]),n):[]}});var ObjectsFindObj=function(e,t,n,i,a){FindBaseObj.apply(this,[e,t,n,i,a])};ObjectsFindObj.prototype=Object.create(FindBaseObj.prototype),extend(ObjectsFindObj.prototype,{canAddPara:function(e){return!0}}),zw.define("FindWorkerHandler",[],[],function(){"user strict";var e,t={},n=function(){e=new ZWJsThreadPool("find",300,"FindWorker.execute",o,i,a,5)},i=function(e){t[e.id]&&t[e.id].onSearchComplete(e),delete t[e.id]},a=function(e){ReviewUtil.sendErrorMail(ZWCollaboration.FIND_ERROR,e)},o=function(e){var n,i=e.id;(n=t[i])&&ZWJSONUtils.mergeJsonObjs(e,n.getSearchData(i))},r=function(n,i){var a={id:n};t[n]=i,e.add(a)},c=function(n){var i={id:n};e.remove(i),delete t[n]},l=function(){return e.isEmpty()},u=function(){t={},e.clear()};return{init:n,addToQueue:r,removeFromQueue:c,isQueueEmpty:l,clearQueue:u}});var FindResultNode=function(e,t,n,i){this.start=e,this.end=t,this.type=n,this.paraId=i,this.id="node_"+("x"+Math.random()).replace(/\D/g,"")};extend(FindResultNode.prototype,{setStart:function(e){this.start=e},getStart:function(){return this.start},setEnd:function(e){this.end=e},getEnd:function(){return this.end},setType:function(e){this.type=e},getType:function(){return this.type},getId:function(){return this.id},setParaId:function(e){this.paraId=e},getParaId:function(){return this.paraId}}),zw.define("FindResultHighlighter",[],["FindManager"],function(e){"use strict";var t,n=function(){t=new RangeHighlighter("find",{class:"replace-overlay",type:"selection"})},i=function(e,t){var n=[],i=DocTreeManager.getTreeNodeById(e);return i?(t.length&&t.forEach(function(e){n.push({start:e.getStart(),end:e.getEnd(),id:e.getId(),paraId:e.getParaId()})}),n):n},a=function(e,n){var a=!1;try{var o=DocTreeManager.getTreeNodeAtIndex(editor.doc.getSelection().getStart());a=o&&o.id===e,t.addRanges(i(e,n),a)}catch(e){var r=e.stack||e;ZWLogger.log("Exception@ FindresultHighlighter addNodes "),ReviewUtil.sendErrorMail(ZWCollaboration.FIND_RANGE_HIGHLIGHTER_ERROR,r)}},o=function(e,n){t.removeRanges(i(e,n))},r=function(){t.reset()},c=function(n){try{var i,a,o,r,c,l,u=[],d=n.parent,s=e.getCollection().getNodes(d.id);for(i=d.getIndex(),a=n.start+i,o=n.end+1+i,c=0,l=s.length;c<l;c++)r=s[c],a<=r.getStart()+i&&r.getEnd()+i<=o&&u.push({start:r.getStart(),end:r.getEnd(),id:r.getId(),paraId:r.getParaId()});u.length&&(t.removeRanges(u),t.addRanges(u,!0))}catch(e){var g=e.stack||e;ZWLogger.log("Exception@ FindresultHighlighter while drawing highlight on line render"),ReviewUtil.sendErrorMail(ZWCollaboration.FIND_RANGE_HIGHLIGHTER_ERROR,g)}},l=function(){PubSub.subscribe("Document/Find/Para/MatchesFound",a),PubSub.subscribe("Document/Find/Para/MatchesRemoved",o),PubSub.subscribe("Document/Find/AllMatchesRemoved",r),PubSub.subscribe([DOMVIEW.LINE_UPDATED,DOMVIEW.LINE_ADDED],c)},u=function(){r(),PubSub.unsubscribe("Document/Find/Para/MatchesFound",a),PubSub.unsubscribe("Document/Find/Para/MatchesRemoved",o),PubSub.unsubscribe("Document/Find/AllMatchesRemoved",r),PubSub.unsubscribe([DOMVIEW.LINE_UPDATED,DOMVIEW.LINE_ADDED],c)};return PubSub.subscribe("Document/Find/Opened",l),PubSub.subscribe("Document/Find/Closed",u),{init:n,reset:r}}),zw.define("FindResultNavigator",[],["FindManager","RangeHighlighter"],function(e,t){"use strict";var n,i,a=0,o=0,r=0,c=null,l=!1,u=function(){n=new t("findresult",{class:"#overlay zw-find animated",type:"selection"})},d=function(){var t;o=e.getCollection().getAllNodes().length,0===o?a=-1:(a>=o||a===-1)&&(r=r>0?r:editor.doc.getSelection().getStart(),t=e.getCollection().getNearestNodeIndex(r),a=t!=-1?t:0),s()},s=function(){var e=a+1+"/"+o;c[0].textContent=e},g=function(e){e&&0!=e.length?c.show():c.hide()},p=function(e,t){g(t)},f=function(){o&&(a===o-1?a=0:a++,b(),s())},h=function(){o&&(0===a?a=o-1:a--,b(),s())},E=function(){try{l&&(n.removeHighlights(),l=!1)}catch(t){ZWLogger.log("Exception@ FindResultNavigator on removeFocus");var e=t.stack||t;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_RESULT_NAVIGATOR_ERROR,e)}},b=function(t,i){try{t=t?t:e.getCollection().getNodeAt(a),i=void 0==i||i;var o;if(!t)return;var c=DocTreeManager.getTreeNodeById(t.getParaId());if(!c)return;r=t.getStart()+c.getIndex(),E();var u=t.getStart()+c.getIndex();if(o={id:"default",start:t.getStart(),end:t.getEnd(),paraId:t.getParaId()},i){var d=DocLayoutManager.getLineAtIndex(u,editor.getPageID()),s=d&&DomViewManager.getDOMElem(d);if(t.getStart()===t.getEnd()||!s){var g=editor.doc.createRange(u,u);editor.doc.getSelection().removeAllRanges().setSelectionType(SEL_AUTO_GEN).addRange(g),s=editor.doc.getCursorPortionNode()}var p=DomUtil.scrollElementIntoView(s);p&&p.promise().then(function(){n.drawOnDemand(o)})}else n.drawOnDemand(o);l=!0}catch(e){ZWLogger.log("Exception@ FindResultNavigator on focusResult");var f=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_RESULT_NAVIGATOR_ERROR,f)}},m=function(){return e.getCollection().getNodeAt(a)},T=function(t,n){if(t){var i=e.getCollection().getNodeIndex(t);i!=-1&&(a=i,b(t,n),s())}},v=function(){a=-1,F()},N=function(e){e&&T(e),PubSub.subscribe("Document/Find/SearchComplete",v)},O=function(){try{var t=editor.doc.getSelection();r=t.getStart(),E(),t.selectionType===SEL_MOUSE&&0!=o&&T(e.getCollection().getNearestNode(t.getStart()),!1)}catch(e){ZWLogger.log("Exception@ FindResultNavigator on CursorChange");var n=e.stack||e;ReviewUtil.sendErrorMail(ZWCollaboration.FIND_RESULT_NAVIGATOR_ERROR,n)}},F=function(){clearTimeout(i);var e=a===-1||a>=o;i=setTimeout(function(){return d(),o?void(e&&b()):void E()},50)},C=function(){a=-1,o=0,r=0,E(),s()},D=function(e){c=e,c[0].textContent=""},A=function(){var t=e.getFindValue();t&&0!=t.length&&F(),I()},I=function(){PubSub.subscribe(["Document/Find/Para/MatchesFound","Document/Find/Para/MatchesRemoved"],F),PubSub.subscribe("Document/Find/ValueChanged",g),PubSub.subscribe("Document/Find/FilterChanged",p),PubSub.subscribe("Document/Find/AllMatchesRemoved",C),PubSub.subscribe(["Cursor/Collapsed","Cursor/Selected"],O)},R=function(){C(),PubSub.unsubscribe(["Document/Find/Para/MatchesFound","Document/Find/Para/MatchesRemoved"],F),PubSub.unsubscribe("Document/Find/ValueChanged",g),PubSub.unsubscribe("Document/Find/FilterChanged",p),PubSub.unsubscribe("Document/Find/AllMatchesRemoved",C),PubSub.unsubscribe(["Cursor/Collapsed","Cursor/Selected"],O)};return PubSub.subscribe("Document/Find/Opened",A),PubSub.subscribe("Document/Find/Closed",R),{init:u,prev:h,next:f,setNavigationTextContainer:D,getHighlightedNode:m,changeFocus:T,moveToNextReplace:N}}),zw.define("FindBulletinManager",[],["FindManager","BulletinManager","FindResultNavigator"],function(e,t,n){"use strict";var i,a=function(){i=new t("find-quickseek-cont",{bgColor:"rgb(255, 245, 0)",borderColor:"rgb(255, 173, 0)"},o)},o=function(t,i){var a=e.getCollection().getNodeById(t);if(a){var o=DocTreeManager.getTreeNodeById(a.getParaId());if(o){var r=o.getIndex()+a.getStart(),c=editor.doc.createRange(r,r);editor.doc.getSelection().removeAllRanges().setSelectionType(SEL_AUTO_GEN).addRange(c);var l=DomUtil.scrollElementIntoView(editor.doc.getCursorPortionNode());l&&l.promise().then(function(){n.changeFocus(a)})}}},r=function(e,t){var n,a,o,r=DocTreeManager.getTreeNodeById(e);if(r){var c=r.getIndex();for(n=0,a=t.length;n<a;n++)o=t[n],i.addBulletin(c+o.getStart(),c+o.getEnd(),o.getId())}},c=function(e,t){var n,a;for(n=0,a=t.length;n<a;n++)i.removeBulletin(t[n].getId())},l=function(){i.removeAllBulletins()},u=function(){i.showBulletinContainer(),PubSub.subscribe("Document/Find/Para/MatchesFound",r),PubSub.subscribe("Document/Find/Para/MatchesRemoved",c),PubSub.subscribe("Document/Find/AllMatchesRemoved",l)},d=function(){l(),i.hideBulletinContainer(),PubSub.unsubscribe("Document/Find/Para/MatchesFound",r),PubSub.unsubscribe("Document/Find/Para/MatchesRemoved",c),PubSub.unsubscribe("Document/Find/AllMatchesRemoved",l)};return PubSub.subscribe("Document/Find/Opened",u),PubSub.subscribe("Document/Find/Closed",d),{init:a}});